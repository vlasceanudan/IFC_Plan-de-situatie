/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/openbim-components@1.5.1/src/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import*as e from"https://esm.sh/three@0.160.1/+esm";import{Vector2 as t,Raycaster as s,Vector3 as i,LineBasicMaterial as n,Triangle as o,MathUtils as r,Line3 as a,Plane as l,BufferGeometry as h,BufferAttribute as c}from"https://esm.sh/three@0.160.1/+esm";import{generateUUID as d}from"https://esm.sh/three@0.160.1/src/math/MathUtils/+esm";import u from"https://esm.sh/top-tool-package-reader@0.0.3/+esm";import{CSS2DRenderer as p,CSS2DObject as m}from"https://esm.sh/three@0.160.1/examples/jsm/renderers/CSS2DRenderer/+esm";import E from"https://esm.sh/camera-controls@2.7.3/+esm";import{computeBoundsTree as g,disposeBoundsTree as I,acceleratedRaycast as C,ExtendedTriangle as f,MeshBVH as w}from"https://esm.sh/three-mesh-bvh@0.7.0/+esm";import{createPopper as T}from"https://esm.sh/@popperjs/core@2.11.8/dist/esm/+esm";import{TransformControls as b}from"https://esm.sh/three@0.160.1/examples/jsm/controls/TransformControls/+esm";import{ConvexHull as v}from"https://esm.sh/three@0.160.1/examples/jsm/math/ConvexHull/+esm";import{EffectComposer as _}from"https://esm.sh/three@0.160.1/examples/jsm/postprocessing/EffectComposer/+esm";import{RenderPass as y}from"https://esm.sh/three@0.160.1/examples/jsm/postprocessing/RenderPass/+esm";import{N8AOPass as A}from"https://esm.sh/n8ao@1.5.1/+esm";import{ShaderPass as F}from"https://esm.sh/three@0.160.1/examples/jsm/postprocessing/ShaderPass/+esm";import{GammaCorrectionShader as R}from"https://esm.sh/three@0.160.1/examples/jsm/shaders/GammaCorrectionShader/+esm";import{Pass as S,FullScreenQuad as M}from"https://esm.sh/three@0.160.1/examples/jsm/postprocessing/Pass/+esm";import*as P from"https://esm.sh/bim-fragment@1.5.0/+esm";import{Serializer as L,Alignment as N,FragmentMesh as O}from"https://esm.sh/bim-fragment@1.5.0/+esm";import*as x from"https://esm.sh/web-ifc@0.0.53/+esm";import D from"https://esm.sh/earcut@2.2.4/+esm";import{unzip as U}from"https://esm.sh/unzipit@1.4.3/+esm";import B from"https://esm.sh/dexie@3.2.7/+esm";import{HorizontalBlurShader as k}from"https://esm.sh/three@0.160.1/examples/jsm/shaders/HorizontalBlurShader/+esm";import{VerticalBlurShader as V}from"https://esm.sh/three@0.160.1/examples/jsm/shaders/VerticalBlurShader/+esm";import{LineMaterial as G}from"https://esm.sh/three@0.160.1/examples/jsm/lines/LineMaterial/+esm";import{LineGeometry as z}from"https://esm.sh/three@0.160.1/examples/jsm/lines/LineGeometry/+esm";import{Line2 as Y}from"https://esm.sh/three@0.160.1/examples/jsm/lines/Line2/+esm";import H from"https://esm.sh/dxf-writer@1.18.4/+esm";class j{constructor(e){this.components=e,this.isDisposeable=()=>"dispose"in this,this.isResizeable=()=>"resize"in this&&"getSize"in this,this.isUpdateable=()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this,this.isHideable=()=>"visible"in this,this.isConfigurable=()=>"setup"in this&&"config"in this&&"onSetup"in this,this.hasUI=()=>"uiElement"in this}}class W{constructor(){this.trigger=async e=>{const t=this.handlers.slice(0);for(const s of t)await s(e)},this.handlers=[]}add(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter((t=>t!==e))}reset(){this.handlers.length=0}}class X extends j{constructor(){super(...arguments),this.onResize=new W,this.onClippingPlanesUpdated=new W,this.clippingPlanes=[]}async updateClippingPlanes(){await this.onClippingPlanesUpdated.trigger()}togglePlane(e,t,s){t.isLocal=s;const i=this.clippingPlanes.indexOf(t);e&&-1===i?this.clippingPlanes.push(t):!e&&i>-1&&this.clippingPlanes.splice(i,1);this.get().clippingPlanes=this.clippingPlanes.filter((e=>!e.isLocal))}}class ${constructor(t){this.dom=t,this._position=new e.Vector2,this.onDisposed=new W,this.updateMouseInfo=e=>{this._event=e},this.setupEvents(!0)}get position(){if(this._event){const e=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(e,this._event),this._position.y=this.getPositionY(e,this._event)}return this._position}async dispose(){this.setupEvents(!1),await this.onDisposed.trigger(),this.onDisposed.reset()}getPositionY(e,t){return-(t.clientY-e.top)/(e.bottom-e.top)*2+1}getPositionX(e,t){return(t.clientX-e.left)/(e.right-e.left)*2-1}setupEvents(e){e?this.dom.addEventListener("mousemove",this.updateMouseInfo):this.dom.removeEventListener("mousemove",this.updateMouseInfo)}}class K extends j{constructor(){super(...arguments),this.id=d(),this.onDisposed=new W,this._enabled=!1,this._isDrawing=!1,this._svgViewport=null,this.start=e=>null,this.draw=e=>{},this.end=e=>{},this.cancel=e=>{e&&(e.stopImmediatePropagation(),"Escape"===e.key&&this.cancel(e))}}set svgViewport(e){this._svgViewport=e}get svgViewport(){return this._svgViewport??void 0}set enabled(e){if(this._enabled=e,this.setupEvents(e),this.components.uiEnabled){this.uiElement.get("main").active=e}}get enabled(){return this._enabled}get canDraw(){return this.enabled&&this._svgViewport}get(){return null}async dispose(){this._svgViewport&&this._svgViewport.remove(),this.setupEvents(!1),this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}setupEvents(e){if(e){if(document.addEventListener("keydown",this.cancel),!this._svgViewport)return;this._svgViewport.addEventListener("mousemove",this.draw),this._svgViewport.addEventListener("mousedown",this.start),this._svgViewport.addEventListener("mouseup",this.end)}else{if(document.removeEventListener("keydown",this.cancel),!this._svgViewport)return;this._svgViewport.removeEventListener("mousemove",this.draw),this._svgViewport.removeEventListener("mousedown",this.start),this._svgViewport.removeEventListener("mouseup",this.end)}}}class Q{constructor(){this._data=null,this.initError="UI Components not initialized."}get(e){if(!this._data)throw new Error(this.initError);return this._data[e]}set(e){this._data=e}async dispose(){if(this._data){for(const e in this._data){const t=this._data[e];await t.dispose()}this._data=null}}}class Z extends j{constructor(){super(...arguments),this.list={},this.onDisposed=new W,this.token="",this.uuid="ToolComponent",this.enabled=!0,this._reader=new u,this._urls={base:"https://api.platform.thatopen.com/v1/tools/",baseDev:"https://dev.api.dev.platform.thatopen.com/v1/tools/",path:"/download?accessToken="},this.onToolAdded=new W,this._uuidv4Pattern=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/}init(e){this._OBC=e}add(e,t){if(e in this.list)throw new Error("You're trying to add a tool that already exists in the components intance. Use ToolsComponent.get() instead.");this.validateUUID(e),this.list[e]=t,this.onToolAdded.trigger(t)}get(e){const t=e.uuid;if(!(t in this.list)){const s=new e(this.components);return t in this.list||this.add(t,s),s}return this.list[t]}async update(e){for(const t in this.list){const s=this.list[t];s.enabled&&s.isUpdateable()&&await s.update(e)}}async dispose(){for(const e in this.list){const t=this.list[e];t.enabled=!1,t.isDisposeable()&&await t.dispose()}await this.onDisposed.trigger(),this.onDisposed.reset()}validateUUID(e){if(!this._uuidv4Pattern.test(e))throw new Error(`${e} is not a valid UUID v4.\n\n- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.\n\n- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}async getPlatformComponent(t){this._OBC||console.log("Tools component not initialized! Call the init method."),this.validateUUID(t);const{base:s,baseDev:i,path:n}=this._urls,o=(window.location.href.match(/(https:\/\/qa.)|(localhost)/)?i:s)+t+n+this.token,r=await fetch(o),a=await r.arrayBuffer(),l=new Uint8Array(a),h=this._reader.read(l),c=document.createElement("script");c.textContent=h.js,document.body.appendChild(c);const d=window;if(!d.ThatOpenTool)throw new Error(`There was a problem fetching the tool ${t}.`);const u=d.ThatOpenTool(this._OBC,e);return d.ThatOpenTool=void 0,c.remove(),new u(this.components)}}Z.libraryUUIDs=new Set;class q extends j{constructor(e){super(e),this._disposedComponents=new Set,this.enabled=!0,e.tools.add(q.uuid,this)}get(){return this._disposedComponents}destroy(e,t=!0,s=!0){e.removeFromParent();const i=e;i.dispose&&i.dispose(),this.disposeGeometryAndMaterials(e,t),s&&i.children&&i.children.length&&this.disposeChildren(i),e.children.length=0}disposeGeometry(e){e.boundsTree&&e.disposeBoundsTree(),e.dispose()}disposeGeometryAndMaterials(e,t){const s=e;s.geometry&&this.disposeGeometry(s.geometry),t&&s.material&&q.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(e){for(const t of e.children)this.destroy(t)}static disposeMaterial(e){if(e.material)if(Array.isArray(e.material))for(const t of e.material)t.dispose();else e.material.dispose()}}q.uuid="76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe",Z.libraryUUIDs.add(q.uuid);class J extends j{constructor(t){super(t),this.enabled=!0,this.isSetup=!1,this.onDisposed=new W,this.config={directionalLight:{color:new e.Color("white"),intensity:1.5,position:new e.Vector3(5,10,3)},ambientLight:{color:new e.Color("white"),intensity:1}},this.onSetup=new W,this._scene=new e.Scene,this._scene.background=new e.Color(2107698)}get(){return this._scene}async dispose(){const e=this.components.tools.get(q);for(const t of this._scene.children){const s=t;s.geometry&&e.destroy(s)}this._scene.children=[],await this.onDisposed.trigger(),this.onDisposed.reset()}async setup(t){this.config={...this.config,...t};const s=new e.DirectionalLight(this.config.directionalLight.color,this.config.directionalLight.intensity);s.position.copy(this.config.directionalLight.position);const i=new e.AmbientLight(this.config.ambientLight.color,this.config.ambientLight.intensity);this._scene.add(s,i),this.isSetup=!0,this.onSetup.trigger(this)}}class ee extends X{constructor(t,s,i){super(t),this.enabled=!0,this.onDisposed=new W,this.onBeforeUpdate=new W,this.onAfterUpdate=new W,this._renderer2D=new p,this.resize=e=>{if(this.updateContainer(),!this.container)return;const t=e?e.x:this.container.clientWidth,s=e?e.y:this.container.clientHeight;this._renderer.setSize(t,s),this._renderer2D.setSize(t,s),this.onResize.trigger(e)},this.resizeEvent=()=>{this.resize()},this.onContextLost=e=>{e.preventDefault(),this.components.enabled=!1},this.onContextBack=()=>{this._renderer.setRenderTarget(null),this._renderer.dispose(),this._renderer=new e.WebGLRenderer({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.components.enabled=!0},this.container=s||null,this._parameters=i,this._renderer=new e.WebGLRenderer({antialias:!0,alpha:!0,...i}),this._renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderers(),this.setupEvents(!0),this.resize(),this._canvas=this._renderer.domElement;const n=this._renderer.getContext(),{canvas:o}=n;o.addEventListener("webglcontextlost",this.onContextLost,!1),o.addEventListener("webglcontextrestored",this.onContextBack,!1)}get(){return this._renderer}async update(){if(!this.enabled)return;await this.onBeforeUpdate.trigger(this);const e=this.overrideScene||this.components.scene.get(),t=this.overrideCamera||this.components.camera.get();e&&t&&(this._renderer.render(e,t),this._renderer2D.render(e,t),await this.onAfterUpdate.trigger(this))}async dispose(){this.enabled=!1,this.setupEvents(!1),this._renderer.domElement.remove(),this._renderer.dispose(),this._renderer2D.domElement.remove(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),await this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new e.Vector2(this._renderer.domElement.clientWidth,this._renderer.domElement.clientHeight)}setupEvents(e){e?window.addEventListener("resize",this.resizeEvent):window.removeEventListener("resize",this.resizeEvent)}setupRenderers(){this._renderer.localClippingEnabled=!0,this._renderer2D.domElement.style.position="absolute",this._renderer2D.domElement.style.top="0px",this._renderer2D.domElement.style.pointerEvents="none",this.container&&(this.container.appendChild(this._renderer.domElement),this.container.appendChild(this._renderer2D.domElement)),this.updateContainer()}updateContainer(){if(!this.container){const e=this._renderer.domElement.parentElement;e&&(this.container=e,e.appendChild(this._renderer2D.domElement))}}}class te extends j{get enabled(){return this.controls.enabled}set enabled(e){this.controls.enabled=e}constructor(e){super(e),this.onBeforeUpdate=new W,this.onAfterUpdate=new W,this.onAspectUpdated=new W,this.onDisposed=new W,this.updateAspect=()=>{if(this.components.renderer.isResizeable()){const e=this.components.renderer.getSize();this._perspectiveCamera.aspect=e.width/e.height,this._perspectiveCamera.updateProjectionMatrix(),this.onAspectUpdated.trigger()}},this._perspectiveCamera=this.setupCamera(),this.activeCamera=this._perspectiveCamera,this.controls=this.setupCameraControls();e.scene.get().add(this._perspectiveCamera),this.setupEvents(!0)}get(){return this.activeCamera}async dispose(){this.setupEvents(!1),this.enabled=!1,this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this._perspectiveCamera.removeFromParent(),this.controls.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}async update(e){this.enabled&&(await this.onBeforeUpdate.trigger(this),this.controls.update(e),await this.onAfterUpdate.trigger(this))}setupCamera(){const t=window.innerWidth/window.innerHeight,s=new e.PerspectiveCamera(60,t,1,1e3);return s.position.set(50,50,50),s.lookAt(new e.Vector3(0,0,0)),s}setupCameraControls(){E.install({THREE:te.getSubsetOfThree()});const e=this.components.renderer.get().domElement,t=new E(this._perspectiveCamera,e);return t.smoothTime=.2,t.dollyToCursor=!0,t.infinityDolly=!0,t.setTarget(0,0,0),t}setupEvents(e){e?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:e.MOUSE,Vector2:e.Vector2,Vector3:e.Vector3,Vector4:e.Vector4,Quaternion:e.Quaternion,Matrix4:e.Matrix4,Spherical:e.Spherical,Box3:e.Box3,Sphere:e.Sphere,Raycaster:e.Raycaster,MathUtils:e.MathUtils}}}class se extends j{constructor(){super(...arguments),this.onDisposed=new W}}class ie extends se{constructor(t){super(t),this.enabled=!0,this.onDisposed=new W,this._raycaster=new e.Raycaster;const s=t.renderer.get().domElement;this.mouse=new $(s)}get(){return this._raycaster}async dispose(){this.mouse.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}castRay(e=Array.from(this.components.meshes)){const t=this.components.camera.get();return this._raycaster.setFromCamera(this.mouse.position,t),this.intersect(e)}castRayFromVector(e,t,s=Array.from(this.components.meshes)){return this._raycaster.set(e,t),this.intersect(s)}intersect(e=Array.from(this.components.meshes)){const t=this._raycaster.intersectObjects(e),s=this.filterClippingPlanes(t);return s.length>0?s[0]:null}filterClippingPlanes(e){const t=this.components.renderer;if(!t.clippingPlanes)return e;const s=t.clippingPlanes;return e.length<=0||!s||s?.length<=0?e:e.filter((e=>s.every((t=>t.distanceToPoint(e.point)>0))))}}class ne extends j{get visible(){return this._grid.visible}set visible(e){if(e){this.components.scene.get().add(this._grid)}else this._grid.removeFromParent()}get material(){return this._grid.material}get fade(){return 3===this._fade}set fade(e){this._fade=e?3:0,this.material.uniforms.uFade.value=this._fade}constructor(t,s=new e.Color(12303291),i=1,n=10,o=500){super(t),this.onDisposed=new W,this.enabled=!0,this._fade=3,this.updateZoom=()=>{const e=this.components.camera;this.material.uniforms.uZoom.value=e.get().zoom},this.components.tools.add(ne.uuid,this);const r=new e.PlaneGeometry(2,2,1,1),a=new e.ShaderMaterial({side:e.DoubleSide,uniforms:{uSize1:{value:i},uSize2:{value:n},uColor:{value:s},uDistance:{value:o},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uDistance;\n            \n            void main() {\n            \n                    vec3 pos = position.xzy * uDistance;\n                    pos.xz += cameraPosition.xz;\n                    \n                    worldPosition = pos;\n                    \n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n            \n            }\n            ",fragmentShader:"\n            \n            varying vec3 worldPosition;\n            \n            uniform float uZoom;\n            uniform float uFade;\n            uniform float uSize1;\n            uniform float uSize2;\n            uniform vec3 uColor;\n            uniform float uDistance;\n                \n                \n                \n                float getGrid(float size) {\n                \n                    vec2 r = worldPosition.xz / size;\n                    \n                    \n                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);\n                    float line = min(grid.x, grid.y);\n                    \n                \n                    return 1.0 - min(line, 1.0);\n                }\n                \n            void main() {\n            \n                    \n                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);\n                    \n                    float g1 = getGrid(uSize1);\n                    float g2 = getGrid(uSize2);\n                    \n                    // Ortho camera fades the grid away when zooming out\n                    float minZoom = step(0.2, uZoom);\n                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;\n                    \n                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));\n                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;\n                    \n                    if ( gl_FragColor.a <= 0.0 ) discard;\n                    \n            \n            }\n            \n            ",extensions:{derivatives:!0}});this._grid=new e.Mesh(r,a),this._grid.frustumCulled=!1;t.scene.get().add(this._grid),this.setupEvents(!0)}get(){return this._grid}async dispose(){this.setupEvents(!1);this.components.tools.get(q).destroy(this._grid),await this.onDisposed.trigger(ne.uuid),this.onDisposed.reset()}setupEvents(e){const t=this.components.camera.controls;e?t.addEventListener("update",this.updateZoom):t.removeEventListener("update",this.updateZoom)}}ne.uuid="d1e814d5-b81c-4452-87a2-f039375e0489",Z.libraryUUIDs.add(ne.uuid);class oe extends j{get domElement(){if(!this._domElement)throw new Error("Dom element not initialized!");return this._domElement}set domElement(e){this._domElement&&this._domElement.remove(),this._domElement=e}set parent(e){this._parent=e}get parent(){return this._parent}get active(){return this._active}set active(e){this.domElement.setAttribute("data-active",String(e)),this._active=e}get visible(){return this._visible}set visible(e){this._visible=e,e?(this.domElement.classList.remove("hidden"),this.onVisible.trigger(this.get())):(this.domElement.classList.add("hidden"),this.onHidden.trigger(this.get()))}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this.onEnabled.trigger(this.get()):this.onDisabled.trigger(this.get())}get hasElements(){return this.children.length>0}set template(e){const t=document.createElement("div");t.innerHTML=e.replace(/id="([^"]+)"/g,`id="$1-${this.id}"`);const s=t.firstElementChild;s.id=this.id,this.domElement=s,t.remove()}constructor(e,t,s){super(e),this.name="SimpleUIComponent",this.onDisposed=new W,this.children=[],this.data={},this.slots={},this.innerElements={},this.onVisible=new W,this.onHidden=new W,this.onEnabled=new W,this.onDisabled=new W,this._parent=null,this._enabled=!0,this._visible=!0,this._active=!1,this._components=e,this.id=s??d(),this.template=t??"<div></div>"}cleanData(){this.data={}}get(){return this.domElement}async dispose(e=!1){for(const e in this.slots){const t=this.slots[e];t&&await t.dispose()}for(const e of this.children)await e.dispose(),this.removeChild(e);for(const e in this.innerElements){const t=this.innerElements[e];t&&t.remove()}e||(this._domElement&&this._domElement.remove(),this.onVisible.reset(),this.onHidden.reset(),this.onEnabled.reset(),this.onDisabled.reset(),this.innerElements={},this.children=[],this.slots={},this.parent=null),await this.onDisposed.trigger(),this.onDisposed.reset()}addChild(...e){for(const t of e)this.children.push(t),this.domElement.append(t.domElement),t.parent=this}removeChild(...e){for(const t of e)t.domElement.remove(),t.parent=null;const t=this.children.filter((t=>!e.includes(t)));this.children=t}removeFromParent(){this.parent&&(this.get().removeAttribute("data-tooeen-slot"),this.parent.removeChild(this))}getInnerElement(e){return this.get().querySelector(`#${e}-${this.id}`)}setSlot(e,t){const s=this.get().querySelector(`[data-tooeen-slot="${e}"]`);if(!s)throw new Error(`Slot ${e} not found. You need to declare it in the UIComponent template using data-tooeen-slot="${e}"`);this.slots[e]=t,t.get().setAttribute("data-tooeen-slot",e),t.parent=this,s.replaceWith(t.get()),this.children.push(t)}setSlots(){for(const e in this.slots){const t=this.slots[e];this.setSlot(e,t)}}}class re extends oe{set visible(e){this._visible=e&&this.hasElements,e&&this.hasElements?(this.domElement.classList.remove("hidden"),this.onVisible.trigger(this.get())):(this.domElement.classList.add("hidden"),this.onHidden.trigger(this.get()))}get visible(){return this._visible}set enabled(e){this.closeMenus(),this.children.forEach((t=>{t.enabled=e,t.menu.enabled=e})),this._enabled=e}set position(e){this._position=e,this.updateElements()}get position(){return this._position}constructor(e,t){const s={position:"bottom",...t};super(e,`\n    <div class="${re.Class.Base}"></div> \n    `),this.children=[],this._parent=null,this.name=s.name??"Toolbar",this.position=s.position??"bottom",this.visible=!0}get hasElements(){return this.children.length>0}get(){return this.domElement}addChild(...e){e.forEach((e=>{e.parent=this,this.children.push(e),this.domElement.append(e.domElement)})),this._components.ui.updateToolbars()}updateElements(){this.children.forEach((e=>e.parent=this))}closeMenus(){this.children.forEach((e=>e.closeMenus()))}setDirection(e="horizontal"){this.domElement.classList.remove("flex-col");const t="horizontal"===e?["flex"]:["flex-col"];this.domElement.classList.add(...t)}}re.Class={Base:"flex shadow-md w-fit h-fit gap-x-2 gap-y-2 p-2 text-white rounded pointer-events-auto backdrop-blur-xl \n           bg-ifcjs-100 z-50"};class ae extends oe{set tooltip(e){const t=this.innerElements.tooltip;t.textContent=e,e?t.classList.remove("hidden"):t.classList.add("hidden")}get tooltip(){return this.innerElements.tooltip.textContent}set label(e){const t=this.innerElements.label;t.textContent=e,e?t.classList.remove("hidden"):t.classList.add("hidden")}get label(){return this.innerElements.label.textContent}set parent(e){this._parent=e,e&&(this.menu.position=e.position,this.updateMenuPlacement())}get parent(){return this._parent}set alignment(e){this.domElement.classList.remove("justify-start","justify-center","justify-end"),this.domElement.classList.add(`justify-${e}`)}set materialIcon(e){const t=this.innerElements.icon;t.textContent=e,t.style.display=e?"unset":"none"}get materialIcon(){return this.innerElements.icon.textContent}get customIcon(){return this.innerElements.customIcon.innerHTML}constructor(e,t){super(e,`\n    <button class="${ae.Class.Base}">\n      <span style="display: none" id="custom-icon" class="md-18"></span> \n      <span style="display: none" id="icon" class="material-icons md-18"></span> \n      <span id="tooltip" class="${ae.Class.Tooltip}"></span> \n      <p id="label" class="${ae.Class.Label}"></p>\n    </button>\n    `),this.name="TooeenButton",this.onClick=new W,this._parent=null,this._closeOnClick=!0,this.innerElements={customIcon:this.getInnerElement("custom-icon"),icon:this.getInnerElement("icon"),label:this.getInnerElement("label"),tooltip:this.getInnerElement("tooltip")},this.materialIcon=t?.materialIconName??null,this.label=t?.name??null,this.tooltip=t?.tooltip??null,this.alignment="start",void 0!==t?.closeOnClick&&(this._closeOnClick=t.closeOnClick),this.domElement.onclick=async e=>{e.stopImmediatePropagation(),await this.onClick.trigger(e),this.menu.children.length?(this.menu.visible=!0,this._popper.update()):this._closeOnClick&&(this._components.ui.closeMenus(),this._components.ui.contextMenu.visible=!1,this.parent&&(this.parent.parent||this._components.ui.closeMenus(),this.parent.closeMenus&&this.parent.closeMenus()))},this.domElement.addEventListener("mouseover",(({target:e})=>{this.isButton(e)&&this._components.ui.tooltipsEnabled&&this.innerElements.tooltip.classList.remove("opacity-0")})),this.domElement.addEventListener("mouseleave",(({target:e})=>{this.isButton(e)&&this.innerElements.tooltip.classList.add("opacity-0")})),this.menu=new re(e),this.menu.visible=!1,this.menu.parent=this,this.menu.setDirection("vertical"),this.domElement.append(this.menu.domElement),this._popper=T(this.domElement,this.menu.domElement,{modifiers:[{name:"offset",options:{offset:[0,15]}},{name:"preventOverflow",options:{boundary:this._components.ui.viewerContainer}}]}),this.onEnabled.add((()=>this.domElement.disabled=!1)),this.onDisabled.add((()=>this.domElement.disabled=!0))}async dispose(e=!1){await super.dispose(e),await this.menu.dispose(),e||this.domElement.remove(),this.onClick.reset(),this._popper.destroy()}addChild(...e){this.menu.addChild(...e)}closeMenus(){this.menu.closeMenus(),this.menu.visible=!1}async setCustomIcon(e){const{customIcon:t}=this.innerElements;if(e){const s=await fetch(e);t.innerHTML=await s.text(),t.style.display="unset"}else t.style.display="none"}updateMenuPlacement(){let e="bottom";"bottom"===this.parent?.position&&(e=this.parent?.parent?"right":"top"),"top"===this.parent?.position&&(e=this.parent?.parent?"right":"bottom"),"left"===this.parent?.position&&(e="right"),"right"===this.parent?.position&&(e="left"),this._popper.setOptions({placement:e})}isButton(e){return e===this.get()||e===this.innerElements.icon||e===this.innerElements.label}}ae.Class={Base:"\n    relative flex gap-x-2 items-center bg-transparent text-white rounded-[10px] \n    max-h-8 p-2 hover:cursor-pointer hover:bg-ifcjs-200 hover:text-black\n    data-[active=true]:cursor-pointer data-[active=true]:bg-ifcjs-200 data-[active=true]:text-black\n    disabled:cursor-default disabled:bg-gray-600 disabled:text-gray-400 pointer-events-auto\n    transition-all fill-white hover:fill-black\n    ",Label:"text-sm tracking-[1.25px] whitespace-nowrap",Tooltip:"\n    transition-opacity bg-ifcjs-100 text-sm text-gray-100 rounded-md \n    absolute left-1/2 -translate-x-1/2 -translate-y-12 opacity-0 mx-auto p-4 w-max h-4 flex items-center\n    pointer-events-none\n    "};class le extends oe{set description(e){const t=this.innerElements.description;t.textContent=e,e?t.classList.remove("hidden"):t.classList.add("hidden")}get description(){return this.innerElements.description.textContent}set title(e){this.innerElements.title.textContent=e}get title(){return this.innerElements.title.textContent}set materialIcon(e){this.innerElements.expandBtn.textContent=e}get expanded(){return this._expanded}set expanded(e){this._expanded=e,this.slots.content.visible=e,e?(this.onExpand.trigger(),this.innerElements.titleContainer.classList.add("bg-ifcjs-120"),this.materialIcon="arrow_drop_down"):(this.onCollapse.trigger(),this.innerElements.titleContainer.classList.remove("bg-ifcjs-120"),this.materialIcon="arrow_right")}set onmouseover(e){this.domElement.onmouseover=t=>{t.stopImmediatePropagation(),e(t)}}constructor(e,t){super(e,'\n    <div class="flex flex-col items-start w-full box-border cursor-pointer text-base my-0">\n      <div id="title-container" class="flex flex-wrap items-center text-base my-0 justify-between hover:bg-ifcjs-120 rounded-md w-full min-h-[30px] pr-3 bg-ifcjs-120">\n        <div class="flex flex-row items-center gap-x-2 mr-4">\n          <span id="expandBtn" class="material-icons md-18 text-white rounded-[10px] h-fit hover:cursor-pointer hover:bg-ifcjs-200 hover:text-black transition-all p-1"></span>\n          <div class="flex flex-col items-start py-[5px]">\n            <p id="title" class="text-base my-0"></p>\n            <p id="description" class="text-sm text-gray-400 my-0"></p>\n          </div>\n        </div> \n        <div data-tooeen-slot="titleRight"></div>\n      </div>\n      <div data-tooeen-slot="content"></div>\n    </div>\n    '),this._expanded=!0,this.onExpand=new W,this.onCollapse=new W,this.onClick=new W,this.domElement.onclick=async e=>{e.stopImmediatePropagation(),await this.onClick.trigger(e)},this.innerElements={titleContainer:this.getInnerElement("title-container"),title:this.getInnerElement("title"),description:this.getInnerElement("description"),expandBtn:this.getInnerElement("expandBtn")},this.innerElements.expandBtn.onclick=()=>this.toggle(),this.slots={content:new oe(e,'<div class="flex flex-col w-full pl-[22px]"></div>'),titleRight:new oe(e)},this.setSlots(),this.title=t??null,this.collapse()}async dispose(e=!1){await super.dispose(e),e||(this.onExpand.reset(),this.onCollapse.reset())}toggle(e=!1){e?this.expanded?this.collapse():this.expand():this.expanded=!this.expanded}addChild(...e){this.slots.content.addChild(...e)}collapse(e=!0){if(this.expanded&&(this.expanded=!1,e))for(const t of this.children)t instanceof le&&t.collapse(e)}expand(e=!0){if(!this.expanded&&(this.expanded=!0,e))for(const t of this.children)t instanceof le&&t.expand(e)}}class he extends j{get viewerContainer(){return this._components.renderer.get().domElement.parentElement}constructor(e){super(e),this.name="UIManager",this.enabled=!0,this.toolbars=[],this.tooltipsEnabled=!0,this.children=[],this.onDisposed=new W,this._mouseMoved=!1,this._mouseDown=!1,this._containers={top:document.createElement("div"),right:document.createElement("div"),bottom:document.createElement("div"),left:document.createElement("div")},this.onMouseUp=()=>{this._mouseDown=!1},this.onMouseMoved=()=>{this._mouseDown&&(this._mouseMoved=!0)},this.onMouseDown=e=>{this._mouseDown=!0;const t=this._components.renderer.get().domElement;e.target===t&&(this.closeMenus(),this.contextMenu.visible=!1)},this.onContextMenu=e=>{this._mouseMoved?this._mouseMoved=!1:(e.preventDefault(),e.stopImmediatePropagation(),this.closeMenus(),this._contextMenuContainer.style.left=`${e.offsetX}px`,this._contextMenuContainer.style.top=`${e.offsetY}px`,this.contextMenu.visible=!0,this._popperInstance.update())},this._components=e,this.contextMenu=new re(e),this.contextMenu.setDirection("vertical"),this.contextMenu.position="left",this._contextMenuContainer=document.createElement("div"),this._contextMenuContainer.style.position="absolute",this._contextMenuContainer.append(this.contextMenu.domElement),this._popperInstance=T(this._contextMenuContainer,this.contextMenu.domElement,{placement:"bottom-start",modifiers:[{name:"preventOverflow",options:{boundary:Object.values(this._containers)}}]});const t={top:["top-0","pt-4"],right:["top-0","right-0","pr-4"],bottom:["bottom-0","pb-4"],left:["top-0","left-0","pl-4"]};for(const e in this._containers){const s=this._containers[e];s.className="absolute flex gap-y-3 gap-x-3 pointer-events-none p-4",s.classList.add(...t[e]),s.id=`${e}-toolbar-container`,this.setContainerAlignment(e,"center")}const s=["flex-row","w-full"],i=["flex-column","h-full"];this._containers.top.classList.add(...s),this._containers.right.classList.add(...i),this._containers.bottom.classList.add(...s),this._containers.left.classList.add(...i)}get(){return this.toolbars}async dispose(){this.setupEvents(!1);for(const e in this._containers){this._containers[e].remove()}for(const e of this.toolbars)await e.dispose();for(const e of this.children)await e.dispose();this._popperInstance.destroy(),this.children=[],await this.contextMenu.dispose(),this._containers={},this._contextMenuContainer.remove(),this._popperInstance=null,this._components=null,this.contextMenu=null,this._contextMenuContainer=null,await this.onDisposed.trigger(),this.onDisposed.reset()}async init(){this.setupEvents(!0),this.viewerContainer.append(this._containers.top,this._containers.right,this._containers.bottom,this._containers.left,this._contextMenuContainer),this.viewerContainer.style.position="relative",this.viewerContainer.classList.add("obc-viewer");const e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/icon?family=Material+Icons";const t=await fetch("https://raw.githubusercontent.com/ThatOpen/engine_components/main/resources/styles.css"),s=await t.text(),i=document.createElement("style");i.id="openbim-components",i.textContent=s;const n=document.head.querySelector("link");n?(document.head.insertBefore(e,n),document.head.insertBefore(i,n)):document.head.append(e,i)}add(...e){for(const t of e)this.children.push(t),this.viewerContainer.append(t.domElement)}closeMenus(){this.toolbars.forEach((e=>e.closeMenus())),this.contextMenu.closeMenus()}setContainerAlignment(e,t){this._containers[e].style.justifyContent=t,this._containers[e].style.alignItems=t}addToolbar(...e){e.forEach((e=>{const t=this._containers[e.position];t&&(t.append(e.domElement),this.toolbars.push(e))})),this.updateToolbars()}updateToolbars(){this.toolbars.forEach((e=>{e.visible=!0,e.updateElements(),"bottom"===e.position||"top"===e.position?e.setDirection("horizontal"):e.setDirection("vertical")}))}setupEvents(e){e?(this.viewerContainer.addEventListener("mouseup",this.onMouseUp),this.viewerContainer.addEventListener("mousedown",this.onMouseDown),this.viewerContainer.addEventListener("mousemove",this.onMouseMoved),this.viewerContainer.addEventListener("contextmenu",this.onContextMenu)):(this.viewerContainer.removeEventListener("mouseup",this.onMouseUp),this.viewerContainer.removeEventListener("mousedown",this.onMouseDown),this.viewerContainer.removeEventListener("mousemove",this.onMouseMoved),this.viewerContainer.removeEventListener("contextmenu",this.onContextMenu))}}he.Class={Label:"block leading-6 text-gray-400 text-sm my-0"};class ce extends oe{set title(e){this.innerElements.title.textContent=e}get title(){return this.innerElements.title.textContent}set description(e){this.innerElements.description.textContent=e}get description(){return this.innerElements.description.textContent}constructor(e,t){super(e,'\n    <div class="p-2 text-white flex items-center rounded-lg border-transparent border border-solid">\n      <div class="mr-auto">\n        <p id="title" class="text-base"></p>\n        <p id="description" class="text-sm text-gray-400"></p>\n      </div>\n      <div data-tooeen-slot="rightContainer"></div> \n    </div> \n    ',t),this.name="SimpleUICard",this.innerElements={title:this.getInnerElement("title"),description:this.getInnerElement("description")},this.slots={rightContainer:new oe(e,'<div class="flex"></div>')},this.setSlots()}addChild(...e){e.forEach((e=>{this.slots.rightContainer.addChild(e)}))}}class de extends oe{get containerSize(){return{height:this.domElement.clientHeight-this.innerElements.titleContainer.clientHeight,width:this.domElement.clientWidth}}get viewerContainer(){return this._components.renderer.get().domElement.parentElement}set description(e){const t=this.innerElements.description;t.textContent=e,e?t.classList.remove("hidden"):t?.classList.add("hidden")}get description(){return this.innerElements.description.textContent}set title(e){const t=this.innerElements.title;t.textContent=e,e?t.classList.remove("hidden"):t.classList.add("hidden")}get title(){return this.innerElements.title.textContent}set resizeable(e){this._resizeable=e,e?this.get().classList.add("resize"):this.get().classList.remove("resize")}get resizeable(){return this._resizeable}set movable(e){this._movable=e,e?this.innerElements.titleContainer.classList.add("cursor-move"):this.innerElements.titleContainer.classList.remove("cursor-move")}get movable(){return this._movable}constructor(e,s){super(e,`\n    <div class="${de.Class.Base}">\n      <div id="title-container" class="z-10 flex justify-between items-center top-0 select-none cursor-move px-6 py-3 border-b-2 border-solid border-[#3A444E]">\n        <div class="flex flex-col">\n          <h3 class="text-3xl text-ifcjs-200 font-medium my-0" id="title">Tooeen Floating Window</h3>\n          <p id="description" class="${de.Class.Description}"></p>\n        </div>\n        <span id="close" class="material-icons text-2xl ml-4 text-gray-400 z-20 hover:cursor-pointer hover:text-ifcjs-200">close</span>\n      </div>\n      <div data-tooeen-slot="content"></div>\n    </div>\n    `,s),this._resizeable=!0,this._movable=!0,this.onMoved=new W,this.onResized=new W,this._isMouseDown=!1,this._offsetX=0,this._offsetY=0,this.onMOuseDown=e=>{if(!this.movable)return;this._isMouseDown=!0;const t=this.domElement.getBoundingClientRect();this._offsetX=e.clientX-t.left,this._offsetY=e.clientY-t.top},this.onMouseUp=()=>{this._isMouseDown=!1},this.onMouseMove=e=>{if(!this._isMouseDown||!this.movable)return;const{width:t,height:s}=this.domElement.getBoundingClientRect(),{x:i,y:n,width:o,height:r}=this.viewerContainer.getBoundingClientRect(),a=o-t,l=r-s,h=Math.max(0,Math.min(e.clientX-this._offsetX-i,a)),c=Math.max(0,Math.min(e.clientY-this._offsetY-n,l));this.domElement.style.left=`${h}px`,this.domElement.style.top=`${c}px`,this.onMoved.trigger(this)},this.innerElements={title:this.getInnerElement("title"),description:this.getInnerElement("description"),titleContainer:this.getInnerElement("title-container"),closeBtn:this.getInnerElement("close")},this.slots={content:new oe(e,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>')},this.setSlots(),this.innerElements.closeBtn.onclick=()=>this.visible=!1,this.setMovableListeners();new ResizeObserver((()=>this.onResized.trigger())).observe(this.get()),this.description=null,this.movable=!0,this.resizeable=!0,this.referencePoints={topLeft:new t,top:new t,topRight:new t,left:new t,center:new t,right:new t,bottomLeft:new t,bottom:new t,bottomRight:new t},this.domElement.style.width="400px",this.domElement.style.height="250px"}async dispose(e=!1){await super.dispose(e),this.setupEvents(!1),this.onMoved.reset(),this.onResized.reset()}setMovableListeners(){try{this._components.renderer}catch(e){return}this.setupEvents(!0)}addChild(...e){const t=this.slots.content;t.addChild(...e),t.visible||(t.visible=!0)}updateReferencePoints(){const e=this.domElement.getBoundingClientRect();this.referencePoints.topLeft.set(e.x,e.y),this.referencePoints.top.set(e.x+e.width/2,e.y),this.referencePoints.topRight.set(e.x+e.width,e.y),this.referencePoints.left.set(e.x,e.y+e.height/2),this.referencePoints.center.set(e.x+e.width/2,e.y+e.height/2),this.referencePoints.right.set(e.x+e.width,e.y+e.height/2),this.referencePoints.bottomLeft.set(e.x,e.y+e.height),this.referencePoints.bottom.set(e.x+e.width/2,e.y+e.height),this.referencePoints.bottomRight.set(e.x+e.width,e.y+e.height)}setupEvents(e){const t=this.innerElements.titleContainer,s=this.viewerContainer;e?(t&&t.addEventListener("mousedown",this.onMOuseDown),s.addEventListener("mousemove",this.onMouseMove),s.addEventListener("mouseup",this.onMouseUp)):(t&&t.removeEventListener("mousedown",this.onMOuseDown),s.removeEventListener("mousemove",this.onMouseMove),s.removeEventListener("mouseup",this.onMouseUp))}}de.Class={Base:"absolute flex flex-col backdrop-blur-xl shadow-md overflow-auto top-5 resize z-50 left-5 min-h-[80px] min-w-[150px] w-fit h-fit text-white bg-ifcjs-100 rounded-md",Description:"text-base text-gray-400"};class ue extends oe{set value(e){const t=this.options.find((t=>t===e))??this.options[0];this.innerElements.button.textContent=t??null,this.onChange.trigger(this.value)}get value(){return this.innerElements.button.textContent}set allowSearch(e){this._allowSearch=e,e?this.innerElements.search.classList.remove("hidden"):this.innerElements.search.classList.add("hidden")}get allowSearch(){return this._allowSearch}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}constructor(e,t="Tooeen Dropdown"){super(e,`\n    <div class="w-full">\n      <label id="label" class="${he.Class.Label}"></label>\n      <button\n      id="button"\n      data-dropdown-toggle="dropdown"\n      class="text-white bg-transparent w-full ring-1 ring-gray-500 focus:outline-none focus:ring-ifcjs-200 rounded-md text-base p-3 text-center inline-flex items-center"\n      type="button">\n        <svg class="w-2.5 h-2.5 ml-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">\n          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>\n        </svg>\n        </button>\n      <div id="dropdown" class="z-10 absolute hidden px-4 py-3 mt-1 max-h-[300px] w-fit overflow-auto bg-[#212121] rounded-md shadow">\n        <div id="search" class="hidden">\n          <label class="block leading-6 text-gray-400 text-xs">Search</label>\n          <input id="searchInput" class="block bg-transparent w-full rounded-md p-3 text-white ring-1 text-base ring-gray-500 placeholder:text-gray-400 focus:ring-ifcjs-200 focus:outline-none"></input>\n        </div>\n        <ul id="dropdownList" class="text-sm text-white list-none m-0 p-0"></ul>\n      </div>\n    </div>\n    `),this.name="TooeenDropdown",this.options=[],this.onChange=new W,this._allowSearch=!1,this.hide=e=>{this.get().contains(e.target)||this.innerElements.dropdown.classList.add("hidden")},this.innerElements={label:this.getInnerElement("label"),button:this.getInnerElement("button"),dropdown:this.getInnerElement("dropdown"),search:this.getInnerElement("search"),searchInput:this.getInnerElement("searchInput"),dropdownList:this.getInnerElement("dropdownList")},this.setSearch(),this.innerElements.button.onclick=()=>this.toggle(),this.setupEvents(!0),this.label=t}async dispose(e=!1){super.dispose(e),this.onChange.reset(),this.setupEvents(!1)}toggle(){this.innerElements.dropdown.classList.contains("hidden")?this.innerElements.dropdown.classList.remove("hidden"):this.innerElements.dropdown.classList.add("hidden")}addOption(...e){const t=e.filter((e=>!this.options.includes(e)));for(const e of t){this.options.push(e);const t=document.createElement("li");t.id=`${e.replace(/\s+/g,"_")}-${this.id}`,t.className="py-2 text-base cursor-pointer hover:text-ifcjs-200 m-0 p-0",t.textContent=e,t.onclick=()=>{this.value=e,this.innerElements.dropdown.classList.add("hidden")},this.innerElements.dropdownList.appendChild(t)}return this}removeOption(...e){const t=e.filter((e=>this.options.includes(e)));for(const e of t){const t=this.get().querySelector(`#${e.replace(/\s+/g,"_")}-${this.id}`);t&&t.remove()}return this.options=this.options.filter((t=>!e.includes(t))),this}setSearch(){this.innerElements.searchInput.oninput=()=>{const e=this.innerElements.searchInput.value.toLowerCase(),t=this.innerElements.dropdownList.children;for(const s of t){const t=s.textContent?.toLowerCase();t&&(t.includes(e)?s.classList.remove("hidden"):s.classList.add("hidden"))}}}setupEvents(e){e?document.addEventListener("click",this.hide,!0):document.removeEventListener("click",this.hide,!0)}}class pe extends oe{set value(e){this.innerElements.input.value=e,this.onChange.trigger(this.value)}get value(){return this.innerElements.input.value}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}constructor(e){super(e,`\n    <div class="w-full">\n      <label id="label" class="${he.Class.Label}"></label>\n      <input id="input" type="text" class="block bg-transparent w-full rounded-md p-3 text-white ring-1 text-base ring-gray-500 focus:ring-ifcjs-200 focus:outline-none placeholder:text-gray-400">\n    </div>\n    `),this.name="TooeenTextInput",this.onChange=new W,this.innerElements={label:this.getInnerElement("label"),input:this.getInnerElement("input")},this.label="Tooeen Text",this.innerElements.label.setAttribute("for",`input-${this.id}`)}async dispose(e=!1){await super.dispose(e),this.onChange.reset()}}class me extends oe{set value(e){this.innerElements.input.checked=e,this.onChange.trigger(this.value)}get value(){return this.innerElements.input.checked}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}constructor(e){super(e,`\n    <div class="w-full flex gap-x-2 items-center">\n        <input id="input" type="checkbox" \n            class="h-4 w-4 rounded border-gray-300 accent-ifcjs-300 text-ifcjs-300 focus:ring-ifcjs-300">\n        <label id="label" class="${he.Class.Label}"></label>\n    </div>\n    `),this.name="TooeenCheckboxInput",this.onChange=new W,this.innerElements={label:this.getInnerElement("label"),input:this.getInnerElement("input")},this.innerElements.input.addEventListener("change",(()=>{this.onChange.trigger(this.value)})),this.label="Tooeen Checkbox"}async dispose(e=!1){await super.dispose(e),this.onChange.reset()}}class Ee extends oe{set value(e){this.innerElements.input.value=e,this.onChange.trigger(this.value)}get value(){return this.innerElements.input.value}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}constructor(e){super(e,`\n    <div class="w-full">\n      <label id="label" class="${he.Class.Label}"></label>\n      <input id="input" type="color" class="block w-full h-[48px] rounded-md text-white text-base ring-gray-500 focus:ring-ifcjs-200 focus:outline-none">\n    </div>\n    `),this.name="TooeenColorInput",this.onChange=new W,this.innerElements={label:this.getInnerElement("label"),input:this.getInnerElement("input")},this.label="Tooeen Color",this.value="#BCF124",this.innerElements.input.oninput=()=>{this.onChange.trigger(this.value)}}async dispose(e=!1){await super.dispose(e),this.onChange.reset()}}class ge extends oe{set value(e){this.innerElements.input.value=String(e),this.onChange.trigger(this.value)}get value(){return Number(this.innerElements.input.value)}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}set min(e){this.innerElements.input.min=String(e)}get min(){return Number(this.innerElements.input.min)}set max(e){this.innerElements.input.max=String(e)}get max(){return Number(this.innerElements.input.max)}set step(e){this.innerElements.input.step=String(e)}get step(){return Number(this.innerElements.input.step)}constructor(e){super(e,`\n    <div>\n      <label id="label" class="${he.Class.Label}"></label>\n      <input id="input" type="range" class="block w-full rounded-md border-0 py-1.5 shadow-sm accent-ifcjs-300">\n    </div>\n    `),this.name="TooeenRangeInput",this.onChange=new W,this.innerElements={label:this.getInnerElement("label"),input:this.getInnerElement("input")},this.label="Tooeen Range",this.innerElements.input.oninput=()=>{this.onChange.trigger(this.value)}}}class Ie extends oe{constructor(t){super(t,'\n        <canvas class="absolute w-80 h-40 right-8 bottom-4 bg-ifcjs-120 \n        border-transparent border border-solid rounded-lg"></canvas> \n    '),this.name="Canvas",this.onResize=new W,this._size=new e.Vector2(320,160)}getSize(){return this._size}resize(e){e&&(this._size=e,this.domElement.style.width=`${e.x}px`,this.domElement.style.height=`${e.y}px`,this.onResize.trigger(e))}}class Ce extends oe{constructor(e,t){super(e,`\n      <div class="absolute top-8 bottom-8 left-8 right-8">\n        <div class="flex items-center justify-center w-full h-full">\n            <label for="dropzone-file" class="h-full flex flex-col items-center justify-center w-full border-2 border-gray-300 border-dashed rounded-lg cursor-pointer backdrop-blur-xl bg-ifcjs-100 dark:hover:bg-bray-800 dark:bg-gray-700 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600 transition ease-in-out hover:backdrop-blur-xl duration-300">\n                <div class="flex flex-col items-center justify-center pt-5 pb-6">\n                    <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">\n                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>\n                    </svg>\n                    <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>\n                    <p class="text-xs text-gray-500 dark:text-gray-400">${t?t.subTitle:""}</p>\n                </div>\n                <input id="dropzone-file" type="file" class="hidden" />\n            </label>\n        </div> \n      </div>\n    `),this.name="DragAndDropInput",this.onFilesLoaded=new W;const s=this.get().querySelector("input");if(!s)throw new Error("Input not found!");const i=async()=>{null!==s.files&&await this.onFilesLoaded.trigger(s.files)};s.onchange=()=>i();const n=e=>e.preventDefault();this.get().ondragover=n,this.get().ondragenter=n,this.get().ondrop=async e=>{e.preventDefault(),s.files=e.dataTransfer.files,await i()}}async dispose(e=!1){await super.dispose(e),this.onFilesLoaded.reset()}}class fe extends oe{constructor(e){super(e,'\n    <div class="absolute w-screen h-screen top-0 bottom-0 right-0 left-0 flex justify-center items-center pointer-events-none">\n      <div role="status">\n        <svg aria-hidden="true" class="w-8 h-8 mr-2 text-ifcjs-200 animate-spin fill-black" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>\n          <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>\n        </svg>\n        <span class="sr-only">Loading...</span>\n      </div>\n    </div>\n    '),this.name="Spinner"}}class we extends oe{set materialIcon(e){this.innerElements.icon.textContent=e,e?this.innerElements.icon.classList.remove("hidden"):this.innerElements.icon.classList.add("hidden")}constructor(e,t){super(e,'\n    <div class="absolute bottom-8 left-8 transition-transform">\n      <div id="toast-default" class="flex items-center w-full max-w-xs p-4 text-gray-500 bg-ifcjs-200 rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">\n        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-ifcjs-200 bg-ifcjs-300 rounded-full dark:bg-blue-800 dark:text-blue-200">\n          <span id="icon" class="material-icons md-18"></span>\n        </div>\n        <p id="message" class="ml-3 text-sm font-normal"></p>\n      </div>\n    </div>\n    '),this.name="ToastNotification",this.duration=3e3,this.innerElements={icon:this.getInnerElement("icon"),message:this.getInnerElement("message")},this.domElement.style.zIndex="9999",this.materialIcon=t.materialIconName??"done",this.message=t.message}get message(){return this.innerElements.message.textContent}set message(e){this.innerElements.message.textContent=e}set visible(e){e?(super.visible=e,setTimeout((()=>{this.domElement.style.transform="translateY(0)",this.hideAutomatically()}),200)):(this.domElement.style.transform="translateY(10rem)",setTimeout((()=>super.visible=e),200))}hideAutomatically(){setTimeout((()=>{this.visible=!1}),this.duration)}}class Te extends oe{set value(e){this.innerElements.input.value=e,this.onChange.trigger(this.value)}get value(){return this.innerElements.input.value}set label(e){this.innerElements.label.textContent=e,e?this.innerElements.label.classList.remove("hidden"):this.innerElements.label.classList.add("hidden")}get label(){return this.innerElements.label.textContent}set placeholder(e){this.innerElements.input.placeholder=e}get placeholder(){return this.innerElements.input.placeholder}constructor(e){super(e,`\n    <div class="w-full">\n      <label id="label" for="message" class="${he.Class.Label}"></label>\n      <textarea id="input" rows="4" class="block bg-transparent w-full rounded-md p-3 text-white ring-1 text-base ring-gray-500 focus:ring-ifcjs-200 focus:outline-none placeholder:text-gray-400"></textarea>\n    </div>\n    `),this.name="TooeenTextArea",this.onChange=new W,this.innerElements={label:this.getInnerElement("label"),input:this.getInnerElement("input")},this.label="Tooeen Text Area",this.placeholder="Write something...",this.innerElements.label.setAttribute("for",`input-${this.id}`)}async dispose(e=!1){await super.dispose(e),this.onChange.reset()}}class be extends oe{get hasCommands(){return 0!==Object.keys(this.commands).length}constructor(t){super(t,'<div id="window" class="absolute bg-ifcjs-100 backdrop-blur-xl rounded-md p-3 z-50"></div>'),this.name="CommandsMenu",this.offset=new e.Vector2(20,-10),this.commands={},this.hideCommandsMenu=()=>{this.visible=!1},this.innerElements={window:this.getInnerElement("window")},this.setupEvents(!0)}update(){this.dispose(!0);for(const e in this.commands){const t=this.commands[e],s=new ae(this._components,{name:e});s.name=e,this.addChild(s),s.onClick.add((()=>t(this.commandData)))}}popup(e,t){this.domElement.style.left=`${e+this.offset.x}px`,this.domElement.style.top=`${t+this.offset.y}px`,this.visible=!0}async dispose(e=!1){await super.dispose(e),e||(this.setupEvents(!1),this.commands={},this.commandData=null)}setupEvents(e){e?window.addEventListener("click",this.hideCommandsMenu):window.removeEventListener("click",this.hideCommandsMenu)}}class ve extends oe{get visible(){return this._visible}set visible(e){const t=this.domElement.classList;if("top"===this._type||"bottom"===this._type){const s="top"===this._type?"-":"";e?t.remove(`${s}translate-y-full`):t.add(`${s}translate-y-full`)}else{const s="left"===this._type?"-":"";e?t.remove(`${s}translate-x-full`):t.add(`${s}translate-x-full`)}this._visible=e}get size(){return this._size}set size(e){this._size=e;const t="top"===this._type||"bottom"===this._type,s=t?this._size:"inherit",i=t?"inherit":this._size;this.domElement.style.height=s,this.domElement.style.width=i}get containerSize(){return{height:this.domElement.clientHeight,width:this.domElement.clientWidth}}set alignment(e){const t=this.domElement.classList;this._type=e,t.remove("h-full"),t.remove("w-full"),t.remove("top-0"),t.remove("bottom-0"),t.remove("left-0"),t.remove("right-0"),t.remove("-translate-x-full"),t.remove("-translate-y-full"),t.remove("translate-x-full"),t.remove("translate-y-full"),"top"===e||"bottom"===e?(t.add("w-full"),t.add("left-0"),t.add(`${e}-0`)):(t.add("h-full"),t.add("top-0"),t.add(`${e}-0`)),this.size=this._size,this.visible=this._visible}constructor(e){super(e,'\n        <div class="fixed bg-ifcjs-100 backdrop-blur-xl shadow-md overflow-auto z-20 top-0 left-0 h-full transition-all duration-500 transform text-white">\n            <div data-tooeen-slot="content"></div>\n        </div>\n    '),this.onResized=new W,this._size="10rem",this._visible=!0,this._type="left",this.domElement.style.width=this._size,this.slots={content:new oe(e,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>')},this.setSlots();new ResizeObserver((()=>this.onResized.trigger())).observe(this.get())}addChild(...e){const t=this.slots.content;t.addChild(...e),t.visible||(t.visible=!0)}}class _e extends oe{set description(e){const t=this.innerElements.description;t.textContent=e,e?t.classList.remove("hidden"):t?.classList.add("hidden")}get description(){return this.innerElements.description.textContent}set title(e){const t=this.innerElements.title;t.textContent=e,e?t.classList.remove("hidden"):t.classList.add("hidden")}get title(){return this.innerElements.title.textContent}set visible(e){this._visible=e,e?(this.get().showModal(),this.onVisible.trigger()):(this.get().close(),this.onHidden.trigger())}get visible(){return this._visible}constructor(e,t="Tooeen Modal"){super(e,`\n    <dialog class="thatopen-dialog overflow-visible bg-transparent m-auto backdrop:backdrop-blur-md">\n      <div class="flex flex-col backdrop-blur-xl w-[350px] h-fit text-white bg-ifcjs-100 rounded-md">\n        <div class="flex justify-between items-center top-0 select-none px-6 py-3 border-b-2 border-solid border-[#3A444E]">\n          <h3 class="text-3xl text-ifcjs-200 font-medium" id="title">${t}</h3>\n          <p id="description" class="text-base text-gray-400"></p>\n        </div>\n        <div data-tooeen-slot="content"></div>\n        <div data-tooeen-slot="actionButtons"></div>\n      </div>\n    </dialog> \n    `),this.onAccept=new W,this.onCancel=new W,this.innerElements={title:this.getInnerElement("title"),description:this.getInnerElement("description")},this.slots={content:new oe(e),actionButtons:new oe(e,'<div class="flex gap-x-2 justify-end p-4"></div>')},this.setSlots();const s=new ae(this._components);s.materialIcon="check",s.label="Accept",s.get().classList.remove("hover:bg-ifcjs-200"),s.get().classList.add("hover:bg-success"),s.onClick.add((()=>this.onAccept.trigger()));const i=new ae(this._components);i.materialIcon="close",i.label="Cancel",i.get().classList.remove("hover:bg-ifcjs-200"),i.get().classList.add("hover:bg-error"),i.onClick.add((()=>this.onCancel.trigger())),this.slots.actionButtons.addChild(i,s)}async dispose(e=!1){await super.dispose(e),this.onCancel.reset(),this.onAccept.reset()}}class ye{get ui(){if(!this._ui)throw new Error("UIManager hasn't been initialised.");return this._ui}get renderer(){if(!this._renderer)throw new Error("Renderer hasn't been initialised.");return this._renderer}set renderer(e){this._renderer=e}get scene(){if(!this._scene)throw new Error("Scene hasn't been initialised.");return this._scene}set scene(e){this._scene=e}get camera(){if(!this._camera)throw new Error("Camera hasn't been initialised.");return this._camera}set camera(e){this._camera=e}get raycaster(){if(!this._raycaster)throw new Error("Raycaster hasn't been initialised.");return this._raycaster}set raycaster(e){this._raycaster=e}constructor(){this.meshes=new Set,this.onInitialized=new W,this.onDisposed=new W,this.enabled=!1,this.uiEnabled=!0,this.update=async()=>{if(!this.enabled)return;const e=this._clock.getDelta();await ye.update(this.scene,e),await ye.update(this.renderer,e),await ye.update(this.camera,e),await this.tools.update(e);this.renderer.get().setAnimationLoop(this.update)},this._clock=new e.Clock,this.tools=new Z(this),ye.setupBVH()}async init(){this.enabled=!0,this._clock.start(),this.uiEnabled&&(this._ui=new he(this),await this.ui.init()),await this.update(),await this.onInitialized.trigger(this)}async dispose(){const e=this.tools.get(q);this.enabled=!1,await this.tools.dispose(),await(this._ui?.dispose()),this.onInitialized.reset(),this._clock.stop();for(const t of this.meshes)e.destroy(t);this.meshes.clear(),this._renderer?.isDisposeable()&&await this._renderer.dispose(),this._scene?.isDisposeable()&&await this._scene.dispose(),this._camera?.isDisposeable()&&await this._camera.dispose(),this._raycaster?.isDisposeable()&&await this._raycaster.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}static async update(e,t){e.isUpdateable()&&e.enabled&&await e.update(t)}static setupBVH(){e.BufferGeometry.prototype.computeBoundsTree=g,e.BufferGeometry.prototype.disposeBoundsTree=I,e.Mesh.prototype.raycast=C}}ye.release="1.4.21";class Ae extends j{get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.components.renderer.togglePlane(e,this._plane)}get visible(){return this._visible}set visible(e){this._visible=e,this._controls.visible=e,this._helper.visible=e,this.toggleControls(e)}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(e){this._planeMesh.material=e}get size(){return this._planeMesh.scale.x}set size(e){this._planeMesh.scale.set(e,e,e)}get helper(){return this._helper}constructor(t,s,i,n,o=5,r=!0){super(t),this.name="SimplePlane",this.onDraggingStarted=new W,this.onDraggingEnded=new W,this.onDisposed=new W,this._plane=new e.Plane,this._visible=!0,this._enabled=!0,this._controlsActive=!1,this._arrowBoundBox=new e.Mesh,this._hiddenMaterial=new e.MeshBasicMaterial({visible:!1}),this.update=async()=>{this._enabled&&this._plane.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)},this.changeDrag=e=>{this._visible=!e.value,this.preventCameraMovement(),this.notifyDraggingChanged(e)},this.normal=i,this.origin=s,this.components.renderer.togglePlane(!0,this._plane),this._planeMesh=Ae.newPlaneMesh(o,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this._plane.setFromNormalAndCoplanarPoint(i,s),r&&this.toggleControls(!0)}async setFromNormalAndCoplanarPoint(e,t){this.reset(),this.normal.equals(e)||(this.normal.copy(e),this._helper.lookAt(e)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix(),await this.update()}get(){return this._plane}async dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.components.renderer.togglePlane(!1,this._plane),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.removeFromParent(),this._controls.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new e.Vector3(1,0,0),s=new e.Vector3;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(s),this._helper.position.copy(s),this._helper.updateMatrix()}toggleControls(e){if(e){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=e}newTransformControls(){const e=this.components.camera.get(),t=this.components.renderer.get().domElement,s=new b(e,t);return this.initializeControls(s),this.components.scene.get().add(s),s}initializeControls(e){e.attach(this._helper),e.showX=!1,e.showY=!1,e.setSpace("local"),this.createArrowBoundingBox(),e.children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new e.CylinderGeometry(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(e){e.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.components.camera.enabled=this._visible}newHelper(){const t=new e.Object3D;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.components.scene.get().add(t),t}static newPlaneMesh(t,s){const i=new e.PlaneGeometry(1),n=new e.Mesh(i,s);return n.scale.set(t,t,t),n}}class Fe extends j{get enabled(){return this._enabled}set enabled(e){this._enabled=e;for(const t of this._planes)t.enabled=e;this.updateMaterialsAndPlanes(),this.components.uiEnabled&&(this.uiElement.get("main").active=e)}get visible(){return this._visible}set visible(e){this._visible=e;for(const t of this._planes)t.visible=e}get material(){return this._material}set material(e){this._material=e;for(const t of this._planes)t.planeMaterial=e}get size(){return this._size}set size(e){this._size=e;for(const t of this._planes)t.size=e}constructor(t){super(t),this.onAfterCreate=new W,this.onAfterDelete=new W,this.onBeforeDrag=new W,this.onAfterDrag=new W,this.onBeforeCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.uiElement=new Q,this.orthogonalY=!1,this.toleranceOrthogonalY=.7,this._planes=[],this.onDisposed=new W,this._material=new e.MeshBasicMaterial({color:16776960,side:e.DoubleSide,transparent:!0,opacity:.2}),this._size=5,this._enabled=!1,this._visible=!1,this._onStartDragging=()=>{this.onBeforeDrag.trigger()},this._onEndDragging=()=>{this.onAfterDrag.trigger()},this.components.tools.add(Fe.uuid,this),this.PlaneType=Ae,t.uiEnabled&&this.setUI(t)}endCreation(){}cancelCreation(){}get(){return this._planes}async dispose(){this._enabled=!1;for(const e of this._planes)await e.dispose();this._planes.length=0,this.uiElement.dispose(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),await this.onDisposed.trigger(Fe.uuid),this.onDisposed.reset()}create(){if(!this.enabled)return;const e=this.components.raycaster.castRay();e&&this.createPlaneFromIntersection(e)}createFromNormalAndCoplanarPoint(e,t){const s=this.newPlane(t,e);return this.updateMaterialsAndPlanes(),s}delete(e){this.enabled&&(e||(e=this.pickPlane()),e&&this.deletePlane(e))}deleteAll(){for(;this._planes.length>0;)this.delete(this._planes[0])}deletePlane(e){const t=this._planes.indexOf(e);-1!==t&&(this._planes.splice(t,1),this.components.renderer.togglePlane(!1,e.get()),e.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(e))}setUI(e){const t=new ae(e);t.materialIcon="content_cut",t.onClick.add((()=>{t.active=!t.active,this.enabled=t.active,this.visible=t.active})),this.uiElement.set({main:t})}pickPlane(){const e=this.getAllPlaneMeshes(),t=this.components.raycaster.castRay(e);if(t){const e=t.object;return this._planes.find((t=>t.meshes.includes(e)))}}getAllPlaneMeshes(){const e=[];for(const t of this._planes)e.push(...t.meshes);return e}createPlaneFromIntersection(t){const s=t.point.distanceTo(new e.Vector3(0,0,0)),i=t.face?.normal;if(!s||!i)return;const n=this.getWorldNormal(t,i),o=this.newPlane(t.point,n.negate());this.components.renderer.togglePlane(!0,o.get()),this.updateMaterialsAndPlanes()}getWorldNormal(t,s){const i=t.object;let n=t.object.matrixWorld.clone();if(i instanceof e.InstancedMesh&&void 0!==t.instanceId){const s=new e.Matrix4;i.getMatrixAt(t.instanceId,s),n=s.multiply(n)}const o=(new e.Matrix3).getNormalMatrix(n),r=s.clone().applyMatrix3(o).normalize();return this.normalizePlaneDirectionY(r),r}normalizePlaneDirectionY(e){this.orthogonalY&&(e.y>this.toleranceOrthogonalY&&(e.x=0,e.y=1,e.z=0),e.y<-this.toleranceOrthogonalY&&(e.x=0,e.y=-1,e.z=0))}newPlane(e,t){const s=this.newPlaneInstance(e,t);return s.onDraggingStarted.add(this._onStartDragging),s.onDraggingEnded.add(this._onEndDragging),this._planes.push(s),this.onAfterCreate.trigger(s),s}newPlaneInstance(e,t){return new this.PlaneType(this.components,e,t,this._material)}updateMaterialsAndPlanes(){this.components.renderer.updateClippingPlanes();const e=this.components.renderer.clippingPlanes;for(const t of this.components.meshes)if(Array.isArray(t.material))for(const s of t.material)s.clippingPlanes=e;else t.material.clippingPlanes=e}}async function Re(e,t,s,i,n,o,r){const a=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),await function(e,t,s,i){return new Promise(((n,o)=>{!function r(){const a=e.clientWaitSync(t,s,0);a!==e.WAIT_FAILED?a!==e.TIMEOUT_EXPIRED?n():setTimeout(r,i):o()}()}))}(e,a,0,10),e.deleteSync(a),e.bindBuffer(t,s),e.getBufferSubData(t,i,n,o,r),e.bindBuffer(t,null)}Fe.uuid="66290bc5-18c4-4cd1-9379-2e17a0617611",Z.libraryUUIDs.add(Fe.uuid);class Se extends j{constructor(t,s){super(t),this.onDisposed=new W,this.onViewUpdated=new W,this.enabled=!0,this.needsUpdate=!1,this.renderDebugFrame=!1,this._width=512,this._height=512,this.autoUpdate=!0,this.updateInterval=1e3,this.scene=new e.Scene,this._availableColor=1,this.updateVisibility=async e=>{if(!this.enabled)return;if(!this.needsUpdate&&!e)return;const t=this.components.camera.get();t.updateMatrix(),this.renderer.setSize(this._width,this._height),this.renderer.setRenderTarget(this.renderTarget),this.renderer.render(this.scene,t);const s=this.renderer.getContext();await async function(e,t,s,i,n,o,r,a){const l=e.createBuffer();return e.bindBuffer(e.PIXEL_PACK_BUFFER,l),e.bufferData(e.PIXEL_PACK_BUFFER,a.byteLength,e.STREAM_READ),e.readPixels(t,s,i,n,o,r,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),await Re(e,e.PIXEL_PACK_BUFFER,l,0,a),e.deleteBuffer(l),a}(s,0,0,this._width,this._height,s.RGBA,s.UNSIGNED_BYTE,this._buffer),this.renderer.setRenderTarget(null),this.renderDebugFrame&&this.renderer.render(this.scene,t),this.worker.postMessage({buffer:this._buffer}),this.needsUpdate=!1},this.applySettings(s),this.renderer=new e.WebGLRenderer;const i=this.components.renderer.clippingPlanes;this.renderer.clippingPlanes=i,this.renderTarget=new e.WebGLRenderTarget(this._width,this._height),this.bufferSize=this._width*this._height*4,this._buffer=new Uint8Array(this.bufferSize);const n=new Blob(['\n      addEventListener("message", (event) => {\n        const { buffer } = event.data;\n        const colors = new Map();\n        for (let i = 0; i < buffer.length; i += 4) {\n          const r = buffer[i];\n          const g = buffer[i + 1];\n          const b = buffer[i + 2];\n          const code = "" + r + "-" + g + "-" + b;\n          if(colors.has(code)) {\n            colors.set(code, colors.get(code) + 1);\n          } else {\n            colors.set(code, 1);\n          }\n        }\n        postMessage({ colors });\n      });\n    '],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(n))}get(){return this.renderer}async dispose(){this.enabled=!1;for(const e of this.scene.children)e.removeFromParent();this.onViewUpdated.reset(),this.worker.terminate(),this.renderer.dispose(),this.renderTarget.dispose(),this._buffer=null,this.onDisposed.reset()}getAvailableColor(){let e=BigInt(this._availableColor.toString());const t=[];do{t.unshift(Number(e%256n)),e/=256n}while(e);for(;3!==t.length;)t.unshift(0);const[s,i,n]=t;return{r:s,g:i,b:n,code:`${s}-${i}-${n}`}}increaseColor(){16777216!==this._availableColor?this._availableColor++:console.warn("Color can't be increased over 256 x 256 x 256!")}decreaseColor(){1!==this._availableColor?this._availableColor--:console.warn("Color can't be decreased under 0!")}applySettings(e){e&&(void 0!==e.updateInterval&&(this.updateInterval=e.updateInterval),void 0!==e.height&&(this._height=e.height),void 0!==e.width&&(this._width=e.width),void 0!==e.autoUpdate&&(this.autoUpdate=e.autoUpdate))}}function Me(e){const t={};return e.forEach((e=>{t[e.id]=new Set(e.ids)})),t}function Pe(){const t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","_","$"],s=e.MathUtils.generateUUID(),i=(e=>{const t=[];return e.split("-").map((e=>{const s=e.match(/.{1,2}/g);return s?s.map((e=>t.push(parseInt(e,16)))):null})),t})(s),n=(e=>{const t=[];return e.split("-").map((e=>{const s=e.match(/.{1,2}/g);return s?s.map((e=>t.push(e))):null})),t})(s),o=(e,s,i,n)=>{let o=e;const r=n;let a;for(a=0;a<r;a+=1)s[i+n-a-1]=t[parseInt((o%64).toString(),10)],o/=64;return s},r=(e,t)=>parseInt(e.slice(t,t+2).reduce(((e,t)=>e+t),""),16)>>>0,a=(e,t)=>parseInt(e.slice(t,t+4).reduce(((e,t)=>e+t),""),16)>>>0,l=[];let h,c=[],d=2,u=0;for(l[0]=a(n,0)/16777216,l[1]=a(n,0)%16777216,l[2]=256*r(n,4)+r(n,6)/256>>>0,l[3]=r(n,6)%256*65536+256*i[8]+i[9]>>>0,l[4]=65536*i[10]+256*i[11]+i[12]>>>0,l[5]=65536*i[13]+256*i[14]+i[15]>>>0,h=0;h<6;h++)c=o(l[h],c,u,d),u+=d,d=4;return c.join("")}function Le(t){const s=t.getAttribute("position"),i=s.itemSize,n=s.array,o=[],r=[],a=[];for(let e=0;e<n.length;e+=i){let t=`${n[e]},${n[e+1]}`;const s=n[e+2];t+=i>=3?`,${s}`:",0";const l=n[e+3];if(4===i&&(t+=`,${l}`),-1===r.indexOf(t)){r.push(t),o.push(r.length-1);t.split(",").forEach((e=>a.push(Number(e))))}else{const e=r.indexOf(t);o.push(e)}}const l=new Uint16Array(o),h=new Float32Array(a);t.setAttribute("position",new e.BufferAttribute(h,2===i?3:i)),t.setIndex(new e.BufferAttribute(l,1)),t.getAttribute("position").needsUpdate=!0}function Ne(e,t,s){const i=[e[0]-t[0],e[1]-t[1],e[2]-t[2]];return s[0]*i[0]+s[1]*i[1]+s[2]*i[2]>0}function Oe(e){return e.transparent&&e.opacity<1}class xe extends j{set enabled(e){this._enabled=e,e||(this._pickedPoint=null)}get enabled(){return this._enabled}get config(){return this._config}set config(e){this._config={...this._config,...e}}constructor(e,t){super(e),this.name="LineIntersectionPicker",this.onAfterUpdate=new W,this.onBeforeUpdate=new W,this.onDisposed=new W,this._pickedPoint=null,this._raycaster=new s,this._originVector=new i,this.config={snapDistance:.25,...t},this._raycaster.params.Line&&(this._raycaster.params.Line.threshold=.2),this._mouse=new $(e.renderer.get().domElement);const n=document.createElement("div");n.className="w-[15px] h-[15px] border-3 border-solid border-red-500",this._marker=new m(n),this._marker.visible=!1,this.components.scene.get().add(this._marker),this.enabled=!1}async dispose(){this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this._marker.removeFromParent(),this._marker.element.remove(),await this.onDisposed.trigger(),this.onDisposed.reset()}update(){if(!this.enabled)return;this.onBeforeUpdate.trigger(this),this._raycaster.setFromCamera(this._mouse.position,this.components.camera.get());const e=this.components.meshes.filter((e=>e.isLine)),t=this._raycaster.intersectObjects(e);if(2!==t.length)return this._pickedPoint=null,void this.updateMarker();const s=t[0].object,n=t[1].object,o=[t[0].index,t[1].index],r=(new i).copy(t[0].point).add(t[1].point).multiplyScalar(.5);if(s.uuid===n.uuid){const e=s.geometry.getAttribute("position"),t=(new i).fromBufferAttribute(e,o[0]),n=(new i).fromBufferAttribute(e,o[0]+1),a=(new i).fromBufferAttribute(e,o[1]),l=(new i).fromBufferAttribute(e,o[1]+1),h=this.findIntersection(t,n,a,l);if(!h)return;if(this._pickedPoint=h,this._pickedPoint.distanceTo(r)>.25)return;this.updateMarker()}else{const e=s.geometry.getAttribute("position"),t=n.geometry.getAttribute("position"),a=(new i).fromBufferAttribute(e,o[0]),l=(new i).fromBufferAttribute(e,o[0]+1),h=(new i).fromBufferAttribute(t,o[1]),c=(new i).fromBufferAttribute(t,o[1]+1),d=this.findIntersection(a,l,h,c);if(!d)return;if(this._pickedPoint=d,this._pickedPoint.distanceTo(r)>.25)return;this.updateMarker()}this.onAfterUpdate.trigger(this)}findIntersection(e,t,s,n){const o=t.sub(e),r=n.sub(s),a=(new i).crossVectors(o,r),l=a.lengthSq();if(0===l)return null;const h=s.sub(e),c=(new i).crossVectors(a,h).dot(r)/l;return(new i).addVectors(e,o.multiplyScalar(c))}updateMarker(){this._marker.visible=!!this._pickedPoint,this._marker.position.copy(this._pickedPoint??this._originVector)}get(){return this._pickedPoint}}class De extends j{set visible(e){this._visible=e,this._marker.visible=e}get visible(){return this._visible}constructor(e,t,s){let i;super(e),this.enabled=!0,this._visible=!0,this.onDisposed=new W,t?i=t:(i=document.createElement("div"),i.className="w-[15px] h-[15px] border-3 border-solid border-red-600"),this._marker=new m(i),s?s.add(this._marker):this.components.scene.get().add(this._marker),this.visible=!0}get(){return this._marker}toggleVisibility(){this.visible=!this.visible}async dispose(){this._marker.removeFromParent(),this._marker.element.remove(),await this.onDisposed.trigger(),this.onDisposed.reset()}}class Ue extends j{set enabled(e){this._enabled=e,e||(this._marker.visible=!1,this._pickedPoint=null)}get enabled(){return this._enabled}get _raycaster(){return this._components.raycaster}constructor(e,t){super(e),this.name="VertexPicker",this.afterUpdate=new W,this.beforeUpdate=new W,this._pickedPoint=null,this._enabled=!1,this._workingPlane=null,this.onDisposed=new W,this.update=()=>{if(!this.enabled)return;this.beforeUpdate.trigger(this);const e=this._raycaster.castRay();if(!e)return this._marker.visible=!1,void(this._pickedPoint=null);const t=this.getClosestVertex(e);if(!t)return this._marker.visible=!1,void(this._pickedPoint=null);if(!(!this.workingPlane||Math.abs(this.workingPlane.distanceToPoint(t))<.001))return this._marker.visible=!1,void(this._pickedPoint=null);this._pickedPoint=t,this._marker.visible=!0,this._marker.get().position.set(this._pickedPoint.x,this._pickedPoint.y,this._pickedPoint.z),this.afterUpdate.trigger(this)},this._components=e,this.config={snapDistance:.25,showOnlyVertex:!1,...t},this._marker=new De(e,this.config.previewElement),this._marker.visible=!1,this.setupEvents(!0),this.enabled=!1}set workingPlane(e){this._workingPlane=e}get workingPlane(){return this._workingPlane}set config(e){this._config={...this._config,...e}}get config(){return this._config}async dispose(){this.setupEvents(!1),await this._marker.dispose(),this.afterUpdate.reset(),this.beforeUpdate.reset(),this._components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}get(){return this._pickedPoint}getClosestVertex(t){let s=new e.Vector3,i=!1,n=Number.MAX_SAFE_INTEGER;const o=this.getVertices(t);return o?.forEach((e=>{if(!e)return;const o=t.point.distanceTo(e);o>n||o>this._config.snapDistance||(i=!0,s=e,n=t.point.distanceTo(e))})),i?s:this.config.showOnlyVertex?null:t.point}getVertices(e){const t=e.object;if(!e.face||!t)return null;const s=t.geometry;return[this.getVertex(e.face.a,s),this.getVertex(e.face.b,s),this.getVertex(e.face.c,s)].map((e=>e?.applyMatrix4(t.matrixWorld)))}getVertex(t,s){if(void 0===t)return null;const i=s.attributes.position;return new e.Vector3(i.getX(t),i.getY(t),i.getZ(t))}setupEvents(e){const t=this.components.renderer.get().domElement.parentElement;t&&(e?t.addEventListener("mousemove",this.update):t.removeEventListener("mousemove",this.update))}}class Be extends j{set visible(e){this._visible=e;for(const t of this._markers)t.visible=e}get visible(){return this._visible}constructor(e,t){super(e),this.name="GeometryVerticesMarker",this.enabled=!0,this.onDisposed=new W,this._markers=[],this._visible=!0;const s=t.getAttribute("position");for(let t=0;t<s.count;t++){const i=new De(e);i.get().position.set(s.getX(t),s.getY(t),s.getZ(t)),this._markers.push(i)}}async dispose(){for(const e of this._markers)await e.dispose();this._markers=[],await this.onDisposed.trigger(),this.onDisposed.reset()}get(){return this._markers}}const ke=[2,2,1],Ve=[1,0,0];function Ge(e,t){return 3*e+t}function ze(e){const t=e.elements;let s=0;for(let e=0;e<3;e++){const i=t[Ge(ke[e],Ve[e])];s+=2*i*i}return Math.sqrt(s)}function Ye(e,t){let s=0,i=1;const n=e.elements;for(let e=0;e<3;e++){const t=Math.abs(n[Ge(ke[e],Ve[e])]);t>s&&(s=t,i=e)}let o=1,r=0;const a=Ve[i],l=ke[i];if(Math.abs(n[Ge(l,a)])>Number.EPSILON){const e=(n[Ge(l,l)]-n[Ge(a,a)])/2/n[Ge(l,a)];let t;t=e<0?-1/(-e+Math.sqrt(1+e*e)):1/(e+Math.sqrt(1+e*e)),o=1/Math.sqrt(1+t*t),r=t*o}return t.identity(),t.elements[Ge(a,a)]=o,t.elements[Ge(l,l)]=o,t.elements[Ge(l,a)]=r,t.elements[Ge(a,l)]=-r,t}function He(t,s){let i=0,n=0;s.unitary.identity(),s.diagonal.copy(t);const o=s.unitary,r=s.diagonal,a=new e.Matrix3,l=new e.Matrix3,h=Number.EPSILON*function(e){const t=e.elements;let s=0;for(let e=0;e<9;e++)s+=t[e]*t[e];return Math.sqrt(s)}(r);for(;n<10&&ze(r)>h;)Ye(r,a),l.copy(a).transpose(),r.multiply(a),r.premultiply(l),o.multiply(a),++i>2&&(n++,i=0);return s}function je(t){const s=[];for(let i=0;i<t.length-2;i+=3){const n=t[i],o=t[i+1],r=t[i+2];s.push(new e.Vector3(n,o,r))}const i=new v;i.setFromPoints(s);const n={unitary:new e.Matrix3,diagonal:new e.Matrix3},o=i.faces,r=[],a=[];for(let e=0,t=o.length;e<t;e++){const t=o[e];let s=t.edge;r.length=0;do{r.push(s),s=s.next}while(s!==t.edge);for(let e=1,t=r.length-2;e<=t;e++){const t=r[0].vertex,s=r[e+0].vertex,i=r[e+1].vertex;a.push(t.point.x,t.point.y,t.point.z),a.push(s.point.x,s.point.y,s.point.z),a.push(i.point.x,i.point.y,i.point.z)}}const l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new e.Vector3,u=new e.Vector3,p=new e.Vector3,m=new e.Vector3,E=new e.Vector3;let g=0,I=0,C=0,f=0,w=0,T=0,b=0;for(let e=0,t=a.length;e<t;e+=9){l.fromArray(a,e),h.fromArray(a,e+3),c.fromArray(a,e+6),m.set(0,0,0),m.add(l).add(h).add(c).divideScalar(3),d.subVectors(h,l),u.subVectors(c,l);const t=p.crossVectors(d,u).length()/2;E.add(p.copy(m).multiplyScalar(t)),g+=t,I+=(9*m.x*m.x+l.x*l.x+h.x*h.x+c.x*c.x)*(t/12),C+=(9*m.x*m.y+l.x*l.y+h.x*h.y+c.x*c.y)*(t/12),f+=(9*m.x*m.z+l.x*l.z+h.x*h.z+c.x*c.z)*(t/12),w+=(9*m.y*m.y+l.y*l.y+h.y*h.y+c.y*c.y)*(t/12),T+=(9*m.y*m.z+l.y*l.z+h.y*h.z+c.y*c.z)*(t/12),b+=(9*m.z*m.z+l.z*l.z+h.z*h.z+c.z*c.z)*(t/12)}E.divideScalar(g),I/=g,C/=g,f/=g,w/=g,T/=g,b/=g,I-=E.x*E.x,C-=E.x*E.y,f-=E.x*E.z,w-=E.y*E.y,T-=E.y*E.z,b-=E.z*E.z;const _=new e.Matrix3;_.elements[0]=I,_.elements[1]=C,_.elements[2]=f,_.elements[3]=C,_.elements[4]=w,_.elements[5]=T,_.elements[6]=f,_.elements[7]=T,_.elements[8]=b,He(_,n);const y=n.unitary,A=new e.Vector3,F=new e.Vector3,R=new e.Vector3;y.extractBasis(A,F,R);let S=-1/0,M=-1/0,P=-1/0,L=1/0,N=1/0,O=1/0;for(let e=0,t=s.length;e<t;e++){const t=s[e];S=Math.max(A.dot(t),S),M=Math.max(F.dot(t),M),P=Math.max(R.dot(t),P),L=Math.min(A.dot(t),L),N=Math.min(F.dot(t),N),O=Math.min(R.dot(t),O)}A.multiplyScalar(.5*(L+S)),F.multiplyScalar(.5*(N+M)),R.multiplyScalar(.5*(O+P));const x=new e.Vector3,D=new e.Vector3,U=new e.Matrix3;x.add(A).add(F).add(R),D.x=S-L,D.y=M-N,D.z=P-O,D.multiplyScalar(.5),U.copy(y);const{x:B,y:k,z:V}=D,G=new e.Matrix4;G.makeScale(2*B,2*k,2*V);const z=new e.Matrix4;z.makeTranslation(-B,-k,-V);const Y=new e.Matrix4;Y.makeTranslation(x.x,x.y,x.z);const H=new e.Matrix4;H.setFromMatrix3(U);const j=new e.Matrix4;return j.multiply(Y),j.multiply(H),j.multiply(z),j.multiply(G),{center:x,halfSizes:D,rotation:U,transformation:j}}class We extends Se{constructor(t,s){super(t,s),this.threshold=100,this.onViewUpdated=new W,this.colorMeshes=new Map,this.isProcessing=!1,this._colorCodeMeshMap=new Map,this._meshIDColorCodeMap=new Map,this._currentVisibleMeshes=new Set,this._recentlyHiddenMeshes=new Set,this._transparentMat=new e.MeshBasicMaterial({transparent:!0,opacity:0}),this.handleWorkerMessage=async e=>{if(this.isProcessing)return;const t=e.data.colors;this._recentlyHiddenMeshes=new Set(this._currentVisibleMeshes),this._currentVisibleMeshes.clear();for(const[e,s]of t){if(s<this.threshold)continue;const t=this._colorCodeMeshMap.get(e);t&&(this._currentVisibleMeshes.add(t),this._recentlyHiddenMeshes.delete(t))}this.onViewUpdated.trigger({seen:this._currentVisibleMeshes,unseen:this._recentlyHiddenMeshes})},this.worker.addEventListener("message",this.handleWorkerMessage),this.autoUpdate&&window.setInterval((async()=>{this.isProcessing||await this.updateVisibility()}),this.updateInterval)}async dispose(){await super.dispose(),this._currentVisibleMeshes.clear(),this._recentlyHiddenMeshes.clear(),this._meshIDColorCodeMap.clear(),this._transparentMat.dispose(),this._colorCodeMeshMap.clear();const e=this.components.tools.get(q);for(const t in this.colorMeshes){const s=this.colorMeshes.get(t);s&&e.destroy(s,!0)}this.colorMeshes.clear()}add(t){if(!this.enabled)return;if(this.isProcessing)return void console.log("Culler processing not finished yet.");this.isProcessing=!0;const s=t instanceof e.InstancedMesh,{geometry:i,material:n}=t,{colorMaterial:o,code:r}=this.getAvailableMaterial();let a;if(Array.isArray(n)){let e=!0;const t=[];for(const s of n)Oe(s)?t.push(this._transparentMat):(e=!1,t.push(o));if(e)return o.dispose(),void(this.isProcessing=!1);a=t}else{if(Oe(n))return o.dispose(),void(this.isProcessing=!1);a=o}this._colorCodeMeshMap.set(r,t),this._meshIDColorCodeMap.set(t.uuid,r);const l=s?t.count:1,h=new e.InstancedMesh(i,a,l);s?h.instanceMatrix=t.instanceMatrix:h.setMatrixAt(0,new e.Matrix4),t.visible=!1,h.applyMatrix4(t.matrix),h.updateMatrix(),this.scene.add(h),this.colorMeshes.set(t.uuid,h),this.increaseColor(),this.isProcessing=!1}remove(e){if(this.isProcessing)return void console.log("Culler processing not finished yet.");this.isProcessing=!0;const t=this.components.tools.get(q);this._currentVisibleMeshes.delete(e),this._recentlyHiddenMeshes.delete(e);const s=this.colorMeshes.get(e.uuid),i=this._meshIDColorCodeMap.get(e.uuid);if(!s||!i)return this.isProcessing=!1,void console.log(e.visible);this._colorCodeMeshMap.delete(i),this._meshIDColorCodeMap.delete(e.uuid),this.colorMeshes.delete(e.uuid),s.geometry=void 0,s.material=[],t.destroy(s,!0),this._recentlyHiddenMeshes.delete(e),this._currentVisibleMeshes.delete(e),this.isProcessing=!1}getAvailableMaterial(){const{r:t,g:s,b:i,code:n}=this.getAvailableColor(),o=e.ColorManagement.enabled;e.ColorManagement.enabled=!1;const r=new e.Color(`rgb(${t}, ${s}, ${i})`),a=this.components.renderer.clippingPlanes,l=new e.MeshBasicMaterial({color:r,clippingPlanes:a,side:e.DoubleSide});return e.ColorManagement.enabled=o,{colorMaterial:l,code:n}}}class Xe extends j{get enabled(){return!!this._elements&&this.elements.enabled}set enabled(e){this._elements&&(this.elements.enabled=e)}get onViewUpdated(){return this.elements.onViewUpdated}get needsUpdate(){return this.elements.needsUpdate}set needsUpdate(e){this.elements.needsUpdate=e}get renderDebugFrame(){return this.elements.renderDebugFrame}set renderDebugFrame(e){this.elements.renderDebugFrame=e}get elements(){if(!this._elements)throw new Error("Elements not initialized! Call ScreenCuller.setup() first");return this._elements}get renderer(){return this.elements.get()}constructor(e){super(e),this.config={updateInterval:1e3,width:512,height:512,autoUpdate:!0},this.isSetup=!1,this.onDisposed=new W,this.onSetup=new W,this.updateVisibility=async e=>{await this.elements.updateVisibility(e)},e.tools.add(Xe.uuid,this)}async setup(e){this._elements=new We(this.components,e),this.elements.onViewUpdated.add((({seen:e,unseen:t})=>{for(const t of e)t.visible=!0;for(const e of t)e.visible=!1})),this.isSetup=!0,await this.onSetup.trigger(this)}get(){return this.elements.colorMeshes}async dispose(){this.enabled=!1,await this.elements.dispose(),await this.onDisposed.trigger(Xe.uuid),this.onDisposed.reset()}add(e){this.elements.add(e)}}Xe.uuid="69f2a50d-c266-44fc-b1bd-fa4d34be89e6",Z.libraryUUIDs.add(Xe.uuid);class $e extends j{get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.resize(),this._undoList=[],this.components.uiEnabled&&(this.uiElement.get("toolbar").visible=e),e?this._viewport.classList.remove("pointer-events-none"):(this.clear(),this.uiElement.get("settingsWindow").visible=!1,this._viewport.classList.add("pointer-events-none"))}constructor(e){super(e),this.uiElement=new Q,this.isSetup=!1,this.id=d().toLowerCase(),this._enabled=!1,this.onDisposed=new W,this._viewport=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._size=new t,this._undoList=[],this.config={fillColor:"transparent",strokeColor:"#BCF124",strokeWidth:4},this.onSetup=new W,this.onResize=()=>{this.resize()},this._viewport.classList.add("absolute","top-0","right-0"),this._viewport.setAttribute("width","100%"),this._viewport.setAttribute("height","100%"),e.uiEnabled&&this.setUI(),this.enabled=!1,this.components.ui.viewerContainer.append(this._viewport),this.setupEvents(!0)}async setup(e){this.config={...this.config,...e},this.isSetup=!0,await this.onSetup.trigger(this)}async dispose(){this._undoList=[],await this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}get(){return this._viewport}clear(){const e=this.get();for(this._undoList=[];e.firstChild;)e.removeChild(e.firstChild)}getDrawing(){return this.get().childNodes}resize(){const e=this.components.renderer.getSize(),t=this.enabled?e.x:0,s=this.enabled?e.y:0;this._size.set(t,s)}getSize(){return this._size}setupEvents(e){e?window.addEventListener("resize",this.onResize):window.removeEventListener("resize",this.onResize)}setUI(){const e=new ae(this.components,{materialIconName:"undo"});e.onClick.add((()=>{this._viewport.lastChild&&(this._undoList.push(this._viewport.lastChild),this._viewport.lastChild.remove())}));const t=new ae(this.components,{materialIconName:"redo"});t.onClick.add((()=>{const e=this._undoList[this._undoList.length-1];e&&(this._undoList.pop(),this._viewport.append(e))}));const s=new ae(this.components,{materialIconName:"delete"});s.onClick.add((()=>this.clear()));const i=new de(this.components,this.id);i.title="Drawing Settings",i.visible=!1,this.components.ui.add(i);const n=new ge(this.components);n.label="Stroke Width",n.min=2,n.max=6,n.value=4,n.onChange.add((e=>{this.config.strokeWidth=e}));const o=new Ee(this.components);o.label="Stroke Color",o.value=this.config.strokeColor,o.onChange.add((e=>{this.config.strokeColor=e}));const r=new Ee(this.components);r.label="Fill Color",r.value=this.config.fillColor,r.onChange.add((e=>{this.config.fillColor=e})),i.addChild(o,r,n);const a=new ae(this.components,{materialIconName:"settings"});a.onClick.add((()=>{i.visible=!i.visible,a.active=i.visible})),i.onHidden.add((()=>a.active=!1));const l=new re(this.components,{position:"top"});l.addChild(a,e,t,s),this.uiElement.set({toolbar:l,settingsWindow:i})}}class Ke extends j{constructor(e){super(e),this.enabled=!0,this._originalBackground=null,this.onDisposed=new W,this._originals={},this._list={},this.components.tools.add(Ke.uuid,this)}get(){return Object.keys(this._list)}set(t,s=Object.keys(this._list)){for(const i of s){const{material:s,meshes:n}=this._list[i];for(const i of n)if(t)this._originals[i.uuid]||(this._originals[i.uuid]={material:i.material}),i instanceof e.InstancedMesh&&i.instanceColor&&(this._originals[i.uuid].instances=i.instanceColor,i.instanceColor=null),i.material=s;else{if(!this._originals[i.uuid])continue;i.material=this._originals[i.uuid].material;const t=this._originals[i.uuid].instances;i instanceof e.InstancedMesh&&t&&(i.instanceColor=t)}}}async dispose(){for(const e in this._list){const{material:t}=this._list[e];t.dispose()}this._list={},this._originals={},await this.onDisposed.trigger(Ke.uuid),this.onDisposed.reset()}setBackgroundColor(e){const t=this.components.scene.get();this._originalBackground||(this._originalBackground=t.background),this._originalBackground&&(t.background=e)}resetBackgroundColor(){const e=this.components.scene.get();this._originalBackground&&(e.background=this._originalBackground)}addMaterial(e,t){if(this._list[e])throw new Error("This ID already exists!");this._list[e]={material:t,meshes:new Set}}addMeshes(e,t){if(!this._list[e])throw new Error("This ID doesn't exists!");for(const s of t)this._list[e].meshes.add(s)}removeMeshes(e,t){if(!this._list[e])throw new Error("This ID doesn't exists!");for(const s of t)this._list[e].meshes.delete(s)}}Ke.uuid="24989d27-fa2f-4797-8b08-35918f74e502",Z.libraryUUIDs.add(Ke.uuid);class Qe{get projection(){return this._currentProjection}constructor(e,t){this.components=e,this._previousDistance=-1,this.matchOrthoDistanceEnabled=!1,this._camera=t;const s="Perspective";this._currentCamera=t.get(s),this._currentProjection=s}async setProjection(e){this.projection!==e&&("Orthographic"===e?this.setOrthoCamera():await this.setPerspectiveCamera(),await this.updateActiveCamera())}setOrthoCamera(){if("FirstPerson"===this._camera.currentMode.id)return;this._previousDistance=this._camera.controls.distance,this._camera.controls.distance=200;const{width:e,height:t}=this.getDims();this.setupOrthoCamera(t,e),this._currentCamera=this._camera.get("Orthographic"),this._currentProjection="Orthographic"}async updateActiveCamera(){await new Promise((e=>{setTimeout((()=>{this._camera.activeCamera=this._currentCamera,e()}),50)}))}getDims(){const t=new e.Vector3;this._camera.get("Perspective").getWorldDirection(t);const s=new e.Vector3;this._camera.controls.getTarget(s);const i=s.clone().sub(this._camera.get("Perspective").position).dot(t),n=this.components.renderer.getSize(),o=n.x/n.y,r=this._camera.get("Perspective"),a=2*i*Math.atan(r.fov*(Math.PI/180)/2);return{width:a*o,height:a}}setupOrthoCamera(e,t){this._camera.controls.mouseButtons.wheel=E.ACTION.ZOOM,this._camera.controls.mouseButtons.middle=E.ACTION.ZOOM;const s=this._camera.get("Perspective"),i=this._camera.get("Orthographic");i.zoom=1,i.left=t/-2,i.right=t/2,i.top=e/2,i.bottom=e/-2,i.updateProjectionMatrix(),i.position.copy(s.position),i.quaternion.copy(s.quaternion),this._camera.controls.camera=i}getDistance(){const e=this._camera.get("Perspective"),t=this._camera.get("Orthographic");return(t.top-t.bottom)/t.zoom/(2*Math.atan(e.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._camera.controls.mouseButtons.wheel=E.ACTION.DOLLY,this._camera.controls.mouseButtons.middle=E.ACTION.DOLLY;const e=this._camera.get("Perspective"),t=this._camera.get("Orthographic");e.position.copy(t.position),e.quaternion.copy(t.quaternion),this._camera.controls.mouseButtons.wheel=E.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._camera.controls.distance=this.getDistance():this._camera.controls.distance=this._previousDistance,await this._camera.controls.zoomTo(1),e.updateProjectionMatrix(),this._camera.controls.camera=e,this._currentCamera=e,this._currentProjection="Perspective"}}class Ze{constructor(e){this.camera=e,this.enabled=!0,this.id="Orbit",this.projectionChanged=new W,this.activateOrbitControls()}toggle(e){this.enabled=e,e&&this.activateOrbitControls()}activateOrbitControls(){const t=this.camera.controls;t.minDistance=1,t.maxDistance=300;const s=new e.Vector3;t.getPosition(s);const i=s.length();t.distance=i,t.truckSpeed=2;const{rotation:n}=this.camera.get(),o=new e.Vector3(0,0,-1).applyEuler(n),r=s.addScaledVector(o,i);t.moveTo(r.x,r.y,r.z)}}class qe{constructor(e){this.camera=e,this.enabled=!1,this.id="FirstPerson",this.projectionChanged=new W}toggle(e){if(this.enabled=e,e){if("Perspective"!==this.camera.getProjection())return void this.camera.setNavigationMode("Orbit");this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const t=this.camera.controls,s=new e.Vector3;t.distance--,t.getPosition(s),t.minDistance=1,t.maxDistance=1,t.distance=1,t.moveTo(s.x,s.y,s.z),t.truckSpeed=50,t.mouseButtons.wheel=E.ACTION.DOLLY,t.touches.two=E.ACTION.TOUCH_ZOOM_TRUCK}}class Je{constructor(e){this.camera=e,this.enabled=!1,this.id="Plan",this.projectionChanged=new W,this.mouseInitialized=!1,this.defaultAzimuthSpeed=e.controls.azimuthRotateSpeed,this.defaultPolarSpeed=e.controls.polarRotateSpeed}toggle(e){this.enabled=e;const t=this.camera.controls;t.azimuthRotateSpeed=e?0:this.defaultAzimuthSpeed,t.polarRotateSpeed=e?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=t.touches.one,this.mouseAction2=t.touches.two,this.mouseInitialized=!0),e?(t.mouseButtons.left=E.ACTION.TRUCK,t.touches.one=E.ACTION.TOUCH_TRUCK,t.touches.two=E.ACTION.TOUCH_ZOOM):(t.mouseButtons.left=E.ACTION.ROTATE,t.touches.one=this.mouseAction1,t.touches.two=this.mouseAction2)}}class et extends te{constructor(e){super(e),this.projectionChanged=new W,this._userInputButtons={},this._frustumSize=50,this._navigationModes=new Map,this.uiElement=new Q,this._orthoCamera=this.newOrthoCamera(),this._navigationModes.set("Orbit",new Ze(this)),this._navigationModes.set("FirstPerson",new qe(this)),this._navigationModes.set("Plan",new Je(this)),this.currentMode=this._navigationModes.get("Orbit"),this.currentMode.toggle(!0,{preventTargetAdjustment:!0}),this.toggleEvents(!0),this._projectionManager=new Qe(e,this),e.onInitialized.add((()=>{e.uiEnabled&&this.setUI()})),this.onAspectUpdated.add((()=>this.setOrthoCameraAspect()))}setUI(){const t=new ae(this.components);t.materialIcon="video_camera_back",t.tooltip="Camera";const s=new ae(this.components,{materialIconName:"camera",name:"Projection"}),i=new ae(this.components,{name:"Perspective"});i.active=!0,i.onClick.add((()=>this.setProjection("Perspective")));const n=new ae(this.components,{name:"Orthographic"});n.onClick.add((()=>this.setProjection("Orthographic"))),s.addChild(i,n);const o=new ae(this.components,{materialIconName:"open_with",name:"Navigation"}),r=new ae(this.components,{name:"Orbit Around"});r.onClick.add((()=>this.setNavigationMode("Orbit")));const a=new ae(this.components,{name:"Plan View"});a.onClick.add((()=>this.setNavigationMode("Plan")));const l=new ae(this.components,{name:"First person"});l.onClick.add((()=>this.setNavigationMode("FirstPerson"))),o.addChild(r,a,l),t.addChild(o,s),this.projectionChanged.add((t=>{t instanceof e.PerspectiveCamera?(i.active=!0,n.active=!1):(i.active=!1,n.active=!0)})),this.uiElement.set({main:t})}async dispose(){await super.dispose(),this.toggleEvents(!1),this._orthoCamera.removeFromParent()}get(e){return e?"Orthographic"===e?this._orthoCamera:this._perspectiveCamera:this.activeCamera}getProjection(){return this._projectionManager.projection}set matchOrthoDistanceEnabled(e){this._projectionManager.matchOrthoDistanceEnabled=e}async toggleProjection(){const e="Perspective"===this.getProjection()?"Orthographic":"Perspective";await this.setProjection(e)}async setProjection(e){await this._projectionManager.setProjection(e),await this.projectionChanged.trigger(this.activeCamera)}toggleUserInput(e){e?this.enableUserInput():this.disableUserInput()}setNavigationMode(e){if(this.currentMode.id!==e){if(this.currentMode.toggle(!1),!this._navigationModes.has(e))throw new Error("The specified mode does not exist!");this.currentMode=this._navigationModes.get(e),this.currentMode.toggle(!0)}}async fit(t=this.components.meshes,s=1.5){if(!this.enabled)return;const i=Number.MAX_VALUE,n=Number.MIN_VALUE,o=new e.Vector3(i,i,i),r=new e.Vector3(n,n,n);for(const s of t){const t=(new e.Box3).setFromObject(s);t.min.x<o.x&&(o.x=t.min.x),t.min.y<o.y&&(o.y=t.min.y),t.min.z<o.z&&(o.z=t.min.z),t.max.x>r.x&&(r.x=t.max.x),t.max.y>r.y&&(r.y=t.max.y),t.max.z>r.z&&(r.z=t.max.z)}const a=new e.Box3(o,r),l=new e.Vector3;a.getSize(l);const h=new e.Vector3;a.getCenter(h);const c=Math.max(l.x,l.y,l.z)*s,d=new e.Sphere(h,c);await this.controls.fitToSphere(d,!0)}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){0!==Object.keys(this._userInputButtons).length&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=this.components.renderer.getSize(),s=t.x/t.y;return new e.OrthographicCamera(this._frustumSize*s/-2,this._frustumSize*s/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoCameraAspect(){const e=this.components.renderer.getSize(),t=e.x/e.y;this._orthoCamera.left=-this._frustumSize*t/2,this._orthoCamera.right=this._frustumSize*t/2,this._orthoCamera.top=this._frustumSize/2,this._orthoCamera.bottom=-this._frustumSize/2,this._orthoCamera.updateProjectionMatrix()}toggleEvents(e){const t=Object.values(this._navigationModes);for(const s of t)e?s.projectionChanged.on(this.projectionChanged.trigger):s.projectionChanged.reset()}}class tt extends S{get lineColor(){return this._lineColor}set lineColor(e){this._lineColor=e;this.fsQuad.material.uniforms.lineColor.value.set(e)}get tolerance(){return this._tolerance}set tolerance(e){this._tolerance=e;this.fsQuad.material.uniforms.tolerance.value=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;this.fsQuad.material.uniforms.opacity.value=e}get glossEnabled(){return this._glossEnabled}set glossEnabled(e){if(e===this._glossEnabled)return;this._glossEnabled=e;this.fsQuad.material.uniforms.glossEnabled.value=e?1:0}get glossExponent(){return this._glossExponent}set glossExponent(e){this._glossExponent=e;this.fsQuad.material.uniforms.glossExponent.value=e}get minGloss(){return this._minGloss}set minGloss(e){this._minGloss=e;this.fsQuad.material.uniforms.minGloss.value=e}get maxGloss(){return(new e.MeshBasicMaterial).color.convertLinearToSRGB(),this._maxGloss}set maxGloss(e){this._maxGloss=e;this.fsQuad.material.uniforms.maxGloss.value=e}get outlineEnabled(){return this._outlineEnabled}set outlineEnabled(e){if(e===this._outlineEnabled)return;this._outlineEnabled=e;this.fsQuad.material.uniforms.outlineEnabled.value=e?1:0}constructor(t,s,i,n){super(),this.excludedMeshes=[],this.outlinedMeshes={},this._outlineScene=new e.Scene,this._outlineEnabled=!1,this._lineColor=10066329,this._opacity=.4,this._tolerance=3,this._glossEnabled=!0,this._glossExponent=1.9,this._minGloss=-.1,this._maxGloss=.1,this._outlinesNeedsUpdate=!1,this.components=s,this.renderScene=i,this.renderCamera=n,this.resolution=new e.Vector2(t.x,t.y),this.fsQuad=new M,this.fsQuad.material=this.createOutlinePostProcessMaterial(),this.planeBuffer=this.newRenderTarget(),this.glossBuffer=this.newRenderTarget(),this.outlineBuffer=this.newRenderTarget();const o=new e.ShaderMaterial({side:2,clipping:!0,uniforms:{},vertexShader:"\n    varying vec4 vColor;\n    \n    #include <clipping_planes_pars_vertex>\n  \n    void main() {\n       #include <begin_vertex>\n    \n       vec4 absPosition = vec4(position, 1.0);\n       vec3 trueNormal = normal;\n       \n       #ifdef USE_INSTANCING\n          absPosition = instanceMatrix * absPosition;\n          trueNormal = (instanceMatrix * vec4(normal, 0.)).xyz;\n       #endif\n       \n       absPosition = modelMatrix * absPosition;\n       trueNormal = (normalize(modelMatrix * vec4(trueNormal, 0.))).xyz;\n       \n       vec3 planePosition = absPosition.xyz / 40.;\n       float d = abs(dot(trueNormal, planePosition));\n       vColor = vec4(abs(trueNormal), d);\n       gl_Position = projectionMatrix * viewMatrix * absPosition;\n       \n       #include <project_vertex>\n       #include <clipping_planes_vertex>\n    }\n    ",fragmentShader:"\n    varying vec4 vColor;\n    \n    #include <clipping_planes_pars_fragment>\n  \n    void main() {\n      #include <clipping_planes_fragment>\n      gl_FragColor = vColor;\n    }\n    "});o.clippingPlanes=s.renderer.clippingPlanes,this.normalOverrideMaterial=o;const r=new e.ShaderMaterial({side:2,clipping:!0,uniforms:{},vertexShader:"\n    varying vec3 vCameraPosition;\n    varying vec3 vPosition;\n    varying vec3 vNormal;\n    \n    #include <clipping_planes_pars_vertex>\n  \n    void main() {\n       #include <begin_vertex>\n       \n       vec4 absPosition = vec4(position, 1.0);\n       vNormal = normal;\n       \n       #ifdef USE_INSTANCING\n          absPosition = instanceMatrix * absPosition;\n          vNormal = (instanceMatrix * vec4(normal, 0.)).xyz;\n       #endif\n       \n       absPosition = modelMatrix * absPosition;\n       vNormal = (normalize(modelMatrix * vec4(vNormal, 0.))).xyz;\n       \n       gl_Position = projectionMatrix * viewMatrix * absPosition;\n       \n       vCameraPosition = cameraPosition;\n       vPosition = absPosition.xyz;\n       \n       #include <project_vertex>\n       #include <clipping_planes_vertex>\n    }\n    ",fragmentShader:"\n    varying vec3 vCameraPosition;\n    varying vec3 vPosition;\n    varying vec3 vNormal;\n    \n    #include <clipping_planes_pars_fragment>\n  \n    void main() {\n      #include <clipping_planes_fragment>\n      vec3 cameraPixelVec = normalize(vCameraPosition - vPosition);\n      float difference = abs(dot(vNormal, cameraPixelVec));\n      \n      // This achieves a double gloss effect: when the surface is perpendicular and when it's parallel\n      difference = abs((difference * 2.) - 1.);\n      \n      gl_FragColor = vec4(difference, difference, difference, 1.);\n    }\n    "});r.clippingPlanes=s.renderer.clippingPlanes,this.glossOverrideMaterial=r}async dispose(){this.planeBuffer.dispose(),this.glossBuffer.dispose(),this.outlineBuffer.dispose(),this.normalOverrideMaterial.dispose(),this.glossOverrideMaterial.dispose(),this.fsQuad.dispose(),this.excludedMeshes=[],this._outlineScene.children=[];const e=await this.components.tools.get(q);for(const t in this.outlinedMeshes){const s=this.outlinedMeshes[t];for(const t of s.meshes)e.destroy(t,!0,!0);s.material.dispose()}}setSize(e,t){this.planeBuffer.setSize(e,t),this.glossBuffer.setSize(e,t),this.outlineBuffer.setSize(e,t),this.resolution.set(e,t);this.fsQuad.material.uniforms.screenSize.value.set(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}render(t,s,i){const n=s.depthBuffer;s.depthBuffer=!1;const o=this.renderScene.overrideMaterial,r=this.renderScene.background;this.renderScene.background=null;for(const e of this.excludedMeshes)e.visible=!1;if(t.setRenderTarget(this.planeBuffer),this.renderScene.overrideMaterial=this.normalOverrideMaterial,t.render(this.renderScene,this.renderCamera),this._glossEnabled&&(t.setRenderTarget(this.glossBuffer),this.renderScene.overrideMaterial=this.glossOverrideMaterial,t.render(this.renderScene,this.renderCamera)),this.renderScene.overrideMaterial=o,this._outlineEnabled){let s=!1;for(const t in this.outlinedMeshes){const i=this.outlinedMeshes[t];for(const t of i.meshes)s=!0,t.userData.materialPreOutline=t.material,t.material=i.material,t.userData.groupsPreOutline=t.geometry.groups,t.geometry.groups=[],t instanceof e.InstancedMesh&&(t.userData.colorPreOutline=t.instanceColor,t.instanceColor=null),t.userData.parentPreOutline=t.parent,this._outlineScene.add(t)}(s||this._outlinesNeedsUpdate)&&(t.setRenderTarget(this.outlineBuffer),t.render(this._outlineScene,this.renderCamera),this._outlinesNeedsUpdate=s);for(const t in this.outlinedMeshes){const s=this.outlinedMeshes[t];for(const t of s.meshes)t.material=t.userData.materialPreOutline,t.geometry.groups=t.userData.groupsPreOutline,t instanceof e.InstancedMesh&&(t.instanceColor=t.userData.colorPreOutline),t.userData.parentPreOutline&&t.userData.parentPreOutline.add(t),t.userData.materialPreOutline=void 0,t.userData.groupsPreOutline=void 0,t.userData.colorPreOutline=void 0,t.userData.parentPreOutline=void 0}}for(const e of this.excludedMeshes)e.visible=!0;this.renderScene.background=r;const a=this.fsQuad.material;a.uniforms.planeBuffer.value=this.planeBuffer.texture,a.uniforms.glossBuffer.value=this.glossBuffer.texture,a.uniforms.outlineBuffer.value=this.outlineBuffer.texture,a.uniforms.sceneColorBuffer.value=i.texture,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(s),this.fsQuad.render(t)),s.depthBuffer=n}get vertexShader(){return"\n\t  varying vec2 vUv;\n\t  void main() {\n\t  \tvUv = uv;\n\t  \tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t  }\n\t"}get fragmentShader(){return"\n\t  uniform sampler2D sceneColorBuffer;\n\t  uniform sampler2D planeBuffer;\n\t  uniform sampler2D glossBuffer;\n\t  uniform sampler2D outlineBuffer;\n\t  uniform vec4 screenSize;\n\t  uniform vec3 lineColor;\n\t  \n\t  uniform float outlineEnabled;\n\t  \n      uniform int width;\n\t  uniform float opacity;\n      uniform float tolerance;\n      uniform float glossExponent;\n      uniform float minGloss;\n      uniform float maxGloss;\n      uniform float glossEnabled;\n\n\t  varying vec2 vUv;\n\n\t  vec4 getValue(sampler2D buffer, int x, int y) {\n\t  \treturn texture2D(buffer, vUv + screenSize.zw * vec2(x, y));\n\t  }\n\n      float normalDiff(vec3 normal1, vec3 normal2) {\n        return ((dot(normal1, normal2) - 1.) * -1.) / 2.;\n      }\n\n      // Returns 0 if it's background, 1 if it's not\n      float getIsBackground(vec3 normal) {\n        float background = 1.0;\n        background *= step(normal.x, 0.);\n        background *= step(normal.y, 0.);\n        background *= step(normal.z, 0.);\n        background = (background - 1.) * -1.;\n        return background;\n      }\n\n\t  void main() {\n\t  \n\t    vec4 sceneColor = getValue(sceneColorBuffer, 0, 0);\n\t    vec3 normSceneColor = normalize(sceneColor.rgb);\n  \n        vec4 plane = getValue(planeBuffer, 0, 0);\n\t    vec3 normal = plane.xyz;\n        float distance = plane.w;\n  \n        vec3 normalTop = getValue(planeBuffer, 0, width).rgb;\n        vec3 normalBottom = getValue(planeBuffer, 0, -width).rgb;\n        vec3 normalRight = getValue(planeBuffer, width, 0).rgb;\n        vec3 normalLeft = getValue(planeBuffer, -width, 0).rgb;\n        vec3 normalTopRight = getValue(planeBuffer, width, width).rgb;\n        vec3 normalTopLeft = getValue(planeBuffer, -width, width).rgb;\n        vec3 normalBottomRight = getValue(planeBuffer, width, -width).rgb;\n        vec3 normalBottomLeft = getValue(planeBuffer, -width, -width).rgb;\n  \n        float distanceTop = getValue(planeBuffer, 0, width).a;\n        float distanceBottom = getValue(planeBuffer, 0, -width).a;\n        float distanceRight = getValue(planeBuffer, width, 0).a;\n        float distanceLeft = getValue(planeBuffer, -width, 0).a;\n        float distanceTopRight = getValue(planeBuffer, width, width).a;\n        float distanceTopLeft = getValue(planeBuffer, -width, width).a;\n        float distanceBottomRight = getValue(planeBuffer, width, -width).a;\n        float distanceBottomLeft = getValue(planeBuffer, -width, -width).a;\n        \n        vec3 sceneColorTop = normalize(getValue(sceneColorBuffer, 1, 0).rgb);\n        vec3 sceneColorBottom = normalize(getValue(sceneColorBuffer, -1, 0).rgb);\n        vec3 sceneColorLeft = normalize(getValue(sceneColorBuffer, 0, -1).rgb);\n        vec3 sceneColorRight = normalize(getValue(sceneColorBuffer, 0, 1).rgb);\n        vec3 sceneColorTopRight = normalize(getValue(sceneColorBuffer, 1, 1).rgb);\n        vec3 sceneColorBottomRight = normalize(getValue(sceneColorBuffer, -1, 1).rgb);\n        vec3 sceneColorTopLeft = normalize(getValue(sceneColorBuffer, 1, 1).rgb);\n        vec3 sceneColorBottomLeft = normalize(getValue(sceneColorBuffer, -1, 1).rgb);\n\n        // Checks if the planes of this texel and the neighbour texels are different\n\n        float planeDiff = 0.0;\n\n        planeDiff += step(0.001, normalDiff(normal, normalTop));\n        planeDiff += step(0.001, normalDiff(normal, normalBottom));\n        planeDiff += step(0.001, normalDiff(normal, normalLeft));\n        planeDiff += step(0.001, normalDiff(normal, normalRight));\n        planeDiff += step(0.001, normalDiff(normal, normalTopRight));\n        planeDiff += step(0.001, normalDiff(normal, normalTopLeft));\n        planeDiff += step(0.001, normalDiff(normal, normalBottomRight));\n        planeDiff += step(0.001, normalDiff(normal, normalBottomLeft));\n        \n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorTop));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorBottom));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorLeft));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorRight));\n       \tplaneDiff += step(0.001, normalDiff(normSceneColor, sceneColorTopRight));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorTopLeft));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorBottomRight));\n        planeDiff += step(0.001, normalDiff(normSceneColor, sceneColorBottomLeft));\n\n        planeDiff += step(0.001, abs(distance - distanceTop));\n        planeDiff += step(0.001, abs(distance - distanceBottom));\n        planeDiff += step(0.001, abs(distance - distanceLeft));\n        planeDiff += step(0.001, abs(distance - distanceRight));\n        planeDiff += step(0.001, abs(distance - distanceTopRight));\n        planeDiff += step(0.001, abs(distance - distanceTopLeft));\n        planeDiff += step(0.001, abs(distance - distanceBottomRight));\n        planeDiff += step(0.001, abs(distance - distanceBottomLeft));\n\n        // Add extra background outline\n\n        int width2 = width + 1;\n        vec3 normalTop2 = getValue(planeBuffer, 0, width2).rgb;\n        vec3 normalBottom2 = getValue(planeBuffer, 0, -width2).rgb;\n        vec3 normalRight2 = getValue(planeBuffer, width2, 0).rgb;\n        vec3 normalLeft2 = getValue(planeBuffer, -width2, 0).rgb;\n        vec3 normalTopRight2 = getValue(planeBuffer, width2, width2).rgb;\n        vec3 normalTopLeft2 = getValue(planeBuffer, -width2, width2).rgb;\n        vec3 normalBottomRight2 = getValue(planeBuffer, width2, -width2).rgb;\n        vec3 normalBottomLeft2 = getValue(planeBuffer, -width2, -width2).rgb;\n\n        planeDiff += -(getIsBackground(normalTop2) - 1.);\n        planeDiff += -(getIsBackground(normalBottom2) - 1.);\n        planeDiff += -(getIsBackground(normalRight2) - 1.);\n        planeDiff += -(getIsBackground(normalLeft2) - 1.);\n        planeDiff += -(getIsBackground(normalTopRight2) - 1.);\n        planeDiff += -(getIsBackground(normalBottomRight2) - 1.);\n        planeDiff += -(getIsBackground(normalBottomRight2) - 1.);\n        planeDiff += -(getIsBackground(normalBottomLeft2) - 1.);\n\n        // Tolerance sets the minimum amount of differences to consider\n        // this texel an edge\n\n        float line = step(tolerance, planeDiff);\n\n        // Exclude background and apply opacity\n\n        float background = getIsBackground(normal);\n        line *= background;\n        line *= opacity;\n        \n        // Add gloss\n        \n        vec3 gloss = getValue(glossBuffer, 0, 0).xyz;\n        float diffGloss = abs(maxGloss - minGloss);\n        vec3 glossExpVector = vec3(glossExponent,glossExponent,glossExponent);\n        gloss = min(pow(gloss, glossExpVector), vec3(1.,1.,1.));\n        gloss *= diffGloss;\n        gloss += minGloss;\n        vec4 glossedColor = sceneColor + vec4(gloss, 1.) * glossEnabled;\n        \n        vec4 corrected = mix(sceneColor, glossedColor, background);\n        \n        // Draw lines\n        \n        corrected = mix(corrected, vec4(lineColor, 1.), line);\n        \n        // Add outline\n        \n        vec4 outlinePreview =getValue(outlineBuffer, 0, 0);\n        float outlineColorCorrection = 1. / max(0.2, outlinePreview.a);\n        vec3 outlineColor = outlinePreview.rgb * outlineColorCorrection;\n        \n        // thickness between 10 and 2, opacity between 1 and 0.2\n\t    int outlineThickness = int(outlinePreview.a * 10.);\n\t    \n\t    float outlineDiff = 0.;\n        \n        outlineDiff += step(0.1, getValue(outlineBuffer, 0, 0).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, 1, 0).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, -1, 0).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, 0, -1).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, 0, 1).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, outlineThickness, 0).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, -outlineThickness, 0).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, 0, -outlineThickness).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, 0, outlineThickness).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, outlineThickness, outlineThickness).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, -outlineThickness, outlineThickness).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, -outlineThickness, -outlineThickness).a);\n        outlineDiff += step(0.1, getValue(outlineBuffer, outlineThickness, -outlineThickness).a);\n        \n        float outLine = step(4., outlineDiff) * step(outlineDiff, 12.) * outlineEnabled;\n        corrected = mix(corrected, vec4(outlineColor, 1.), outLine);\n        \n        gl_FragColor = corrected;\n\t}\n\t\t\t"}createOutlinePostProcessMaterial(){return new e.ShaderMaterial({uniforms:{opacity:{value:this._opacity},debugVisualize:{value:0},sceneColorBuffer:{value:null},tolerance:{value:this._tolerance},planeBuffer:{value:null},glossBuffer:{value:null},outlineBuffer:{value:null},glossEnabled:{value:1},minGloss:{value:this._minGloss},maxGloss:{value:this._maxGloss},outlineEnabled:{value:0},glossExponent:{value:this._glossExponent},width:{value:1},lineColor:{value:new e.Color(this._lineColor)},screenSize:{value:new e.Vector4(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}},vertexShader:this.vertexShader,fragmentShader:this.fragmentShader})}newRenderTarget(){const t=new e.WebGLRenderTarget(this.resolution.x,this.resolution.y);return t.texture.colorSpace="srgb-linear",t.texture.format=e.RGBAFormat,t.texture.type=e.HalfFloatType,t.texture.minFilter=e.NearestFilter,t.texture.magFilter=e.NearestFilter,t.texture.generateMipmaps=!1,t.stencilBuffer=!1,t}}class st{get basePass(){if(!this._basePass)throw new Error("Custom effects not initialized!");return this._basePass}get gammaPass(){if(!this._gammaPass)throw new Error("Custom effects not initialized!");return this._gammaPass}get customEffects(){if(!this._customEffects)throw new Error("Custom effects not initialized!");return this._customEffects}get n8ao(){if(!this._n8ao)throw new Error("Custom effects not initialized!");return this._n8ao}get enabled(){return this._enabled}set enabled(e){this._initialized||this.initialize(),this._enabled=e}get settings(){return{...this._settings}}constructor(t,s){this.components=t,this.renderer=s,this.excludedItems=new Set,this.overrideClippingPlanes=!1,this._enabled=!1,this._initialized=!1,this._settings={gamma:!0,custom:!0,ao:!1},this._renderTarget=new e.WebGLRenderTarget(window.innerWidth,window.innerHeight),this._renderTarget.texture.colorSpace="srgb-linear",this.composer=new _(this.renderer,this._renderTarget),this.composer.setSize(window.innerWidth,window.innerHeight)}async dispose(){this._renderTarget.dispose(),this._depthTexture?.dispose(),await(this._customEffects?.dispose()),this._gammaPass?.dispose(),this._n8ao?.dispose(),this.excludedItems.clear()}setPasses(e){let t=!1;for(const s in e){const i=s;if(this.settings[i]!==e[i]){t=!0;break}}if(t){for(const t in e){const s=t;void 0!==this._settings[s]&&(this._settings[s]=e[s])}this.updatePasses()}}setSize(e,t){this._initialized&&(this.composer.setSize(e,t),this.basePass.setSize(e,t),this.n8ao.setSize(e,t),this.customEffects.setSize(e,t),this.gammaPass.setSize(e,t))}update(){this._enabled&&this.composer.render()}updateCamera(){const e=this.components.camera.get();this._n8ao&&(this._n8ao.camera=e),this._customEffects&&(this._customEffects.renderCamera=e),this._basePass&&(this._basePass.camera=e)}initialize(){const t=this.overrideScene||this.components.scene.get(),s=this.overrideCamera||this.components.camera.get();if(!t||!s)return;this.components.camera instanceof et&&this.components.camera.projectionChanged.add((()=>{this.updateCamera()}));const i=this.components.renderer;this.overrideClippingPlanes||(this.renderer.clippingPlanes=i.clippingPlanes),this.renderer.outputColorSpace="srgb",this.renderer.toneMapping=e.NoToneMapping,this.newBasePass(t,s),this.newSaoPass(t,s),this.newGammaPass(),this.newCustomPass(t,s),this._initialized=!0,this.updatePasses()}updateProjection(e){this.composer.passes.forEach((t=>{t.camera=e})),this.update()}updatePasses(){for(const e of this.composer.passes)this.composer.removePass(e);this._basePass&&this.composer.addPass(this.basePass),this._settings.gamma&&this.composer.addPass(this.gammaPass),this._settings.ao&&this.composer.addPass(this.n8ao),this._settings.custom&&this.composer.addPass(this.customEffects)}newCustomPass(t,s){this._customEffects=new tt(new e.Vector2(window.innerWidth,window.innerHeight),this.components,t,s)}newGammaPass(){this._gammaPass=new F(R)}newSaoPass(t,s){const{width:i,height:n}=this.components.renderer.getSize();this._n8ao=new A(t,s,i,n);const{configuration:o}=this._n8ao;o.aoSamples=16,o.denoiseSamples=1,o.denoiseRadius=13,o.aoRadius=1,o.distanceFalloff=4,o.aoRadius=1,o.intensity=4,o.halfRes=!0,o.color=(new e.Color).setHex(13421772,"srgb-linear")}newBasePass(e,t){this._basePass=new y(e,t)}}class it extends ee{constructor(e,t,s){super(e,t,s),this.postproduction=new st(e,this._renderer),this.setPostproductionSize(),this.onResize.add((e=>this.resizePostproduction(e)))}async update(){if(!this.enabled)return;await this.onBeforeUpdate.trigger();const e=this.overrideScene||this.components.scene.get(),t=this.overrideCamera||this.components.camera.get();e&&t&&(this.postproduction.enabled?this.postproduction.composer.render():this._renderer.render(e,t),this._renderer2D.render(e,t),await this.onAfterUpdate.trigger())}async dispose(){await super.dispose(),await this.postproduction.dispose()}resizePostproduction(e){this.postproduction&&this.setPostproductionSize(e)}setPostproductionSize(e){if(!this.container)return;const t=e?e.x:this.container.clientWidth,s=e?e.y:this.container.clientHeight;this.postproduction.setSize(t,s)}}class nt{constructor(t,s){this.numbers=new e.Group,this.maxRegenerateRetrys=4,this.gridsFactor=5,this.scaleX=1,this.scaleY=1,this._group=new e.Group,this._frustum=new e.Frustum,this._frustumMat=new e.Matrix4,this._regenerateDelay=200,this._regenerateCounter=0,this._camera=t,this._container=s;const i=this.newGrid(2236962,-1),n=this.newGrid(1118481,-2);this.grids={main:i,secondary:n},this._group.add(n,i,this.numbers)}get(){return this._group}dispose(){const{main:e,secondary:t}=this.grids;e.removeFromParent(),t.removeFromParent(),e.geometry.dispose();e.material.dispose(),t.geometry.dispose();t.material.dispose()}regenerate(){if(!this.isGridReady()){if(this._regenerateCounter++,this._regenerateCounter>this.maxRegenerateRetrys)throw new Error("Grid could not be regenerated");return void setTimeout((()=>this.regenerate),this._regenerateDelay)}this._regenerateCounter=0;const t=this._frustumMat.multiplyMatrices(this._camera.projectionMatrix,this._camera.matrixWorldInverse);this._frustum.setFromProjectionMatrix(t);const{planes:s}=this._frustum,i=s[0].constant*-s[0].normal.x,n=s[1].constant*-s[1].normal.x,o=s[2].constant*-s[2].normal.y,r=s[3].constant*-s[3].normal.y,a=Math.abs(i-n),l=Math.abs(r-o),{clientWidth:h,clientHeight:c}=this._container,d=Math.max(h,c),u=Math.max(a,l)/d,p=Math.ceil(Math.log10(a/this.scaleX)),m=Math.ceil(Math.log10(l/this.scaleY)),E=10**(p-2)*this.scaleX,g=10**(m-2)*this.scaleY,I=E*this.gridsFactor,C=g*this.gridsFactor,f=Math.ceil(l/C),w=Math.ceil(a/I),T=Math.ceil(l/g),b=Math.ceil(a/E),v=E*Math.ceil(n/E),_=g*Math.ceil(o/g),y=I*Math.ceil(n/I),A=C*Math.ceil(o/C),F=[...this.numbers.children];for(const e of F)e.removeFromParent();this.numbers.children=[];const R=[],S=9*u,M=1e4,P=Math.round(Math.abs(y/this.scaleX)*M)/M,L=(w-1)*I,N=Math.round(Math.abs((y+L)/this.scaleX)*M)/M,O=Math.max(P,N).toString().length*S;let x=Math.ceil(O/I)*I;for(let e=0;e<w;e++){let t=y+e*I;R.push(t,r,0,t,o,0);const s=t/this.scaleX;t=Math.round(t*M)/M,x=Math.round(x*M)/M;const i=t%x;if(!(I<1||C<1)&&Math.abs(i)>.01)continue;const n=12*u;this.newNumber(s).position.set(t,o+n,0)}for(let e=0;e<f;e++){const t=A+e*C;R.push(n,t,0,i,t,0);const s=this.newNumber(t/this.scaleY);let o=12;s.element.textContent&&(o+=4*s.element.textContent.length);const r=o*u;s.position.set(n+r,t,0)}const D=[];for(let e=0;e<b;e++){const t=v+e*E;D.push(t,r,0,t,o,0)}for(let e=0;e<T;e++){const t=_+e*g;D.push(n,t,0,i,t,0)}const U=new e.BufferAttribute(new Float32Array(R),3),B=new e.BufferAttribute(new Float32Array(D),3),{main:k,secondary:V}=this.grids;k.geometry.setAttribute("position",U),V.geometry.setAttribute("position",B)}newNumber(e){const t=document.createElement("div"),s=Math.round(100*e)/100;t.textContent=`${s}`,t.style.height="24px",t.style.fontSize="12px";const i=new m(t);return this.numbers.add(i),i}newGrid(t,s){const i=new e.BufferGeometry,n=new e.LineBasicMaterial({color:t}),o=new e.LineSegments(i,n);return o.frustumCulled=!1,o.renderOrder=s,o}isGridReady(){const e=this._camera.projectionMatrix.elements;for(let t=0;t<e.length;t++){const s=e[t];if(Number.isNaN(s))return!1}return!0}}class ot extends j{get size(){return this._size.clone()}get scaleX(){return this._scaleX}set scaleX(e){this._scaleX=e,this._root.scale.x=e,this.grid.scaleX=e,this.grid.regenerate()}get scaleY(){return this._scaleY}set scaleY(e){this._scaleY=e,this._root.scale.y=e,this.grid.scaleY=e,this.grid.regenerate()}constructor(t,s=!1){if(super(t),this.onAfterUpdate=new W,this.onBeforeUpdate=new W,this.onResize=new W,this.enabled=!0,this.onDisposed=new W,this.uiElement=new Q,this._scaleX=1,this._scaleY=1,this._root=new e.Group,this._size=new e.Vector2,this._frustumSize=50,this.resize=()=>{const{height:e,width:t}=this._size,s=t/e;this.camera.left=-this._frustumSize*s/2,this.camera.right=this._frustumSize*s/2,this.camera.top=this._frustumSize/2,this.camera.bottom=-this._frustumSize/2,this.camera.updateProjectionMatrix(),this.camera.updateProjectionMatrix(),this.renderer.resize(this._size)},!t.uiEnabled)throw new Error("The Simple2DScene component needs to use UI elements (TODO: Decouple from them).");const i=new oe(t);i.domElement.classList.add("relative"),this.uiElement.set({container:i}),this.scene=new e.Scene,this._size.set(window.innerWidth,window.innerHeight);const{width:n,height:o}=this._size,r=n/o,a=.5*this._frustumSize;this.camera=new e.OrthographicCamera(-a*r,a*r,a,-a,-1e3,1e3),this.scene.add(this.camera),this.camera.position.z=10;const l=i.domElement;this.scene.add(this._root),this.grid=new nt(this.camera,l);const h=this.grid.get();this.scene.add(h),this.renderer=s?new it(this.components,l):new ee(this.components,l);const c=this.renderer.get();c.localClippingEnabled=!1,this.renderer.setupEvents(!1),this.renderer.overrideScene=this.scene,this.renderer.overrideCamera=this.camera,this.controls=new E(this.camera,c.domElement),this.controls.setTarget(0,0,0),this.controls.addEventListener("update",(()=>this.grid.regenerate())),this.controls.mouseButtons.left=E.ACTION.TRUCK,this.controls.dollyToCursor=!0,this.controls.restThreshold=2,this.controls.smoothTime=.2}get(){return this._root}async dispose(){const t=this.components.tools.get(q);for(const s of this.scene.children){const i=s;i instanceof e.Object3D&&t.destroy(i)}await this.renderer.dispose(),await this.uiElement.dispose(),await this.onDisposed.trigger(ot.uuid),this.onDisposed.reset()}async update(){await this.onBeforeUpdate.trigger(),this.controls.update(1/60),await this.renderer.update(),await this.onAfterUpdate.trigger()}getSize(){return new e.Vector2(this._size.width,this._size.height)}setSize(e,t){this._size.width=t,this._size.height=e,this.resize()}}ot.uuid="b48b7194-0f9a-43a4-a718-270b1522595f";class rt extends j{get meshes(){const e=[];for(const t in this.list)e.push(this.list[t].mesh);return e}constructor(e){super(e),this.onDisposed=new W,this.enabled=!0,this.list={},this.groups=[],this.baseCoordinationModel="",this.onFragmentsLoaded=new W,this.onFragmentsDisposed=new W,this.uiElement=new Q,this.commands=[],this._loader=new L,this._cards=[],this.components.tools.add(rt.uuid,this),e.uiEnabled&&this.setupUI(e)}get(){return Object.values(this.list)}async dispose(e=!1){e&&await this.uiElement.dispose();for(const e of this.groups){for(const t of e.items)this.components.meshes.delete(t.mesh);e.dispose(!0)}for(const e of this.commands)await e.dispose();for(const e of this._cards)await e.dispose();this.groups=[],this.list={},this.onFragmentsLoaded.reset(),this.onFragmentsDisposed.reset(),await this.onDisposed.trigger(rt.uuid),this.onDisposed.reset()}async disposeGroup(e){const{uuid:t}=e,s=[];for(const t of e.items)s.push(t.id),this.components.meshes.delete(t.mesh),delete this.list[t.id];e.dispose(!0);const i=this.groups.indexOf(e);this.groups.splice(i,1),await this.onFragmentsDisposed.trigger({groupID:t,fragmentIDs:s}),await this.updateWindow()}reset(){for(const e in this.list){this.list[e].dispose()}this.list={}}async load(e,t=!0){const s=this._loader.import(e),i=[];this.components.scene.get().add(s);for(const e of s.items)e.group=s,this.list[e.id]=e,i.push(e.id),this.components.meshes.add(e.mesh);return t&&this.coordinate([s]),this.groups.push(s),await this.onFragmentsLoaded.trigger(s),s}export(e){return this._loader.export(e)}async updateWindow(){if(this.components.uiEnabled){for(const e of this._cards)await e.dispose();for(const e of this.groups){const t=new ce(this.components);t.domElement.classList.remove("bg-ifcjs-120"),t.domElement.classList.remove("border-transparent"),t.domElement.className+=" min-w-[300px] my-2 border-1 border-solid border-[#3A444E] ";const s=new oe(this.components);t.addChild(s),t.title=e.name,this.uiElement.get("window").addChild(t),this._cards.push(t);const i=new ae(this.components);i.materialIcon="delete",s.addChild(i),i.onClick.add((()=>this.disposeGroup(e)))}}}coordinate(e=this.groups){if(0===this.baseCoordinationModel.length){const t=e.pop();if(!t)return;this.baseCoordinationModel=t.uuid}if(!e.length)return;const t=this.groups.find((e=>e.uuid===this.baseCoordinationModel));if(t)for(const s of e)s!==t&&(s.position.set(0,0,0),s.rotation.set(0,0,0),s.scale.set(1,1,1),s.updateMatrix(),s.applyMatrix4(s.coordinationMatrix.clone().invert()),s.applyMatrix4(t.coordinationMatrix));else console.log("No base model found for coordination!")}setupUI(e){const t=new de(e);t.title="Models",t.domElement.style.left="70px",t.domElement.style.top="100px",t.domElement.style.width="340px",t.domElement.style.height="400px";const s=t.slots.content.domElement;s.classList.remove("overflow-auto"),s.classList.add("overflow-x-hidden"),e.ui.add(t),t.visible=!1;const i=new ae(e);i.tooltip="Models",i.materialIcon="inbox",i.onClick.add((()=>{t.visible=!t.visible})),this.uiElement.set({main:i,window:t}),this.onFragmentsLoaded.add((()=>this.updateWindow()))}}rt.uuid="fef46874-46a3-461b-8c44-2922ab77c806",Z.libraryUUIDs.add(rt.uuid);class at{constructor(){this.factor=1,this.complement=1}apply(e){const t=this.getScaleMatrix().multiply(e);e.copy(t)}setUp(e){this.factor=1;const t=this.getLengthUnits(e);if(!t)return;const s=null==t,i=void 0===t.Name||null===t.Name;s||i||("FOOT"===t.Name.value?this.factor=.3048:"MILLI"===t.Prefix?.value&&(this.complement=.001))}getLengthUnits(e){try{const t=e.GetLineIDsWithType(0,x.IFCUNITASSIGNMENT).get(0),s=e.GetLine(0,t);for(const t of s.Units){if(!t||null===t.value||void 0===t.value)continue;const s=e.GetLine(0,t.value);if(s.UnitType&&"LENGTHUNIT"===s.UnitType.value)return s}return null}catch(e){return console.log("Could not get units"),null}}getScaleMatrix(){const t=this.factor;return(new e.Matrix4).fromArray([t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1])}}class lt{constructor(){this.itemsByFloor={},this._units=new at}setUp(e){this._units.setUp(e),this.cleanUp();try{const t=e.GetLineIDsWithType(0,x.IFCRELCONTAINEDINSPATIALSTRUCTURE),s=new Set,i=e.GetLineIDsWithType(0,x.IFCSPACE);for(let e=0;e<i.size();e++)s.add(i.get(e));const n=e.GetLineIDsWithType(0,x.IFCRELAGGREGATES),o=n.size();for(let t=0;t<o;t++){const i=n.get(t),o=e.GetLine(0,i);if(!o||!o.RelatingObject||!o.RelatedObjects)continue;const r=o.RelatingObject.value,a=o.RelatedObjects;for(const e of a){const t=e.value;s.has(t)&&(this.itemsByFloor[t]=r)}}const r={},a=t.size();for(let i=0;i<a;i++){const n=t.get(i),o=e.GetLine(0,n);if(!o||!o.RelatingStructure||!o.RelatedElements)continue;const a=o.RelatingStructure.value,l=o.RelatedElements;if(s.has(a))for(const e of l){r[a]||(r[a]=[]);const t=e.value;r[a].push(t)}else for(const e of l){const t=e.value;this.itemsByFloor[t]=a}}for(const e in r){const t=this.itemsByFloor[e];if(void 0!==t){const s=r[e];for(const e of s)this.itemsByFloor[e]=t}}for(let t=0;t<o;t++){const s=n.get(t),i=e.GetLine(0,s);if(!i||!i.RelatingObject||!i.RelatedObjects)continue;const o=i.RelatingObject.value,r=i.RelatedObjects;for(const e of r){const t=e.value,s=this.itemsByFloor[o];void 0!==s&&(this.itemsByFloor[t]=s)}}}catch(e){console.log("Could not get floors.")}}cleanUp(){this.itemsByFloor={}}}class ht{constructor(){this.includeProperties=!0,this.optionalCategories=[x.IFCSPACE],this.coordinate=!0,this.wasm={path:"",absolute:!1,logLevel:x.LogLevel.LOG_LEVEL_OFF},this.excludedCategories=new Set,this.saveLocations=!1,this.webIfc={COORDINATE_TO_ORIGIN:!0,OPTIMIZE_PROFILES:!0},this.autoSetWasm=!0,this.customLocateFileHandler=null}}class ct{constructor(){this.defLineMat=new e.LineBasicMaterial({color:16777215})}read(e){const t={IfcAlignment:e.GetAllAlignments(0),IfcCrossSection2D:e.GetAllCrossSections2D(0),IfcCrossSection3D:e.GetAllCrossSections3D(0)};return this.get(t)}get(t){if(t.IfcAlignment){const s=new Map;for(const e of t.IfcAlignment){const t=new N;t.absolute=this.getCurves(e.curve3D,t),t.horizontal=this.getCurves(e.horizontal,t),t.vertical=this.getCurves(e.vertical,t),s.set(s.size,t)}return{alignments:s,coordinationMatrix:new e.Matrix4}}}getCurves(t,s){const i=[];let n=0;for(const o of t){const t={};if(o.data)for(const e of o.data){const[s,i]=e.split(": "),n=parseFloat(i);t[s]=n||i}const{points:r}=o,a=new Float32Array(3*r.length);for(let e=0;e<r.length;e++){const{x:t,y:s,z:i}=r[e];a[3*e]=t,a[3*e+1]=s,a[3*e+2]=i||0}const l=new e.BufferAttribute(a,3),h=new e.EdgesGeometry;h.setAttribute("position",l);const c=new P.CurveMesh(n,t,s,h,this.defLineMat);i.push(c.curve),n++}return i}}class dt{get(e,t){let s="";const i=e.GetHeaderLine(0,t)||"";if(!i)return s;for(const e of i.arguments)if(null!=e)if(Array.isArray(e))for(const t of e)s+=`${t.value}|`;else s+=`${e.value}|`;return s}}const ut=new Set([1123145078,574549367,1675464909,2059837836,3798115385,32440307,3125803723,3207858831,2740243338,2624227202,4240577450,3615266464,3724593414,220341763,477187591,1878645084,1300840506,3303107099,1607154358,1878645084,846575682,1351298697,2417041796,3049322572,3331915920,1416205885,776857604,3285139300,3958052878,2827736869,2732653382,673634403,3448662350,4142052618,2924175390,803316827,2556980723,1809719519,2205249479,807026263,3737207727,1660063152,2347385850,3940055652,2705031697,3732776249,2485617015,2611217952,1704287377,2937912522,2770003689,1281925730,1484403080,3448662350,4142052618,3800577675,4006246654,3590301190,1383045692,2775532180,2047409740,370225590,3593883385,2665983363,4124623270,812098782,3649129432,987898635,1105321065,3510044353,1635779807,2603310189,3406155212,1310608509,4261334040,2736907675,3649129432,1136057603,1260505505,4182860854,2713105998,2898889636,59481748,3749851601,3486308946,3150382593,1062206242,3264961684,15328376,1485152156,370225590,1981873012,2859738748,45288368,2614616156,2732653382,775493141,2147822146,2601014836,2629017746,1186437898,2367409068,1213902940,3632507154,3900360178,476780140,1472233963,2804161546,3008276851,738692330,374418227,315944413,3905492369,3570813810,2571569899,178912537,2294589976,1437953363,2133299955,572779678,3092502836,388784114,2624227202,1425443689,3057273783,2347385850,1682466193,2519244187,2839578677,3958567839,2513912981,2830218821,427810014]);class pt{async export(e,t,s=!1,i=!0){const n={},o=new Set(e.GetIfcEntityList(t)),r=new Set([x.IFCPROJECT,x.IFCSITE,x.IFCBUILDING,x.IFCBUILDINGSTOREY,x.IFCSPACE]);for(const e of r)o.add(e);for(const a of o){if(ut.has(a))continue;const o=r.has(a)&&i,l=e.GetLineIDsWithType(t,a);for(const t of l){const i=e.GetLine(0,t,o,s);n[i.expressID]=i}}return n}}class mt extends j{constructor(t){super(t),this.onIfcLoaded=new W,this.onIfcStartedLoading=new W,this.onSetup=new W,this.onDisposed=new W,this.settings=new ht,this.enabled=!0,this.uiElement=new Q,this._material=new e.MeshLambertMaterial,this._spatialTree=new lt,this._metaData=new dt,this._fragmentInstances=new Map,this._webIfc=new x.IfcAPI,this._civil=new ct,this._propertyExporter=new pt,this._visitedFragments=new Map,this._materialT=new e.MeshLambertMaterial({transparent:!0,opacity:.5}),this.components.tools.add(mt.uuid,this),t.uiEnabled&&this.setupUI(),this.settings.excludedCategories.add(x.IFCOPENINGELEMENT)}get(){return this._webIfc}async dispose(){this.onIfcLoaded.reset(),await this.uiElement.dispose(),this._webIfc=null,await this.onDisposed.trigger(mt.uuid),this.onDisposed.reset()}async setup(e){this.settings={...this.settings,...e},this.settings.autoSetWasm&&await this.autoSetWasm(),await this.onSetup.trigger()}async load(e,t=!0){const s=performance.now();await this.onIfcStartedLoading.trigger(),await this.readIfcFile(e);const i=await this.getAllGeometries(),n=await this._propertyExporter.export(this._webIfc,0);i.setLocalProperties(n),this.cleanUp(),console.log(`Streaming the IFC took ${performance.now()-s} ms!`);const o=this.components.tools.get(rt);o.groups.push(i);for(const e of i.items)o.list[e.id]=e,e.mesh.uuid=e.id,e.group=i,this.components.meshes.add(e.mesh);return t&&o.coordinate([i]),await this.onIfcLoaded.trigger(i),i}setupUI(){const e=new ae(this.components);e.materialIcon="upload_file",e.tooltip="Load IFC";const t=new we(this.components,{message:"IFC model successfully loaded!"});e.onClick.add((()=>{const e=document.createElement("input");e.type="file",e.accept=".ifc",e.style.display="none",e.onchange=async()=>{const s=this.components.tools.get(rt);if(null===e.files||0===e.files.length)return;const i=e.files[0],n=await i.arrayBuffer(),o=new Uint8Array(n),r=await this.load(o);this.components.scene.get().add(r),t.visible=!0,await s.updateWindow(),e.remove()},e.click()})),this.components.ui.add(t),t.visible=!1,this.uiElement.set({main:e,toast:t})}async readIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;return this._webIfc.SetWasmPath(t,s),await this._webIfc.Init(),i&&this._webIfc.SetLogLevel(i),this._webIfc.OpenModel(e,this.settings.webIfc)}async getAllGeometries(){this._spatialTree.setUp(this._webIfc);const e=this._webIfc.GetIfcEntityList(0),t=new P.FragmentsGroup,{FILE_NAME:s,FILE_DESCRIPTION:i}=x;t.ifcMetadata={name:this._metaData.get(this._webIfc,s),description:this._metaData.get(this._webIfc,i),schema:this._webIfc.GetModelSchema(0)||"IFC2X3",maxExpressID:this._webIfc.GetMaxExpressID(0)};const n=[];for(const s of e){if(!this._webIfc.IsIfcElement(s)&&s!==x.IFCSPACE)continue;if(this.settings.excludedCategories.has(s))continue;const e=this._webIfc.GetLineIDsWithType(0,s),i=e.size();for(let o=0;o<i;o++){const i=e.get(o);n.push(i);const r=this._spatialTree.itemsByFloor[i]||0;t.data.set(i,[[],[r,s]])}}this._spatialTree.cleanUp(),this._webIfc.StreamMeshes(0,n,(e=>{this.getMesh(e,t)}));for(const e of this._visitedFragments){const{index:s,fragment:i}=e[1];t.keyFragments.set(s,i.id)}for(const e of t.items){const t=this._fragmentInstances.get(e.id);if(!t)throw new Error("Fragment not found!");const s=[];for(const[e,i]of t)s.push(i);e.add(s)}const o=this._webIfc.GetCoordinationMatrix(0);return t.coordinationMatrix.fromArray(o),t.civilData=this._civil.read(this._webIfc),t}cleanUp(){this._webIfc=null,this._webIfc=new x.IfcAPI,this._visitedFragments.clear(),this._fragmentInstances.clear()}getMesh(t,s){const i=t.geometries.size(),n=t.expressID;for(let o=0;o<i;o++){const i=t.geometries.get(o),{x:r,y:a,z:l,w:h}=i.color,c=1!==h,{geometryExpressID:d}=i,u=`${d}-${c}`;if(!this._visitedFragments.has(u)){const e=this.getGeometry(this._webIfc,d),t=c?this._materialT:this._material,i=new P.Fragment(e,t,1);s.add(i.mesh),s.items.push(i);const n=this._visitedFragments.size;this._visitedFragments.set(u,{index:n,fragment:i})}const p=(new e.Color).setRGB(r,a,l,"srgb"),m=new e.Matrix4;m.fromArray(i.flatTransformation);const E=this._visitedFragments.get(u);if(void 0===E)throw new Error("Error getting geometry data for streaming!");const g=s.data.get(n);if(!g)throw new Error("Data not found!");g[0].push(E.index);const{fragment:I}=E;this._fragmentInstances.has(I.id)||this._fragmentInstances.set(I.id,new Map);const C=this._fragmentInstances.get(I.id);if(!C)throw new Error("Instances not found!");if(C.has(n)){const e=C.get(n);if(!e)throw new Error("Instance not found!");e.transforms.push(m),e.colors&&e.colors.push(p)}else C.set(n,{id:n,transforms:[m],colors:[p]})}}getGeometry(t,s){const i=t.GetGeometry(0,s),n=t.GetIndexArray(i.GetIndexData(),i.GetIndexDataSize()),o=t.GetVertexArray(i.GetVertexData(),i.GetVertexDataSize()),r=new Float32Array(o.length/2),a=new Float32Array(o.length/2);for(let e=0;e<o.length;e+=6)r[e/2]=o[e],r[e/2+1]=o[e+1],r[e/2+2]=o[e+2],a[e/2]=o[e+3],a[e/2+1]=o[e+4],a[e/2+2]=o[e+5];const l=new e.BufferGeometry,h=new e.BufferAttribute(r,3),c=new e.BufferAttribute(a,3);return l.setAttribute("position",h),l.setAttribute("normal",c),l.setIndex(Array.from(n)),i.delete(),l}async autoSetWasm(){const e=await fetch(`https://unpkg.com/openbim-components@${ye.release}/package.json`);if(!e.ok)return void console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");const t=await e.json();if("web-ifc"in t.peerDependencies??1){const e=t.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${e}/`,this.settings.wasm.absolute=!0}else console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.")}}mt.uuid="a659add7-1418-4771-a0d6-7d4d438e4624",Z.libraryUUIDs.add(mt.uuid);class Et extends j{constructor(e){super(e),this.enabled=!0,this.onDisposed=new W,this._meshes=[],this.components.tools.add(Et.uuid,this),this._absoluteMin=Et.newBound(!0),this._absoluteMax=Et.newBound(!1)}static getDimensions(t){const{min:s,max:i}=t,n=Math.abs(i.x-s.x),o=Math.abs(i.y-s.y),r=Math.abs(i.z-s.z),a=new e.Vector3;return a.subVectors(i,s).divideScalar(2).add(s),{width:n,height:o,depth:r,center:a}}static newBound(t){const s=t?1:-1;return new e.Vector3(s*Number.MAX_VALUE,s*Number.MAX_VALUE,s*Number.MAX_VALUE)}static getBounds(t,s,i){const n=i||this.newBound(!1),o=s||this.newBound(!0);for(const e of t)e.x<o.x&&(o.x=e.x),e.y<o.y&&(o.y=e.y),e.z<o.z&&(o.z=e.z),e.x>n.x&&(n.x=e.x),e.y>n.y&&(n.y=e.y),e.z>n.z&&(n.z=e.z);return new e.Box3(s,i)}async dispose(){const e=this.components.tools.get(q);for(const t of this._meshes)e.destroy(t);this._meshes=[],await this.onDisposed.trigger(Et.uuid),this.onDisposed.reset()}get(){const t=this._absoluteMin.clone(),s=this._absoluteMax.clone();return new e.Box3(t,s)}getSphere(){const t=this._absoluteMin.clone(),s=this._absoluteMax.clone(),i=Math.abs((s.x-t.x)/2),n=Math.abs((s.y-t.y)/2),o=Math.abs((s.z-t.z)/2),r=new e.Vector3(t.x+i,t.y+n,t.z+o),a=r.distanceTo(t);return new e.Sphere(r,a)}getMesh(){const t=new e.Box3(this._absoluteMin,this._absoluteMax),s=Et.getDimensions(t),{width:i,height:n,depth:o,center:r}=s,a=new e.BoxGeometry(i,n,o),l=new e.Mesh(a);return this._meshes.push(l),l.position.copy(r),l}reset(){this._absoluteMin=Et.newBound(!0),this._absoluteMax=Et.newBound(!1)}add(e){for(const t of e.items)this.addMesh(t.mesh)}addMesh(t){if(!t.geometry.index)return;const s=Et.getFragmentBounds(t);t.updateMatrixWorld();const i=t.matrixWorld,n=new e.Matrix4,o=t instanceof e.InstancedMesh,r=o?t.count:1;for(let e=0;e<r;e++){const r=s.min.clone(),a=s.max.clone();o&&(t.getMatrixAt(e,n),r.applyMatrix4(n),a.applyMatrix4(n)),r.applyMatrix4(i),a.applyMatrix4(i),r.x<this._absoluteMin.x&&(this._absoluteMin.x=r.x),r.y<this._absoluteMin.y&&(this._absoluteMin.y=r.y),r.z<this._absoluteMin.z&&(this._absoluteMin.z=r.z),r.x>this._absoluteMax.x&&(this._absoluteMax.x=r.x),r.y>this._absoluteMax.y&&(this._absoluteMax.y=r.y),r.z>this._absoluteMax.z&&(this._absoluteMax.z=r.z),a.x>this._absoluteMax.x&&(this._absoluteMax.x=a.x),a.y>this._absoluteMax.y&&(this._absoluteMax.y=a.y),a.z>this._absoluteMax.z&&(this._absoluteMax.z=a.z),a.x<this._absoluteMin.x&&(this._absoluteMin.x=a.x),a.y<this._absoluteMin.y&&(this._absoluteMin.y=a.y),a.z<this._absoluteMin.z&&(this._absoluteMin.z=a.z)}}static getFragmentBounds(t){const s=t.geometry.attributes.position,i=Number.MAX_VALUE,n=-i,o=new e.Vector3(i,i,i),r=new e.Vector3(n,n,n);if(!t.geometry.index)throw new Error("Geometry must be indexed!");const a=Array.from(t.geometry.index.array);for(let e=0;e<a.length;e++){if(e%3==0&&0===a[e]&&0===a[e+1]&&0===a[e+2]){e+=2;continue}const t=a[e],i=s.getX(t),n=s.getY(t),l=s.getZ(t);i<o.x&&(o.x=i),n<o.y&&(o.y=n),l<o.z&&(o.z=l),i>r.x&&(r.x=i),n>r.y&&(r.y=n),l>r.z&&(r.z=l)}return new e.Box3(o,r)}}Et.uuid="d1444724-dba6-4cdd-a0c7-68ee1450d166",Z.libraryUUIDs.add(Et.uuid);class gt extends j{get outlineEnabled(){return this._outlineEnabled}set outlineEnabled(e){this._outlineEnabled=e,e||delete this._postproduction.customEffects.outlinedMeshes.fragments}get _postproduction(){if(!(this.components.renderer instanceof it))throw new Error("Postproduction renderer is needed for outlines!");return this.components.renderer.postproduction}constructor(t){super(t),this.onDisposed=new W,this.onBeforeUpdate=new W,this.onAfterUpdate=new W,this.needsUpdate=!1,this.isSetup=!1,this.enabled=!0,this.highlightMats={},this.events={},this.multiple="ctrlKey",this.zoomFactor=1.5,this.zoomToSelection=!1,this.selection={},this.excludeOutline=new Set,this.fillEnabled=!0,this.outlineMaterial=new e.MeshBasicMaterial({color:"white",transparent:!0,depthTest:!1,depthWrite:!1,opacity:.4}),this._eventsActive=!1,this._outlineEnabled=!0,this._outlinedMeshes={},this._invisibleMaterial=new e.MeshBasicMaterial({visible:!1}),this._tempMatrix=new e.Matrix4,this.config={selectName:"select",hoverName:"hover",selectionMaterial:new e.MeshBasicMaterial({color:"#BCF124",transparent:!0,opacity:.85,depthTest:!0}),hoverMaterial:new e.MeshBasicMaterial({color:"#6528D7",transparent:!0,opacity:.2,depthTest:!0}),autoHighlightOnClick:!0,cullHighlightMeshes:!0},this._mouseState={down:!1,moved:!1},this.onFragmentsDisposed=e=>{this.disposeOutlinedMeshes(e.fragmentIDs)},this.onSetup=new W,this.onMouseDown=()=>{this.enabled&&(this._mouseState.down=!0)},this.onMouseUp=async e=>{if(this.enabled&&e.target===this.components.renderer.get().domElement)if(this._mouseState.down=!1,this._mouseState.moved||0!==e.button)this._mouseState.moved=!1;else if(this._mouseState.moved=!1,this.config.autoHighlightOnClick){const t="none"===this.multiple||!e[this.multiple];await this.highlight(this.config.selectName,t,this.zoomToSelection)}},this.onMouseMove=async()=>{this.enabled&&(this._mouseState.moved?await this.clearFills(this.config.hoverName):(this._mouseState.moved=this._mouseState.down,await this.highlight(this.config.hoverName,!0,!1)))},this.components.tools.add(gt.uuid,this);t.tools.get(rt).onFragmentsDisposed.add(this.onFragmentsDisposed)}get(){return this.highlightMats}getHoveredSelection(){return this.selection[this.config.hoverName]}disposeOutlinedMeshes(e){for(const t of e){const e=this._outlinedMeshes[t];e&&(e.geometry.dispose(),delete this._outlinedMeshes[t])}}async dispose(){this.setupEvents(!1),this.config.hoverMaterial.dispose(),this.config.selectionMaterial.dispose(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset();for(const e in this.highlightMats){const t=this.highlightMats[e]||[];for(const e of t)e.dispose()}this.disposeOutlinedMeshes(Object.keys(this._outlinedMeshes)),this.outlineMaterial.dispose(),this._invisibleMaterial.dispose(),this.highlightMats={},this.selection={};for(const e in this.events)this.events[e].onClear.reset(),this.events[e].onHighlight.reset();this.onSetup.reset();this.components.tools.get(rt).onFragmentsDisposed.remove(this.onFragmentsDisposed),this.events={},await this.onDisposed.trigger(gt.uuid),this.onDisposed.reset()}async add(e,t){if(this.highlightMats[e])throw new Error("A highlight with this name already exists.");this.highlightMats[e]=t,this.selection[e]={},this.events[e]={onHighlight:new W,onClear:new W},await this.updateHighlight()}async updateHighlight(){if(!this.fillEnabled)return;await this.onBeforeUpdate.trigger(this);const e=this.components.tools.get(rt);for(const t in e.list){const s=e.list[t];this.addHighlightToFragment(s);const i=this._outlinedMeshes[t];i&&(s.mesh.updateMatrixWorld(!0),i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),i.applyMatrix4(s.mesh.matrixWorld))}await this.onAfterUpdate.trigger(this)}async highlight(e,t=!0,s=this.zoomToSelection){if(!this.enabled)return null;this.checkSelection(e);const i=this.components.tools.get(rt),n=[],o=i.meshes,r=this.components.raycaster.castRay(o);if(!r||!r.face)return await this.clear(e),null;const a=r.object,l=a.geometry,h=r.face.a,c=r.instanceId;if(!l||void 0===h||void 0===c)return null;t&&await this.clear(e),this.selection[e][a.fragment.id]||(this.selection[e][a.fragment.id]=new Set),n.push(a.fragment);const d=a.fragment.getItemID(c);if(null===d)throw new Error("Item ID not found!");this.selection[e][a.fragment.id].add(d),await this.regenerate(e,a.fragment.id);const u=a.fragment.group;if(u){const t=u.data.get(d);if(!t)throw new Error("Data not found!");const s=t[0];for(let t=0;t<s.length;t++){const o=s[t],r=u.keyFragments.get(o);if(!r)throw new Error("Fragment ID not found!");if(r===a.fragment.id)continue;const l=i.list[r];n.push(l),this.selection[e][r]||(this.selection[e][r]=new Set),this.selection[e][r].add(d),await this.regenerate(e,r)}}return await this.events[e].onHighlight.trigger(this.selection[e]),s&&await this.zoomSelection(e),{id:d,fragments:n}}async highlightByID(e,t,s=!0,i=this.zoomToSelection){if(!this.enabled)return;s&&await this.clear(e);const n=this.selection[e];for(const s in t){n[s]||(n[s]=new Set);for(const e of t[s])n[s].add(e);await this.regenerate(e,s)}await this.events[e].onHighlight.trigger(this.selection[e]),i&&await this.zoomSelection(e)}async clear(e){await this.clearFills(e),e&&this.excludeOutline.has(e)||await this.clearOutlines()}async setup(e){e?.selectionMaterial&&this.config.selectionMaterial.dispose(),e?.hoverMaterial&&this.config.hoverMaterial.dispose(),this.config={...this.config,...e},this.outlineMaterial.color.set(15794042),this.excludeOutline.add(this.config.hoverName),await this.add(this.config.selectName,[this.config.selectionMaterial]),await this.add(this.config.hoverName,[this.config.hoverMaterial]),this.setupEvents(!0),this.enabled=!0,this.isSetup=!0,await this.onSetup.trigger(this)}async regenerate(e,t){this.fillEnabled&&await this.updateFragmentFill(e,t),this._outlineEnabled&&await this.updateFragmentOutline(e,t)}async zoomSelection(e){if(!this.fillEnabled&&!this._outlineEnabled)return;const t=this.components.tools.get(Et),s=this.components.tools.get(rt);t.reset();const i=this.selection[e];if(!Object.keys(i).length)return;for(const n in i){const i=s.list[n];if(this.fillEnabled){const s=i.fragments[e];s&&t.addMesh(s.mesh)}this._outlineEnabled&&this._outlinedMeshes[n]&&t.addMesh(this._outlinedMeshes[n])}const n=t.getSphere(),o=1/0,r=-1/0,{x:a,y:l,z:h}=n.center,c=n.radius===o||a===o||l===o||h===o,d=n.radius===r||a===r||l===r||h===r,u=0===n.radius;if(c||d||u)return;n.radius*=this.zoomFactor;const p=this.components.camera;await p.controls.fitToSphere(n,!0)}async clearStyle(e){const t=this.components.tools.get(rt);for(const s in this.selection[e]){const i=t.list[s];if(!i)continue;const n=i.fragments[e];n&&n.mesh.removeFromParent()}await this.events[e].onClear.trigger(null),this.selection[e]={}}async updateFragmentFill(e,t){const s=this.components.tools.get(rt),i=this.selection[e][t],n=s.list[t];if(!n)return;const o=n.fragments[e];if(!o)return;const r=n.mesh.parent;r&&(r.add(o.mesh),o.setVisibility(!1),o.setVisibility(!0,i))}checkSelection(e){if(!this.selection[e])throw new Error(`Selection ${e} does not exist.`)}addHighlightToFragment(e){for(const t in this.highlightMats)if(!e.fragments[t]){const s=this.highlightMats[t],i=e.addFragment(t,s);i.group=e.group,i.mesh.renderOrder=2,i.mesh.frustumCulled=!1}}async clearFills(e){const t=e?[e]:Object.keys(this.selection);for(const e of t)await this.clearStyle(e)}async clearOutlines(){const e=this._postproduction.customEffects.outlinedMeshes.fragments;e&&e.meshes.clear();for(const e in this._outlinedMeshes){this._outlinedMeshes[e].count=0}}async updateFragmentOutline(t,s){const i=this.components.tools.get(rt);if(!this.selection[t][s])return;if(this.excludeOutline.has(t))return;const n=this.selection[t][s],o=i.list[s];if(!o)return;const r=o.mesh.geometry,a=this._postproduction.customEffects;a.outlinedMeshes.fragments||(a.outlinedMeshes.fragments={meshes:new Set,material:this.outlineMaterial});const l=a.outlinedMeshes.fragments;if(!this._outlinedMeshes[s]){const t=new e.BufferGeometry;t.attributes=r.attributes,t.index=r.index;const i=new e.InstancedMesh(t,this._invisibleMaterial,o.capacity);i.frustumCulled=!1,i.renderOrder=999,o.mesh.updateMatrixWorld(!0),i.applyMatrix4(o.mesh.matrixWorld),this._outlinedMeshes[s]=i;this.components.scene.get().add(i)}const h=this._outlinedMeshes[s];l.meshes.add(h);let c=0;for(const e of n){const t=o.getInstancesIDs(e);if(!t)throw new Error("Instances IDs not found!");for(const e of t)o.mesh.getMatrixAt(e,this._tempMatrix),h.setMatrixAt(c++,this._tempMatrix)}h.count=c,h.instanceMatrix.needsUpdate=!0}setupEvents(e){const t=this.components.renderer.get().domElement;e!==this._eventsActive&&(this._eventsActive=e,e?(t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("mouseup",this.onMouseUp),t.addEventListener("mousemove",this.onMouseMove)):(t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("mousemove",this.onMouseMove)))}}gt.uuid="cb8a76f2-654a-4b50-80c6-66fd83cafd77",Z.libraryUUIDs.add(gt.uuid);const It={103090709:"IFCPROJECT",4097777520:"IFCSITE",4031249490:"IFCBUILDING",3124254112:"IFCBUILDINGSTOREY",3856911033:"IFCSPACE",1674181508:"IFCANNOTATION",25142252:"IFCCONTROLLER",32344328:"IFCBOILER",76236018:"IFCLAMP",90941305:"IFCPUMP",177149247:"IFCAIRTERMINALBOX",182646315:"IFCFLOWINSTRUMENT",263784265:"IFCFURNISHINGELEMENT",264262732:"IFCELECTRICGENERATOR",277319702:"IFCAUDIOVISUALAPPLIANCE",310824031:"IFCPIPEFITTING",331165859:"IFCSTAIR",342316401:"IFCDUCTFITTING",377706215:"IFCMECHANICALFASTENER",395920057:"IFCDOOR",402227799:"IFCELECTRICMOTOR",413509423:"IFCSYSTEMFURNITUREELEMENT",484807127:"IFCEVAPORATOR",486154966:"IFCWINDOWSTANDARDCASE",629592764:"IFCLIGHTFIXTURE",630975310:"IFCUNITARYCONTROLELEMENT",635142910:"IFCCABLECARRIERFITTING",639361253:"IFCCOIL",647756555:"IFCFASTENER",707683696:"IFCFLOWSTORAGEDEVICE",738039164:"IFCPROTECTIVEDEVICE",753842376:"IFCBEAM",812556717:"IFCTANK",819412036:"IFCFILTER",843113511:"IFCCOLUMN",862014818:"IFCELECTRICDISTRIBUTIONBOARD",900683007:"IFCFOOTING",905975707:"IFCCOLUMNSTANDARDCASE",926996030:"IFCVOIDINGFEATURE",979691226:"IFCREINFORCINGBAR",987401354:"IFCFLOWSEGMENT",1003880860:"IFCELECTRICTIMECONTROL",1051757585:"IFCCABLEFITTING",1052013943:"IFCDISTRIBUTIONCHAMBERELEMENT",1062813311:"IFCDISTRIBUTIONCONTROLELEMENT",1073191201:"IFCMEMBER",1095909175:"IFCBUILDINGELEMENTPROXY",1156407060:"IFCPLATESTANDARDCASE",1162798199:"IFCSWITCHINGDEVICE",1329646415:"IFCSHADINGDEVICE",1335981549:"IFCDISCRETEACCESSORY",1360408905:"IFCDUCTSILENCER",1404847402:"IFCSTACKTERMINAL",1426591983:"IFCFIRESUPPRESSIONTERMINAL",1437502449:"IFCMEDICALDEVICE",1509553395:"IFCFURNITURE",1529196076:"IFCSLAB",1620046519:"IFCTRANSPORTELEMENT",1634111441:"IFCAIRTERMINAL",1658829314:"IFCENERGYCONVERSIONDEVICE",1677625105:"IFCCIVILELEMENT",1687234759:"IFCPILE",1904799276:"IFCELECTRICAPPLIANCE",1911478936:"IFCMEMBERSTANDARDCASE",1945004755:"IFCDISTRIBUTIONELEMENT",1973544240:"IFCCOVERING",1999602285:"IFCSPACEHEATER",2016517767:"IFCROOF",2056796094:"IFCAIRTOAIRHEATRECOVERY",2058353004:"IFCFLOWCONTROLLER",2068733104:"IFCHUMIDIFIER",2176052936:"IFCJUNCTIONBOX",2188021234:"IFCFLOWMETER",2223149337:"IFCFLOWTERMINAL",2262370178:"IFCRAILING",2272882330:"IFCCONDENSER",2295281155:"IFCPROTECTIVEDEVICETRIPPINGUNIT",2320036040:"IFCREINFORCINGMESH",2347447852:"IFCTENDONANCHOR",2391383451:"IFCVIBRATIONISOLATOR",2391406946:"IFCWALL",2474470126:"IFCMOTORCONNECTION",2769231204:"IFCVIRTUALELEMENT",2814081492:"IFCENGINE",2906023776:"IFCBEAMSTANDARDCASE",2938176219:"IFCBURNER",2979338954:"IFCBUILDINGELEMENTPART",3024970846:"IFCRAMP",3026737570:"IFCTUBEBUNDLE",3027962421:"IFCSLABSTANDARDCASE",3040386961:"IFCDISTRIBUTIONFLOWELEMENT",3053780830:"IFCSANITARYTERMINAL",3079942009:"IFCOPENINGSTANDARDCASE",3087945054:"IFCALARM",3101698114:"IFCSURFACEFEATURE",3127900445:"IFCSLABELEMENTEDCASE",3132237377:"IFCFLOWMOVINGDEVICE",3171933400:"IFCPLATE",3221913625:"IFCCOMMUNICATIONSAPPLIANCE",3242481149:"IFCDOORSTANDARDCASE",3283111854:"IFCRAMPFLIGHT",3296154744:"IFCCHIMNEY",3304561284:"IFCWINDOW",3310460725:"IFCELECTRICFLOWSTORAGEDEVICE",3319311131:"IFCHEATEXCHANGER",3415622556:"IFCFAN",3420628829:"IFCSOLARDEVICE",3493046030:"IFCGEOGRAPHICELEMENT",3495092785:"IFCCURTAINWALL",3508470533:"IFCFLOWTREATMENTDEVICE",3512223829:"IFCWALLSTANDARDCASE",3518393246:"IFCDUCTSEGMENT",3571504051:"IFCCOMPRESSOR",3588315303:"IFCOPENINGELEMENT",3612865200:"IFCPIPESEGMENT",3640358203:"IFCCOOLINGTOWER",3651124850:"IFCPROJECTIONELEMENT",3694346114:"IFCOUTLET",3747195512:"IFCEVAPORATIVECOOLER",3758799889:"IFCCABLECARRIERSEGMENT",3824725483:"IFCTENDON",3825984169:"IFCTRANSFORMER",3902619387:"IFCCHILLER",4074379575:"IFCDAMPER",4086658281:"IFCSENSOR",4123344466:"IFCELEMENTASSEMBLY",4136498852:"IFCCOOLEDBEAM",4156078855:"IFCWALLELEMENTEDCASE",4175244083:"IFCINTERCEPTOR",4207607924:"IFCVALVE",4217484030:"IFCCABLESEGMENT",4237592921:"IFCWASTETERMINAL",4252922144:"IFCSTAIRFLIGHT",4278956645:"IFCFLOWFITTING",4288193352:"IFCACTUATOR",4292641817:"IFCUNITARYEQUIPMENT",3009204131:"IFCGRID"};class Ct{getAll(e,t){const s={},i=Object.keys(It).map((e=>parseInt(e,10)));for(let n=0;n<i.length;n++){const o=i[n],r=e.GetLineIDsWithType(t,o),a=r.size();for(let e=0;e<a;e++)s[r.get(e)]=o}return s}}const ft={950732822:"IFCURIREFERENCE",4075327185:"IFCTIME",1209108979:"IFCTEMPERATURERATEOFCHANGEMEASURE",3457685358:"IFCSOUNDPRESSURELEVELMEASURE",4157543285:"IFCSOUNDPOWERLEVELMEASURE",2798247006:"IFCPROPERTYSETDEFINITIONSET",1790229001:"IFCPOSITIVEINTEGER",525895558:"IFCNONNEGATIVELENGTHMEASURE",1774176899:"IFCLINEINDEX",1275358634:"IFCLANGUAGEID",2541165894:"IFCDURATION",3701338814:"IFCDAYINWEEKNUMBER",2195413836:"IFCDATETIME",937566702:"IFCDATE",1683019596:"IFCCARDINALPOINTREFERENCE",2314439260:"IFCBINARY",1500781891:"IFCAREADENSITYMEASURE",3683503648:"IFCARCINDEX",4065007721:"IFCYEARNUMBER",1718600412:"IFCWARPINGMOMENTMEASURE",51269191:"IFCWARPINGCONSTANTMEASURE",2593997549:"IFCVOLUMETRICFLOWRATEMEASURE",3458127941:"IFCVOLUMEMEASURE",3345633955:"IFCVAPORPERMEABILITYMEASURE",1278329552:"IFCTORQUEMEASURE",2591213694:"IFCTIMESTAMP",2726807636:"IFCTIMEMEASURE",743184107:"IFCTHERMODYNAMICTEMPERATUREMEASURE",2016195849:"IFCTHERMALTRANSMITTANCEMEASURE",857959152:"IFCTHERMALRESISTANCEMEASURE",2281867870:"IFCTHERMALEXPANSIONCOEFFICIENTMEASURE",2645777649:"IFCTHERMALCONDUCTIVITYMEASURE",232962298:"IFCTHERMALADMITTANCEMEASURE",296282323:"IFCTEXTTRANSFORMATION",603696268:"IFCTEXTFONTNAME",3490877962:"IFCTEXTDECORATION",1460886941:"IFCTEXTALIGNMENT",2801250643:"IFCTEXT",58845555:"IFCTEMPERATUREGRADIENTMEASURE",361837227:"IFCSPECULARROUGHNESS",2757832317:"IFCSPECULAREXPONENT",3477203348:"IFCSPECIFICHEATCAPACITYMEASURE",993287707:"IFCSOUNDPRESSUREMEASURE",846465480:"IFCSOUNDPOWERMEASURE",3471399674:"IFCSOLIDANGLEMEASURE",408310005:"IFCSHEARMODULUSMEASURE",2190458107:"IFCSECTIONALAREAINTEGRALMEASURE",3467162246:"IFCSECTIONMODULUSMEASURE",2766185779:"IFCSECONDINMINUTE",3211557302:"IFCROTATIONALSTIFFNESSMEASURE",1755127002:"IFCROTATIONALMASSMEASURE",2133746277:"IFCROTATIONALFREQUENCYMEASURE",200335297:"IFCREAL",96294661:"IFCRATIOMEASURE",3972513137:"IFCRADIOACTIVITYMEASURE",3665567075:"IFCPRESSUREMEASURE",2169031380:"IFCPRESENTABLETEXT",1364037233:"IFCPOWERMEASURE",1245737093:"IFCPOSITIVERATIOMEASURE",3054510233:"IFCPOSITIVEPLANEANGLEMEASURE",2815919920:"IFCPOSITIVELENGTHMEASURE",4042175685:"IFCPLANEANGLEMEASURE",2642773653:"IFCPLANARFORCEMEASURE",2260317790:"IFCPARAMETERVALUE",929793134:"IFCPHMEASURE",2395907400:"IFCNUMERICMEASURE",2095195183:"IFCNORMALISEDRATIOMEASURE",765770214:"IFCMONTHINYEARNUMBER",2615040989:"IFCMONETARYMEASURE",3114022597:"IFCMOMENTOFINERTIAMEASURE",1648970520:"IFCMOLECULARWEIGHTMEASURE",3177669450:"IFCMOISTUREDIFFUSIVITYMEASURE",1753493141:"IFCMODULUSOFSUBGRADEREACTIONMEASURE",1052454078:"IFCMODULUSOFROTATIONALSUBGRADEREACTIONMEASURE",2173214787:"IFCMODULUSOFLINEARSUBGRADEREACTIONMEASURE",3341486342:"IFCMODULUSOFELASTICITYMEASURE",102610177:"IFCMINUTEINHOUR",3531705166:"IFCMASSPERLENGTHMEASURE",3124614049:"IFCMASSMEASURE",4017473158:"IFCMASSFLOWRATEMEASURE",1477762836:"IFCMASSDENSITYMEASURE",2486716878:"IFCMAGNETICFLUXMEASURE",286949696:"IFCMAGNETICFLUXDENSITYMEASURE",151039812:"IFCLUMINOUSINTENSITYMEASURE",2755797622:"IFCLUMINOUSINTENSITYDISTRIBUTIONMEASURE",2095003142:"IFCLUMINOUSFLUXMEASURE",503418787:"IFCLOGICAL",3086160713:"IFCLINEARVELOCITYMEASURE",1307019551:"IFCLINEARSTIFFNESSMEASURE",2128979029:"IFCLINEARMOMENTMEASURE",191860431:"IFCLINEARFORCEMEASURE",1243674935:"IFCLENGTHMEASURE",3258342251:"IFCLABEL",2054016361:"IFCKINEMATICVISCOSITYMEASURE",3192672207:"IFCISOTHERMALMOISTURECAPACITYMEASURE",3686016028:"IFCIONCONCENTRATIONMEASURE",3809634241:"IFCINTEGERCOUNTRATEMEASURE",1939436016:"IFCINTEGER",2679005408:"IFCINDUCTANCEMEASURE",3358199106:"IFCILLUMINANCEMEASURE",983778844:"IFCIDENTIFIER",2589826445:"IFCHOURINDAY",1158859006:"IFCHEATINGVALUEMEASURE",3113092358:"IFCHEATFLUXDENSITYMEASURE",3064340077:"IFCGLOBALLYUNIQUEID",3044325142:"IFCFREQUENCYMEASURE",1361398929:"IFCFORCEMEASURE",2590844177:"IFCFONTWEIGHT",2715512545:"IFCFONTVARIANT",1102727119:"IFCFONTSTYLE",2078135608:"IFCENERGYMEASURE",2506197118:"IFCELECTRICVOLTAGEMEASURE",2951915441:"IFCELECTRICRESISTANCEMEASURE",3790457270:"IFCELECTRICCURRENTMEASURE",2093906313:"IFCELECTRICCONDUCTANCEMEASURE",3818826038:"IFCELECTRICCHARGEMEASURE",1827137117:"IFCELECTRICCAPACITANCEMEASURE",69416015:"IFCDYNAMICVISCOSITYMEASURE",524656162:"IFCDOSEEQUIVALENTMEASURE",4134073009:"IFCDIMENSIONCOUNT",1514641115:"IFCDESCRIPTIVEMEASURE",300323983:"IFCDAYLIGHTSAVINGHOUR",86635668:"IFCDAYINMONTHNUMBER",94842927:"IFCCURVATUREMEASURE",1778710042:"IFCCOUNTMEASURE",3238673880:"IFCCONTEXTDEPENDENTMEASURE",3812528620:"IFCCOMPOUNDPLANEANGLEMEASURE",2991860651:"IFCCOMPLEXNUMBER",1867003952:"IFCBOXALIGNMENT",2735952531:"IFCBOOLEAN",2650437152:"IFCAREAMEASURE",632304761:"IFCANGULARVELOCITYMEASURE",360377573:"IFCAMOUNTOFSUBSTANCEMEASURE",4182062534:"IFCACCELERATIONMEASURE",3699917729:"IFCABSORBEDDOSEMEASURE",1971632696:"IFCGEOSLICE",2680139844:"IFCGEOMODEL",24726584:"IFCELECTRICFLOWTREATMENTDEVICE",3693000487:"IFCDISTRIBUTIONBOARD",3460952963:"IFCCONVEYORSEGMENT",3999819293:"IFCCAISSONFOUNDATION",3314249567:"IFCBOREHOLE",4196446775:"IFCBEARING",325726236:"IFCALIGNMENT",3425753595:"IFCTRACKELEMENT",991950508:"IFCSIGNAL",3798194928:"IFCREINFORCEDSOIL",3290496277:"IFCRAIL",1383356374:"IFCPAVEMENT",2182337498:"IFCNAVIGATIONELEMENT",234836483:"IFCMOORINGDEVICE",2078563270:"IFCMOBILETELECOMMUNICATIONSAPPLIANCE",1638804497:"IFCLIQUIDTERMINAL",1154579445:"IFCLINEARPOSITIONINGELEMENT",2696325953:"IFCKERB",2713699986:"IFCGEOTECHNICALASSEMBLY",2142170206:"IFCELECTRICFLOWTREATMENTDEVICETYPE",3376911765:"IFCEARTHWORKSFILL",1077100507:"IFCEARTHWORKSELEMENT",3071239417:"IFCEARTHWORKSCUT",479945903:"IFCDISTRIBUTIONBOARDTYPE",3426335179:"IFCDEEPFOUNDATION",1502416096:"IFCCOURSE",2940368186:"IFCCONVEYORSEGMENTTYPE",3203706013:"IFCCAISSONFOUNDATIONTYPE",3862327254:"IFCBUILTSYSTEM",1876633798:"IFCBUILTELEMENT",963979645:"IFCBRIDGEPART",644574406:"IFCBRIDGE",3649138523:"IFCBEARINGTYPE",1662888072:"IFCALIGNMENTVERTICAL",317615605:"IFCALIGNMENTSEGMENT",1545765605:"IFCALIGNMENTHORIZONTAL",4266260250:"IFCALIGNMENTCANT",3956297820:"IFCVIBRATIONDAMPERTYPE",1530820697:"IFCVIBRATIONDAMPER",840318589:"IFCVEHICLE",1953115116:"IFCTRANSPORTATIONDEVICE",618700268:"IFCTRACKELEMENTTYPE",2281632017:"IFCTENDONCONDUITTYPE",3663046924:"IFCTENDONCONDUIT",42703149:"IFCSINESPIRAL",1894708472:"IFCSIGNALTYPE",3599934289:"IFCSIGNTYPE",33720170:"IFCSIGN",1027922057:"IFCSEVENTHORDERPOLYNOMIALSPIRAL",544395925:"IFCSEGMENTEDREFERENCECURVE",3649235739:"IFCSECONDORDERPOLYNOMIALSPIRAL",550521510:"IFCROADPART",146592293:"IFCROAD",3818125796:"IFCRELADHERESTOELEMENT",4021432810:"IFCREFERENT",1891881377:"IFCRAILWAYPART",3992365140:"IFCRAILWAY",1763565496:"IFCRAILTYPE",1946335990:"IFCPOSITIONINGELEMENT",514975943:"IFCPAVEMENTTYPE",506776471:"IFCNAVIGATIONELEMENTTYPE",710110818:"IFCMOORINGDEVICETYPE",1950438474:"IFCMOBILETELECOMMUNICATIONSAPPLIANCETYPE",976884017:"IFCMARINEPART",525669439:"IFCMARINEFACILITY",1770583370:"IFCLIQUIDTERMINALTYPE",2176059722:"IFCLINEARELEMENT",679976338:"IFCKERBTYPE",3948183225:"IFCIMPACTPROTECTIONDEVICETYPE",2568555532:"IFCIMPACTPROTECTIONDEVICE",2898700619:"IFCGRADIENTCURVE",1594536857:"IFCGEOTECHNICALSTRATUM",4230923436:"IFCGEOTECHNICALELEMENT",4228831410:"IFCFACILITYPARTCOMMON",1310830890:"IFCFACILITYPART",24185140:"IFCFACILITY",4234616927:"IFCDIRECTRIXDERIVEDREFERENCESWEPTAREASOLID",1306400036:"IFCDEEPFOUNDATIONTYPE",4189326743:"IFCCOURSETYPE",2000195564:"IFCCOSINESPIRAL",3497074424:"IFCCLOTHOID",1626504194:"IFCBUILTELEMENTTYPE",3651464721:"IFCVEHICLETYPE",1229763772:"IFCTRIANGULATEDIRREGULARNETWORK",3665877780:"IFCTRANSPORTATIONDEVICETYPE",782932809:"IFCTHIRDORDERPOLYNOMIALSPIRAL",2735484536:"IFCSPIRAL",1356537516:"IFCSECTIONEDSURFACE",1290935644:"IFCSECTIONEDSOLIDHORIZONTAL",1862484736:"IFCSECTIONEDSOLID",1441486842:"IFCRELPOSITIONS",1033248425:"IFCRELASSOCIATESPROFILEDEF",3381221214:"IFCPOLYNOMIALCURVE",2485787929:"IFCOFFSETCURVEBYDISTANCES",590820931:"IFCOFFSETCURVE",3465909080:"IFCINDEXEDPOLYGONALTEXTUREMAP",593015953:"IFCDIRECTRIXCURVESWEPTAREASOLID",4212018352:"IFCCURVESEGMENT",3425423356:"IFCAXIS2PLACEMENTLINEAR",823603102:"IFCSEGMENT",2165702409:"IFCPOINTBYDISTANCEEXPRESSION",182550632:"IFCOPENCROSSPROFILEDEF",388784114:"IFCLINEARPLACEMENT",536804194:"IFCALIGNMENTHORIZONTALSEGMENT",3752311538:"IFCALIGNMENTCANTSEGMENT",1010789467:"IFCTEXTURECOORDINATEINDICESWITHVOIDS",222769930:"IFCTEXTURECOORDINATEINDICES",2691318326:"IFCQUANTITYNUMBER",3633395639:"IFCALIGNMENTVERTICALSEGMENT",2879124712:"IFCALIGNMENTPARAMETERSEGMENT",25142252:"IFCCONTROLLER",3087945054:"IFCALARM",4288193352:"IFCACTUATOR",630975310:"IFCUNITARYCONTROLELEMENT",4086658281:"IFCSENSOR",2295281155:"IFCPROTECTIVEDEVICETRIPPINGUNIT",182646315:"IFCFLOWINSTRUMENT",1426591983:"IFCFIRESUPPRESSIONTERMINAL",819412036:"IFCFILTER",3415622556:"IFCFAN",1003880860:"IFCELECTRICTIMECONTROL",402227799:"IFCELECTRICMOTOR",264262732:"IFCELECTRICGENERATOR",3310460725:"IFCELECTRICFLOWSTORAGEDEVICE",862014818:"IFCELECTRICDISTRIBUTIONBOARD",1904799276:"IFCELECTRICAPPLIANCE",1360408905:"IFCDUCTSILENCER",3518393246:"IFCDUCTSEGMENT",342316401:"IFCDUCTFITTING",562808652:"IFCDISTRIBUTIONCIRCUIT",4074379575:"IFCDAMPER",3640358203:"IFCCOOLINGTOWER",4136498852:"IFCCOOLEDBEAM",2272882330:"IFCCONDENSER",3571504051:"IFCCOMPRESSOR",3221913625:"IFCCOMMUNICATIONSAPPLIANCE",639361253:"IFCCOIL",3902619387:"IFCCHILLER",4217484030:"IFCCABLESEGMENT",1051757585:"IFCCABLEFITTING",3758799889:"IFCCABLECARRIERSEGMENT",635142910:"IFCCABLECARRIERFITTING",2938176219:"IFCBURNER",32344328:"IFCBOILER",2906023776:"IFCBEAMSTANDARDCASE",277319702:"IFCAUDIOVISUALAPPLIANCE",2056796094:"IFCAIRTOAIRHEATRECOVERY",177149247:"IFCAIRTERMINALBOX",1634111441:"IFCAIRTERMINAL",486154966:"IFCWINDOWSTANDARDCASE",4237592921:"IFCWASTETERMINAL",4156078855:"IFCWALLELEMENTEDCASE",4207607924:"IFCVALVE",4292641817:"IFCUNITARYEQUIPMENT",3179687236:"IFCUNITARYCONTROLELEMENTTYPE",3026737570:"IFCTUBEBUNDLE",3825984169:"IFCTRANSFORMER",812556717:"IFCTANK",1162798199:"IFCSWITCHINGDEVICE",385403989:"IFCSTRUCTURALLOADCASE",1404847402:"IFCSTACKTERMINAL",1999602285:"IFCSPACEHEATER",3420628829:"IFCSOLARDEVICE",3027962421:"IFCSLABSTANDARDCASE",3127900445:"IFCSLABELEMENTEDCASE",1329646415:"IFCSHADINGDEVICE",3053780830:"IFCSANITARYTERMINAL",2572171363:"IFCREINFORCINGBARTYPE",1232101972:"IFCRATIONALBSPLINECURVEWITHKNOTS",90941305:"IFCPUMP",655969474:"IFCPROTECTIVEDEVICETRIPPINGUNITTYPE",738039164:"IFCPROTECTIVEDEVICE",1156407060:"IFCPLATESTANDARDCASE",3612865200:"IFCPIPESEGMENT",310824031:"IFCPIPEFITTING",3694346114:"IFCOUTLET",144952367:"IFCOUTERBOUNDARYCURVE",2474470126:"IFCMOTORCONNECTION",1911478936:"IFCMEMBERSTANDARDCASE",1437502449:"IFCMEDICALDEVICE",629592764:"IFCLIGHTFIXTURE",76236018:"IFCLAMP",2176052936:"IFCJUNCTIONBOX",4175244083:"IFCINTERCEPTOR",2068733104:"IFCHUMIDIFIER",3319311131:"IFCHEATEXCHANGER",2188021234:"IFCFLOWMETER",1209101575:"IFCEXTERNALSPATIALELEMENT",484807127:"IFCEVAPORATOR",3747195512:"IFCEVAPORATIVECOOLER",2814081492:"IFCENGINE",2417008758:"IFCELECTRICDISTRIBUTIONBOARDTYPE",3242481149:"IFCDOORSTANDARDCASE",3205830791:"IFCDISTRIBUTIONSYSTEM",400855858:"IFCCOMMUNICATIONSAPPLIANCETYPE",905975707:"IFCCOLUMNSTANDARDCASE",1677625105:"IFCCIVILELEMENT",3296154744:"IFCCHIMNEY",2674252688:"IFCCABLEFITTINGTYPE",2188180465:"IFCBURNERTYPE",1177604601:"IFCBUILDINGSYSTEM",39481116:"IFCBUILDINGELEMENTPARTTYPE",1136057603:"IFCBOUNDARYCURVE",2461110595:"IFCBSPLINECURVEWITHKNOTS",1532957894:"IFCAUDIOVISUALAPPLIANCETYPE",4088093105:"IFCWORKCALENDAR",4009809668:"IFCWINDOWTYPE",926996030:"IFCVOIDINGFEATURE",2391383451:"IFCVIBRATIONISOLATOR",2415094496:"IFCTENDONTYPE",3081323446:"IFCTENDONANCHORTYPE",413509423:"IFCSYSTEMFURNITUREELEMENT",3101698114:"IFCSURFACEFEATURE",3657597509:"IFCSTRUCTURALSURFACEACTION",2757150158:"IFCSTRUCTURALCURVEREACTION",1004757350:"IFCSTRUCTURALCURVEACTION",338393293:"IFCSTAIRTYPE",1072016465:"IFCSOLARDEVICETYPE",4074543187:"IFCSHADINGDEVICETYPE",2157484638:"IFCSEAMCURVE",2781568857:"IFCROOFTYPE",2310774935:"IFCREINFORCINGMESHTYPE",964333572:"IFCREINFORCINGELEMENTTYPE",683857671:"IFCRATIONALBSPLINESURFACEWITHKNOTS",1469900589:"IFCRAMPTYPE",2839578677:"IFCPOLYGONALFACESET",1158309216:"IFCPILETYPE",3079942009:"IFCOPENINGSTANDARDCASE",1114901282:"IFCMEDICALDEVICETYPE",3113134337:"IFCINTERSECTIONCURVE",3946677679:"IFCINTERCEPTORTYPE",2571569899:"IFCINDEXEDPOLYCURVE",3493046030:"IFCGEOGRAPHICELEMENT",1509553395:"IFCFURNITURE",1893162501:"IFCFOOTINGTYPE",2853485674:"IFCEXTERNALSPATIALSTRUCTUREELEMENT",4148101412:"IFCEVENT",132023988:"IFCENGINETYPE",2397081782:"IFCELEMENTASSEMBLYTYPE",2323601079:"IFCDOORTYPE",1213902940:"IFCCYLINDRICALSURFACE",1525564444:"IFCCONSTRUCTIONPRODUCTRESOURCETYPE",4105962743:"IFCCONSTRUCTIONMATERIALRESOURCETYPE",2185764099:"IFCCONSTRUCTIONEQUIPMENTRESOURCETYPE",15328376:"IFCCOMPOSITECURVEONSURFACE",3875453745:"IFCCOMPLEXPROPERTYTEMPLATE",3893394355:"IFCCIVILELEMENTTYPE",2197970202:"IFCCHIMNEYTYPE",167062518:"IFCBSPLINESURFACEWITHKNOTS",2887950389:"IFCBSPLINESURFACE",2603310189:"IFCADVANCEDBREPWITHVOIDS",1635779807:"IFCADVANCEDBREP",2916149573:"IFCTRIANGULATEDFACESET",1935646853:"IFCTOROIDALSURFACE",2387106220:"IFCTESSELLATEDFACESET",3206491090:"IFCTASKTYPE",699246055:"IFCSURFACECURVE",4095615324:"IFCSUBCONTRACTRESOURCETYPE",603775116:"IFCSTRUCTURALSURFACEREACTION",4015995234:"IFCSPHERICALSURFACE",2481509218:"IFCSPATIALZONETYPE",463610769:"IFCSPATIALZONE",710998568:"IFCSPATIALELEMENTTYPE",1412071761:"IFCSPATIALELEMENT",3663146110:"IFCSIMPLEPROPERTYTEMPLATE",3243963512:"IFCREVOLVEDAREASOLIDTAPERED",816062949:"IFCREPARAMETRISEDCOMPOSITECURVESEGMENT",1521410863:"IFCRELSPACEBOUNDARY2NDLEVEL",3523091289:"IFCRELSPACEBOUNDARY1STLEVEL",427948657:"IFCRELINTERFERESELEMENTS",307848117:"IFCRELDEFINESBYTEMPLATE",1462361463:"IFCRELDEFINESBYOBJECT",2565941209:"IFCRELDECLARES",1027710054:"IFCRELASSIGNSTOGROUPBYFACTOR",3521284610:"IFCPROPERTYTEMPLATE",492091185:"IFCPROPERTYSETTEMPLATE",653396225:"IFCPROJECTLIBRARY",569719735:"IFCPROCEDURETYPE",3967405729:"IFCPREDEFINEDPROPERTYSET",1682466193:"IFCPCURVE",428585644:"IFCLABORRESOURCETYPE",2294589976:"IFCINDEXEDPOLYGONALFACEWITHVOIDS",178912537:"IFCINDEXEDPOLYGONALFACE",4095422895:"IFCGEOGRAPHICELEMENTTYPE",2652556860:"IFCFIXEDREFERENCESWEPTAREASOLID",2804161546:"IFCEXTRUDEDAREASOLIDTAPERED",4024345920:"IFCEVENTTYPE",2629017746:"IFCCURVEBOUNDEDSURFACE",1815067380:"IFCCREWRESOURCETYPE",3419103109:"IFCCONTEXT",2574617495:"IFCCONSTRUCTIONRESOURCETYPE",2059837836:"IFCCARTESIANPOINTLIST3D",1675464909:"IFCCARTESIANPOINTLIST2D",574549367:"IFCCARTESIANPOINTLIST",3406155212:"IFCADVANCEDFACE",3698973494:"IFCTYPERESOURCE",3736923433:"IFCTYPEPROCESS",901063453:"IFCTESSELLATEDITEM",1096409881:"IFCSWEPTDISKSOLIDPOLYGONAL",1042787934:"IFCRESOURCETIME",1608871552:"IFCRESOURCECONSTRAINTRELATIONSHIP",2943643501:"IFCRESOURCEAPPROVALRELATIONSHIP",2090586900:"IFCQUANTITYSET",1482703590:"IFCPROPERTYTEMPLATEDEFINITION",3778827333:"IFCPREDEFINEDPROPERTIES",2998442950:"IFCMIRROREDPROFILEDEF",853536259:"IFCMATERIALRELATIONSHIP",3404854881:"IFCMATERIALPROFILESETUSAGETAPERING",3079605661:"IFCMATERIALPROFILESETUSAGE",2852063980:"IFCMATERIALCONSTITUENTSET",3708119e3:"IFCMATERIALCONSTITUENT",1585845231:"IFCLAGTIME",2133299955:"IFCINDEXEDTRIANGLETEXTUREMAP",1437953363:"IFCINDEXEDTEXTUREMAP",3570813810:"IFCINDEXEDCOLOURMAP",1437805879:"IFCEXTERNALREFERENCERELATIONSHIP",297599258:"IFCEXTENDEDPROPERTIES",211053100:"IFCEVENTTIME",2713554722:"IFCCONVERSIONBASEDUNITWITHOFFSET",3285139300:"IFCCOLOURRGBLIST",1236880293:"IFCWORKTIME",1199560280:"IFCTIMEPERIOD",3611470254:"IFCTEXTUREVERTEXLIST",2771591690:"IFCTASKTIMERECURRING",1549132990:"IFCTASKTIME",2043862942:"IFCTABLECOLUMN",2934153892:"IFCSURFACEREINFORCEMENTAREA",609421318:"IFCSTRUCTURALLOADORRESULT",3478079324:"IFCSTRUCTURALLOADCONFIGURATION",1054537805:"IFCSCHEDULINGTIME",2439245199:"IFCRESOURCELEVELRELATIONSHIP",2433181523:"IFCREFERENCE",3915482550:"IFCRECURRENCEPATTERN",986844984:"IFCPROPERTYABSTRACTION",3843373140:"IFCPROJECTEDCRS",677532197:"IFCPRESENTATIONITEM",1507914824:"IFCMATERIALUSAGEDEFINITION",552965576:"IFCMATERIALPROFILEWITHOFFSETS",164193824:"IFCMATERIALPROFILESET",2235152071:"IFCMATERIALPROFILE",1847252529:"IFCMATERIALLAYERWITHOFFSETS",760658860:"IFCMATERIALDEFINITION",3057273783:"IFCMAPCONVERSION",4294318154:"IFCEXTERNALINFORMATION",1466758467:"IFCCOORDINATEREFERENCESYSTEM",1785450214:"IFCCOORDINATEOPERATION",775493141:"IFCCONNECTIONVOLUMEGEOMETRY",979691226:"IFCREINFORCINGBAR",3700593921:"IFCELECTRICDISTRIBUTIONPOINT",1062813311:"IFCDISTRIBUTIONCONTROLELEMENT",1052013943:"IFCDISTRIBUTIONCHAMBERELEMENT",578613899:"IFCCONTROLLERTYPE",2454782716:"IFCCHAMFEREDGEFEATURE",753842376:"IFCBEAM",3001207471:"IFCALARMTYPE",2874132201:"IFCACTUATORTYPE",3304561284:"IFCWINDOW",3512223829:"IFCWALLSTANDARDCASE",2391406946:"IFCWALL",3313531582:"IFCVIBRATIONISOLATORTYPE",2347447852:"IFCTENDONANCHOR",3824725483:"IFCTENDON",2515109513:"IFCSTRUCTURALANALYSISMODEL",4252922144:"IFCSTAIRFLIGHT",331165859:"IFCSTAIR",1529196076:"IFCSLAB",1783015770:"IFCSENSORTYPE",1376911519:"IFCROUNDEDEDGEFEATURE",2016517767:"IFCROOF",2320036040:"IFCREINFORCINGMESH",3027567501:"IFCREINFORCINGELEMENT",3055160366:"IFCRATIONALBEZIERCURVE",3283111854:"IFCRAMPFLIGHT",3024970846:"IFCRAMP",2262370178:"IFCRAILING",3171933400:"IFCPLATE",1687234759:"IFCPILE",1073191201:"IFCMEMBER",900683007:"IFCFOOTING",3508470533:"IFCFLOWTREATMENTDEVICE",2223149337:"IFCFLOWTERMINAL",707683696:"IFCFLOWSTORAGEDEVICE",987401354:"IFCFLOWSEGMENT",3132237377:"IFCFLOWMOVINGDEVICE",4037862832:"IFCFLOWINSTRUMENTTYPE",4278956645:"IFCFLOWFITTING",2058353004:"IFCFLOWCONTROLLER",4222183408:"IFCFIRESUPPRESSIONTERMINALTYPE",1810631287:"IFCFILTERTYPE",346874300:"IFCFANTYPE",1658829314:"IFCENERGYCONVERSIONDEVICE",857184966:"IFCELECTRICALELEMENT",1634875225:"IFCELECTRICALCIRCUIT",712377611:"IFCELECTRICTIMECONTROLTYPE",1217240411:"IFCELECTRICMOTORTYPE",1365060375:"IFCELECTRICHEATERTYPE",1534661035:"IFCELECTRICGENERATORTYPE",3277789161:"IFCELECTRICFLOWSTORAGEDEVICETYPE",663422040:"IFCELECTRICAPPLIANCETYPE",855621170:"IFCEDGEFEATURE",2030761528:"IFCDUCTSILENCERTYPE",3760055223:"IFCDUCTSEGMENTTYPE",869906466:"IFCDUCTFITTINGTYPE",395920057:"IFCDOOR",3041715199:"IFCDISTRIBUTIONPORT",3040386961:"IFCDISTRIBUTIONFLOWELEMENT",1945004755:"IFCDISTRIBUTIONELEMENT",2063403501:"IFCDISTRIBUTIONCONTROLELEMENTTYPE",1599208980:"IFCDISTRIBUTIONCHAMBERELEMENTTYPE",2635815018:"IFCDISCRETEACCESSORYTYPE",1335981549:"IFCDISCRETEACCESSORY",4147604152:"IFCDIAMETERDIMENSION",3961806047:"IFCDAMPERTYPE",3495092785:"IFCCURTAINWALL",1973544240:"IFCCOVERING",2954562838:"IFCCOOLINGTOWERTYPE",335055490:"IFCCOOLEDBEAMTYPE",488727124:"IFCCONSTRUCTIONPRODUCTRESOURCE",1060000209:"IFCCONSTRUCTIONMATERIALRESOURCE",3898045240:"IFCCONSTRUCTIONEQUIPMENTRESOURCE",1163958913:"IFCCONDITIONCRITERION",2188551683:"IFCCONDITION",2816379211:"IFCCONDENSERTYPE",3850581409:"IFCCOMPRESSORTYPE",843113511:"IFCCOLUMN",2301859152:"IFCCOILTYPE",2611217952:"IFCCIRCLE",2951183804:"IFCCHILLERTYPE",1285652485:"IFCCABLESEGMENTTYPE",3293546465:"IFCCABLECARRIERSEGMENTTYPE",395041908:"IFCCABLECARRIERFITTINGTYPE",1909888760:"IFCBUILDINGELEMENTPROXYTYPE",1095909175:"IFCBUILDINGELEMENTPROXY",2979338954:"IFCBUILDINGELEMENTPART",52481810:"IFCBUILDINGELEMENTCOMPONENT",3299480353:"IFCBUILDINGELEMENT",231477066:"IFCBOILERTYPE",1916977116:"IFCBEZIERCURVE",819618141:"IFCBEAMTYPE",1967976161:"IFCBSPLINECURVE",3460190687:"IFCASSET",2470393545:"IFCANGULARDIMENSION",1871374353:"IFCAIRTOAIRHEATRECOVERYTYPE",3352864051:"IFCAIRTERMINALTYPE",1411407467:"IFCAIRTERMINALBOXTYPE",3821786052:"IFCACTIONREQUEST",1213861670:"IFC2DCOMPOSITECURVE",1033361043:"IFCZONE",3342526732:"IFCWORKSCHEDULE",4218914973:"IFCWORKPLAN",1028945134:"IFCWORKCONTROL",1133259667:"IFCWASTETERMINALTYPE",1898987631:"IFCWALLTYPE",2769231204:"IFCVIRTUALELEMENT",728799441:"IFCVALVETYPE",1911125066:"IFCUNITARYEQUIPMENTTYPE",1600972822:"IFCTUBEBUNDLETYPE",3593883385:"IFCTRIMMEDCURVE",1620046519:"IFCTRANSPORTELEMENT",1692211062:"IFCTRANSFORMERTYPE",1637806684:"IFCTIMESERIESSCHEDULE",5716631:"IFCTANKTYPE",2254336722:"IFCSYSTEM",2315554128:"IFCSWITCHINGDEVICETYPE",148013059:"IFCSUBCONTRACTRESOURCE",1975003073:"IFCSTRUCTURALSURFACECONNECTION",2986769608:"IFCSTRUCTURALRESULTGROUP",1235345126:"IFCSTRUCTURALPOINTREACTION",734778138:"IFCSTRUCTURALPOINTCONNECTION",2082059205:"IFCSTRUCTURALPOINTACTION",3987759626:"IFCSTRUCTURALPLANARACTIONVARYING",1621171031:"IFCSTRUCTURALPLANARACTION",1252848954:"IFCSTRUCTURALLOADGROUP",1721250024:"IFCSTRUCTURALLINEARACTIONVARYING",1807405624:"IFCSTRUCTURALLINEARACTION",2445595289:"IFCSTRUCTURALCURVEMEMBERVARYING",214636428:"IFCSTRUCTURALCURVEMEMBER",4243806635:"IFCSTRUCTURALCURVECONNECTION",1179482911:"IFCSTRUCTURALCONNECTION",682877961:"IFCSTRUCTURALACTION",1039846685:"IFCSTAIRFLIGHTTYPE",3112655638:"IFCSTACKTERMINALTYPE",3812236995:"IFCSPACETYPE",652456506:"IFCSPACEPROGRAM",1305183839:"IFCSPACEHEATERTYPE",3856911033:"IFCSPACE",2533589738:"IFCSLABTYPE",4097777520:"IFCSITE",4105383287:"IFCSERVICELIFE",3517283431:"IFCSCHEDULETIMECONTROL",1768891740:"IFCSANITARYTERMINALTYPE",2863920197:"IFCRELASSIGNSTASKS",160246688:"IFCRELAGGREGATES",2324767716:"IFCRAMPFLIGHTTYPE",2893384427:"IFCRAILINGTYPE",3248260540:"IFCRADIUSDIMENSION",2250791053:"IFCPUMPTYPE",1842657554:"IFCPROTECTIVEDEVICETYPE",3651124850:"IFCPROJECTIONELEMENT",3642467123:"IFCPROJECTORDERRECORD",2904328755:"IFCPROJECTORDER",2744685151:"IFCPROCEDURE",3740093272:"IFCPORT",3724593414:"IFCPOLYLINE",4017108033:"IFCPLATETYPE",4231323485:"IFCPIPESEGMENTTYPE",804291784:"IFCPIPEFITTINGTYPE",3327091369:"IFCPERMIT",2382730787:"IFCPERFORMANCEHISTORY",2837617999:"IFCOUTLETTYPE",3425660407:"IFCORDERACTION",3588315303:"IFCOPENINGELEMENT",4143007308:"IFCOCCUPANT",1916936684:"IFCMOVE",977012517:"IFCMOTORCONNECTIONTYPE",3181161470:"IFCMEMBERTYPE",2108223431:"IFCMECHANICALFASTENERTYPE",377706215:"IFCMECHANICALFASTENER",2506943328:"IFCLINEARDIMENSION",1161773419:"IFCLIGHTFIXTURETYPE",1051575348:"IFCLAMPTYPE",3827777499:"IFCLABORRESOURCE",4288270099:"IFCJUNCTIONBOXTYPE",2391368822:"IFCINVENTORY",1806887404:"IFCHUMIDIFIERTYPE",1251058090:"IFCHEATEXCHANGERTYPE",2706460486:"IFCGROUP",3009204131:"IFCGRID",200128114:"IFCGASTERMINALTYPE",814719939:"IFCFURNITURESTANDARD",263784265:"IFCFURNISHINGELEMENT",3009222698:"IFCFLOWTREATMENTDEVICETYPE",2297155007:"IFCFLOWTERMINALTYPE",1339347760:"IFCFLOWSTORAGEDEVICETYPE",1834744321:"IFCFLOWSEGMENTTYPE",1482959167:"IFCFLOWMOVINGDEVICETYPE",3815607619:"IFCFLOWMETERTYPE",3198132628:"IFCFLOWFITTINGTYPE",3907093117:"IFCFLOWCONTROLLERTYPE",1287392070:"IFCFEATUREELEMENTSUBTRACTION",2143335405:"IFCFEATUREELEMENTADDITION",2827207264:"IFCFEATUREELEMENT",2489546625:"IFCFASTENERTYPE",647756555:"IFCFASTENER",3737207727:"IFCFACETEDBREPWITHVOIDS",807026263:"IFCFACETEDBREP",3390157468:"IFCEVAPORATORTYPE",3174744832:"IFCEVAPORATIVECOOLERTYPE",3272907226:"IFCEQUIPMENTSTANDARD",1962604670:"IFCEQUIPMENTELEMENT",2107101300:"IFCENERGYCONVERSIONDEVICETYPE",1704287377:"IFCELLIPSE",2590856083:"IFCELEMENTCOMPONENTTYPE",1623761950:"IFCELEMENTCOMPONENT",4123344466:"IFCELEMENTASSEMBLY",1758889154:"IFCELEMENT",360485395:"IFCELECTRICALBASEPROPERTIES",3849074793:"IFCDISTRIBUTIONFLOWELEMENTTYPE",3256556792:"IFCDISTRIBUTIONELEMENTTYPE",681481545:"IFCDIMENSIONCURVEDIRECTEDCALLOUT",1457835157:"IFCCURTAINWALLTYPE",3295246426:"IFCCREWRESOURCE",1916426348:"IFCCOVERINGTYPE",1419761937:"IFCCOSTSCHEDULE",3895139033:"IFCCOSTITEM",3293443760:"IFCCONTROL",2559216714:"IFCCONSTRUCTIONRESOURCE",2510884976:"IFCCONIC",3732776249:"IFCCOMPOSITECURVE",300633059:"IFCCOLUMNTYPE",2937912522:"IFCCIRCLEHOLLOWPROFILEDEF",3124254112:"IFCBUILDINGSTOREY",1950629157:"IFCBUILDINGELEMENTTYPE",4031249490:"IFCBUILDING",1260505505:"IFCBOUNDEDCURVE",3649129432:"IFCBOOLEANCLIPPINGRESULT",1334484129:"IFCBLOCK",3207858831:"IFCASYMMETRICISHAPEPROFILEDEF",1674181508:"IFCANNOTATION",2296667514:"IFCACTOR",2097647324:"IFCTRANSPORTELEMENTTYPE",3473067441:"IFCTASK",1580310250:"IFCSYSTEMFURNITUREELEMENTTYPE",4124788165:"IFCSURFACEOFREVOLUTION",2809605785:"IFCSURFACEOFLINEAREXTRUSION",2028607225:"IFCSURFACECURVESWEPTAREASOLID",4070609034:"IFCSTRUCTUREDDIMENSIONCALLOUT",2218152070:"IFCSTRUCTURALSURFACEMEMBERVARYING",3979015343:"IFCSTRUCTURALSURFACEMEMBER",3689010777:"IFCSTRUCTURALREACTION",530289379:"IFCSTRUCTURALMEMBER",3136571912:"IFCSTRUCTURALITEM",3544373492:"IFCSTRUCTURALACTIVITY",451544542:"IFCSPHERE",3893378262:"IFCSPATIALSTRUCTUREELEMENTTYPE",2706606064:"IFCSPATIALSTRUCTUREELEMENT",3626867408:"IFCRIGHTCIRCULARCYLINDER",4158566097:"IFCRIGHTCIRCULARCONE",1856042241:"IFCREVOLVEDAREASOLID",2914609552:"IFCRESOURCE",1401173127:"IFCRELVOIDSELEMENT",3451746338:"IFCRELSPACEBOUNDARY",366585022:"IFCRELSERVICESBUILDINGS",4122056220:"IFCRELSEQUENCE",1058617721:"IFCRELSCHEDULESCOSTITEMS",1245217292:"IFCRELREFERENCEDINSPATIALSTRUCTURE",750771296:"IFCRELPROJECTSELEMENT",202636808:"IFCRELOVERRIDESPROPERTIES",2051452291:"IFCRELOCCUPIESSPACES",3268803585:"IFCRELNESTS",4189434867:"IFCRELINTERACTIONREQUIREMENTS",279856033:"IFCRELFLOWCONTROLELEMENTS",3940055652:"IFCRELFILLSELEMENT",781010003:"IFCRELDEFINESBYTYPE",4186316022:"IFCRELDEFINESBYPROPERTIES",693640335:"IFCRELDEFINES",2551354335:"IFCRELDECOMPOSES",2802773753:"IFCRELCOVERSSPACES",886880790:"IFCRELCOVERSBLDGELEMENTS",3242617779:"IFCRELCONTAINEDINSPATIALSTRUCTURE",3678494232:"IFCRELCONNECTSWITHREALIZINGELEMENTS",504942748:"IFCRELCONNECTSWITHECCENTRICITY",1638771189:"IFCRELCONNECTSSTRUCTURALMEMBER",3912681535:"IFCRELCONNECTSSTRUCTURALELEMENT",2127690289:"IFCRELCONNECTSSTRUCTURALACTIVITY",3190031847:"IFCRELCONNECTSPORTS",4201705270:"IFCRELCONNECTSPORTTOELEMENT",3945020480:"IFCRELCONNECTSPATHELEMENTS",1204542856:"IFCRELCONNECTSELEMENTS",826625072:"IFCRELCONNECTS",2851387026:"IFCRELASSOCIATESPROFILEPROPERTIES",2655215786:"IFCRELASSOCIATESMATERIAL",3840914261:"IFCRELASSOCIATESLIBRARY",982818633:"IFCRELASSOCIATESDOCUMENT",2728634034:"IFCRELASSOCIATESCONSTRAINT",919958153:"IFCRELASSOCIATESCLASSIFICATION",4095574036:"IFCRELASSOCIATESAPPROVAL",1327628568:"IFCRELASSOCIATESAPPLIEDVALUE",1865459582:"IFCRELASSOCIATES",205026976:"IFCRELASSIGNSTORESOURCE",3372526763:"IFCRELASSIGNSTOPROJECTORDER",2857406711:"IFCRELASSIGNSTOPRODUCT",4278684876:"IFCRELASSIGNSTOPROCESS",1307041759:"IFCRELASSIGNSTOGROUP",2495723537:"IFCRELASSIGNSTOCONTROL",1683148259:"IFCRELASSIGNSTOACTOR",3939117080:"IFCRELASSIGNS",3454111270:"IFCRECTANGULARTRIMMEDSURFACE",2798486643:"IFCRECTANGULARPYRAMID",2770003689:"IFCRECTANGLEHOLLOWPROFILEDEF",3219374653:"IFCPROXY",1451395588:"IFCPROPERTYSET",4194566429:"IFCPROJECTIONCURVE",103090709:"IFCPROJECT",4208778838:"IFCPRODUCT",2945172077:"IFCPROCESS",220341763:"IFCPLANE",603570806:"IFCPLANARBOX",3566463478:"IFCPERMEABLECOVERINGPROPERTIES",3505215534:"IFCOFFSETCURVE3D",3388369263:"IFCOFFSETCURVE2D",3888040117:"IFCOBJECT",1425443689:"IFCMANIFOLDSOLIDBREP",1281925730:"IFCLINE",572779678:"IFCLSHAPEPROFILEDEF",1484403080:"IFCISHAPEPROFILEDEF",987898635:"IFCGEOMETRICCURVESET",1268542332:"IFCFURNITURETYPE",4238390223:"IFCFURNISHINGELEMENTTYPE",3455213021:"IFCFLUIDFLOWPROPERTIES",315944413:"IFCFILLAREASTYLETILES",4203026998:"IFCFILLAREASTYLETILESYMBOLWITHSTYLE",374418227:"IFCFILLAREASTYLEHATCHING",2047409740:"IFCFACEBASEDSURFACEMODEL",477187591:"IFCEXTRUDEDAREASOLID",80994333:"IFCENERGYPROPERTIES",2835456948:"IFCELLIPSEPROFILEDEF",2777663545:"IFCELEMENTARYSURFACE",339256511:"IFCELEMENTTYPE",1883228015:"IFCELEMENTQUANTITY",1472233963:"IFCEDGELOOP",4006246654:"IFCDRAUGHTINGPREDEFINEDCURVEFONT",445594917:"IFCDRAUGHTINGPREDEFINEDCOLOUR",3073041342:"IFCDRAUGHTINGCALLOUT",526551008:"IFCDOORSTYLE",1714330368:"IFCDOORPANELPROPERTIES",2963535650:"IFCDOORLININGPROPERTIES",32440307:"IFCDIRECTION",4054601972:"IFCDIMENSIONCURVETERMINATOR",606661476:"IFCDIMENSIONCURVE",693772133:"IFCDEFINEDSYMBOL",2827736869:"IFCCURVEBOUNDEDPLANE",2601014836:"IFCCURVE",2147822146:"IFCCSGSOLID",2506170314:"IFCCSGPRIMITIVE3D",194851669:"IFCCRANERAILFSHAPEPROFILEDEF",4133800736:"IFCCRANERAILASHAPEPROFILEDEF",2485617015:"IFCCOMPOSITECURVESEGMENT",2205249479:"IFCCLOSEDSHELL",1383045692:"IFCCIRCLEPROFILEDEF",1416205885:"IFCCARTESIANTRANSFORMATIONOPERATOR3DNONUNIFORM",3331915920:"IFCCARTESIANTRANSFORMATIONOPERATOR3D",3486308946:"IFCCARTESIANTRANSFORMATIONOPERATOR2DNONUNIFORM",3749851601:"IFCCARTESIANTRANSFORMATIONOPERATOR2D",59481748:"IFCCARTESIANTRANSFORMATIONOPERATOR",1123145078:"IFCCARTESIANPOINT",2898889636:"IFCCSHAPEPROFILEDEF",2713105998:"IFCBOXEDHALFSPACE",2581212453:"IFCBOUNDINGBOX",4182860854:"IFCBOUNDEDSURFACE",2736907675:"IFCBOOLEANRESULT",2740243338:"IFCAXIS2PLACEMENT3D",3125803723:"IFCAXIS2PLACEMENT2D",4261334040:"IFCAXIS1PLACEMENT",1302238472:"IFCANNOTATIONSURFACE",2265737646:"IFCANNOTATIONFILLAREAOCCURRENCE",669184980:"IFCANNOTATIONFILLAREA",3288037868:"IFCANNOTATIONCURVEOCCURRENCE",2543172580:"IFCZSHAPEPROFILEDEF",1299126871:"IFCWINDOWSTYLE",512836454:"IFCWINDOWPANELPROPERTIES",336235671:"IFCWINDOWLININGPROPERTIES",2759199220:"IFCVERTEXLOOP",1417489154:"IFCVECTOR",427810014:"IFCUSHAPEPROFILEDEF",2347495698:"IFCTYPEPRODUCT",1628702193:"IFCTYPEOBJECT",1345879162:"IFCTWODIRECTIONREPEATFACTOR",2715220739:"IFCTRAPEZIUMPROFILEDEF",3124975700:"IFCTEXTLITERALWITHEXTENT",4282788508:"IFCTEXTLITERAL",3028897424:"IFCTERMINATORSYMBOL",3071757647:"IFCTSHAPEPROFILEDEF",230924584:"IFCSWEPTSURFACE",1260650574:"IFCSWEPTDISKSOLID",2247615214:"IFCSWEPTAREASOLID",1878645084:"IFCSURFACESTYLERENDERING",2513912981:"IFCSURFACE",2233826070:"IFCSUBEDGE",3653947884:"IFCSTRUCTURALSTEELPROFILEPROPERTIES",3843319758:"IFCSTRUCTURALPROFILEPROPERTIES",1190533807:"IFCSTRUCTURALLOADSINGLEFORCEWARPING",1597423693:"IFCSTRUCTURALLOADSINGLEFORCE",1973038258:"IFCSTRUCTURALLOADSINGLEDISPLACEMENTDISTORTION",2473145415:"IFCSTRUCTURALLOADSINGLEDISPLACEMENT",2668620305:"IFCSTRUCTURALLOADPLANARFORCE",1595516126:"IFCSTRUCTURALLOADLINEARFORCE",390701378:"IFCSPACETHERMALLOADPROPERTIES",1202362311:"IFCSOUNDVALUE",2485662743:"IFCSOUNDPROPERTIES",723233188:"IFCSOLIDMODEL",2609359061:"IFCSLIPPAGECONNECTIONCONDITION",4124623270:"IFCSHELLBASEDSURFACEMODEL",2411513650:"IFCSERVICELIFEFACTOR",1509187699:"IFCSECTIONEDSPINE",2778083089:"IFCROUNDEDRECTANGLEPROFILEDEF",478536968:"IFCRELATIONSHIP",3765753017:"IFCREINFORCEMENTDEFINITIONPROPERTIES",3413951693:"IFCREGULARTIMESERIES",3615266464:"IFCRECTANGLEPROFILEDEF",110355661:"IFCPROPERTYTABLEVALUE",3650150729:"IFCPROPERTYSINGLEVALUE",3357820518:"IFCPROPERTYSETDEFINITION",941946838:"IFCPROPERTYREFERENCEVALUE",2752243245:"IFCPROPERTYLISTVALUE",4166981789:"IFCPROPERTYENUMERATEDVALUE",1680319473:"IFCPROPERTYDEFINITION",871118103:"IFCPROPERTYBOUNDEDVALUE",673634403:"IFCPRODUCTDEFINITIONSHAPE",179317114:"IFCPREDEFINEDPOINTMARKERSYMBOL",433424934:"IFCPREDEFINEDDIMENSIONSYMBOL",2559016684:"IFCPREDEFINEDCURVEFONT",759155922:"IFCPREDEFINEDCOLOUR",2775532180:"IFCPOLYGONALBOUNDEDHALFSPACE",2924175390:"IFCPOLYLOOP",1423911732:"IFCPOINTONSURFACE",4022376103:"IFCPOINTONCURVE",2067069095:"IFCPOINT",1663979128:"IFCPLANAREXTENT",2004835150:"IFCPLACEMENT",597895409:"IFCPIXELTEXTURE",3021840470:"IFCPHYSICALCOMPLEXQUANTITY",2519244187:"IFCPATH",2529465313:"IFCPARAMETERIZEDPROFILEDEF",1029017970:"IFCORIENTEDEDGE",2665983363:"IFCOPENSHELL",2833995503:"IFCONEDIRECTIONREPEATFACTOR",219451334:"IFCOBJECTDEFINITION",1430189142:"IFCMECHANICALCONCRETEMATERIALPROPERTIES",2022407955:"IFCMATERIALDEFINITIONREPRESENTATION",2347385850:"IFCMAPPEDITEM",1008929658:"IFCLOOP",2624227202:"IFCLOCALPLACEMENT",3422422726:"IFCLIGHTSOURCESPOT",1520743889:"IFCLIGHTSOURCEPOSITIONAL",4266656042:"IFCLIGHTSOURCEGONIOMETRIC",2604431987:"IFCLIGHTSOURCEDIRECTIONAL",125510826:"IFCLIGHTSOURCEAMBIENT",1402838566:"IFCLIGHTSOURCE",3741457305:"IFCIRREGULARTIMESERIES",3905492369:"IFCIMAGETEXTURE",2445078500:"IFCHYGROSCOPICMATERIALPROPERTIES",812098782:"IFCHALFSPACESOLID",178086475:"IFCGRIDPLACEMENT",3590301190:"IFCGEOMETRICSET",4142052618:"IFCGEOMETRICREPRESENTATIONSUBCONTEXT",2453401579:"IFCGEOMETRICREPRESENTATIONITEM",3448662350:"IFCGEOMETRICREPRESENTATIONCONTEXT",1446786286:"IFCGENERALPROFILEPROPERTIES",803998398:"IFCGENERALMATERIALPROPERTIES",3857492461:"IFCFUELPROPERTIES",738692330:"IFCFILLAREASTYLE",4219587988:"IFCFAILURECONNECTIONCONDITION",3008276851:"IFCFACESURFACE",803316827:"IFCFACEOUTERBOUND",1809719519:"IFCFACEBOUND",2556980723:"IFCFACE",1860660968:"IFCEXTENDEDMATERIALPROPERTIES",476780140:"IFCEDGECURVE",3900360178:"IFCEDGE",4170525392:"IFCDRAUGHTINGPREDEFINEDTEXTFONT",3732053477:"IFCDOCUMENTREFERENCE",1694125774:"IFCDIMENSIONPAIR",2273265877:"IFCDIMENSIONCALLOUTRELATIONSHIP",3632507154:"IFCDERIVEDPROFILEDEF",3800577675:"IFCCURVESTYLE",2889183280:"IFCCONVERSIONBASEDUNIT",3050246964:"IFCCONTEXTDEPENDENTUNIT",45288368:"IFCCONNECTIONPOINTECCENTRICITY",1981873012:"IFCCONNECTIONCURVEGEOMETRY",370225590:"IFCCONNECTEDFACESET",1485152156:"IFCCOMPOSITEPROFILEDEF",2542286263:"IFCCOMPLEXPROPERTY",776857604:"IFCCOLOURRGB",647927063:"IFCCLASSIFICATIONREFERENCE",3150382593:"IFCCENTERLINEPROFILEDEF",616511568:"IFCBLOBTEXTURE",2705031697:"IFCARBITRARYPROFILEDEFWITHVOIDS",1310608509:"IFCARBITRARYOPENPROFILEDEF",3798115385:"IFCARBITRARYCLOSEDPROFILEDEF",2297822566:"IFCANNOTATIONTEXTOCCURRENCE",3612888222:"IFCANNOTATIONSYMBOLOCCURRENCE",962685235:"IFCANNOTATIONSURFACEOCCURRENCE",2442683028:"IFCANNOTATIONOCCURRENCE",1065908215:"IFCWATERPROPERTIES",891718957:"IFCVIRTUALGRIDINTERSECTION",1907098498:"IFCVERTEXPOINT",3304826586:"IFCVERTEXBASEDTEXTUREMAP",2799835756:"IFCVERTEX",180925521:"IFCUNITASSIGNMENT",1735638870:"IFCTOPOLOGYREPRESENTATION",1377556343:"IFCTOPOLOGICALREPRESENTATIONITEM",581633288:"IFCTIMESERIESVALUE",1718945513:"IFCTIMESERIESREFERENCERELATIONSHIP",3101149627:"IFCTIMESERIES",3317419933:"IFCTHERMALMATERIALPROPERTIES",1210645708:"IFCTEXTUREVERTEX",2552916305:"IFCTEXTUREMAP",1742049831:"IFCTEXTURECOORDINATEGENERATOR",280115917:"IFCTEXTURECOORDINATE",1484833681:"IFCTEXTSTYLEWITHBOXCHARACTERISTICS",1640371178:"IFCTEXTSTYLETEXTMODEL",2636378356:"IFCTEXTSTYLEFORDEFINEDFONT",1983826977:"IFCTEXTSTYLEFONTMODEL",1447204868:"IFCTEXTSTYLE",912023232:"IFCTELECOMADDRESS",531007025:"IFCTABLEROW",985171141:"IFCTABLE",1290481447:"IFCSYMBOLSTYLE",626085974:"IFCSURFACETEXTURE",1351298697:"IFCSURFACESTYLEWITHTEXTURES",846575682:"IFCSURFACESTYLESHADING",1607154358:"IFCSURFACESTYLEREFRACTION",3303107099:"IFCSURFACESTYLELIGHTING",1300840506:"IFCSURFACESTYLE",3049322572:"IFCSTYLEDREPRESENTATION",3958052878:"IFCSTYLEDITEM",2830218821:"IFCSTYLEMODEL",3408363356:"IFCSTRUCTURALLOADTEMPERATURE",2525727697:"IFCSTRUCTURALLOADSTATIC",2162789131:"IFCSTRUCTURALLOAD",2273995522:"IFCSTRUCTURALCONNECTIONCONDITION",3692461612:"IFCSIMPLEPROPERTY",4240577450:"IFCSHAPEREPRESENTATION",3982875396:"IFCSHAPEMODEL",867548509:"IFCSHAPEASPECT",4165799628:"IFCSECTIONREINFORCEMENTPROPERTIES",2042790032:"IFCSECTIONPROPERTIES",448429030:"IFCSIUNIT",2341007311:"IFCROOT",3679540991:"IFCRIBPLATEPROFILEPROPERTIES",1660063152:"IFCREPRESENTATIONMAP",3008791417:"IFCREPRESENTATIONITEM",3377609919:"IFCREPRESENTATIONCONTEXT",1076942058:"IFCREPRESENTATION",1222501353:"IFCRELAXATION",1580146022:"IFCREINFORCEMENTBARPROPERTIES",2692823254:"IFCREFERENCESVALUEDOCUMENT",825690147:"IFCQUANTITYWEIGHT",2405470396:"IFCQUANTITYVOLUME",3252649465:"IFCQUANTITYTIME",931644368:"IFCQUANTITYLENGTH",2093928680:"IFCQUANTITYCOUNT",2044713172:"IFCQUANTITYAREA",3710013099:"IFCPROPERTYENUMERATION",148025276:"IFCPROPERTYDEPENDENCYRELATIONSHIP",3896028662:"IFCPROPERTYCONSTRAINTRELATIONSHIP",2598011224:"IFCPROPERTY",2802850158:"IFCPROFILEPROPERTIES",3958567839:"IFCPROFILEDEF",2267347899:"IFCPRODUCTSOFCOMBUSTIONPROPERTIES",2095639259:"IFCPRODUCTREPRESENTATION",2417041796:"IFCPRESENTATIONSTYLEASSIGNMENT",3119450353:"IFCPRESENTATIONSTYLE",1304840413:"IFCPRESENTATIONLAYERWITHSTYLE",2022622350:"IFCPRESENTATIONLAYERASSIGNMENT",1775413392:"IFCPREDEFINEDTEXTFONT",3213052703:"IFCPREDEFINEDTERMINATORSYMBOL",990879717:"IFCPREDEFINEDSYMBOL",3727388367:"IFCPREDEFINEDITEM",3355820592:"IFCPOSTALADDRESS",2226359599:"IFCPHYSICALSIMPLEQUANTITY",2483315170:"IFCPHYSICALQUANTITY",101040310:"IFCPERSONANDORGANIZATION",2077209135:"IFCPERSON",1207048766:"IFCOWNERHISTORY",1411181986:"IFCORGANIZATIONRELATIONSHIP",4251960020:"IFCORGANIZATION",1227763645:"IFCOPTICALMATERIALPROPERTIES",2251480897:"IFCOBJECTIVE",3701648758:"IFCOBJECTPLACEMENT",1918398963:"IFCNAMEDUNIT",2706619895:"IFCMONETARYUNIT",3368373690:"IFCMETRIC",677618848:"IFCMECHANICALSTEELMATERIALPROPERTIES",4256014907:"IFCMECHANICALMATERIALPROPERTIES",2597039031:"IFCMEASUREWITHUNIT",3265635763:"IFCMATERIALPROPERTIES",2199411900:"IFCMATERIALLIST",1303795690:"IFCMATERIALLAYERSETUSAGE",3303938423:"IFCMATERIALLAYERSET",248100487:"IFCMATERIALLAYER",1847130766:"IFCMATERIALCLASSIFICATIONRELATIONSHIP",1838606355:"IFCMATERIAL",30780891:"IFCLOCALTIME",1566485204:"IFCLIGHTINTENSITYDISTRIBUTION",4162380809:"IFCLIGHTDISTRIBUTIONDATA",3452421091:"IFCLIBRARYREFERENCE",2655187982:"IFCLIBRARYINFORMATION",3020489413:"IFCIRREGULARTIMESERIESVALUE",852622518:"IFCGRIDAXIS",3548104201:"IFCEXTERNALLYDEFINEDTEXTFONT",3207319532:"IFCEXTERNALLYDEFINEDSYMBOL",1040185647:"IFCEXTERNALLYDEFINEDSURFACESTYLE",2242383968:"IFCEXTERNALLYDEFINEDHATCHSTYLE",3200245327:"IFCEXTERNALREFERENCE",1648886627:"IFCENVIRONMENTALIMPACTVALUE",3796139169:"IFCDRAUGHTINGCALLOUTRELATIONSHIP",770865208:"IFCDOCUMENTINFORMATIONRELATIONSHIP",1154170062:"IFCDOCUMENTINFORMATION",1376555844:"IFCDOCUMENTELECTRONICFORMAT",2949456006:"IFCDIMENSIONALEXPONENTS",1045800335:"IFCDERIVEDUNITELEMENT",1765591967:"IFCDERIVEDUNIT",1072939445:"IFCDATEANDTIME",3510044353:"IFCCURVESTYLEFONTPATTERN",2367409068:"IFCCURVESTYLEFONTANDSCALING",1105321065:"IFCCURVESTYLEFONT",539742890:"IFCCURRENCYRELATIONSHIP",602808272:"IFCCOSTVALUE",1065062679:"IFCCOORDINATEDUNIVERSALTIMEOFFSET",347226245:"IFCCONSTRAINTRELATIONSHIP",613356794:"IFCCONSTRAINTCLASSIFICATIONRELATIONSHIP",1658513725:"IFCCONSTRAINTAGGREGATIONRELATIONSHIP",1959218052:"IFCCONSTRAINT",2732653382:"IFCCONNECTIONSURFACEGEOMETRY",4257277454:"IFCCONNECTIONPORTGEOMETRY",2614616156:"IFCCONNECTIONPOINTGEOMETRY",2859738748:"IFCCONNECTIONGEOMETRY",3264961684:"IFCCOLOURSPECIFICATION",3639012971:"IFCCLASSIFICATIONNOTATIONFACET",938368621:"IFCCLASSIFICATIONNOTATION",1098599126:"IFCCLASSIFICATIONITEMRELATIONSHIP",1767535486:"IFCCLASSIFICATIONITEM",747523909:"IFCCLASSIFICATION",622194075:"IFCCALENDARDATE",2069777674:"IFCBOUNDARYNODECONDITIONWARPING",1387855156:"IFCBOUNDARYNODECONDITION",3367102660:"IFCBOUNDARYFACECONDITION",1560379544:"IFCBOUNDARYEDGECONDITION",4037036970:"IFCBOUNDARYCONDITION",3869604511:"IFCAPPROVALRELATIONSHIP",390851274:"IFCAPPROVALPROPERTYRELATIONSHIP",2080292479:"IFCAPPROVALACTORRELATIONSHIP",130549933:"IFCAPPROVAL",1110488051:"IFCAPPLIEDVALUERELATIONSHIP",411424972:"IFCAPPLIEDVALUE",639542469:"IFCAPPLICATION",618182010:"IFCADDRESS",3630933823:"IFCACTORROLE",599546466:"FILE_DESCRIPTION",1390159747:"FILE_NAME",1109904537:"FILE_SCHEMA"};class wt{static async getUnits(e){const{IFCUNITASSIGNMENT:t}=x,s=await e.getAllPropertiesOfType(t);if(!s)return 1;const i=Object.keys(s),n=s[parseInt(i[0],10)];for(const t of n.Units){if(void 0===t.value||null===t.value)continue;const s=await e.getProperties(t.value);if(!s||!s.UnitType||!s.UnitType.value)continue;if("LENGTHUNIT"!==s.UnitType.value)continue;let i=1,n=1;return"METRE"===s.Name.value&&(n=1),"FOOT"===s.Name.value&&(n=.3048),"MILLI"===s.Prefix?.value&&(i=.001),n*i}return 1}static async findItemByGuid(e,t){const s=e.getAllPropertiesIDs();for(const i of s){const s=await e.getProperties(i);if(s&&s.GlobalId?.value===t)return s}return null}static async getRelationMap(e,t,s){const i=s??(()=>{}),n={},o=e.getAllPropertiesIDs();for(const s of o){const o=await e.getProperties(s);if(!o)continue;const r=o.type===t,a=Object.keys(o).find((e=>e.startsWith("Relating"))),l=Object.keys(o).find((e=>e.startsWith("Related")));if(!(r&&a&&l))continue;const h=await e.getProperties(o[a]?.value),c=o[l];if(!h||!c)continue;if(!c||!Array.isArray(c))continue;const d=c.map((e=>e.value));i(h.expressID,d),n[h.expressID]=d}return n}static async getQsetQuantities(e,t,s){const i=s??(()=>{}),n=await e.getProperties(t);if(!n||n.type!==x.IFCELEMENTQUANTITY)return null;return(n.Quantities??[{}]).map((e=>(e.value&&i(e.value),e.value))).filter((e=>null!==e))}static async getPsetProps(e,t,s){const i=s??(()=>{}),n=await e.getProperties(t);if(!n||n.type!==x.IFCPROPERTYSET)return null;return(n.HasProperties??[{}]).map((e=>(e.value&&i(e.value),e.value))).filter((e=>null!==e))}static async getPsetRel(e,t){if(!await e.getProperties(t))return null;const s=await e.getAllPropertiesOfType(x.IFCRELDEFINESBYPROPERTIES);if(!s)return null;const i=Object.values(s);let n=null;for(const e of i)e.RelatingPropertyDefinition?.value===t&&(n=e.expressID);return n}static async getQsetRel(e,t){return wt.getPsetRel(e,t)}static async getEntityName(e,t){const s=await e.getProperties(t);if(!s)return{key:null,name:null};const i=Object.keys(s).find((e=>e.endsWith("Name")))??null;return{key:i,name:i?s[i]?.value:null}}static async getQuantityValue(e,t){const s=await e.getProperties(t);if(!s)return{key:null,value:null};const i=Object.keys(s).find((e=>e.endsWith("Value")))??null;let n;return n=null===i||void 0===s[i]||null===s[i]?null:s[i].value,{key:i,value:n}}static isRel(e){return ft[e].startsWith("IFCREL")}static async attributeExists(e,t,s){const i=await e.getProperties(t);return!!i&&Object.keys(i).includes(s)}static async groupEntitiesByType(e,t){const s=new Map;for(const i of t){const t=await e.getProperties(i);if(!t)continue;const n=t.type;s.get(n)||s.set(n,new Set),s.get(n)?.add(i)}return s}}class Tt extends oe{constructor(e){super(e,'<div class="flex"></div>'),this.onNewPset=new W,this.data={},this.addPsetBtn=new ae(this._components,{materialIconName:"add"}),this.addPsetBtn.onClick.add((async()=>{this._nameInput.value="",this._descriptionInput.value="",this.modal.visible=!0})),this.addChild(this.addPsetBtn),this.modal=new _e(e,"New Property Set"),this._components.ui.add(this.modal),this.modal.visible=!1,this.modal.onHidden.add((()=>this.removeFromParent()));const t=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4"></div>');this.modal.setSlot("content",t),this._nameInput=new pe(this._components),this._nameInput.label="Name",this._descriptionInput=new pe(this._components),this._descriptionInput.label="Description",this.modal.onAccept.add((()=>{const e=this._nameInput.value,t=this._descriptionInput.value;this.modal.visible=!1;const{model:s,elementIDs:i}=this.data;s&&""!==e&&this.onNewPset.trigger({model:s,elementIDs:i,name:e,description:t})})),this.modal.onCancel.add((()=>this.modal.visible=!1)),t.addChild(this._nameInput,this._descriptionInput)}async dispose(e=!1){await super.dispose(e),this.data={},this.onNewPset.reset(),await this.addPsetBtn.dispose(),await this.modal.dispose(),await this._nameInput.dispose(),await this._descriptionInput.dispose()}}class bt extends oe{constructor(e){super(e,'<div class="flex"></div>'),this.modalVisible=!1,this.onEditPset=new W,this.onRemovePset=new W,this.onNewProp=new W,this.data={},this._modal=new _e(e,"New Property Set"),this._components.ui.add(this._modal),this._modal.visible=!1,this._modal.onHidden.add((()=>this.removeFromParent())),this._modal.onCancel.add((()=>{this._modal.visible=!1,this._modal.slots.content.dispose(!0)})),this.editPsetBtn=new ae(this._components),this.editPsetBtn.materialIcon="edit",this.editPsetBtn.onClick.add((()=>this.setEditUI())),this.removePsetBtn=new ae(this._components),this.removePsetBtn.materialIcon="delete",this.removePsetBtn.onClick.add((()=>this.setRemoveUI())),this.addPropBtn=new ae(this._components),this.addPropBtn.materialIcon="add",this.addPropBtn.onClick.add((()=>this.setAddPropUI())),this.addChild(this.addPropBtn,this.editPsetBtn,this.removePsetBtn)}async dispose(e=!1){await super.dispose(e),await this.editPsetBtn.dispose(),await this.removePsetBtn.dispose(),await this.addPropBtn.dispose(),await this._modal.dispose(),this.onEditPset.reset(),this.onRemovePset.reset(),this.onNewProp.reset(),this.data={}}async setEditUI(){const{model:e,psetID:t}=this.data;if(!e||!t||!e.hasProperties)return;const s=await e.getProperties(t);if(!s)return;this._modal.onAccept.reset(),this._modal.title="Edit Property Set";const i=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>'),n=new pe(this._components);n.label="Name";const o=new pe(this._components);o.label="Description",this._modal.onAccept.add((async()=>{this._modal.visible=!1,await this.onEditPset.trigger({model:e,psetID:t,name:n.value,description:o.value})})),i.addChild(n,o),n.value=s.Name?.value??"",o.value=s.Description?.value??"",this._modal.setSlot("content",i),this._modal.visible=!0}setRemoveUI(){const{model:e,psetID:t}=this.data;if(!e||!t)return;this._modal.onAccept.reset(),this._modal.title="Remove Property Set";const s=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>'),i=document.createElement("div");i.className="text-base text-center",i.textContent="Are you sure to delete this property set? This action can't be undone.",s.get().append(i),this._modal.onAccept.add((async()=>{this._modal.visible=!1,this.removeFromParent(),await this.onRemovePset.trigger({model:e,psetID:t})})),this._modal.setSlot("content",s),this._modal.visible=!0}setAddPropUI(){const{model:e,psetID:t}=this.data;if(!e||!t)return;this._modal.onAccept.reset(),this._modal.title="New Property";const s=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>'),i=new pe(this._components);i.label="Name";const n=new ue(this._components);n.label="Type",n.addOption("IfcText","IfcLabel","IfcIdentifier"),n.value="IfcText";const o=new pe(this._components);o.label="Value",this._modal.onAccept.add((async()=>{this._modal.visible=!1;const s=i.value,r=n.value;""!==s&&r&&await this.onNewProp.trigger({model:e,psetID:t,name:s,type:r,value:o.value})})),s.addChild(i,n,o),this._modal.setSlot("content",s),this._modal.visible=!0}}class vt extends oe{constructor(e){document.createElement("div").className="flex",super(e,'<div class="flex"></div>'),this.modalVisible=!1,this.onEditProp=new W,this.onRemoveProp=new W,this.data={},this._modal=new _e(e,"New Property Set"),this._components.ui.add(this._modal),this._modal.visible=!1,this._modal.onHidden.add((()=>this.removeFromParent())),this._modal.onCancel.add((()=>{this._modal.visible=!1,this._modal.slots.content.dispose(!0)})),this.editPropBtn=new ae(this._components),this.editPropBtn.materialIcon="edit",this.editPropBtn.onClick.add((()=>this.setEditUI())),this.removePropBtn=new ae(this._components),this.removePropBtn.materialIcon="delete",this.removePropBtn.onClick.add((()=>this.setRemoveUI())),this.addChild(this.editPropBtn,this.removePropBtn)}async dispose(e=!1){await super.dispose(e),this.onRemoveProp.reset(),await this.editPropBtn.dispose(),await this.removePropBtn.dispose(),await this._modal.dispose(),this.data={}}async setEditUI(){const{model:e,expressID:t}=this.data;if(!e||!t||!e.hasProperties)return;const s=await e.getProperties(t);if(!s)return;this._modal.onAccept.reset(),this._modal.title="Edit Property";const i=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>'),n=new pe(this._components);n.label="Name";const o=new pe(this._components);o.label="Value",this._modal.onAccept.add((async()=>{this._modal.visible=!1,await this.onEditProp.trigger({model:e,expressID:t,name:n.value,value:o.value})})),i.addChild(n,o);const{key:r}=await wt.getEntityName(e,t);n.value=r?s[r]?.value??"":s.Name?.value??"";const{key:a}=await wt.getQuantityValue(e,t);o.value=a?s[a]?.value??"":s.NominalValue?.value??"",this._modal.setSlot("content",i),this._modal.visible=!0}setRemoveUI(){const{model:e,expressID:t,setID:s}=this.data;if(!e||!t||!s)return;const i=new oe(this._components,'<div class="flex flex-col gap-y-4 p-4 overflow-auto"></div>'),n=document.createElement("div");n.className="text-base text-center",n.textContent="Are you sure to delete this property? This action can't be undone.",i.get().append(n),this._modal.onAccept.add((async()=>{this._modal.visible=!1,this.removeFromParent(),await this.onRemoveProp.trigger({model:e,expressID:t,setID:s})})),this._modal.setSlot("content",i),this._modal.visible=!0}}class _t extends j{constructor(e){super(e),this.onDisposed=new W,this.onRequestFile=new W,this.ifcToExport=null,this.onElementToPset=new W,this.onPropToPset=new W,this.onPsetRemoved=new W,this.onDataChanged=new W,this.wasm={path:"/",absolute:!1},this.enabled=!0,this.attributeListeners={},this.uiElement=new Q,this._changeMap={},this.components.tools.add(_t.uuid,this),e.uiEnabled&&(this.setUI(e),this.setUIEvents())}get(){return this._changeMap}async dispose(){this.selectedModel=void 0,this.attributeListeners={},this._changeMap={},this.onElementToPset.reset(),this.onPropToPset.reset(),this.onPsetRemoved.reset(),this.onDataChanged.reset(),await this.uiElement.dispose(),await this.onDisposed.trigger(_t.uuid),this.onDisposed.reset()}setUI(e){const t=new ae(e);t.tooltip="Export IFC",t.materialIcon="exit_to_app",t.onClick.add((async()=>{if(await this.onRequestFile.trigger(),!this.ifcToExport||!this.selectedModel)return;const e=new Uint8Array(this.ifcToExport),t=this.selectedModel.name,s=await this.saveToIfc(this.selectedModel,e),i=new File([new Blob([s])],t),n=document.createElement("a");n.download=t,n.href=URL.createObjectURL(i),n.click(),n.remove()})),this.uiElement.set({exportButton:t,entityActions:new Tt(e),psetActions:new bt(e),propActions:new vt(e)})}setUIEvents(){const e=this.uiElement.get("entityActions"),t=this.uiElement.get("propActions"),s=this.uiElement.get("psetActions");e.onNewPset.add((async({model:t,elementIDs:s,name:i,description:n})=>{const{pset:o}=await this.newPset(t,i,""===n?void 0:n);for(const e of s??[])await this.addElementToPset(t,o.expressID,e);e.cleanData()})),t.onEditProp.add((async({model:e,expressID:s,name:i,value:n})=>{const o=await e.getProperties(s);if(!o)return;const{key:r}=await wt.getQuantityValue(e,s),{key:a}=await wt.getEntityName(e,s);""!==i&&a&&(o[a]?.value?o[a].value=i:o.Name={type:1,value:i}),""!==n&&r&&(o[r]?.value?o[r].value=n:o.NominalValue={type:1,value:n}),await this.registerChange(e,s),t.cleanData()})),t.onRemoveProp.add((async({model:e,expressID:s,setID:i})=>{await this.removePsetProp(e,i,s),t.cleanData()})),s.onEditPset.add((async({model:e,psetID:t,name:s,description:i})=>{const n=await e.getProperties(t);n&&(""!==s&&(n.Name?.value?n.Name.value=s:n.Name={type:1,value:s}),""!==i&&(n.Description?.value?n.Description.value=i:n.Description={type:1,value:i}),await this.registerChange(e,t))})),s.onRemovePset.add((async({model:e,psetID:t})=>{await this.removePset(e,t)})),s.onNewProp.add((async({model:e,psetID:t,name:s,type:i,value:n})=>{const o=await this.newSingleStringProperty(e,i,s,n);await this.addPropToPset(e,t,o.expressID)}))}increaseMaxID(e){return e.ifcMetadata.maxExpressID++,e.ifcMetadata.maxExpressID}static getIFCSchema(e){const t=e.ifcMetadata.schema;if(!t)throw new Error("IFC Schema not found");return t}newGUID(e){const t=_t.getIFCSchema(e);return new x[t].IfcGloballyUniqueId(Pe())}async getOwnerHistory(e){const t=await e.getAllPropertiesOfType(x.IFCOWNERHISTORY);if(!t)throw new Error("No OwnerHistory was found.");const s=t[Object.keys(t).map((e=>parseInt(e,10)))[0]];return{ownerHistory:s,ownerHistoryHandle:new x.Handle(s.expressID)}}async registerChange(e,...t){this._changeMap[e.uuid]||(this._changeMap[e.uuid]=new Set);for(const s of t)this._changeMap[e.uuid].add(s),await this.onDataChanged.trigger({model:e,expressID:s})}async setData(e,...t){for(const s of t){const t=s.expressID;t&&(await e.setProperties(t,s),await this.registerChange(e,t))}}async newPset(e,t,s){const i=_t.getIFCSchema(e),{ownerHistoryHandle:n}=await this.getOwnerHistory(e),o=this.newGUID(e),r=new x[i].IfcLabel(t),a=s?new x[i].IfcText(s):null,l=new x[i].IfcPropertySet(o,n,r,a,[]);l.expressID=this.increaseMaxID(e);const h=this.newGUID(e),c=new x[i].IfcRelDefinesByProperties(h,n,null,null,[],new x.Handle(l.expressID));return c.expressID=this.increaseMaxID(e),await this.setData(e,l,c),{pset:l,rel:c}}async removePset(e,...t){for(const s of t){const t=await e.getProperties(s);if(t?.type!==x.IFCPROPERTYSET)continue;const i=await wt.getPsetRel(e,s);if(i&&(await e.setProperties(i,null),await this.registerChange(e,i)),t){for(const s of t.HasProperties)await e.setProperties(s.value,null);await e.setProperties(s,null),await this.onPsetRemoved.trigger({model:e,psetID:s}),await this.registerChange(e,s)}}}async newSingleProperty(e,t,s,i){const n=_t.getIFCSchema(e),o=new x[n].IfcIdentifier(s),r=new x[n][t](i),a=new x[n].IfcPropertySingleValue(o,null,r,null);return a.expressID=this.increaseMaxID(e),await this.setData(e,a),a}newSingleStringProperty(e,t,s,i){return this.newSingleProperty(e,t,s,i)}newSingleNumericProperty(e,t,s,i){return this.newSingleProperty(e,t,s,i)}newSingleBooleanProperty(e,t,s,i){return this.newSingleProperty(e,t,s,i)}async removePsetProp(e,t,s){const i=await e.getProperties(t),n=await e.getProperties(s);i&&n&&i.type===x.IFCPROPERTYSET&&n&&(i.HasProperties=i.HasProperties.filter((e=>e.value!==s)),await e.setProperties(s,null),await this.registerChange(e,t,s))}async addElementToPset(e,t,...s){const i=await wt.getPsetRel(e,t);if(!i)return;const n=await e.getProperties(i);if(n){for(const i of s){const s=new x.Handle(i);n.RelatedObjects.push(s),await this.onElementToPset.trigger({model:e,psetID:t,elementID:i})}await this.registerChange(e,t)}}async addPropToPset(e,t,...s){const i=await e.getProperties(t);if(i){for(const n of s){if(i.HasProperties.includes(n))continue;const s=new x.Handle(n);i.HasProperties.push(s),await this.onPropToPset.trigger({model:e,psetID:t,propID:n})}await this.registerChange(e,t)}}async saveToIfc(e,t){const s=this.components.tools.get(mt),i=s.get(),n=await s.readIfcFile(t),o=this._changeMap[e.uuid]??[];for(const t of o){const s=await e.getProperties(t);if(s)try{i.WriteLine(n,s)}catch(e){}else try{i.DeleteLine(n,t)}catch(e){}}const r=i.SaveModel(n);return s.get().CloseModel(n),s.cleanUp(),r}async setAttributeListener(e,t,s){this.attributeListeners[e.uuid]||(this.attributeListeners[e.uuid]={});const i=this.attributeListeners[e.uuid][t]?this.attributeListeners[e.uuid][t][s]:null;if(i)return i;const n=await e.getProperties(t);if(!n)throw new Error(`Entity with expressID ${t} doesn't exists.`);const o=n[s];if(Array.isArray(o)||!o)throw new Error(`Attribute ${s} is array or null, and it can't have a listener.`);const r=o.value;if(void 0===r||null==r)throw new Error(`Attribute ${s} has a badly defined handle.`);const a=new W;return Object.defineProperty(n[s],"value",{get(){return this._value},async set(e){this._value=e,await a.trigger(e)}}),n[s].value=r,this.attributeListeners[e.uuid][t]||(this.attributeListeners[e.uuid][t]={}),this.attributeListeners[e.uuid][t][s]=a,a}}_t.uuid="58c2d9f0-183c-48d6-a402-dfcf5b9a34df",Z.libraryUUIDs.add(_t.uuid);class yt extends oe{get label(){return this.innerElements.label.textContent}set label(e){this.innerElements.label.textContent=e}get value(){return this.innerElements.value.textContent}set value(e){this.innerElements.value.textContent=String(e)}constructor(e,t,s,i){super(e,`\n    <div class="flex gap-x-2 hover:bg-ifcjs-120 py-1 px-3 rounded-md items-center min-h-[40px]">\n      <div class="flex flex-col grow">\n        <p id="label" class="${he.Class.Label}"></p>\n        <p id="value" class="text-base my-0"></p>\n      </div> \n    </div> \n    `),this.name="PropertyTag",this.expressID=0,this.innerElements={label:this.getInnerElement("label"),value:this.getInnerElement("value")},this.model=s,this.expressID=i,this._propertiesProcessor=t,this.setInitialValues(),this.setListeners()}async dispose(e=!1){await super.dispose(e),this.model=null,this._propertiesProcessor=null,Object.keys(this.innerElements).length&&(this.innerElements.value.remove(),this.innerElements.label.remove())}async setListeners(){const e=this._propertiesProcessor.propertiesManager;if(!e)return;const{key:t}=await wt.getEntityName(this.model,this.expressID),{key:s}=await wt.getQuantityValue(this.model,this.expressID);if(t){(await e.setAttributeListener(this.model,this.expressID,t)).add((e=>this.label=e.toString()))}if(s){(await e.setAttributeListener(this.model,this.expressID,s)).add((e=>this.value=e))}}async setInitialValues(){if(await this.model.getProperties(this.expressID)){const{name:e}=await wt.getEntityName(this.model,this.expressID),{value:t}=await wt.getQuantityValue(this.model,this.expressID);this.label=e,this.value=t}else this.label="NULL",this.value=`ExpressID ${this.expressID} not found`}}class At extends yt{constructor(e,t,s,i,n="Name"){super(e,t,s,i),this.name="AttributeTag",this.expressID=0,this.model=s,this.expressID=i,this.attributeName=n,this._propertiesProcessor=t,this.setInitialValues(),this.setListeners()}async dispose(e=!1){await super.dispose(e),this.model=null}async setListeners(){const e=this._propertiesProcessor.propertiesManager;if(e)try{(await e.setAttributeListener(this.model,this.expressID,this.attributeName)).add((e=>this.value=e))}catch(e){}}async setInitialValues(){if(!this.model.hasProperties)return this.label=`Model ${this.model.ifcMetadata.name} has no properties`,void(this.value="NULL");const e=await this.model.getProperties(this.expressID);if(!e)return this.label=`ExpressID ${this.expressID} not found`,void(this.value="NULL");if(!Object.keys(e).includes(this.attributeName))return this.label=`Attribute ${this.attributeName} not found`,void(this.value="NULL");e[this.attributeName]&&(this.label=this.attributeName,this.value=e[this.attributeName].value)}}class Ft extends le{set expressID(e){this._expressID=e,this._attributes=[],this.slots.content.dispose(!0)}get expressID(){return this._expressID}constructor(e,t,s,i){super(e,"ATTRIBUTES"),this.name="AttributeSet",this.attributesToIgnore=[],this._expressID=0,this._attributes=[],this._generated=!1,this.model=s,this.expressID=i,this._propertiesProcessor=t,this.onExpand.add((()=>this.generate()))}async dispose(e=!1){await super.dispose(e),this.model=null,this.attributesToIgnore=[],this._attributes=[],this._propertiesProcessor=null}async generate(){!this._generated&&this.model.hasProperties&&(await this.update(),this._generated=!0)}async update(){const e=await this.model.getProperties(this.expressID);if(e)for(const t in e){if(this.attributesToIgnore.includes(t))continue;if(this._attributes.includes(t));else{const s=e[t];if(!s?.value)continue;this._attributes.push(t);const i=new At(this._components,this._propertiesProcessor,this.model,this.expressID,t);this.addChild(i)}}}}class Rt extends j{set propertiesManager(e){this._propertiesManager||(this._propertiesManager=e,e&&(e.onElementToPset.add((async({model:e,psetID:t,elementID:s})=>{if(this._indexMap[e.uuid]&&(this.setEntityIndex(e,s).add(t),this._currentUI[s])){const i=await this.newPsetUI(e,t);this._currentUI[s].addChild(...i)}})),e.onPsetRemoved.add((async({psetID:e})=>{const t=this._currentUI[e];t&&await t.dispose()})),e.onPropToPset.add((async({model:e,psetID:t,propID:s})=>{const i=this._currentUI[t];if(!i)return;const n=await this.newPropertyTag(e,t,s,"NominalValue");n&&i.addChild(n)})),this.onPropertiesManagerSet.trigger(e)))}get propertiesManager(){return this._propertiesManager}constructor(e){super(e),this.onDisposed=new W,this.enabled=!0,this.uiElement=new Q,this.relationsToProcess=[x.IFCRELDEFINESBYPROPERTIES,x.IFCRELDEFINESBYTYPE,x.IFCRELASSOCIATESMATERIAL,x.IFCRELCONTAINEDINSPATIALSTRUCTURE,x.IFCRELASSOCIATESCLASSIFICATION,x.IFCRELASSIGNSTOGROUP],this.entitiesToIgnore=[x.IFCOWNERHISTORY,x.IFCMATERIALLAYERSETUSAGE],this.attributesToIgnore=["CompositionType","Representation","ObjectPlacement","OwnerHistory"],this._indexMap={},this._renderFunctions={},this._propertiesManager=null,this._currentUI={},this.onPropertiesManagerSet=new W,this.onFragmentsDisposed=e=>{delete this._indexMap[e.groupID]},this.components.tools.add(Rt.uuid,this),this._renderFunctions=this.getRenderFunctions();e.tools.get(rt).onFragmentsDisposed.add(this.onFragmentsDisposed),e.uiEnabled&&this.setUI()}getRenderFunctions(){return{0:(e,t)=>this.newEntityUI(e,t),[x.IFCPROPERTYSET]:(e,t)=>this.newPsetUI(e,t),[x.IFCELEMENTQUANTITY]:(e,t)=>this.newQsetUI(e,t)}}async dispose(){await this.uiElement.dispose(),this._indexMap={},this.propertiesManager=null;for(const e in this._currentUI)await this._currentUI[e].dispose();this._currentUI={},this.onPropertiesManagerSet.reset();this.components.tools.get(rt).onFragmentsDisposed.remove(this.onFragmentsDisposed),await this.onDisposed.trigger(Rt.uuid),this.onDisposed.reset()}async getProperties(e,t){if(!e.hasProperties)return null;const s=e.getLocalProperties();if(void 0===s)return null;const i=this._indexMap[e.uuid];if(!i)return null;const n=i[t],o=parseInt(t,10),r=await e.getProperties(o);if(!r)throw new Error("Properties not found!");const a=this.cloneProperty(r);if(!a)throw new Error("Properties not found!");const l=[a];if(n)for(const t of n){const i=await e.getProperties(t);if(!i)continue;const n=this.cloneProperty(i);n&&(this.getPsetProperties(n,s),this.getNestedPsets(n,s),l.push(n))}return l}getNestedPsets(e,t){if(e.HasPropertySets)for(const s of e.HasPropertySets){const e=s.value;s.value=this.cloneProperty(t[e]),this.getPsetProperties(s.value,t)}}getPsetProperties(e,t){if(e.HasProperties)for(const s of e.HasProperties){const e=s.value,i=this.cloneProperty(t[e]);s.value={...i}}}setUI(){const e=new oe(this.components),t=new oe(this.components,'<div class="flex flex-col"></div>'),s=new ae(this.components,{materialIconName:"list"}),i=new de(this.components);this.components.ui.add(i),i.title="Element Properties",i.addChild(e,t),s.tooltip="Properties",s.onClick.add((()=>{i.visible=!i.visible})),i.onHidden.add((()=>s.active=!1)),i.onVisible.add((()=>s.active=!0)),i.visible=!1,this.uiElement.set({main:s,propertiesWindow:i,propsList:t,topToolbar:e})}async cleanPropertiesList(){if(this._currentUI={},this.components.uiEnabled){if(this._propertiesManager){this._propertiesManager.uiElement.get("exportButton").removeFromParent()}const e=this.uiElement.get("propsList");await e.dispose(!0);this.uiElement.get("propertiesWindow").description=null,e.children=[]}}get(){return this._indexMap}async process(e){if(!e.hasProperties)throw new Error("FragmentsGroup properties not found");this._indexMap[e.uuid]={};const t=[x.IFCPROPERTYSET,x.IFCELEMENTQUANTITY];for(const s of this.relationsToProcess)await wt.getRelationMap(e,s,(async(s,i)=>{const n=await e.getProperties(s);if(n){t.includes(n.type)||this.setEntityIndex(e,s);for(const t of i)this.setEntityIndex(e,t).add(s)}}))}async renderProperties(e,t){if(!this.components.uiEnabled)return;await this.cleanPropertiesList();const s=this.uiElement.get("topToolbar"),i=this.uiElement.get("propsList"),n=this.uiElement.get("propertiesWindow"),o=await this.newEntityUI(e,t);if(!o)return;if(this._propertiesManager){this._propertiesManager.selectedModel=e;const t=this._propertiesManager.uiElement.get("exportButton");s.addChild(t)}const{name:r}=await wt.getEntityName(e,t);n.description=r,i.addChild(...[o].flat())}async newEntityUI(e,t){if(!e.hasProperties)throw new Error("FragmentsGroup properties not found.");const s=this._indexMap[e.uuid];if(!s)return null;const i=await e.getProperties(t),n=this.entitiesToIgnore.includes(i?.type);if(!i||n)return null;if(i.type===x.IFCPROPERTYSET)return this.newPsetUI(e,t);const o=await this.newEntityTree(e,t);return o?(this.addEntityActions(e,t,o),o.onExpand.add((async()=>{const{uiProcessed:i}=o.data;if(i)return;o.addChild(...this.newAttributesUI(e,t));const n=s[t]??[];for(const t of n){const i=await e.getProperties(t);if(!i)continue;const n=this._renderFunctions[i.type]??this._renderFunctions[0],r=s[t]?await this.newEntityUI(e,t):await n(e,t);r&&o.addChild(...[r].flat())}o.data.uiProcessed=!0})),o):null}setEntityIndex(e,t){return this._indexMap[e.uuid][t]||(this._indexMap[e.uuid][t]=new Set),this._indexMap[e.uuid][t]}newAttributesUI(e,t){if(!e.hasProperties)return[];const s=new Ft(this.components,this,e,t);return s.attributesToIgnore=this.attributesToIgnore,[s]}async newPsetUI(e,t){const s=[],i=await e.getProperties(t);if(!i||i.type!==x.IFCPROPERTYSET)return s;const n=await this.newEntityTree(e,t);return n?(await this.addPsetActions(e,t,n),n.onExpand.add((async()=>{const{uiProcessed:s}=n.data;if(s)return;const i=await wt.getPsetProps(e,t,(async s=>{if(!await e.getProperties(s))return;const i=await this.newPropertyTag(e,t,s,"NominalValue");i&&n.addChild(i)}));if(!i||0===i.length){const e='\n         <p class="text-base text-gray-500 py-1 px-3">\n            This pset has no properties.\n         </p>\n        ',t=new oe(this.components,e);n.addChild(t)}n.data.uiProcessed=!0})),s.push(n),s):s}async newQsetUI(e,t){const s=[],i=await e.getProperties(t);if(!i||i.type!==x.IFCELEMENTQUANTITY)return s;const n=await this.newEntityTree(e,t);return n?(await this.addPsetActions(e,t,n),await wt.getQsetQuantities(e,t,(async s=>{const{key:i}=await wt.getQuantityValue(e,s);if(!i)return;const o=await this.newPropertyTag(e,t,s,i);o&&n.addChild(o)})),s.push(n),s):s}async addPsetActions(e,t,s){if(!this.propertiesManager)return;const i=this.propertiesManager.uiElement.get("psetActions");(await this.propertiesManager.setAttributeListener(e,t,"Name")).add((e=>s.description=e.toString())),s.innerElements.titleContainer.onmouseenter=()=>{i.data={model:e,psetID:t},s.slots.titleRight.addChild(i)},s.innerElements.titleContainer.onmouseleave=()=>{i.modalVisible||(i.removeFromParent(),i.cleanData())}}addEntityActions(e,t,s){if(!this.propertiesManager)return;const i=this.propertiesManager.uiElement.get("entityActions");s.innerElements.titleContainer.onmouseenter=()=>{i.data={model:e,elementIDs:[t]},s.slots.titleRight.addChild(i)},s.innerElements.titleContainer.onmouseleave=()=>{i.modal.visible||(i.removeFromParent(),i.cleanData())}}async newEntityTree(e,t){const s=await e.getProperties(t);if(!s)return null;const i=this._currentUI[t];if(i)return i;const n=new le(this.components);this._currentUI[t]=n,n.title=`${ft[s.type]}`;const{name:o}=await wt.getEntityName(e,t);return n.description=o,n}async newPropertyTag(e,t,s,i){if(!await e.getProperties(s))return null;const n=new yt(this.components,this,e,s);if(this._currentUI[s]=n,!this.propertiesManager)return n;const o=this.propertiesManager.uiElement.get("propActions");return n.get().onmouseenter=()=>{o.data={model:e,setID:t,expressID:s,valueKey:i},n.addChild(o)},n.get().onmouseleave=()=>{o.modalVisible||(o.removeFromParent(),o.cleanData())},n}cloneProperty(e,t={}){if(!e)return t;for(const s in e){const i=e[s],n=Array.isArray(i),o="object"==typeof i&&!n&&null!==i;if(n){t[s]=[];const e=t[s];this.clonePropertyArray(i,e)}else if(o){t[s]={};const e=t[s];this.cloneProperty(i,e)}else t[s]=i}return t}clonePropertyArray(e,t){for(const s of e){const e=Array.isArray(s),i="object"==typeof s&&!e&&null!==s;if(e){const e=[];t.push(e),this.clonePropertyArray(s,e)}else if(i){const e={};t.push(e),this.cloneProperty(s,e)}else t.push(s)}}}Rt.uuid="23a889ab-83b3-44a4-8bee-ead83438370b",Z.libraryUUIDs.add(Rt.uuid);class St extends oe{get query(){const e=this.attribute.value,t=this.condition.value,s=this.operator.value||null,i={attribute:e,condition:t,value:"type"===e?this.getTypeConstant(this.ifcTypes.value):this.value.value,negateResult:"NOT A"===this.negate.value,operator:s};return this.operator.visible&&(i.operator=this.operator.value),i}set query(e){if(e.operator&&(this.operator.value=e.operator,this.operator.visible=!0),this.attribute.value=e.attribute,this.condition.value=e.condition,this.negate.value=e.negateResult?"NOT A":"A","type"===e.attribute){if("number"!=typeof e.value)throw new Error("Corrupted IfcPropertiesFinder cached data!");this.value.value="",this.ifcTypes.value=ft[e.value]}else this.ifcTypes.value=null,this.value.value=String(e.value)}getTypeConstant(e){for(const[t,s]of Object.entries(ft))if(s===e)return Number(t);return null}constructor(e){super(e,'<div class="flex gap-x-2"></div>'),this.negate=new ue(e);const t=this.negate.domElement.classList;t.remove("w-full"),t.add("min-w-[4.5rem]"),this.negate.label="Sign",this.negate.addOption("A","NOT A"),this.negate.value="A",this.operator=new ue(e),this.operator.visible=!1,this.operator.label="Operator",this.operator.get().style.width="300px",this.operator.addOption("AND","OR"),this.attribute=new ue(e),this.attribute.label="Attribute",this.attribute.addOption("type","Name","PredefinedType","NominalValue","Description"),this.attribute.onChange.add((e=>{const t="type"===e;this.value.visible=!t,this.ifcTypes.visible=t})),this.condition=new ue(e),this.condition.label="Condition",this.condition.addOption("is","includes","startsWith","endsWith","matches"),this.condition.value=this.condition.options[0],this.value=new pe(e),this.value.label="Value",this.ifcTypes=new ue(e),this.ifcTypes.allowSearch=!0,this.ifcTypes.visible=!1,this.ifcTypes.label="Value";for(const e of Object.values(ft))this.ifcTypes.addOption(e);this.ifcTypes.value="IFCWALL",this.removeBtn=new ae(e,{materialIconName:"remove"}),this.removeBtn.visible=!1,this.removeBtn.get().classList.remove("mt-auto","hover:bg-ifcjs-200"),this.removeBtn.get().classList.add("mt-auto","mb-2","hover:bg-error"),this.removeBtn.onClick.add((async()=>{this.parent instanceof oe&&this.parent.removeChild(this),await this.dispose()})),this.addChild(this.operator,this.attribute,this.condition,this.negate,this.value,this.ifcTypes,this.removeBtn),this.attribute.value="Name"}async dispose(e=!1){await super.dispose(e),await this.operator.dispose(),await this.attribute.dispose(),await this.condition.dispose(),await this.value.dispose(),await this.ifcTypes.dispose(),await this.removeBtn.dispose(),await this.negate.dispose()}}class Mt extends oe{get query(){const e=this.children.map((e=>e instanceof St?e.query:null)).filter((e=>null!==e)),t={queries:e};return this.operator.visible&&(t.operator=this.operator.value),t}set query(e){e.operator&&(this.operator.value=e.operator);for(const e of this.children)e instanceof St&&(this.removeChild(e),e.dispose());let t=!0;for(const[s,i]of e.queries.entries()){if(!i.condition)continue;const e=i;0===s&&e.operator&&delete e.operator;const n=new St(this._components);n.query=e,this.addChild(n),t?t=!1:n.removeBtn.visible=!0}}constructor(e){super(e,'<div class="flex flex-col gap-y-3 p-3 border border-solid border-ifcjs-120 rounded-md"></div>'),this.operator=new ue(e),this.operator.visible=!1,this.operator.label=null,this.operator.addOption("AND","OR");const t=new oe(e,'<div class="flex gap-x-2 w-fit ml-auto"></div>'),s=new ae(e,{materialIconName:"add"});s.get().classList.add("w-fit"),s.label="Add Rule",s.onClick.add((()=>{const t=new St(e);t.operator.visible=!0,t.operator.value=t.operator.options[0],t.removeBtn.visible=!0,this.addChild(t)}));const i=new ae(e,{materialIconName:"add"});i.get().classList.add("w-fit"),i.label="Add Group",this.removeBtn=new ae(e,{materialIconName:"delete"}),this.removeBtn.label="Delete Group",this.removeBtn.visible=!1,this.removeBtn.onClick.add((async()=>{this.parent instanceof oe&&this.parent.removeChild(this),await this.dispose()})),t.addChild(s,this.removeBtn);const n=new St(e);this.addChild(t,this.operator,n)}async dispose(e=!1){await super.dispose(e),await this.operator.dispose(),await this.removeBtn.dispose()}}class Pt extends oe{get query(){return this.children.map((e=>e instanceof Mt?e.query:null)).filter((e=>null!==e))}set query(e){for(const e of this.children)e instanceof Mt&&(this.removeChild(e),e.dispose());let t=!0;for(const[s,i]of e.entries()){0===s&&i.operator&&delete i.operator;const e=new Mt(this._components);e.removeBtn.visible=!0,e.query=i,this.addChild(e),t&&(t=!1,e.removeBtn.visible=!1)}this.get().append(this.findButton.get()),this.onQuerySet.trigger(e)}constructor(e){super(e,'<div class="flex flex-col gap-y-3"></div>'),this.onQuerySet=new W,this.findButton=new ae(this._components,{materialIconName:"search"}),this.findButton.label="Find",this.findButton.alignment="center",this.findButton.get().classList.add("border","border-solid","border-ifcjs-120","hover:border-ifcjs-200");const t=new oe(this._components,'<div class="flex gap-x-2 w-fit ml-auto"></div>'),s=new ae(this._components,{materialIconName:"add"});s.get().classList.add("w-fit"),s.label="Add Group",s.onClick.add((()=>{const e=new Mt(this._components);e.operator.visible=!0,e.operator.value=e.operator.options[0],e.removeBtn.visible=!0,this.addChild(e),this.get().append(this.findButton.get())}));new ae(this._components,{materialIconName:"refresh"}).label="Reset",t.addChild(s);const i=new Mt(this._components);this.addChild(t,i,this.findButton)}async dispose(e=!1){await super.dispose(e),await this.findButton.dispose(),this.onQuerySet.reset()}}class Lt extends j{constructor(e){super(e),this.onFound=new W,this.onDisposed=new W,this.enabled=!0,this.uiElement=new Q,this._localStorageID="IfcPropertiesFinder",this._indexedModels={},this._noHandleAttributes=["type"],this.onFragmentsDisposed=e=>{delete this._indexedModels[e.groupID]},this._conditionFunctions=this.getConditionFunctions();e.tools.get(rt).onFragmentsDisposed.add(this.onFragmentsDisposed)}init(){this.components.uiEnabled&&this.setUI()}get(){return this._indexedModels}async dispose(){this._indexedModels={},this.onFound.reset(),await this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}loadCached(e){e&&(this._localStorageID=`IfcPropertiesFinder-${e}`);const t=localStorage.getItem(this._localStorageID);if(!t)return;const s=JSON.parse(t);this.uiElement.get("query").query=s}deleteCache(){localStorage.removeItem(this._localStorageID)}setUI(){const e=new ae(this.components,{materialIconName:"manage_search"}),t=new de(this.components);this.components.ui.add(t);const s=this.components.tools.get(rt);t.get().style.width="700px",t.get().style.height="420px",t.visible=!1,t.title="Model Queries",e.onClick.add((()=>{t.visible=!t.visible})),t.onVisible.add((()=>e.active=!0)),t.onHidden.add((()=>e.active=!1));const i=new Pt(this.components);i.findButton.onClick.add((async()=>{s.groups[0]&&await this.find()})),t.addChild(i),this.uiElement.set({main:e,queryWindow:t,query:i})}async indexEntityRelations(e){const t={};await wt.getRelationMap(e,x.IFCRELDEFINESBYPROPERTIES,(async(s,i)=>{t[s]||(t[s]=new Set);const n=[];await wt.getPsetProps(e,s,(e=>{n.push(e),t[s].add(e),t[e]||(t[e]=new Set),t[e].add(s)}));for(const e of i){t[s].add(e);for(const s of n)t[s].add(e);t[e]||(t[e]=new Set),t[e].add(e)}}));const s=[x.IFCRELCONTAINEDINSPATIALSTRUCTURE,x.IFCRELDEFINESBYTYPE,x.IFCRELASSIGNSTOGROUP];for(const i of s)await wt.getRelationMap(e,i,(async(e,s)=>{t[e]||(t[e]=new Set);for(const i of s)t[e].add(i),t[i]||(t[i]=new Set),t[i].add(i)}));return this._indexedModels[e.uuid]=t,t}async find(e,t){const s=this.components.tools.get(rt),i=this.uiElement.get("query"),n=t||s.groups,o=e||i.query,r={};this.cache();for(const e of n){let t=this._indexedModels[e.uuid];t||(t=await this.indexEntityRelations(e));let s=[];for(const[i,n]of o.entries()){const o=new Set,r=this.simpleQuery(e,n,o),a=[];for(const e of r){const s=t[e];if(s){a.push(e);for(const e of s)o.has(e)||a.push(e)}}s="AND"===n.operator&&i>0?this.getCommonElements(s,a):[...s,...a]}const i=new Set;for(const[t]of e.data){s.includes(t)&&i.add(t)}const n=new Set;for(const e of s){i.has(e)||n.add(e)}r[e.uuid]={modelEntities:i,otherEntities:n}}const a=this.toFragmentMap(r);return await this.onFound.trigger(a),a}toFragmentMap(e){const t=this.components.tools.get(rt),s={};for(const i in e){const n=t.groups.find((e=>e.uuid===i));if(!n)continue;const o=e[i].modelEntities;for(const e of o){const t=n.data.get(e);if(t)for(const i of t[0]){const t=n.keyFragments.get(i);if(!t)throw new Error("Fragment ID not found!");s[t]||(s[t]=new Set),s[t].add(e)}}}return s}simpleQuery(e,t,s){const i=e.getLocalProperties();if(!i)throw new Error("Model has no properties");let n={},o=0,r=[];for(const a of t.queries){let t=[];const l="AND"===a.operator?n:i;if(a.condition){const e=this.getMatchingEntities(l,a,s);t=e.expressIDs,n={...n,...e.entities}}else t=[...this.simpleQuery(e,a,s)];r=0===o?t:this.combineArrays(r,t,a.operator??"AND"),o++}return new Set(r)}getMatchingEntities(e,t,s){const{attribute:i,condition:n}=t;let{value:o}=t;const r=!this._noHandleAttributes.includes(i),a=[],l=[];for(const h in e){const c=e[h];if(void 0===c)continue;const d=c[i];let u=r?d?.value:d;if(null==u)continue;const p=typeof o,m=typeof u;"number"===p&&"string"===m?o=o.toString():"string"===p&&"number"===m&&(u=u.toString());let E=this._conditionFunctions[n](u,o);t.negateResult&&(E=!E),E?(a.push(c.expressID),l.push(c)):t.negateResult&&s.add(c.expressID)}return{expressIDs:a,entities:l,excludedItems:s}}combineArrays(e,t,s){return s?"AND"===s?this.arrayIntersection(e,t):this.arrayUnion(e,t):t}getCommonElements(...e){const t=[],s=new Map;for(const t of e){const e=new Set(t);for(const t of e)s.has(t)?s.set(t,s.get(t)+1):s.set(t,1)}for(const[i,n]of s)n===e.length&&t.push(i);return t}arrayIntersection(e,t){return e.filter((e=>t.includes(e)))}arrayUnion(e,t){return[...e,...t]}cache(){const e=this.uiElement.get("query").query,t=JSON.stringify(e);localStorage.setItem(this._localStorageID,t)}getConditionFunctions(){return{is:(e,t)=>e===t,includes:(e,t)=>e.toString().includes(t.toString()),startsWith:(e,t)=>e.toString().startsWith(t.toString()),endsWith:(e,t)=>e.toString().endsWith(t.toString()),matches:(e,t)=>new RegExp(t.toString()).test(e.toString())}}}class Nt extends j{constructor(e){super(e),this.onDisposed=new W,this.enabled=!0,this.uiElement=new Q,this._localStorageID="FragmentHiderCache",this._updateVisibilityOnFound=!0,this._filterCards={},this.components.tools.add(Nt.uuid,this),e.uiEnabled&&this.setupUI(e)}setupUI(e){const t=new de(e);t.title="Filters",t.visible=!1,e.ui.add(t),t.domElement.style.width="530px",t.domElement.style.height="400px";const s=new ae(e,{materialIconName:"filter_alt",tooltip:"Visibility filters"});s.onClick.add((()=>{this.hideAllFinders(),t.visible=!t.visible}));const i=new oe(e,'<div class="flex"></div>'),n=new ae(e,{materialIconName:"add"});n.onClick.add((()=>this.createStyleCard())),i.addChild(n),t.addChild(i),this.uiElement.set({window:t,main:s})}async dispose(){this.uiElement.dispose(),await this.onDisposed.trigger(Nt.uuid),this.onDisposed.reset()}set(e,t){const s=this.components.tools.get(rt);if(t)for(const i in t){const n=t[i],o=s.list[i];o&&(o.setVisibility(e,n),this.updateCulledVisibility(o))}else for(const t in s.list){const i=s.list[t];i&&(i.setVisibility(e),this.updateCulledVisibility(i))}}isolate(e){this.set(!1),this.set(!0,e)}get(){}async update(){this._updateVisibilityOnFound=!1;for(const e in this._filterCards){const{finder:t}=this._filterCards[e];await t.find()}this._updateVisibilityOnFound=!0,this.updateQueries()}async loadCached(){const e=localStorage.getItem(this._localStorageID);if(!e)return;const t=JSON.parse(e);for(const e of t)this.createStyleCard(e);await this.update()}updateCulledVisibility(e){const t=this.components.tools.get(Xe);if(!t.isSetup)return;const s=t.get().get(e.id);s&&(s.count=e.mesh.count)}createStyleCard(e){const t=new oe(this.components);e&&e.id.length&&(t.id=e.id);const{id:s}=t;t.domElement.className="m-4 p-4 border-1 border-solid border-[#3A444E] rounded-md flex flex-col",t.domElement.innerHTML=`\n        <div id="top-container-${s}" class="flex">\n        </div>\n        <div id="bottom-container-${s}" class="flex gap-4 items-center">\n        </div>\n    `;const i=new ae(this.components,{materialIconName:"close"});i.domElement.classList.add("self-end"),i.onClick.add((()=>this.deleteStyleCard(s)));const n=t.getInnerElement("top-container");n&&n.appendChild(i.domElement);const o=t.getInnerElement("bottom-container");if(!o)throw new Error("Error creating UI elements!");const r=new pe(this.components);r.label="Name",r.domElement.addEventListener("focusout",(()=>{this.cache()})),e&&(r.value=e.name),o.append(r.domElement);const a=new me(this.components);a.value=!e||e.visible,a.label="Visible",a.onChange.add((()=>this.updateQueries()));const l=new me(this.components);l.value=!e||e.enabled,l.label="Enabled",l.onChange.add((()=>this.updateQueries()));const h=new oe(this.components);h.domElement.classList.remove("w-full"),h.addChild(a),h.addChild(l),o.append(h.domElement);const c=new Lt(this.components);c.init(),c.loadCached(s);const d=c.uiElement.get("query"),u=c.uiElement.get("main"),p=c.uiElement.get("queryWindow");d.findButton.label="Apply",o.append(u.domElement),p.onVisible.add((()=>{this.hideAllFinders(p.id);const e=u.domElement.getBoundingClientRect();p.domElement.style.left=`${e.x+90}px`,p.domElement.style.top=e.y-120+"px"})),c.onFound.add((e=>{p.visible=!1,u.active=!1,this._filterCards[s].fragments=e,this.cache(),this._updateVisibilityOnFound&&this.updateQueries()}));this._filterCards[s]={styleCard:t,fragments:{},name:r,finder:c,deleteButton:i,visible:a,enabled:l};this.uiElement.get("window").addChild(t)}updateQueries(){this.set(!0);for(const e in this._filterCards){const{enabled:t,visible:s,fragments:i}=this._filterCards[e];t.value&&this.set(s.value,i)}this.cache()}async deleteStyleCard(e){const t=this._filterCards[e];t&&(await t.styleCard.dispose(),await t.deleteButton.dispose(),await t.name.dispose(),t.finder.deleteCache(),await t.finder.dispose(),await t.visible.dispose(),await t.enabled.dispose()),delete this._filterCards[e],this.updateQueries()}hideAllFinders(e){for(const t in this._filterCards){const{finder:s}=this._filterCards[t],i=s.uiElement.get("queryWindow"),n=s.uiElement.get("main");i.id!==e&&(i.visible&&n.domElement.click())}}cache(){const e=[];for(const t in this._filterCards){const s=this._filterCards[t],{visible:i,enabled:n,name:o}=s;e.push({visible:i.value,enabled:n.value,name:o.value,id:t})}const t=JSON.stringify(e);localStorage.setItem(this._localStorageID,t)}}Nt.uuid="dd9ccf2d-8a21-4821-b7f6-2949add16a29",Z.libraryUUIDs.add(Nt.uuid);class Ot extends j{get children(){return this._children}set children(e){this._children=e,e.forEach((e=>{const t=e.uiElement.get("tree");this.uiElement.get("tree").addChild(t)}))}constructor(e,t,s){super(e),this.name="FragmentTreeItem",this.enabled=!0,this.filter={},this.uiElement=new Q,this.onSelected=new W,this.onHovered=new W,this.visible=!0,this._children=[],this._blockCheckbox=!1;const i=new ae(e),n=new le(e,s),o=new me(e);o.label="",o.value=!0;const r=this.components.tools.get(Nt);o.onChange.add((async e=>{if(this.visible=e,this._blockCheckbox)return;if(0===Object.keys(this.filter).length)for(const s of this.children){const i=await t.find(s.filter);r.set(e,i)}else{const s=await t.find(this.filter);r.set(e,s)}for(const t of this.children)t.setCheckbox(e,!0)})),n.slots.titleRight.addChild(o),this.uiElement.set({main:i,tree:n,checkbox:o}),n.onClick.add((async e=>{if(e.target instanceof HTMLInputElement)return;const s=await t.find(this.filter);await this.onSelected.trigger({items:s,visible:this.visible})})),n.get().onmouseenter=async()=>{const e=await t.find(this.filter);await this.onHovered.trigger({items:e,visible:this.visible})}}setCheckbox(e,t){this.visible=e,this._blockCheckbox=!0;if(this.uiElement.get("checkbox").value=e,this._blockCheckbox=!1,t)for(const t of this.children)t.setCheckbox(e,!0)}async dispose(){await this.uiElement.dispose(),this.onSelected.reset(),this.onHovered.reset();for(const e of this.children)await e.dispose()}get(){return{name:this.name,filter:this.filter,children:this.children}}}class xt extends j{constructor(e){super(e),this.enabled=!0,this._groupSystems={},this.onDisposed=new W,this.onFragmentsDisposed=e=>{const{groupID:t,fragmentIDs:s}=e;for(const e in this._groupSystems){const i=this._groupSystems[e],n=Object.keys(i);if(n.includes(t))delete i[t],0===Object.values(i).length&&delete this._groupSystems[e];else for(const e of n){const t=i[e];for(const e of s)delete t[e];0===Object.values(t).length&&delete i[e]}}},e.tools.add(xt.uuid,this);e.tools.get(rt).onFragmentsDisposed.add(this.onFragmentsDisposed)}get(){return this._groupSystems}async dispose(){this._groupSystems={};this.components.tools.get(rt).onFragmentsDisposed.remove(this.onFragmentsDisposed),await this.onDisposed.trigger(xt.uuid),this.onDisposed.reset()}remove(e){for(const t in this._groupSystems){const s=this._groupSystems[t];for(const t in s){delete s[t][e]}}}find(e){const t=this.components.tools.get(rt);if(!e){const e={},s=t.list;for(const t in s){const i=s[t];e[t]=new Set(i.ids)}return e}const s=Object.keys(e).length,i={};for(const t in e){const s=e[t];if(this._groupSystems[t])for(const e of s){const s=this._groupSystems[t][e];if(s)for(const e in s){i[e]||(i[e]=new Map);for(const t of s[e]){const s=i[e].get(t);void 0===s?i[e].set(t,1):i[e].set(t,s+1)}}}else console.warn(`Classification ${t} does not exist.`)}const n={};for(const e in i){const t=i[e];for(const[i,o]of t){if(void 0===o)throw new Error("Malformed fragments map!");o===s&&(n[e]||(n[e]=new Set),n[e].add(i))}}return n}byModel(e,t){this._groupSystems.model||(this._groupSystems.model={});const s=this._groupSystems.model;s[e]||(s[e]={});const i=s[e];for(const[e,s]of t.data){const n=s[0];for(const s of n){const n=t.keyFragments.get(s);n&&(i[n]||(i[n]=new Set),i[n].add(e))}}}async byPredefinedType(e){this._groupSystems.predefinedTypes||(this._groupSystems.predefinedTypes={});const t=this._groupSystems.predefinedTypes,s=e.getAllPropertiesIDs();for(const i of s){const s=await e.getProperties(i);if(!s)continue;const n=String(s.PredefinedType?.value).toUpperCase();t[n]||(t[n]={});const o=t[n];for(const[t,i]of e.data){const t=i[0];for(const i of t){const t=e.keyFragments.get(i);if(!t)throw new Error("Fragment ID not found!");o[t]||(o[t]=new Set);o[t].add(s.expressID)}}}}byEntity(e){this._groupSystems.entities||(this._groupSystems.entities={});for(const[t,s]of e.data){const i=s[1][1],n=ft[i];this.saveItem(e,"entities",n,t)}}byStorey(e){for(const[t,s]of e.data){const i=s[1][0].toString();this.saveItem(e,"storeys",i,t)}}async byIfcRel(e,t,s){wt.isRel(t)&&await wt.getRelationMap(e,t,(async(t,i)=>{const{name:n}=await wt.getEntityName(e,t);for(const t of i)this.saveItem(e,s,n??"NO REL NAME",t)}))}saveItem(e,t,s,i){this._groupSystems[t]||(this._groupSystems[t]={});const n=e.data.get(i);if(n)for(const o of n[0]){const n=e.keyFragments.get(o);if(n){const e=this._groupSystems[t];e[s]||(e[s]={}),e[s][n]||(e[s][n]=new Set),e[s][n].add(i)}}}}xt.uuid="e25a7f3c-46c4-4a14-9d3d-5115f24ebeb7",Z.libraryUUIDs.add(xt.uuid);class Dt extends j{constructor(e){super(e),this.onDisposed=new W,this.enabled=!0,this.onSelected=new W,this.onHovered=new W,this._title="Model Tree",this.uiElement=new Q}get(){if(!this._tree)throw new Error("Fragment tree not initialized yet!");return this._tree}init(){const e=this.components.tools.get(xt),t=new Ot(this.components,e,"Model Tree");this._tree=t,this.components.uiEnabled&&this.setupUI(t)}async dispose(){this.onSelected.reset(),this.onHovered.reset(),this.uiElement.dispose(),this._tree&&await this._tree.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset()}async update(e){if(!this._tree)return;const t=this.components.tools.get(xt);this._tree.children.length&&(await this._tree.dispose(),this._tree=new Ot(this.components,t,this._title)),this._tree.children=this.regenerate(e)}setupUI(e){const t=new de(this.components),s=e.uiElement.get("tree");t.addChild(s),t.title="Model tree",this.components.ui.add(t),t.visible=!1;const i=new ae(this.components);i.materialIcon="account_tree",i.tooltip="Model tree",i.onClick.add((()=>{t.visible=!t.visible})),this.uiElement.set({main:i,window:t})}regenerate(e,t={}){const s=this.components.tools.get(xt).get(),i=[],n=e[0],o=s[n];if(!n||!o)return i;for(const s in o){const o=this.components.tools.get(xt),r={...t,[n]:[s]},a=o.find(r);if(Object.keys(a).length>0){const t=n[0].toUpperCase()+n.slice(1),a=new Ot(this.components,o,`${t}: ${s}`);a.onHovered.add((e=>this.onHovered.trigger(e))),a.onSelected.add((e=>this.onSelected.trigger(e))),a.filter=r,i.push(a),a.children=this.regenerate(e.slice(1),r)}}return i}}class Ut extends j{get(){return this._explodedFragments}constructor(e){super(e),this.enabled=!1,this.height=10,this.groupName="storeys",this.uiElement=new Q,this.onDisposed=new W,this._explodedFragments=new Set,e.tools.add(Ut.uuid,this),e.uiEnabled&&this.setupUI(e)}async dispose(){this._explodedFragments.clear(),await this.uiElement.dispose(),await this.onDisposed.trigger(Ut.uuid),this.onDisposed.reset()}explode(){this.enabled=!0,this.update()}reset(){this.enabled=!1,this.update()}update(){const t=this.components.tools.get(xt),s=this.components.tools.get(rt),i=this.enabled?1:-1;let n=0;const o=t.get()[this.groupName],r=new e.Matrix4;for(const e in o){r.elements[13]=n*i*this.height;for(const t in o[e]){const i=s.list[t],n=e+t,a=this._explodedFragments.has(n);if(!i||this.enabled&&a||!this.enabled&&!a)continue;this.enabled?this._explodedFragments.add(n):this._explodedFragments.delete(n);const l=o[e][t];i.applyTransform(l,r)}n++}}setupUI(e){const t=new ae(e);this.uiElement.set({main:t}),t.tooltip="Explode",t.materialIcon="splitscreen",t.onClick.add((async()=>{this.enabled?this.reset():this.explode()}))}}Ut.uuid="d260618b-ce88-4c7d-826c-6debb91de3e2",Z.libraryUUIDs.add(Ut.uuid);class Bt{get visible(){return this._visible}set visible(e){this._visible=e;const t=this.components.scene.get();for(const s in this._objects){const{root:i,marker:n}=this._objects[s];e?(t.add(i),i.add(n)):(i.removeFromParent(),n.removeFromParent())}}constructor(t){this.offsetFactor=.2,this.uiElement=new Q,this.planClicked=new W,this._scale=new e.Vector2(1,1),this._min=new e.Vector3,this._max=new e.Vector3,this._objects={},this._visible=!1,this._planeGeometry=new e.PlaneGeometry(1,1,1),this._linesGeometry=new e.BufferGeometry,this.lineMaterial=new e.LineDashedMaterial({color:12382500,dashSize:.2,gapSize:.2}),this._material=new e.MeshBasicMaterial({transparent:!0,opacity:.3,color:1712424,depthTest:!1}),this.components=t,this.resetBounds(),this.createPlaneOutlineGeometry(),t.uiEnabled&&this.setUI(t)}async dispose(){this.planClicked.reset(),this.visible=!1;for(const e in this._objects){const{marker:t,button:s,outline:i,root:n,plane:o}=this._objects[e];await s.dispose(),i.removeFromParent(),i.geometry=null,i.material=[],n.removeFromParent(),n.children=[],o.removeFromParent(),o.material=[],o.geometry=null,t.element.remove()}this._objects={},this._planeGeometry.dispose(),this._material.dispose(),this.uiElement.dispose(),this.lineMaterial.dispose(),this._material.dispose(),this.components=null}add(t){const{id:s,point:i,name:n}=t,o=new e.Group;o.position.copy(i);const r=new e.Mesh(this._planeGeometry,this._material);r.rotation.x=-Math.PI/2,o.add(r);const a=new e.LineSegments(this._linesGeometry,this.lineMaterial);a.computeLineDistances(),a.rotation.x=-Math.PI/2,o.add(a);const l=new ae(this.components,{materialIconName:"location_on",tooltip:n});l.onClick.add((async()=>{await this.planClicked.trigger({id:t.id})}));const{domElement:h}=l;h.classList.remove("bg-transparent"),h.className+=" transition-none rounded-full";const c=new m(h);o.add(c),this._objects[s]={root:o,plane:r,outline:a,marker:c,button:l}}setBounds(t,s=!1){s&&this.resetBounds();const i=Et.getBounds(t,this._min,this._max);this._min=i.min,this._max=i.max;const n=Et.getDimensions(i),{width:o,depth:r,center:a}=n,l=(o+r/2)*this.offsetFactor,h=new e.Vector2(o+l,r+l),c=this.newScaleMatrix(this._scale),d=this.newScaleMatrix(h);c.invert(),this._planeGeometry.applyMatrix4(c),this._linesGeometry.applyMatrix4(c),this._planeGeometry.applyMatrix4(d),this._linesGeometry.applyMatrix4(d);for(const e in this._objects){const{root:t,outline:s}=this._objects[e];s.computeLineDistances(),t.position.x=a.x,t.position.z=a.z}}setUI(e){const t=new ae(e,{materialIconName:"layers",tooltip:"3D Plans"});t.onClick.add((()=>{this.visible=!this.visible})),this.uiElement.set({main:t})}resetBounds(){this._min=Et.newBound(!0),this._max=Et.newBound(!1)}newScaleMatrix(t){const{x:s,y:i}=t;return(new e.Matrix4).fromArray([s,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1])}createPlaneOutlineGeometry(){const t=new Float32Array([-.5,-.5,0,-.5,.5,0,-.5,.5,0,.5,.5,0,.5,.5,0,.5,-.5,0,.5,-.5,0,-.5,-.5,0]),s=new e.BufferAttribute(t,3);this._linesGeometry.setAttribute("position",s)}}class kt{get visible(){return null!==this.mesh.parent}set visible(e){const t=this.getStyle();if(e){this._components.scene.get().add(this.mesh),t&&t.meshes.add(this.mesh)}else this.mesh.removeFromParent(),t&&t.meshes.delete(this.mesh)}set geometry(e){this._geometry=e,this.mesh.geometry.attributes.position=e.attributes.position}constructor(t,s,i,n){this.mesh=new e.Mesh(new e.BufferGeometry),this._precission=1e4,this._tempVector=new e.Vector3,this._plane2DCoordinateSystem=new e.Matrix4,this._components=t,this.mesh.material=n,this.mesh.frustumCulled=!1,this._plane=s;const{x:o,y:r,z:a}=s.normal;1===Math.abs(o)?this._planeAxis="x":1===Math.abs(r)?this._planeAxis="y":1===Math.abs(a)&&(this._planeAxis="z"),this._geometry=i,this.mesh.geometry.attributes.position=i.attributes.position;const l=s.normal.clone().multiplyScalar(.01);this.mesh.position.copy(l),this.visible=!0}dispose(){const e=this.getStyle();e&&e.meshes.delete(this.mesh),this.mesh.geometry.dispose(),this.mesh.removeFromParent(),this.mesh.geometry=null,this.mesh=null,this._plane=null,this._geometry=null}update(e){const t=this._geometry.attributes.position.array;if(!t)return;this.updatePlane2DCoordinateSystem();const s=[];let i=0;for(let n=0;n<e.length;n++){const o=e[n],r=[];for(let e=i;e<o;e+=2)r.push(3*e);const a=this.computeFill(r,t);for(const e of a)s.push(e);i=o}this.mesh.geometry.setIndex(s)}computeFill(e,t){const s=new Map,i={},n=new Map;let o=0;const r=new Map,a=new Map,l=new Set,h=this._precission;for(let c=0;c<e.length;c++){const d=e[c];let u=0,p=0,m=0,E=0;const g=t[d],I=t[d+1],C=t[d+2],f=t[d+3],w=t[d+4],T=t[d+5];if(this._tempVector.set(g,I,C),this._tempVector.applyMatrix4(this._plane2DCoordinateSystem),u=Math.trunc(this._tempVector.x*h)/h,p=Math.trunc(this._tempVector.y*h)/h,this._tempVector.set(f,w,T),this._tempVector.applyMatrix4(this._plane2DCoordinateSystem),m=Math.trunc(this._tempVector.x*h)/h,E=Math.trunc(this._tempVector.y*h)/h,u===m&&p===E)continue;const b=`${u}|${p}`,v=`${m}|${E}`;s.has(b)||s.set(b,d/3),s.has(v)||s.set(v,d/3+1);const _=s.get(b),y=s.get(v);i[_]=[u,p],i[y]=[m,E];const A=a.has(_),F=r.has(_),R=a.has(y),S=r.has(y);if(!(A||F||R||S))a.set(_,o),r.set(y,o),l.add(o),n.set(o,[_,y]),o++;else if(A&&S){const e=a.get(_),t=r.get(y);if(e!==t){const s=n.get(t),i=n.get(e);if(!s||!i)continue;n.delete(e),l.delete(e),r.set(i[i.length-1],t),r.delete(s[s.length-1]);for(const e of i)s.push(e)}else l.delete(t);a.delete(_),r.delete(y)}else if(F&&R){const e=a.get(y),t=r.get(_);if(e!==t){const s=n.get(t),i=n.get(e);if(!s||!i)continue;n.delete(e),l.delete(e),r.set(i[i.length-1],t),r.delete(s[s.length-1]);for(const e of i)s.push(e)}else l.delete(t);a.delete(y),r.delete(_)}else if(A&&R){const e=a.get(y),t=a.get(_),s=n.get(t),i=n.get(e);if(!s||!i)continue;n.delete(e),l.delete(e),a.delete(s[0]),a.delete(i[0]),r.delete(i[i.length-1]),a.set(i[i.length-1],t),i.reverse(),s.splice(0,0,...i)}else if(F&&S){const e=r.get(y),t=r.get(_),s=n.get(t),i=n.get(e);if(!s||!i)continue;n.delete(e),l.delete(e),r.delete(s[s.length-1]),r.delete(i[i.length-1]),a.delete(i[0]),r.set(i[0],t),i.reverse(),s.push(...i)}else if(A){const e=a.get(_),t=n.get(e);if(!t)continue;t.unshift(y),a.delete(_),a.set(y,e)}else if(F){const e=r.get(_),t=n.get(e);if(!t)continue;t.push(y),r.delete(_),r.set(y,e)}else if(R){const e=a.get(y),t=n.get(e);if(!t)continue;t.unshift(_),a.delete(y),a.set(_,e)}else if(S){const e=r.get(y),t=n.get(e);if(!t)continue;t.push(_),r.delete(y),r.set(_,e)}}const c=[];for(const[e,t]of n){if(l.has(e))continue;const s=[],n=new Map;let o=0;for(const e of t){const t=i[e];s.push(t[0],t[1]),n.set(o++,e)}const r=D(s);for(const e of r){const t=n.get(e);if(void 0===t)throw new Error("Map error!");c.push(t)}}return c}updatePlane2DCoordinateSystem(){this._plane2DCoordinateSystem=new e.Matrix4;const t=new e.Vector3(1,0,0),s=new e.Vector3(0,1,0),i=this._plane.normal,n=new e.Vector3;this._plane.coplanarPoint(n),"x"===this._planeAxis?t.crossVectors(s,i):"y"===this._planeAxis?s.crossVectors(i,t):"z"===this._planeAxis||(t.crossVectors(s,i).normalize(),s.crossVectors(i,t)),this._plane2DCoordinateSystem.fromArray([t.x,t.y,t.z,0,s.x,s.y,s.z,0,i.x,i.y,i.z,0,n.x,n.y,n.z,1]),this._plane2DCoordinateSystem.invert()}getStyle(){const e=this._components.renderer;if(this.styleName&&e instanceof it){return e.postproduction.customEffects.outlinedMeshes[this.styleName]}return null}}class Vt extends j{get visible(){return this._visible}get fillVisible(){for(const e in this._edges){const t=this._edges[e];if(t.fill)return t.fill.visible}return!1}set fillVisible(e){for(const t in this._edges){const s=this._edges[t];s.fill&&(s.fill.visible=e)}}constructor(t,s,i){super(t),this.onDisposed=new W,this.onAfterUpdate=new W,this.onBeforeUpdate=new W,this.name="ClippingEdges",this.enabled=!0,this.fillNeedsUpdate=!1,this._edges={},this._visible=!0,this._inverseMatrix=new e.Matrix4,this._localPlane=new e.Plane,this._tempLine=new e.Line3,this._tempVector=new e.Vector3,this._plane=s,this._styles=i}async setVisible(e){this._visible=e;const t=Object.keys(this._edges);for(const s of t)this.updateEdgesVisibility(s,e);e&&await this.update()}async update(){const e=this._styles.get();await this.updateDeletedEdges(e);for(const t in e)this.drawEdges(t);this.fillNeedsUpdate=!1}get(){return this._edges}async dispose(){const e=Object.keys(this._edges);for(const t of e)this.disposeEdge(t);await this.onDisposed.trigger(),this.onDisposed.reset()}newEdgesMesh(t){const s=this._styles.get()[t].lineMaterial,i=new e.BufferGeometry,n=new Float32Array(3e5),o=new e.BufferAttribute(n,3,!1);o.setUsage(e.DynamicDrawUsage),i.setAttribute("position",o);const r=new e.LineSegments(i,s);return r.frustumCulled=!1,r}newFillMesh(e,t){const s=this._styles.get()[e],i=s.fillMaterial;if(i){const n=new kt(this.components,this._plane,t,i);return this.newFillOutline(e,n,s),n}}newFillOutline(e,t,s){if(!s.outlineMaterial)return;const i=this.components.renderer;if(i instanceof it){const n=i.postproduction.customEffects.outlinedMeshes;n[e]||(n[e]={meshes:new Set,material:s.outlineMaterial}),t.styleName=e}}drawEdges(t){const s=this._styles.get()[t];this._edges[t]||this.initializeStyle(t);const i=this._edges[t];let n=0;const o=i.mesh.geometry.attributes.position;o.array.fill(0);const r=[];let a=0;for(const t of s.meshes)if(t.geometry){if(!t.geometry.boundsTree)throw new Error("Boundstree not found for clipping edges subset.");if(t instanceof e.InstancedMesh){if(0===t.count)continue;const i=t;for(let l=0;l<i.count;l++){const h=i instanceof O,c=i,d=s.fragments[c.fragment.id];if(h&&d){const e=c.fragment.getItemID(l);if(null===e||!d.has(e))continue}const u=new e.Mesh(t.geometry);u.matrix.copy(t.matrix);const p=new e.Matrix4;i.getMatrixAt(l,p),u.applyMatrix4(p),u.applyMatrix4(t.matrix),u.updateMatrix(),u.updateMatrixWorld(),this._inverseMatrix.copy(u.matrixWorld).invert(),this._localPlane.copy(this._plane).applyMatrix4(this._inverseMatrix),n=this.shapecast(u,o,n),n!==a&&(r.push(n),a=n)}}else this._inverseMatrix.copy(t.matrixWorld).invert(),this._localPlane.copy(this._plane).applyMatrix4(this._inverseMatrix),n=this.shapecast(t,o,n),n!==a&&(r.push(n),a=n)}i.mesh.geometry.setDrawRange(0,n),i.mesh.position.copy(this._plane.normal).multiplyScalar(1e-4),o.needsUpdate=!0;const l=i.mesh.geometry.attributes.position;if(!Number.isNaN(l.array[0])){if(!i.mesh.parent){this.components.scene.get().add(i.mesh)}this.fillNeedsUpdate&&i.fill&&(i.fill.geometry=i.mesh.geometry,i.fill.update(r))}}initializeStyle(e){const t=this.newEdgesMesh(e),s=t.geometry,i=this.newFillMesh(e,s);this._edges[e]={mesh:t,name:e,fill:i}}shapecast(e,t,s){return e.geometry.boundsTree.shapecast({intersectsBounds:e=>this._localPlane.intersectsBox(e),intersectsTriangle:i=>{let n=0;if(this._tempLine.start.copy(i.a),this._tempLine.end.copy(i.b),this._localPlane.intersectLine(this._tempLine,this._tempVector)){const i=this._tempVector.applyMatrix4(e.matrixWorld);t.setXYZ(s,i.x,i.y,i.z),n++,s++}if(this._tempLine.start.copy(i.b),this._tempLine.end.copy(i.c),this._localPlane.intersectLine(this._tempLine,this._tempVector)){const i=this._tempVector.applyMatrix4(e.matrixWorld);t.setXYZ(s,i.x,i.y,i.z),n++,s++}if(this._tempLine.start.copy(i.c),this._tempLine.end.copy(i.a),this._localPlane.intersectLine(this._tempLine,this._tempVector)){const i=this._tempVector.applyMatrix4(e.matrixWorld);t.setXYZ(s,i.x,i.y,i.z),n++,s++}2!==n&&(s-=n)}}),s}updateEdgesVisibility(e,t){const s=this._edges[e];if(s.fill&&(s.fill.visible=t),s.mesh.visible=t,t){this.components.scene.get().add(s.mesh)}else s.mesh.removeFromParent()}async updateDeletedEdges(e){const t=Object.keys(this._edges);for(const s of t)void 0===e[s]&&(this.disposeEdge(s),this.disposeOutline(s))}disposeOutline(e){const t=this.components.renderer;if(t instanceof it){delete t.postproduction.customEffects.outlinedMeshes[e]}}disposeEdge(e){const t=this.components.tools.get(q),s=this._edges[e];s.fill&&s.fill.dispose(),t.destroy(s.mesh,!1),delete this._edges[e]}}class Gt extends Ae{constructor(e,t,s,i,n){super(e,t,s,i,5,!1),this.edgesMaxUpdateRate=50,this.lastUpdate=-1,this.updateTimeout=-1,this.updateFill=async()=>{this.edges.fillNeedsUpdate=!0,await this.edges.update(),this._visible&&(this.edges.fillVisible=!0)},this.update=async()=>{if(!this.enabled)return;this._plane.setFromNormalAndCoplanarPoint(this.normal,this._helper.position);const e=Date.now();this.lastUpdate+this.edgesMaxUpdateRate<e?(this.lastUpdate=e,await this.edges.update()):-1===this.updateTimeout&&(this.updateTimeout=window.setTimeout((()=>{this.update(),this.updateTimeout=-1}),this.edgesMaxUpdateRate))},this.hideFills=()=>{this.edges.fillVisible=!1},this.edges=new Vt(e,this._plane,n),this.toggleControls(!0),this.edges.setVisible(!0),this.onDraggingEnded.add(this.updateFill),this.onDraggingStarted.add(this.hideFills)}set enabled(e){this._enabled=e,this.components.renderer.togglePlane(e,this._plane)}get enabled(){return super.enabled}async dispose(){await super.dispose(),await this.edges.dispose()}async setEnabled(e){super.enabled=e,e&&await this.update()}async setVisible(e){super.visible=e,this.toggleControls(e),await this.edges.setVisible(!0)}}class zt extends j{constructor(e){super(e),this.name="EdgesStyles",this.onDisposed=new W,this.enabled=!0,this._styles={},this._defaultLineMaterial=new n({color:0,linewidth:.001}),this.onAfterUpdate=new W,this.onBeforeUpdate=new W}get(){return this._styles}async update(e){await this.onBeforeUpdate.trigger(this._styles),await this.onAfterUpdate.trigger(this._styles)}create(e,t,s=this._defaultLineMaterial,i,n){for(const e of t)e.geometry.boundsTree||e.geometry.computeBoundsTree();const o=this.components.renderer;s.clippingPlanes=o.clippingPlanes;const r={name:e,lineMaterial:s,meshes:t,fillMaterial:i,outlineMaterial:n,fragments:{}};return this._styles[e]=r,r}async dispose(){const e=Object.keys(this._styles);for(const t of e)this.deleteStyle(t);this._styles={},await this.onDisposed.trigger(),this.onDisposed.reset()}deleteStyle(e,t=!0){const s=this._styles[e];s&&(s.meshes.clear(),t&&(s.lineMaterial.dispose(),s.fillMaterial?.dispose(),s.outlineMaterial?.dispose())),delete this._styles[e]}}class Yt extends Fe{constructor(e){super(e),this.fillsNeedUpdate=!1,this.components.tools.list[Yt.uuid]=this,this.PlaneType=Gt,this.styles=new zt(e)}async dispose(){await super.dispose(),await this.styles.dispose()}async updateEdges(e=!1){if(this.enabled)for(const t of this._planes)e||this.fillsNeedUpdate?(await t.updateFill(),this.fillsNeedUpdate=!1):await t.update()}newPlaneInstance(e,t){return new this.PlaneType(this.components,e,t,this._material,this.styles)}}class Ht extends j{get commands(){return this.uiElement.get("commandsMenu").commands}set commands(e){this.uiElement.get("commandsMenu").commands=e}constructor(t){super(t),this.onDisposed=new W,this.onNavigated=new W,this.onExited=new W,this.enabled=!1,this.currentPlan=null,this.defaultSectionOffset=1.5,this.defaultCameraOffset=30,this.storeys=[],this.uiElement=new Q,this._plans=[],this._floorPlanViewCached=!1,this._previousCamera=new e.Vector3,this._previousTarget=new e.Vector3,this._previousProjection="Perspective",this.components.tools.add(Ht.uuid,this),this.objects=new Bt(t),t.uiEnabled&&this.setUI(t)}get(){return this._plans}async dispose(){this.onExited.reset(),this.onNavigated.reset(),this.storeys=[],this._plans=[],await this.objects.dispose(),await this.uiElement.dispose(),await this.onDisposed.trigger(Ht.uuid),this.onDisposed.reset()}async computeAllPlanViews(t){if(!t.hasProperties)throw new Error("Properties are needed to compute plan views!");const s=await t.getAllPropertiesOfType(x.IFCBUILDINGSTOREY);if(!s)throw new Error("Floorplans not found!");const i=t.coordinationMatrix.elements[13],n=await wt.getUnits(t);for(const t of Object.values(s)){const s={value:0};this.getAbsoluteFloorHeight(t.ObjectPlacement,s);const o=s.value*n+i;await this.create({name:t.Name.value,id:t.GlobalId.value,normal:new e.Vector3(0,-1,0),point:new e.Vector3(0,o,0),ortho:!0,offset:this.defaultSectionOffset})}const{min:o,max:r}=t.boundingBox;this.objects.setBounds([o,r])}async create(e){const t=this._plans.find((t=>t.id===e.id));if(t)return void console.warn(`There's already a plan with the id: ${e.id}`);const s=await this.createClippingPlane(e);s.visible=!1;const i={...e,plane:s};this._plans.push(i),this.objects.add(e)}async goTo(e,t=!1){this.currentPlan?.id!==e&&(this.objects.visible=!1,await this.onNavigated.trigger({id:e}),this.storeCameraPosition(),await this.hidePreviousClippingPlane(),this.updateCurrentPlan(e),await this.activateCurrentPlan(),this.enabled||(await this.moveCameraTo2DPlanPosition(t),this.enabled=!0),this.components.uiEnabled&&(this.uiElement.get("exitButton").enabled=!0))}async exitPlanView(e=!1){if(!this.enabled)return;this.enabled=!1,await this.onExited.trigger(),this.cacheFloorplanView();const t=this.components.camera;t.setNavigationMode("Orbit"),await t.setProjection(this._previousProjection),this.currentPlan&&this.currentPlan.plane&&(await this.currentPlan.plane.setEnabled(!1),await this.currentPlan.plane.edges.setVisible(!1)),this.currentPlan=null,await t.controls.setLookAt(this._previousCamera.x,this._previousCamera.y,this._previousCamera.z,this._previousTarget.x,this._previousTarget.y,this._previousTarget.z,e),this.components.uiEnabled&&(this.uiElement.get("exitButton").enabled=!1)}async updatePlansList(){if(!this.components.uiEnabled)return;const e=this.uiElement.get("defaultText"),t=this.uiElement.get("planList"),s=this.uiElement.get("commandsMenu");if(await t.dispose(!0),!this._plans.length)return void(e.visible=!0);e.visible=!1,s.update();const i=s.hasCommands;for(const e of this._plans){const n=`Height: ${Math.trunc(10*e.point.y)/10}`,o=new ce(this.components);o.title=e.name,o.description=n;const r=new re(this.components);this.components.ui.addToolbar(r),o.addChild(r),r.domElement.classList.remove("shadow-md","backdrop-blur-xl","bg-ifcjs-100");const a=new ae(this.components,{materialIconName:"arrow_outward"});a.onClick.add((async()=>{await this.goTo(e.id)})),r.addChild(a);const l=new ae(this.components,{materialIconName:"expand_more"});l.onClick.add((t=>{t&&(s.commandData=e,s.popup(t.x,t.y))})),i||(l.enabled=!1),r.addChild(l),o.domElement.classList.remove("bg-ifcjs-120"),o.domElement.classList.remove("border-transparent"),o.domElement.className+=" min-w-[300px] my-2 border-1 border-solid border-[#3A444E] ",t.addChild(o)}}setUI(e){this.setupPlanObjectUI();const t=new oe(this.components,'<div class="flex"></div>'),s=new ae(e);s.materialIcon="logout",t.addChild(s),s.enabled=!1,s.onClick.add((()=>this.exitPlanView()));const i=new ae(e,{tooltip:"Plans list"});i.materialIcon="folder_copy";const n=new de(e);n.title="Floor Plans",e.ui.add(n),n.visible=!1,n.addChild(t);const o=new oe(e,'<div class="flex flex-col"></div>');n.addChild(o);const r=new oe(e,"<p>No plans yet.</p>");n.addChild(r);const a=new be(e);e.ui.add(a),a.visible=!1,this.uiElement.set({main:i,floatingWindow:n,planList:o,defaultText:r,exitButton:s,commandsMenu:a}),i.onClick.add((()=>{n.visible=!n.visible}))}storeCameraPosition(){this.enabled?this.cacheFloorplanView():this.store3dCameraPosition()}async createClippingPlane(e){const{normal:t,point:s}=e,i=s.clone();e.offset&&(i.y+=e.offset);const n=this.components.tools.get(Yt).createFromNormalAndCoplanarPoint(t,i);return await n.setEnabled(!1),await n.edges.update(),await n.edges.setVisible(!1),n}cacheFloorplanView(){this._floorPlanViewCached=!0;this.components.camera.controls.saveState()}async moveCameraTo2DPlanPosition(e){const t=this.components.camera;this._floorPlanViewCached?await t.controls.reset(e):await t.controls.setLookAt(0,100,0,0,0,0,e)}async activateCurrentPlan(){if(!this.currentPlan)throw new Error("Current plan is not defined.");const e=this.components.camera;this.currentPlan.plane&&(await this.currentPlan.plane.setEnabled(!0),this.currentPlan.plane.edges.fillNeedsUpdate=!0,await this.currentPlan.plane.edges.setVisible(!0)),e.setNavigationMode("Plan");const t=this.currentPlan.ortho?"Orthographic":"Perspective";await e.setProjection(t)}store3dCameraPosition(){const e=this.components.camera;this.components.camera.get().getWorldPosition(this._previousCamera),e.controls.getTarget(this._previousTarget),this._previousProjection=e.getProjection()}updateCurrentPlan(e){const t=this._plans.find((t=>t.id===e));if(!t)throw new Error("The specified plan is undefined!");this.currentPlan=t}async hidePreviousClippingPlane(){if(this.currentPlan){const e=this.currentPlan.plane;e&&await e.setEnabled(!1),this.currentPlan.plane instanceof Gt&&await this.currentPlan.plane.edges.setVisible(!1)}}setupPlanObjectUI(){this.objects.planClicked.add((async({id:e})=>{const t=this.objects.uiElement.get("main");this.enabled||(t.innerElements.icon&&t.innerElements.tooltip&&(t.materialIcon="logout",t.tooltip="Exit floorplans"),t.onClick.add((()=>{this.exitPlanView(),t.innerElements.icon&&t.innerElements.tooltip&&(t.materialIcon="layers",t.tooltip="3D plans"),t.onClick.add((()=>this.objects.visible=!this.objects.visible))}))),this.goTo(e)}))}getAbsoluteFloorHeight(e,t){const s=e.RelativePlacement.Location.Coordinates;t.value+=s[2].value,e.PlacementRelTo&&this.getAbsoluteFloorHeight(e.PlacementRelTo,t)}}Ht.uuid="a80874aa-1c93-43a4-80f2-df346da086b1",Z.libraryUUIDs.add(Ht.uuid);class jt extends j{constructor(e){super(e),this.onChange=new W,this.onDisposed=new W,this.isSetup=!1,this.enabled=!0,this.localStorageID="FragmentClipStyler",this.styleCards={},this.uiElement=new Q,this._defaultStyles='\n     {\n        "B0ebxzZQvZ": {\n            "name": "thick",\n            "lineColor": "#36593e",\n            "lineThickness": 0.5,\n            "fillColor": "#ccdb9a",\n            "categories": "IFCWALLSTANDARDCASE, IFCWALL,IFCSLAB, IFCROOF"\n        },\n        "kG9B1Ojv08": {\n            "name": "thin",\n            "lineColor": "#92a59b",\n            "lineThickness": 0.25,\n            "fillColor": "#e6ffdb",\n            "categories": "IFCWINDOW, IFCDOOR, IFCBUILDINGELEMENTPROXY"\n        }\n    }\n  ',this.config={force:!1},this.onSetup=new W,this.components.tools.add(jt.uuid,this),e.uiEnabled&&this.setupUI(e)}async setup(e){this.config={...this.config,...e};const{force:t}=this.config,s=0===Object.keys(this.styleCards).length;(t||s)&&(localStorage.setItem(this.localStorageID,this._defaultStyles),await this.loadCachedStyles()),this.isSetup=!0,await this.onSetup.trigger(this)}get(){const e=localStorage.getItem(this.localStorageID);if(e){const t=JSON.parse(e);return Object.values(t)}return[]}async dispose(){for(const e in this.styleCards)await this.deleteStyleCard(e,!1);await this.uiElement.dispose(),this.onChange.reset(),await this.onDisposed.trigger(jt.uuid),this.onDisposed.reset()}async update(e=Object.keys(this.styleCards)){const t=this.components.tools.get(Yt),s=this.components.tools.get(rt),i=this.components.tools.get(xt);for(const n of e){const e=this.styleCards[n];if(!e)return;const o=t.styles.get()[n];if(!o)return;o.meshes.clear();const r=e.categories.value.split(",").map((e=>e.replace(" ",""))),a=i.find({entities:r});for(const e in a){const t=s.list[e];if(!t)continue;const{mesh:i}=t;o.fragments[e]=new Set(a[e]),o.meshes.add(i)}}await t.updateEdges(!0),this.cacheStyles()}async loadCachedStyles(){const e=localStorage.getItem(this.localStorageID);if(e){const t=JSON.parse(e);for(const e in t){const s=t[e];await this.createStyleCard(s)}}}setupUI(e){const t=new de(e);t.title="Clipping styles",t.visible=!1,e.ui.add(t),t.domElement.style.width="530px",t.domElement.style.height="400px";const s=new ae(e,{materialIconName:"format_paint",tooltip:"Clipping styles"});s.onClick.add((()=>{t.visible=!t.visible}));const i=new oe(e,'<div class="flex"></div>'),n=new ae(e,{materialIconName:"add"});n.onClick.add((()=>this.createStyleCard())),i.addChild(n),t.addChild(i),this.uiElement.set({mainWindow:t,mainButton:s})}cacheStyles(){const e={};for(const t in this.styleCards){const s=this.styleCards[t];e[t]={name:s.name.value,lineColor:s.lineColor.value,lineThickness:s.lineThickness.value,fillColor:s.fillColor.value,categories:s.categories.value}}const t=JSON.stringify(e);localStorage.setItem(this.localStorageID,t)}async deleteStyleCard(e,t=!0){const s=this.styleCards[e],i=this.components.tools.get(Yt);i.styles.deleteStyle(e,!0),s&&(await s.styleCard.dispose(),await s.deleteButton.dispose(),await s.name.dispose(),await s.categories.dispose(),await s.lineThickness.dispose(),await s.lineColor.dispose(),await s.fillColor.dispose()),delete this.styleCards[e],await i.updateEdges(!0),t&&this.cacheStyles()}async createStyleCard(t){const s=new oe(this.components),{id:i}=s,n="flex gap-4";s.domElement.className="m-4 p-4 border-1 border-solid border-[#3A444E] rounded-md flex flex-col gap-4",s.domElement.innerHTML=`\n        <div id="first-row-${i}" class="${n}">\n        </div>\n        <div class="${n}">\n            <div id="name-${i}" class="flex-1">\n            </div>\n            <div id="line-color-${i}">\n            </div>\n        </div>\n        <div class="${n}">\n            <div id="range-${i}" class="flex-1">\n            </div>\n            <div id="fill-color-${i}">\n            </div>\n        </div>\n        <div id="categories-${i}">\n        </div>\n    `;const o=new ae(this.components,{materialIconName:"close"});o.onClick.add((()=>this.deleteStyleCard(i)));const r=s.getInnerElement("first-row");r&&r.insertBefore(o.domElement,r.firstChild);const a=new pe(this.components);a.label="Name",t&&(a.value=t.name);const l=s.getInnerElement("name");l&&l.append(a.domElement),a.domElement.addEventListener("focusout",(()=>this.cacheStyles()));const h=new Ee(this.components);h.label="Line color";const c=s.getInnerElement("line-color");c&&c.append(h.domElement),h.value=t?t.lineColor:"#808080";const d=new Ee(this.components);d.label="Fill color",t&&(d.value=t.fillColor);const u=s.getInnerElement("fill-color");u&&u.append(d.domElement);const p=new ge(this.components);p.label="Line thickness",p.min=0,p.max=1,p.step=.05,p.value=t?t.lineThickness:.25;const m=s.getInnerElement("range");m&&m.append(p.domElement);const E=new pe(this.components);E.label="Categories";const g=s.getInnerElement("categories");g&&g.append(E.domElement),this.styleCards[i]={styleCard:s,name:a,lineThickness:p,categories:E,deleteButton:o,fillColor:d,lineColor:h},this.uiElement.get("mainWindow").addChild(s);const I=new e.MeshBasicMaterial({color:d.value,side:2});let C;const f=()=>{C&&clearTimeout(C),C=setTimeout((()=>this.cacheStyles()),2e3)};d.onChange.add((()=>{I.color.set(d.value),f(),this.onChange.trigger()}));const w=new e.LineBasicMaterial({color:h.value}),T=new e.MeshBasicMaterial({color:h.value,opacity:p.value,side:2,transparent:!0});p.onChange.add((()=>{T.opacity=p.value,f(),this.onChange.trigger()})),h.onChange.add((()=>{w.color.set(h.value),T.color.set(h.value),f(),this.onChange.trigger()}));this.components.tools.get(Yt).styles.create(i,new Set,w,I,T),E.domElement.addEventListener("focusout",(()=>this.update([i]))),t&&(E.value=t.categories),this.cacheStyles()}}jt.uuid="14de9fbd-2151-4c01-8e07-22a2667e1126",Z.libraryUUIDs.add(jt.uuid);class Wt extends ht{constructor(){super(...arguments),this.minGeometrySize=10,this.minAssetsSize=1e3}}class Xt extends ht{constructor(){super(...arguments),this.propertiesSize=100}}class $t extends j{constructor(){super(...arguments),this.onPropertiesStreamed=new W,this.onProgress=new W,this.onIndicesStreamed=new W,this.onDisposed=new W,this.enabled=!0,this.settings=new Xt,this._webIfc=new x.IfcAPI}get(){return this._webIfc}async dispose(){this.onIndicesStreamed.reset(),this.onPropertiesStreamed.reset(),this._webIfc=null,this.onDisposed.reset()}async streamFromBuffer(e){const t=performance.now();await this.readIfcFile(e),await this.streamAllProperties(),this.cleanUp(),console.log(`Streaming the IFC took ${performance.now()-t} ms!`)}async streamFromCallBack(e){const t=performance.now();await this.streamIfcFile(e),await this.streamAllProperties(),this.cleanUp(),console.log(`Streaming the IFC took ${performance.now()-t} ms!`)}async readIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;this._webIfc.SetWasmPath(t,s),await this._webIfc.Init(),i&&this._webIfc.SetLogLevel(i),this._webIfc.OpenModel(e,this.settings.webIfc)}async streamIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;this._webIfc.SetWasmPath(t,s),await this._webIfc.Init(),i&&this._webIfc.SetLogLevel(i),this._webIfc.OpenModelFromCallback(e,this.settings.webIfc)}async streamAllProperties(){const{propertiesSize:e}=this.settings,t=new Set(this._webIfc.GetIfcEntityList(0)),s=[x.IFCRELDEFINESBYPROPERTIES,x.IFCRELDEFINESBYTYPE,x.IFCRELASSOCIATESMATERIAL,x.IFCRELCONTAINEDINSPATIALSTRUCTURE,x.IFCRELASSOCIATESCLASSIFICATION,x.IFCRELASSIGNSTOGROUP],i=new Map,n=new Set([x.IFCPROJECT,x.IFCSITE,x.IFCBUILDING,x.IFCBUILDINGSTOREY,x.IFCSPACE]);for(const e of n)t.add(e);let o=.01,r=0;for(const a of t){if(r++,ut.has(a))continue;const l=n.has(a),h=this._webIfc.GetLineIDsWithType(0,a),c=h.size();let d=0;for(let t=0;t<c-e;t+=e){const n={};for(let o=0;o<e;o++){d++;const e=h.get(t+o);try{const t=this._webIfc.GetLine(0,e,l);s.includes(a)&&this.getIndices(t,e,i),n[t.expressID]=t}catch(t){console.log(`Could not get property: ${e}`)}}await this.onPropertiesStreamed.trigger({type:a,data:n})}if(d!==c){const e={};for(let t=d;t<c;t++){const n=h.get(t);try{const t=this._webIfc.GetLine(0,n,l);s.includes(a)&&this.getIndices(t,n,i),e[t.expressID]=t}catch(e){console.log(`Could not get property: ${n}`)}}await this.onPropertiesStreamed.trigger({type:a,data:e})}const u=r/t.size;u>o&&(o+=.01,o=Math.max(o,u),await this.onProgress.trigger(Math.round(100*o)/100))}const a=[];for(const[e,t]of i)a.push([e,...t]);await this.onIndicesStreamed.trigger(a)}getIndices(e,t,s){const i=e.RelatedObjects||e.RelatedElements;if(!i)return void console.log(`Related objects not found: ${t}`);const n=e.RelatingType||e.RelatingMaterial||e.RelatingStructure||e.RelatingPropertyDefinition||e.RelatingGroup||e.RelatingClassification;if(!n)return void console.log(`Relating object not found: ${t}`);if(!Array.isArray(i)||void 0===n.value)return;const o=n.value;for(const e of i){if(void 0===e.value||null===e.value)continue;const t=e.value;s.has(t)||s.set(t,new Set);s.get(t).add(o)}}cleanUp(){this._webIfc=null,this._webIfc=new x.IfcAPI}}$t.uuid="88d2c89c-ce32-47d7-8cb6-d51e4b311a0b";class Kt extends j{constructor(e){super(e),this.onGeometryStreamed=new W,this.onAssetStreamed=new W,this.onProgress=new W,this.onIfcLoaded=new W,this.onDisposed=new W,this.settings=new Wt,this.enabled=!0,this._spatialTree=new lt,this._metaData=new dt,this._visitedGeometries=new Map,this._webIfc=new x.IfcAPI,this._streamSerializer=new P.StreamSerializer,this._geometries=new Map,this._geometryCount=0,this._civil=new ct,this._groupSerializer=new P.Serializer,this._assets=[],this._meshesWithHoles=new Set,this.components.tools.add(Kt.uuid,this),this.settings.excludedCategories.add(x.IFCOPENINGELEMENT)}get(){return this._webIfc}async dispose(){this.onIfcLoaded.reset(),this.onGeometryStreamed.reset(),this.onAssetStreamed.reset(),this._webIfc=null,await this.onDisposed.trigger(Kt.uuid),this.onDisposed.reset()}async streamFromBuffer(e){const t=performance.now();await this.readIfcFile(e),await this.streamAllGeometries(),this.cleanUp(),console.log(`Streaming the IFC took ${performance.now()-t} ms!`)}async streamFromCallBack(e){const t=performance.now();await this.streamIfcFile(e),await this.streamAllGeometries(),this.cleanUp(),console.log(`Streaming the IFC took ${performance.now()-t} ms!`)}async readIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;this._webIfc.SetWasmPath(t,s),await this._webIfc.Init(),i&&this._webIfc.SetLogLevel(i),this._webIfc.OpenModel(e,this.settings.webIfc)}async streamIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;this._webIfc.SetWasmPath(t,s),await this._webIfc.Init(),i&&this._webIfc.SetLogLevel(i),this._webIfc.OpenModelFromCallback(e,this.settings.webIfc)}async streamAllGeometries(){const{minGeometrySize:e,minAssetsSize:t}=this.settings;this._spatialTree.setUp(this._webIfc);const s=this._webIfc.GetIfcEntityList(0),i=[[]],n=new P.FragmentsGroup,{FILE_NAME:o,FILE_DESCRIPTION:r}=x;n.ifcMetadata={name:this._metaData.get(this._webIfc,o),description:this._metaData.get(this._webIfc,r),schema:this._webIfc.GetModelSchema(0)||"IFC2X3",maxExpressID:this._webIfc.GetMaxExpressID(0)};let a=0,l=0;for(const t of s){if(!this._webIfc.IsIfcElement(t)&&t!==x.IFCSPACE)continue;if(this.settings.excludedCategories.has(t))continue;const s=this._webIfc.GetLineIDsWithType(0,t),o=s.size();for(let r=0;r<o;r++){a>e&&(a=0,l++,i.push([]));const o=s.get(r);i[l].push(o);const h=this._spatialTree.itemsByFloor[o]||0;n.data.set(o,[[],[h,t]]),a++}}this._spatialTree.cleanUp();let h=.01,c=0;for(const s of i){c++,this._webIfc.StreamMeshes(0,s,(e=>{this.getMesh(this._webIfc,e,n)})),this._geometryCount>e&&await this.streamGeometries(),this._assets.length>t&&await this.streamAssets();const o=c/i.length;o>h&&(h+=.01,h=Math.max(h,o),await this.onProgress.trigger(Math.round(100*h)/100))}this._geometryCount&&await this.streamGeometries(),this._assets.length&&await this.streamAssets();const{opaque:d,transparent:u}=n.geometryIDs;for(const[e,{index:t,uuid:s}]of this._visitedGeometries){n.keyFragments.set(t,s);(e>1?d:u).set(e,t)}const p=n.data.keys();for(const e of p){const[t]=n.data.get(e);t.length||n.data.delete(e)}const m=this._webIfc.GetCoordinationMatrix(0);n.coordinationMatrix.fromArray(m),n.civilData=this._civil.read(this._webIfc);const E=this._groupSerializer.export(n);await this.onIfcLoaded.trigger(E),n.dispose(!0)}cleanUp(){this._webIfc=null,this._webIfc=new x.IfcAPI,this._visitedGeometries.clear(),this._geometries.clear(),this._assets=[],this._meshesWithHoles.clear()}getMesh(t,s,i){const n=s.geometries.size(),o=s.expressID,r={id:o,geometries:[]};664833===s.expressID&&console.log("Heyyy");for(let a=0;a<n;a++){const n=s.geometries.get(a),l=n.geometryExpressID,h=l*(1===n.color.w?1:-1);if(!this._visitedGeometries.has(h)){this._visitedGeometries.has(l)||this.getGeometry(t,l);const s=this._visitedGeometries.size,i=e.MathUtils.generateUUID();this._visitedGeometries.set(h,{uuid:i,index:s})}const c=this._visitedGeometries.get(h);if(void 0===c)throw new Error("Error getting geometry data for streaming!");const d=i.data.get(o);if(!d)throw new Error("Data not found!");d[0].push(c.index);const{x:u,y:p,z:m,w:E}=n.color,g=[u,p,m,E],I=n.flatTransformation;r.geometries.push({color:g,geometryID:l,transformation:I})}this._assets.push(r)}getGeometry(e,t){const s=e.GetGeometry(0,t),i=e.GetIndexArray(s.GetIndexData(),s.GetIndexDataSize()),n=e.GetVertexArray(s.GetVertexData(),s.GetVertexDataSize()),o=new Float32Array(n.length/2),r=new Float32Array(n.length/2);for(let e=0;e<n.length;e+=6)o[e/2]=n[e],o[e/2+1]=n[e+1],o[e/2+2]=n[e+2],r[e/2]=n[e+3],r[e/2+1]=n[e+4],r[e/2+2]=n[e+5];const a=je(o),l=new Float32Array(a.transformation.elements),h=[a.center.x,a.center.y,a.center.z];let c=!1;for(let e=0;e<o.length-2;e+=3){if(Ne(h,[o[e],o[e+1],o[e+2]],[r[e],r[e+1],r[e+2]])){c=!0;break}}this._geometries.set(t,{position:o,normal:r,index:i,boundingBox:l,hasHoles:c}),s.delete(),this._geometryCount++}async streamAssets(){await this.onAssetStreamed.trigger(this._assets),this._assets=null,this._assets=[]}async streamGeometries(){let e=this._streamSerializer.export(this._geometries),t={};for(const[e,{boundingBox:s,hasHoles:i}]of this._geometries)t[e]={boundingBox:s,hasHoles:i};await this.onGeometryStreamed.trigger({data:t,buffer:e}),t=null,e=null,this._geometries.clear(),this._geometryCount=0}}Kt.uuid="d9999a00-e1f5-4d3f-8cfe-c56e08609764",Z.libraryUUIDs.add(Kt.uuid);class Qt extends Se{constructor(t,s){super(t,s),this.threshold=50,this.bboxThreshold=200,this.maxLostTime=3e4,this.maxHiddenTime=5e3,this.boxes=new Map,this.useLowLod=!1,this.lowLod=new Map,this._material=new e.MeshBasicMaterial({transparent:!0,side:2,opacity:1}),this._lodMaterial=new e.MeshLambertMaterial,this.onViewUpdated=new W,this._modelIDIndex=new Map,this._indexModelID=new Map,this._nextModelID=0,this._geometries=new Map,this._geometriesGroups=new Map,this._foundGeometries=new Set,this.codes=new Map,this.handleWorkerMessage=async e=>{const t=e.data.colors,s={},i={},n={},o={},r=performance.now();let a=!1;const l=new Set,h=new Set;let c=0;for(const[e,s]of t){if(s<this.threshold)continue;const t=this._geometries.get(e);if(!t)continue;void 0===t.fragment&&(c+=s)}const d=new Set(this._foundGeometries);for(const[e,u]of t){const t=this._geometries.get(e);if(!t)continue;const p=u>this.threshold,{exists:m}=t;if(!p&&!m)continue;const E=this._indexModelID.get(t.modelIndex);if(d.delete(e),p&&m)t.time=r,o[E]||(o[E]=new Set),o[E].add(t.geometryID),this._foundGeometries.add(e),a=!0,this.useLowLod&&h.add(t);else if(p&&!m){s[E]||(s[E]=new Map),t.time=r,t.exists=!0,s[E].has(u)||s[E].set(u,new Set);s[E].get(u).add(t.geometryID),this._foundGeometries.add(e),a=!0,this.useLowLod&&h.add(t)}else!p&&m&&c<this.bboxThreshold&&(this.handleLostGeometries(r,e,t,i,n),this.useLowLod&&l.add(t),a=!0)}if(c<=this.bboxThreshold)for(const e of d){const t=this._geometries.get(e);if(!t)throw new Error("Geometry not found!");this.handleLostGeometries(r,e,t,i,n),this.useLowLod&&l.add(t),a=!0}if(a&&await this.onViewUpdated.trigger({toLoad:s,toRemove:i,toHide:n,toShow:o}),this.useLowLod){for(const e of l)this.setLodVisibility(!0,e);for(const e of h)this.setLodVisibility(!1,e)}c>this.bboxThreshold&&(this.needsUpdate=!0)},this.updateInterval=500,this._geometry=new e.BoxGeometry(1,1,1),this._geometry.groups=[],this._geometry.deleteAttribute("uv");const i=this._geometry.attributes.position.array;for(let e=0;e<i.length;e++)i[e]+=.5;this._geometry.attributes.position.needsUpdate=!0,this.worker.addEventListener("message",this.handleWorkerMessage),this.autoUpdate&&window.setInterval(this.updateVisibility,this.updateInterval)}async dispose(){await super.dispose(),this.onViewUpdated.reset(),this._lodMaterial.dispose();for(const[e,t]of this.lowLod)t.dispose(!0);this.lowLod.clear();for(const[e,t]of this._geometriesGroups){t.removeFromParent();const e=[...t.children];for(const t of e)t.removeFromParent()}this._geometriesGroups.clear();for(const[e,t]of this.boxes)t.dispose(!0);this.boxes.clear();for(const[e,t]of this._geometries)t.fragment&&(t.fragment.dispose(!0),t.fragment=void 0);this._geometries.clear(),this._geometry.dispose(),this._material.dispose(),this._modelIDIndex.clear(),this._indexModelID.clear(),this.codes.clear()}add(t,s,i){const n=this.createModelIndex(t),o=e.ColorManagement.enabled;e.ColorManagement.enabled=!1;const r=new Map,a=new e.Matrix4,l=new P.Fragment(this._geometry,this._material,10);if(this.boxes.set(n,l),this.scene.add(l.mesh),this.useLowLod){const e=new P.Fragment(this._geometry,this._lodMaterial,10);this.lowLod.set(n,e)}const h=new e.Group;this.scene.add(h),this._geometriesGroups.set(n,h);const c=new Map;for(const t of s)for(const s of t.geometries){const{geometryID:o,transformation:l,color:h}=s,d=new e.Color;d.setRGB(h[0],h[1],h[2],"srgb");const u=this.getInstanceID(t.id,o),p=i[o];if(!p){console.log(`Geometry not found: ${o}`);continue}const{boundingBox:m}=p;let E;r.has(o)?E=r.get(o):(E=this.getAvailableColor(),this.increaseColor(),r.set(o,E));const{r:g,g:I,b:C,code:f}=E,w=new e.Color;w.setRGB(g/255,I/255,C/255,"srgb"),this.codes.has(n)||this.codes.set(n,new Map);this.codes.get(n).set(o,f);const T=new e.Matrix4,b=Object.values(m);if(T.fromArray(l),a.fromArray(b),T.multiply(a),c.has(u)){const e=c.get(u);if(void 0===e||!e.colors)throw new Error("Malformed item!");e.colors.push(w),e.geometryColors.push(d),e.transforms.push(T)}else c.set(u,{id:u,colors:[w],geometryColors:[d],transforms:[T]});if(this._geometries.has(f)){this._geometries.get(f).assetIDs.add(t.id)}else{const e=new Set([t.id]);this._geometries.set(f,{modelIndex:n,geometryID:o,assetIDs:e,exists:!1,hidden:!1,time:0})}}const d=Array.from(c.values());if(l.add(d),this.useLowLod){for(const e of d)e.colors=e.geometryColors;this.lowLod.get(n).add(d)}e.ColorManagement.enabled=o}remove(e){const t=this._modelIDIndex.get(e);if(void 0===t)throw new Error("Model doesn't exist!");const s=this._geometriesGroups.get(t);s.removeFromParent();const i=[...s.children];for(const e of i)e.removeFromParent();this._geometriesGroups.delete(t);this.boxes.get(t).dispose(!1),this.boxes.delete(t);this.lowLod.get(t).dispose(!1),this.lowLod.delete(t);const n=this.codes.get(t);this.codes.delete(t);for(const[e,t]of n){const e=this._geometries.get(t);e&&e.fragment&&(e.fragment.dispose(!1),e.fragment=void 0),this._geometries.delete(t)}this._modelIDIndex.delete(e),this._indexModelID.delete(t),this._foundGeometries.clear()}addFragment(t,s,i){const n=e.ColorManagement.enabled;e.ColorManagement.enabled=!1;const o=this._modelIDIndex.get(t),r=this.codes.get(o).get(s),a=this._geometries.get(r);if(this.setGeometryVisibility(a,!1,!1),!a.fragment){a.fragment=new P.Fragment(i.mesh.geometry,this._material,i.capacity);const e=this._geometriesGroups.get(o);if(!e)throw new Error("Group not found!");e.add(a.fragment.mesh)}const[l,h,c]=r.split("-").map((e=>parseInt(e,10))),d=[];for(const e of i.ids){const t=i.get(e);if(!t.colors)throw new Error("Malformed fragments!");for(const e of t.colors)e.setRGB(l/255,h/255,c/255,"srgb");d.push(t)}a.fragment.add(d),e.ColorManagement.enabled=n,this.needsUpdate=!0}removeFragment(e,t){const s=this._modelIDIndex.get(e),i=this.codes.get(s).get(t),n=this._geometries.get(i);if(n.hidden||this.setGeometryVisibility(n,!0,!1),n.fragment){const{fragment:e}=n;e.dispose(!1),n.fragment=void 0}}setModelTransformation(e,t){const s=this._modelIDIndex.get(e);if(void 0===s)throw new Error("Model not found!");const i=this.boxes.get(s);i&&(i.mesh.position.set(0,0,0),i.mesh.rotation.set(0,0,0),i.mesh.scale.set(1,1,1),i.mesh.applyMatrix4(t));const n=this._geometriesGroups.get(s);n&&(n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),n.applyMatrix4(t))}setVisibility(e,t,s){const i=this._modelIDIndex.get(t);if(void 0!==i)for(const[t,n]of s){const s=this.codes.get(i);if(void 0===s)throw new Error("Map not found!");const o=s.get(t),r=this._geometries.get(o);if(void 0===r)throw new Error("Geometry not found!");r.hidden=!e,this.setGeometryVisibility(r,e,!0,n)}}setGeometryVisibility(e,t,s,i){const{modelIndex:n,geometryID:o,assetIDs:r}=e,a=this.boxes.get(n);if(void 0===a)throw new Error("Model not found!");const l=i||r;if(s&&e.fragment)e.fragment.setVisibility(t,l);else{const e=new Set;for(const t of l){const s=this.getInstanceID(t,o);e.add(s)}a.setVisibility(t,e)}}handleLostGeometries(e,t,s,i,n){const o=this._indexModelID.get(s.modelIndex),r=e-s.time;r>this.maxLostTime?(i[o]||(i[o]=new Set),s.exists=!1,i[o].add(s.geometryID),this._foundGeometries.delete(t)):r>this.maxHiddenTime&&(n[o]||(n[o]=new Set),n[o].add(s.geometryID))}setLodVisibility(e,t){const s=this.lowLod.get(t.modelIndex);for(const i of t.assetIDs){const n=this.getInstanceID(i,t.geometryID);s.setVisibility(e,[n])}}createModelIndex(e){if(this._modelIDIndex.has(e))throw new Error("Can't load the same model twice!");const t=this._nextModelID;return this._nextModelID++,this._modelIDIndex.set(e,t),this._indexModelID.set(t,e),t}getInstanceID(e,t){return e+t/10**(Math.log(t)*Math.LOG10E+1|0)}}class Zt extends B{constructor(){super("MyAppDatabase"),this.version(1).stores({files:"id, file"})}}class qt extends j{get url(){if(!this._url)throw new Error("url must be set before using the streaming service!");return this._url}set url(e){this._url=e}constructor(t){super(t),this.enabled=!0,this.onFragmentsDeleted=new W,this.onFragmentsLoaded=new W,this.onDisposed=new W,this.models={},this.serializer=new P.StreamSerializer,this.maxRamTime=5e3,this.useCache=!0,this._ramCache=new Map,this._fileCache=new Zt,this._url=null,this._isDisposing=!1,this._geometryInstances={},this._loadedFragments={},this.fragIDData=new Map,this._baseMaterial=new e.MeshLambertMaterial,this._baseMaterialT=new e.MeshLambertMaterial({transparent:!0,opacity:.5}),this.components.tools.add(qt.uuid,this),this.culler=new Qt(t),this.setupCullerEvents()}async dispose(){this._isDisposing=!0,this.onFragmentsLoaded.reset(),this.onFragmentsDeleted.reset(),this._ramCache.clear(),this.models={},this._geometryInstances={},this._loadedFragments={},this.fragIDData.clear(),this._baseMaterial.dispose(),this._baseMaterialT.dispose(),await this.culler.dispose(),this.culler=new Qt(this.components),this.setupCullerEvents(),await this.onDisposed.trigger(qt.uuid),this.onDisposed.reset(),this._isDisposing=!1}async load(e,t=!0,s){const{assets:i,geometries:n,globalDataFileId:o}=e,r=this.url+o,a=await fetch(r),l=await a.arrayBuffer(),h=new Uint8Array(l),c=this.components.tools.get(rt),d=await c.load(h,t),{opaque:u,transparent:p}=d.geometryIDs;for(const[e,t]of u){const s=d.keyFragments.get(t);if(void 0===s)throw new Error("Malformed fragments group!");this.fragIDData.set(s,[d,e,new Set])}for(const[e,t]of p){const s=d.keyFragments.get(t);if(void 0===s)throw new Error("Malformed fragments group!");this.fragIDData.set(s,[d,Math.abs(e),new Set])}this.culler.add(d.uuid,i,n),this.models[d.uuid]={assets:i,geometries:n};const m=new Map;for(const e of i){const t=e.id;for(const{transformation:s,geometryID:i,color:n}of e.geometries){m.has(i)||m.set(i,[]);const e=m.get(i);if(!e)throw new Error("Malformed instances");e.push({id:t,transformation:s,color:n})}}if(this._geometryInstances[d.uuid]=m,s){const e=new Map,t=new Map;for(const t in s.ids){const i=s.ids[t],n=parseInt(t,10);e.set(n,i)}for(const e in s.types){const i=s.types[e],n=parseInt(e,10);t.set(n,i)}const i=o.replace("-global","-properties");d.streamSettings={baseUrl:this.url,baseFileName:i,ids:e,types:t};const{indexesFile:n}=s,r=await fetch(this.url+n),a=await r.arrayBuffer(),l=new File([new Blob([a])],n),h=URL.createObjectURL(l),c=await U(h),u=Object.keys(c.entries)[0],p=await c.entries[u].json(),m=this.components.tools.get(Rt).get();m[d.uuid]={};for(const e of p){const t=e.shift();m[d.uuid][t]=new Set(e)}}this.culler.needsUpdate=!0}remove(e){this._isDisposing=!0;const t=this.components.tools.get(rt).groups.find((t=>t.uuid===e));if(void 0===t)return void console.log("Group to delete not found.");delete this.models[e],delete this._geometryInstances[e],delete this._loadedFragments[e];const s=t.keyFragments.values();for(const e of s)this.fragIDData.delete(e);this.culler.remove(e),this._isDisposing=!1}setVisibility(e,t){const s=new Map;for(const i in t){const n=this.fragIDData.get(i);if(void 0===n)throw new Error("Geometry not found!");const[o,r,a]=n,l=o.uuid;s.has(l)||s.set(l,new Map);const h=s.get(l),c=t[i];for(const t of c)e?a.delete(t):a.add(t);h.get(r)||h.set(r,new Set);const d=h.get(r);for(const e of c)d.add(e)}for(const[i,n]of s){this.culler.setVisibility(e,i,n);for(const[s]of n){const n=this._loadedFragments[i];if(!n)continue;const o=n[s];if(o)for(const s of o){const i=t[s.id];i&&s.setVisibility(e,i)}}}this.culler.needsUpdate=!0}async clearCache(){await this._fileCache.delete()}get(){}update(){}async loadFoundGeometries(t){for(const s in t){if(this._isDisposing)return;const i=this.components.tools.get(rt).groups.find((e=>e.uuid===s));if(!i)return;const{geometries:n}=this.models[s],o=new Map,r=new Set;for(const[e,i]of t[s])for(const t of i){r.add(t);const s=n[t];if(!s)throw new Error("Geometry not found");if(s.geometryFile){const t=s.geometryFile,i=o.get(t)||0;o.set(t,i+e)}}const a=Array.from(o).sort(((e,t)=>t[1]-e[1]));for(const[t]of a){const n=this.url+t;if(!this._ramCache.has(n)){let e=new Uint8Array;if(this.useCache){const t=await this._fileCache.files.get(n);if(t)e=t.file;else{const t=await fetch(n),s=await t.arrayBuffer();e=new Uint8Array(s),await this._fileCache.files.add({file:e,id:n})}}else{const t=await fetch(n),s=await t.arrayBuffer();e=new Uint8Array(s)}const t=this.serializer.import(e);this._ramCache.set(n,{data:t,time:performance.now()})}const o=this._ramCache.get(n);if(!o)continue;o.time=performance.now();const a=[];if(o)for(const[t,{position:n,index:l,normal:h}]of o.data){if(this._isDisposing)return;if(!r.has(t))continue;if(!this._geometryInstances[s]||!this._geometryInstances[s].has(t))continue;const o=this._geometryInstances[s].get(t);if(!o)throw new Error("Instances not found!");const c=new e.BufferGeometry,d=new e.BufferAttribute(n,3),u=new e.BufferAttribute(h,3);c.setAttribute("position",d),c.setAttribute("normal",u),c.setIndex(Array.from(l));const p=[],m=[];for(const e of o)1===e.color[3]?m.push(e):p.push(e);this.newFragment(i,t,c,p,!0,a),this.newFragment(i,t,c,m,!1,a)}a.length&&!this._isDisposing&&await this.onFragmentsLoaded.trigger(a)}const l=new Set,h=performance.now();for(const[e,{time:t}]of this._ramCache)h-t>this.maxRamTime&&l.add(e);for(const e of l)this._ramCache.delete(e)}}async unloadLostGeometries(e){if(this._isDisposing)return;const t=[],s=this.components.tools.get(rt);for(const i in e){const n=s.groups.find((e=>e.uuid===i));if(!n)throw new Error("Fragment group not found!");if(!this._loadedFragments[i])continue;const o=this._loadedFragments[i],r=e[i];for(const e of r){if(this.culler.removeFragment(n.uuid,e),!o[e])continue;const s=o[e];for(const e of s)n.items.splice(n.items.indexOf(e),1),t.push(e);delete o[e]}}t.length&&await this.onFragmentsDeleted.trigger(t);for(const e of t)delete s.list[e.id],this.components.meshes.delete(e.mesh),e.mesh.material=[],e.dispose(!0)}setMeshVisibility(e,t){for(const s in e)for(const i of e[s]){const e=this._loadedFragments[s];if(!e)continue;const n=e[i];if(n)for(const e of n)e.mesh.visible=t}}newFragment(t,s,i,n,o,r){if(0===n.length)return;if(this._isDisposing)return;const a=t.geometryIDs,l=s*(o?-1:1),h=(o?a.transparent:a.opaque).get(l);if(void 0===h)return;const c=t.keyFragments.get(h);if(void 0===c)return;const d=this.components.tools.get(rt);if(void 0!==d.list[c])return;const u=o?this._baseMaterialT:this._baseMaterial,p=new P.Fragment(i,u,n.length);p.id=c,p.mesh.uuid=c,p.group=t,t.add(p.mesh),t.items.push(p),d.list[p.id]=p,this.components.meshes.add(p.mesh),this._loadedFragments[t.uuid]||(this._loadedFragments[t.uuid]={});const m=this._loadedFragments[t.uuid];m[s]||(m[s]=[]),m[s].push(p);const E=new Map;for(let t=0;t<n.length;t++){const s=new e.Matrix4,i=new e.Color,{id:o,transformation:r,color:a}=n[t];s.fromArray(r);const[l,h,c]=a;if(i.setRGB(l,h,c,"srgb"),E.has(o)){const e=E.get(o);if(!e)continue;e.transforms.push(s),e.colors&&e.colors.push(i)}else E.set(o,{id:o,colors:[i],transforms:[s]})}const g=Array.from(E.values());p.add(g);const I=this.fragIDData.get(p.id);if(!I)throw new Error("Fragment data not found!");const C=I[2];C.size&&p.setVisibility(!1,C),this.culler.addFragment(t.uuid,s,p),r.push(p)}setupCullerEvents(){this.culler.onViewUpdated.add((async({toLoad:e,toRemove:t,toShow:s,toHide:i})=>{await this.loadFoundGeometries(e),await this.unloadLostGeometries(t),this.setMeshVisibility(s,!0),this.setMeshVisibility(i,!1)}))}}qt.uuid="22437e8d-9dbc-4b99-a04f-d2da280d50c8",Z.libraryUUIDs.add(qt.uuid);class Jt extends j{constructor(e){super(e),this.tools=[],this.name="CloudProcessor",this.enabled=!0,this.modelProcessed=new W,this.checkInterval=5e3,this._models=[],this._urls={base:"https://dev.api.dev.platform.thatopen.com/v1/models/",tokenParam:"?accessToken="},this.components.tools.add(Jt.uuid,this)}get(){return this._models}get token(){if(!this._token)throw new Error("Auth token has not been initialized!");return this._token}set token(e){this._token=e}async update(){const{base:e,tokenParam:t}=this._urls,s=`${e}${t}${this.token}`,i=await fetch(s),n=await i.json();this._models=n.models}async upload(e){const t=await this.createModel(),s=t.uploadUrl,i=await fetch(e),n=await i.arrayBuffer();await fetch(s,{method:"PUT",body:n}),this.setupModelProcessEvent(t.model._id)}async delete(e){const{base:t,tokenParam:s}=this._urls,i=`${t}/${e}${s}${this.token}`;return(await fetch(i,{method:"DELETE"})).json()}async getModel(e){const{base:t,tokenParam:s}=this._urls,i=`${t}/${e}${s}${this.token}`;return(await fetch(i)).json()}setupModelProcessEvent(e){const t=setInterval((async()=>{const s=await this.getModel(e);if("PROCESSED"===s.model.status){const{entries:e}=await U(s.downloadUrl),i=await e["model.frag"].arrayBuffer(),n=new Uint8Array(i),o=this.components.tools.get(rt),r=await o.load(n),a=await e["properties.json"].json();r.setLocalProperties(a),await this.modelProcessed.trigger(r),clearInterval(t)}}),this.checkInterval)}async createModel(){const{base:e,tokenParam:t}=this._urls,s=`${e}${t}${this.token}`;return(await fetch(s,{method:"POST"})).json()}}Jt.uuid="6fe6c739-d518-47b8-8057-a22a6c96e722";class es extends j{constructor(t){super(t),this.onDisposed=new W,this.enabled=!0,this.cameraHeight=10,this.darkness=1.2,this.opacity=1,this.resolution=512,this.amount=3.5,this.planeColor=16777215,this.shadowOffset=0,this.shadowExtraScaleFactor=1.5,this.shadows={},this.tempMaterial=new e.MeshBasicMaterial({visible:!1}),this.depthMaterial=new e.MeshDepthMaterial,this.components.tools.add(es.uuid,this),this.initializeDepthMaterial()}get(){return this.shadows}async dispose(){for(const e in this.shadows)this.deleteShadow(e);this.tempMaterial.dispose(),this.depthMaterial.dispose(),this.components=null,await this.onDisposed.trigger(es.uuid),this.onDisposed.reset()}renderShadow(e,t){if(this.shadows[t])throw new Error(`There is already a shadow with ID ${t}`);const{size:s,center:i,min:n}=this.getSizeCenterMin(e),o=this.createShadow(t,s);return this.initializeShadow(o,i,n),this.createPlanes(o,s),this.bakeShadow(e,o),o.root}deleteShadow(e){const t=this.components.tools.get(q),s=this.shadows[e];if(delete this.shadows[e],!s)throw new Error(`No shadow with ID ${e} was found.`);t.destroy(s.root),t.destroy(s.blurPlane),s.rt.dispose(),s.rtBlur.dispose()}createPlanes(t,s){const i=new e.PlaneGeometry(s.x,s.z).rotateX(Math.PI/2);this.createBasePlane(t,i),es.createBlurPlane(t,i)}initializeShadow(e,t,s){this.initializeRoot(e,t,s),es.initializeRenderTargets(e),es.initializeCamera(e)}bakeShadow(e,t){const s=this.components.scene.get(),i=e.map((e=>!!e.parent));for(let t=0;t<e.length;t++)i[t]||s.add(e[t]);const n=s.children.filter((s=>!e.includes(s)&&s!==t.root));for(let e=n.length-1;e>=0;e--)s.remove(n[e]);const o=s.background;s.background=null,s.overrideMaterial=this.depthMaterial;const r=[];for(const t of e)r.push(t.visible),t.visible=!0;const a=this.components.renderer.get();a.setRenderTarget(t.rt),a.render(s,t.camera),s.overrideMaterial=null,this.blurShadow(t,this.amount),this.blurShadow(t,.4*this.amount),a.setRenderTarget(null),s.background=o;for(let t=0;t<e.length;t++)e[t].visible=r[t];for(let e=n.length-1;e>=0;e--)s.add(n[e]);for(let t=0;t<e.length;t++)i[t]||s.remove(e[t])}static initializeCamera(e){e.camera.rotation.x=Math.PI/2,e.root.add(e.camera)}static initializeRenderTargets(e){e.rt.texture.generateMipmaps=!1,e.rtBlur.texture.generateMipmaps=!1}initializeRoot(e,t,s){const i=this.components.scene.get();e.root.position.set(t.x,s.y-this.shadowOffset,t.z),i.add(e.root)}createBasePlane(t,s){const i=this.createPlaneMaterial(t),n=new e.Mesh(s,i);n.renderOrder=2,t.root.add(n),n.scale.y=-1}static createBlurPlane(e,t){e.blurPlane.geometry=t,e.blurPlane.visible=!1,e.root.add(e.blurPlane)}createPlaneMaterial(t){const s=this.components.renderer;return new e.MeshBasicMaterial({map:t.rt.texture,opacity:this.opacity,transparent:!0,depthWrite:!1,clippingPlanes:s.clippingPlanes})}initializeDepthMaterial(){this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1;this.depthMaterial.userData.darkness={value:this.darkness},this.depthMaterial.onBeforeCompile=e=>{e.uniforms.darkness=this.depthMaterial.userData.darkness,e.fragmentShader=`\n\t\t\t\t\t\tuniform float darkness;\n\t\t\t\t\t\t${e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * darkness );")}\n\t\t\t\t\t`}}createShadow(t,s){return this.shadows[t]={root:new e.Group,rt:new e.WebGLRenderTarget(this.resolution,this.resolution),rtBlur:new e.WebGLRenderTarget(this.resolution,this.resolution),blurPlane:new e.Mesh,camera:this.createCamera(s)},this.shadows[t]}createCamera(t){return new e.OrthographicCamera(-t.x/2,t.x/2,t.z/2,-t.z/2,0,this.cameraHeight)}getSizeCenterMin(t){const s=t[0].parent,i=new e.Group;i.children=t;const n=(new e.Box3).setFromObject(i);s?.add(...t);const o=new e.Vector3;n.getSize(o),o.x*=this.shadowExtraScaleFactor,o.z*=this.shadowExtraScaleFactor;const r=new e.Vector3;n.getCenter(r);return{size:o,center:r,min:n.min}}blurShadow(t,s){const i=new e.ShaderMaterial(k);i.depthTest=!1;const n=new e.ShaderMaterial(V);n.depthTest=!1,t.blurPlane.visible=!0,t.blurPlane.material=i,t.blurPlane.material.uniforms.tDiffuse.value=t.rt.texture,i.uniforms.h.value=1*s/256;const o=this.components.renderer.get();o.setRenderTarget(t.rtBlur),o.render(t.blurPlane,t.camera),t.blurPlane.material=n,t.blurPlane.material.uniforms.tDiffuse.value=t.rtBlur.texture,n.uniforms.v.value=1*s/256,o.setRenderTarget(t.rt),o.render(t.blurPlane,t.camera),t.blurPlane.visible=!1}}es.uuid="f833a09a-a3ab-4c58-b03e-da5298c7a1b6",Z.libraryUUIDs.add(es.uuid);const ts="text-white text-sm bg-ifcjs-100 rounded-md px-3 py-1",ss="bg-ifcjs-100 rounded-full w-[8px] h-[8px]";class is{get visible(){return this._visible}set visible(e){this._visible=e,this.label.visible=e,this._endpoints[0].visible=e,this._endpoints[1].visible=e;const[t,s]=this._endpoints,i=t.get(),n=s.get(),o=this.label.get();e?(this._components.scene.get().add(this._root),this._root.add(o,i,n)):(o.removeFromParent(),i.removeFromParent(),n.removeFromParent(),this._root.removeFromParent())}get endPoint(){return this._end}set endPoint(e){this._end=e;const t=this._line.geometry.attributes.position;t.setXYZ(1,e.x,e.y,e.z),t.needsUpdate=!0,this._endpoints[1].get().position.copy(e),this.updateLabel()}get startPoint(){return this._start}set startPoint(e){this._start=e;const t=this._line.geometry.attributes.position;t.setXYZ(0,e.x,e.y,e.z),t.needsUpdate=!0,this._endpoints[0].get().position.copy(e),this.updateLabel()}get _center(){let e=this._end.clone().sub(this._start);const t=.5*e.length();return e=e.normalize().multiplyScalar(t),this._start.clone().add(e)}constructor(t,s){this.boundingBox=new e.Mesh,this._visible=!0,this._root=new e.Group,this._endpoints=[],this._components=t,this._start=s.start,this._end=s.end,this._length=this.getLength(),this._line=this.createLine(s),this.newEndpointElement(s.endpointElement),this.newEndpointElement(s.endpointElement.cloneNode(!0)),this.label=this.newText(),this._root.renderOrder=2,this._components.scene.get().add(this._root)}async dispose(){const e=await this._components.tools.get(q);this.visible=!1,e.destroy(this._root),e.destroy(this._line);for(const e of this._endpoints)await e.dispose();this._endpoints.length=0,await this.label.dispose(),this.boundingBox&&e.destroy(this.boundingBox),this._components=null}createBoundingBox(){this.boundingBox.geometry=new e.BoxGeometry(1,1,this._length),this.boundingBox.position.copy(this._center),this.boundingBox.lookAt(this._end),this.boundingBox.visible=!1,this._root.add(this.boundingBox)}toggleLabel(){this.label.toggleVisibility()}newEndpointElement(e){const t=0===this._endpoints.length?this._start:this._end,s=new De(this._components,e);s.get().position.copy(t),this._endpoints.push(s),this._root.add(s.get())}updateLabel(){this._length=this.getLength(),this.label.get().element.textContent=this.getTextContent(),this.label.get().position.copy(this._center),this._line.computeLineDistances()}createLine(t){const s=new e.BufferGeometry;s.setFromPoints([t.start,t.end]);const i=new e.Line(s,t.lineMaterial);return this._root.add(i),i}newText(){const e=document.createElement("div");e.className=ts,e.textContent=this.getTextContent();const t=new De(this._components,e);return t.get().position.copy(this._center),this._root.add(t.get()),t}getTextContent(){return`${this._length/is.scale} ${is.units}`}getLength(){return parseFloat(this._start.distanceTo(this._end).toFixed(2))}}is.scale=1,is.units="m";class ns extends j{constructor(t,s){super(t),this.name="AreaShape",this.enabled=!0,this.visible=!0,this.points=[],this.workingPlane=null,this.onDisposed=new W,this._rotationMatrix=null,this._dimensionLines=[],this._defaultLineMaterial=new e.LineBasicMaterial({color:"red"}),this.onAreaComputed=new W,this.onWorkingPlaneComputed=new W,this.onPointAdded=new W,this.onPointRemoved=new W;const i=document.createElement("div");i.className=ts,this.labelMarker=new De(t,i),this.labelMarker.visible=!1,this.onPointAdded.add((e=>{3!==this.points.length||this._dimensionLines[2]||(this.addDimensionLine(e,this.points[0]),this.labelMarker.visible=!0)})),s?.forEach((e=>this.setPoint(e)))}setPoint(e,t){let s;if(s=t||(0===this.points.length?0:this.points.length),0===s)return void(this.points[0]=e);if(s<0||s>this.points.length)return;const i=this.points.length>s;this.points[s]=e,this.onPointAdded.trigger(e),i||this.addDimensionLine(this.points[s-1],e);const{previousLine:n,nextLine:o}=this.getLinesBetweenIndex(s);n&&(n.endPoint=e),o&&(o.startPoint=e)}removePoint(e){if(3===this.points.length)return;this.points.splice(e,1);const{previousLine:t,nextLine:s}=this.getLinesBetweenIndex(e);s&&(t.endPoint=s.endPoint),s?.dispose(),this._dimensionLines.splice(e,1),this.onPointRemoved.trigger()}toggleLabel(){this.labelMarker.toggleVisibility()}addDimensionLine(e,t){const s=document.createElement("div");s.className="w-2 h-2 bg-red-600 rounded-full";const i=new is(this.components,{start:e,end:t,lineMaterial:this._defaultLineMaterial,endpointElement:s});return i.toggleLabel(),this._dimensionLines.length>1?this._dimensionLines.splice(this._dimensionLines.length-1,0,i):this._dimensionLines.push(i),i}getLinesBetweenIndex(e){const t=0===e?this._dimensionLines.length-1:e-1;return{previousLine:this._dimensionLines[t],nextLine:this._dimensionLines[e]}}computeWorkingPlane(){this.workingPlane=(new e.Plane).setFromCoplanarPoints(this.points[0],this.points[1],this.points[2]);const t=new e.Vector3(0,1,0),s=this.workingPlane.normal.angleTo(t),i=(new e.Vector3).crossVectors(this.workingPlane.normal,t).normalize();this._rotationMatrix=(new e.Matrix4).makeRotationAxis(i,s),this.onWorkingPlaneComputed.trigger(this.workingPlane)}computeArea(){if(!this._rotationMatrix||!this.workingPlane)return this.onAreaComputed.trigger(0),0;let t=0,s=0;const i=this._rotationMatrix,n=this.points.map((n=>{const o=n.clone().applyMatrix4(i),r=new e.Vector2(o.x,o.z);return t+=r.x,s+=r.y,r})),o=Math.abs(e.ShapeUtils.area(n));return this.labelMarker.get().element.textContent=`${o.toFixed(2)} m`,this.labelMarker.get().position.set(t/n.length,-this.workingPlane.constant,s/n.length).applyMatrix4(i.clone().invert()),this.onAreaComputed.trigger(o),o}async dispose(){this.onAreaComputed.reset(),this.onWorkingPlaneComputed.reset(),this.onPointAdded.reset(),this.onPointRemoved.reset();for(const e of this._dimensionLines)e.dispose();await this.labelMarker.dispose(),this._dimensionLines=[],this.points=[],this._rotationMatrix=null,this.workingPlane=null,this._defaultLineMaterial.dispose(),this.components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}get(){return{points:this.points,workingPlane:this.workingPlane,area:this.computeArea()}}}class os extends j{set enabled(e){if(this._enabled=e,this._vertexPicker.enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}this.setupEvents(e),e||this.cancelCreation()}get enabled(){return this._enabled}set workingPlane(e){this._vertexPicker.workingPlane=e}get workingPlane(){return this._vertexPicker.workingPlane}constructor(e){super(e),this.onDisposed=new W,this.uiElement=new Q,this._enabled=!1,this._currentAreaElement=null,this._clickCount=0,this._measurements=[],this.onBeforeCreate=new W,this.onAfterCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.onAfterDelete=new W,this.create=()=>{if(!this.enabled)return;const e=this._vertexPicker.get();if(e){if(!this._currentAreaElement){const e=new ns(this.components);e.onPointAdded.add((()=>{3!==this._clickCount||e.workingPlane||(e.computeWorkingPlane(),this._vertexPicker.workingPlane=e.workingPlane)})),e.onPointRemoved.add((()=>this._clickCount--)),this._currentAreaElement=e}this._currentAreaElement.setPoint(e,this._clickCount),this._currentAreaElement.computeArea(),this._clickCount++}},this.onMouseMove=()=>{const e=this._vertexPicker.get();e&&this._currentAreaElement&&(this._currentAreaElement.setPoint(e,this._clickCount),this._currentAreaElement.computeArea())},this.onKeydown=e=>{this.enabled&&("z"===e.key&&e.ctrlKey&&this._currentAreaElement&&this._currentAreaElement.removePoint(this._clickCount-1),"Enter"===e.key&&this._currentAreaElement&&this.endCreation(),"Escape"===e.key&&(0!==this._clickCount||this._currentAreaElement?this.cancelCreation():this.enabled=!1))},this.components.tools.add(os.uuid,this),this._vertexPicker=new Ue(e),e.uiEnabled&&this.setUI()}async dispose(){this.setupEvents(!1),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),this.uiElement.dispose(),await this._vertexPicker.dispose(),this._currentAreaElement&&await this._currentAreaElement.dispose();for(const e of this._measurements)await e.dispose();this.components=null,await this.onDisposed.trigger(os.uuid),this.onDisposed.reset()}setUI(){const e=new ae(this.components);e.materialIcon="check_box_outline_blank",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1):(e.active=!0,this.enabled=!0)})),this.uiElement.set({main:e})}delete(){}async deleteAll(){for(const e of this._measurements)await e.dispose(),await this.onAfterDelete.trigger(this);this._measurements=[]}endCreation(){this._currentAreaElement&&(this._measurements.push(this._currentAreaElement),this._currentAreaElement.removePoint(this._clickCount),this._currentAreaElement.computeWorkingPlane(),this._currentAreaElement.computeArea(),this._currentAreaElement=null),this._vertexPicker.workingPlane=null,this._clickCount=0}cancelCreation(){this._currentAreaElement&&(this._currentAreaElement.dispose(),this._currentAreaElement=null),this._vertexPicker.workingPlane=null,this._clickCount=0}get(){return this._measurements}setupEvents(e){const t=this.components.ui.viewerContainer;e?(t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeydown)):(t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeydown))}}os.uuid="c453a99e-f054-4781-9060-33df617db4a5",Z.libraryUUIDs.add(os.uuid);class rs extends j{set lineMaterial(e){this._lineMaterial.dispose(),this._lineMaterial=e,this._line.material=e,this._lineMaterial.resolution.set(window.innerWidth,window.innerHeight)}get lineMaterial(){return this._lineMaterial}set labelMarker(e){this._labelMarker.dispose(),this._labelMarker=e}get labelMarker(){return this._labelMarker}get scene(){return this._components.scene.get()}constructor(t,s){super(t),this.enabled=!0,this.visible=!0,this.points=[],this.onDisposed=new W,this._lineMaterial=new G({color:6629591,linewidth:2}),this._lineGeometry=new z,this._line=new Y(this._lineGeometry,this._lineMaterial),this.onAngleComputed=new W,this.onPointAdded=new W,this._components=t;const i=document.createElement("div");i.className=ts,this._labelMarker=new De(t,i),this.labelMarker.visible=!1,this.onPointAdded.add((()=>{1===this.points.length&&this.scene.add(this._line),3===this.points.length&&(this.labelMarker.visible=!0)})),this.onAngleComputed.add((t=>{this.labelMarker.get().element.textContent=`${t.toFixed(2)}`,this.labelMarker.get().position.copy(this.points[1]??new e.Vector3)})),s?.forEach((e=>this.setPoint(e)))}setPoint(e,t){let s;if(s=t||(0===this.points.length?0:this.points.length),![0,1,2].includes(s))return;this.points[s]=e,this.onPointAdded.trigger(e);const i=this.points.map((e=>[e.x,e.y,e.z]));this._lineGeometry.setPositions(i.flat())}toggleLabel(){this.labelMarker.toggleVisibility()}computeAngle(){const t=this.points[0],s=this.points[1],i=this.points[2];if(!(t&&s&&i))return 0;const n=(new e.Vector3).subVectors(s,t),o=(new e.Vector3).subVectors(s,i),r=e.MathUtils.radToDeg(n.angleTo(o));return this.onAngleComputed.trigger(r),r}async dispose(){this.points=[],await this.labelMarker.dispose(),this.onAngleComputed.reset(),this.onPointAdded.reset(),await this.labelMarker.dispose(),this._line.removeFromParent(),this._lineMaterial.dispose(),this._lineGeometry.dispose(),this._components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}get(){return{points:this.points,angle:this.computeAngle()}}}class as extends j{set lineMaterial(e){this._lineMaterial.dispose(),this._lineMaterial=e,this._lineMaterial.resolution.set(window.innerWidth,window.innerHeight)}get lineMaterial(){return this._lineMaterial}set enabled(e){if(this._enabled=e,this.setupEvents(e),this._vertexPicker.enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}e||this.cancelCreation()}get enabled(){return this._enabled}set workingPlane(e){this._vertexPicker.workingPlane=e}get workingPlane(){return this._vertexPicker.workingPlane}constructor(e){super(e),this.onDisposed=new W,this.uiElement=new Q,this._enabled=!1,this._currentAngleElement=null,this._clickCount=0,this._measurements=[],this.onBeforeCreate=new W,this.onAfterCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.onAfterDelete=new W,this.create=()=>{if(!this.enabled)return;const e=this._vertexPicker.get();if(e){if(!this._currentAngleElement){const e=new rs(this.components);e.lineMaterial=this.lineMaterial,this._currentAngleElement=e}this._currentAngleElement.setPoint(e,this._clickCount),this._currentAngleElement.setPoint(e,this._clickCount+1),this._currentAngleElement.setPoint(e,this._clickCount+2),this._currentAngleElement.computeAngle(),this._clickCount++,3===this._clickCount&&this.endCreation()}},this.onMouseMove=()=>{const e=this._vertexPicker.get();e&&this._currentAngleElement&&(this._currentAngleElement.setPoint(e,this._clickCount),this._currentAngleElement.computeAngle())},this.onKeyDown=e=>{this.enabled&&("z"===e.key&&e.ctrlKey&&this._currentAngleElement,"Escape"===e.key&&(0!==this._clickCount||this._currentAngleElement?this.cancelCreation():this.enabled=!1))},this.components.tools.add(as.uuid,this),this.components=e,this._lineMaterial=new G({color:6629591,linewidth:2}),this._vertexPicker=new Ue(e),e.uiEnabled&&this.setUI()}async dispose(){this.setupEvents(!1),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),this.uiElement.dispose(),this._lineMaterial.dispose(),await this._vertexPicker.dispose();for(const e of this._measurements)await e.dispose();this._currentAngleElement&&await this._currentAngleElement.dispose(),this.components=null,await this.onDisposed.trigger(as.uuid),this.onDisposed.reset()}delete(){}async deleteAll(){for(const e of this._measurements)await e.dispose(),await this.onAfterDelete.trigger(this);this._measurements=[]}endCreation(){this._currentAngleElement&&(this._measurements.push(this._currentAngleElement),this._currentAngleElement.computeAngle(),this._currentAngleElement=null),this._clickCount=0}cancelCreation(){this._currentAngleElement&&(this._currentAngleElement.dispose(),this._currentAngleElement=null),this._clickCount=0}get(){return this._measurements}setUI(){const e=new ae(this.components);e.materialIcon="square_foot",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1):(e.active=!0,this.enabled=!0)})),this.uiElement.set({main:e})}setupEvents(e){const t=this.components.ui.viewerContainer;if(e)t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeyDown);else{this.uiElement.get("main").active=!1,t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeyDown)}}}as.uuid="622fb2c9-528c-4b0a-8a0e-6a1375f0a3aa",Z.libraryUUIDs.add(as.uuid);class ls extends j{get enabled(){return this._enabled}set enabled(e){if(e||this.cancelCreation(),this._enabled=e,this._vertexPicker.enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}}get visible(){return this._visible}set visible(e){this._visible=e;for(const t of this._measurements)t.visible=e}set color(e){this._lineMaterial.color=e}constructor(t){super(t),this.onDisposed=new W,this.onBeforeUpdate=new W,this.onAfterUpdate=new W,this.onAfterCreate=new W,this.onBeforeCreate=new W,this.onAfterDelete=new W,this.onBeforeDelete=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.uiElement=new Q,this.snapDistance=.25,this._lineMaterial=new e.LineBasicMaterial({color:"#DC2626",linewidth:2,depthTest:!1}),this._measurements=[],this._visible=!0,this._enabled=!1,this._temp={isDragging:!1,start:new e.Vector3,end:new e.Vector3,dimension:void 0},this.create=async t=>{const s=t instanceof e.Object3D?t:void 0;this._enabled&&(await this.onBeforeCreate.trigger(this),this._temp.isDragging?await this.endCreation():this.drawStart(s))},this.onKeyDown=e=>{this.enabled&&"Escape"===e.key&&(this._temp.isDragging?this.cancelCreation():this.enabled=!1)},this.components.tools.add(ls.uuid,this),this._raycaster=new ie(this.components),this._vertexPicker=new Ue(t,{previewElement:this.newEndpoint(),snapDistance:this.snapDistance}),t.uiEnabled&&this.setUI()}setUI(){const e=new ae(this.components);this.uiElement.set({main:e}),e.materialIcon="straighten",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1,this.setupEvents(!1)):(this.setupEvents(!0),e.active=!0,this.enabled=!0)}))}get(){return this._measurements}async dispose(){this.setupEvents(!1),this.enabled=!1,this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.uiElement.dispose(),this.previewElement&&this.previewElement.remove();for(const e of this._measurements)await e.dispose();this._lineMaterial.dispose(),this._measurements=[],await this._vertexPicker.dispose(),await this.onDisposed.trigger(ls.uuid),this.onDisposed.reset()}async update(e){this._enabled&&(await this.onBeforeUpdate.trigger(this),this._temp.isDragging&&this.drawInProcess(),await this.onAfterUpdate.trigger(this))}createOnPoints(e,t){const s=this.drawDimension();s.startPoint=e,s.endPoint=t,s.createBoundingBox(),this._measurements.push(s)}async delete(){if(!this._enabled||0===this._measurements.length)return;const e=this.getBoundingBoxes(),t=this._raycaster.castRay(e);if(!t)return;const s=this._measurements.find((e=>e.boundingBox===t.object));if(s){const e=this._measurements.indexOf(s);this._measurements.splice(e,1),await s.dispose(),await this.onAfterDelete.trigger(this)}}async deleteMeasurement(e){if(e){const t=this._measurements.indexOf(e);this._measurements.splice(t,1),await e.dispose(),await this.onAfterDelete.trigger(this)}}async deleteAll(){for(const e of this._measurements)await e.dispose(),await this.onAfterDelete.trigger(this);this._measurements=[]}cancelCreation(){this._temp.dimension&&(this._temp.isDragging=!1,this._temp.dimension?.dispose(),this._temp.dimension=void 0)}drawStart(e){const t=e?[e]:void 0,s=this._raycaster.castRay(t),i=this._vertexPicker.get();s&&i&&(this._temp.isDragging=!0,this._temp.start=e?s.point:i)}drawInProcess(){if(!this._raycaster.castRay())return;const e=this._vertexPicker.get();e&&(this._temp.end=e,this._temp.dimension||(this._temp.dimension=this.drawDimension()),this._temp.dimension.endPoint=this._temp.end)}async endCreation(){this._temp.dimension&&(this._temp.dimension.createBoundingBox(),this._measurements.push(this._temp.dimension),await this.onAfterCreate.trigger(this._temp.dimension),this._temp.dimension=void 0,this._temp.isDragging=!1)}drawDimension(){return new is(this.components,{start:this._temp.start,end:this._temp.end,lineMaterial:this._lineMaterial,endpointElement:this.newEndpoint()})}newEndpoint(){const e=document.createElement("div");return e.className="w-2 h-2 bg-red-600 rounded-full",e}getBoundingBoxes(){return this._measurements.map((e=>e.boundingBox)).filter((e=>void 0!==e))}setupEvents(e){const t=this.components.renderer.get().domElement.parentElement;t&&(e?(t.addEventListener("click",this.create),window.addEventListener("keydown",this.onKeyDown)):(t.removeEventListener("click",this.create),window.removeEventListener("keydown",this.onKeyDown)))}}ls.uuid="2f9bcacf-18a9-4be6-a293-e898eae64ea1",Z.libraryUUIDs.add(ls.uuid);class hs extends j{set enabled(e){if(this._enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}this.setupEvents(e),e||this.cancelCreation()}get enabled(){return this._enabled}constructor(t){super(t),this.uiElement=new Q,this._enabled=!1,this.onBeforeCreate=new W,this.onAfterCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.onAfterDelete=new W,this.onDisposed=new W,this.create=()=>{if(!this.enabled)return;const t=this.components.raycaster.castRay();if(!t||!t.object)return;const{object:s}=t;if(s instanceof e.Mesh){const e=this.getVolumeOfMesh(s);console.log(e)}},this.onMouseMove=()=>{},this.onKeydown=e=>{},this.components.tools.add(hs.uuid,this),this.label=this.newLabel(),this.label.get().removeFromParent(),t.uiEnabled&&this.setUI()}async dispose(){this.setupEvents(!1),await this.label.dispose(),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),await this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset(),this.components=null}setUI(){const e=new ae(this.components);e.materialIcon="check_box_outline_blank",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1):(e.active=!0,this.enabled=!0)})),this.uiElement.set({main:e})}delete(){}async deleteAll(){}endCreation(){}cancelCreation(){}get(){}getVolumeFromMeshes(e){let t=0;for(const s of e)t+=this.getVolumeOfMesh(s);const s=this.components.scene.get(),i=this.label.get();s.add(i);const n=this.components.tools.get(Et);for(const t of e)t.geometry.computeBoundingSphere(),n.addMesh(t);const o=n.getSphere();n.reset(),i.position.copy(o.center);const r=Math.trunc(100*t)/100;return i.element.textContent=r.toString(),t}newLabel(){const e=document.createElement("div");return e.className=ts,new De(this.components,e)}setupEvents(e){const t=this.components.ui.viewerContainer;e?(t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeydown)):(t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeydown))}getVolumeOfMesh(t){let s=0;const i=new e.Vector3,n=new e.Vector3,o=new e.Vector3,{index:r}=t.geometry,a=t.geometry.attributes.position.array;if(!r)return console.warn("Geometry must be indexed to compute its volume!"),0;const l=[];if(t instanceof e.InstancedMesh)for(let s=0;s<t.count;s++){const i=new e.Matrix4;t.getMatrixAt(s,i),l.push(i)}else l.push((new e.Matrix4).identity());const{matrixWorld:h}=t;for(let e=0;e<r.array.length-2;e+=3)for(const t of l){const l=t.multiply(h),c=3*r.array[e],d=3*r.array[e+1],u=3*r.array[e+2];i.set(a[c],a[c+1],a[c+2]).applyMatrix4(l),n.set(a[d],a[d+1],a[d+2]).applyMatrix4(l),o.set(a[u],a[u+1],a[u+2]).applyMatrix4(l),s+=this.getSignedVolumeOfTriangle(i,n,o)}return Math.abs(s)}getSignedVolumeOfTriangle(e,t,s){return 1/6*(-(s.x*t.y*e.z)+t.x*s.y*e.z+s.x*e.y*t.z-e.x*s.y*t.z-t.x*e.y*s.z+e.x*t.y*s.z)}}hs.uuid="811da532-7af3-4635-b592-1c06ae494af5",Z.libraryUUIDs.add(hs.uuid);class cs{static getFace(e,t,s){if(!e.geometry.index)throw new Error("Geometry must be indexed!");const i=new Map,n=e.geometry.index.array,{plane:o}=this.getFaceData(t,s,e),r=[];for(let t=0;t<n.length/3;t++){const{plane:n,edges:a}=this.getFaceData(t,s,e);if(n.equals(o)){r.push({index:t,edges:a});for(const{id:e,points:t,distance:s}of a)i.set(e,{points:t,distance:s})}}let a=0;const l=new Map,h=new Map;for(const{index:e,edges:t}of r){const s=new Map;for(const{id:e}of t)if(l.has(e)){const t=l.get(e);s.set(e,t)}const i=t.map((e=>e.id));if(!s.size){const s=a++;for(const{id:e}of t)l.set(e,s);h.set(s,{edges:new Set(i),indices:new Set([e])});continue}let n=null;const o=new Set,r=new Set(i);for(const[e,t]of s){null===n?n=t:t!==n&&o.add(t),l.delete(e);const{edges:s}=h.get(t);s.delete(e),r.delete(e)}if(null===n)throw new Error("Error computing face!");const c=h.get(n),{indices:d}=c;d.add(e);for(const e of r){l.set(e,n);const{edges:t}=c;t.add(e)}for(const e of o){const t=h.get(e),{edges:s,indices:i}=t,o=h.get(n),{edges:r,indices:a}=o;for(const e of s)r.add(e),l.set(e,n);for(const e of i)a.add(e);h.delete(e)}}for(const[e,{indices:s,edges:n}]of h)if(s.has(t)){const e=[];for(const t of n){const s=i.get(t);e.push(s)}return{edges:e,indices:s}}return null}static distanceFromPointToLine(t,s,i,n=!1){const o=new e.Line3,r=new e.Vector3;return o.set(s,i),o.closestPointToPoint(t,n,r),r.distanceTo(t)}static getFaceData(t,s,i){const n=this.getVerticesAndNormal(i,t,s),{p1:o,p2:r,p3:a,faceNormal:l}=n;this.round(o),this.round(r),this.round(a),this.round(l);const h=[{id:`${o.x}|${o.y}|${o.z}`,value:o},{id:`${r.x}|${r.y}|${r.z}`,value:r},{id:`${a.x}|${a.y}|${a.z}`,value:a}];h.sort(((e,t)=>e.id<t.id?-1:e.id>t.id?1:0));const[{id:c,value:d},{id:u,value:p},{id:m,value:E}]=h,g=[{id:`${c}|${u}`,distance:d.distanceTo(p),points:[d,p]},{id:`${u}|${m}`,distance:p.distanceTo(E),points:[p,E]},{id:`${c}|${m}`,distance:d.distanceTo(E),points:[d,E]}],I=new e.Plane;return I.setFromNormalAndCoplanarPoint(l,o),I.constant=Math.round(10*I.constant)/10,{plane:I,edges:g}}static getVerticesAndNormal(t,s,i){if(!t.geometry.index)throw new Error("Geometry must be indexed!");const n=t.geometry.index.array,o=t.geometry.attributes.position.array,r=t.geometry.attributes.normal.array,a=3*n[3*s],l=3*n[3*s+1],h=3*n[3*s+2],c=new e.Vector3(o[a],o[a+1],o[a+2]),d=new e.Vector3(o[l],o[l+1],o[l+2]),u=new e.Vector3(o[h],o[h+1],o[h+2]),p=new e.Vector3(r[a],r[a+1],r[a+2]),m=new e.Vector3(r[l],r[l+1],r[l+2]),E=new e.Vector3(r[h],r[h+1],r[h+2]),g=(p.x+m.x+E.x)/3,I=(p.y+m.y+E.y)/3,C=(p.z+m.z+E.z)/3,f=new e.Vector3(g,I,C);if(void 0!==i&&t instanceof e.InstancedMesh){const s=new e.Matrix4;t.getMatrixAt(i,s);const n=new e.Matrix4;n.extractRotation(s),f.applyMatrix4(n),c.applyMatrix4(s),d.applyMatrix4(s),u.applyMatrix4(s)}return{p1:c,p2:d,p3:u,faceNormal:f}}static round(e){const t=1e3;e.x=Math.trunc(e.x*t)/t,e.y=Math.trunc(e.y*t)/t,e.z=Math.trunc(e.z*t)/t}}class ds extends j{set enabled(e){if(this._enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}if(this.setupEvents(e),e){this.components.scene.get().add(this.preview)}else this.preview.removeFromParent(),this.cancelCreation();this.setVisibility(e)}get enabled(){return this._enabled}constructor(t){super(t),this.uiElement=new Q,this.selection=[],this.preview=new e.Mesh(new e.BufferGeometry,new e.MeshBasicMaterial({side:2,depthTest:!1,transparent:!0,opacity:.25,color:"#BCF124"})),this.selectionMaterial=new e.MeshBasicMaterial({side:2,depthTest:!1,transparent:!0,color:"#BCF124",opacity:.75}),this.onBeforeCreate=new W,this.onAfterCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.onAfterDelete=new W,this.onDisposed=new W,this._enabled=!1,this._currentSelelection=null,this.create=()=>{if(!this.enabled||!this._currentSelelection)return;const t=this.components.scene.get(),s=new e.BufferGeometry,i=new e.Mesh(s,this.selectionMaterial);s.setAttribute("position",this.preview.geometry.attributes.position),t.add(i),s.computeBoundingSphere();const{area:n,perimeter:o}=this._currentSelelection,r=this.newLabel(s,n);i.add(r.get()),this.selection.push({area:n,perimeter:o,mesh:i,label:r})},this.onMouseMove=()=>{if(!this.enabled)return void this.unselect();const t=this.components.raycaster.castRay();if(!t||!t.object||void 0===t.faceIndex)return void this.unselect();const{object:s,faceIndex:i}=t;s instanceof e.Mesh||s instanceof e.InstancedMesh?this.updateSelection(s,i,t.instanceId):this.unselect()},this.onKeydown=e=>{},this.components.tools.add(ds.uuid,this),this.preview.frustumCulled=!1,t.uiEnabled&&this.setUI()}async dispose(){this.setupEvents(!1),await this.deleteAll(),this.preview.removeFromParent(),this.preview.material.dispose(),this.preview.geometry.dispose(),this.selectionMaterial.dispose(),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),await this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset(),this.components=null}setUI(){const e=new ae(this.components);e.materialIcon="check_box_outline_blank",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1):(e.active=!0,this.enabled=!0)})),this.uiElement.set({main:e})}async delete(){const e=this.selection.map((e=>e.mesh)),t=this.components.raycaster.castRay(e);if(!t||!t.object)return;const s=this.selection.find((e=>e.mesh===t.object));if(!s)return;s.mesh.removeFromParent(),s.mesh.geometry.dispose(),await s.label.dispose();const i=this.selection.indexOf(s);this.selection.splice(i,1)}async deleteAll(){for(const e of this.selection)e.mesh.removeFromParent(),e.mesh.geometry.dispose(),await e.label.dispose();this.selection=[]}endCreation(){}cancelCreation(){}get(){const e=[];for(const t of this.selection){const s=t.mesh.geometry,{area:i,perimeter:n}=t,o=s.attributes.position.array;e.push({position:o,area:i,perimeter:n})}return e}set(t){const s=this.components.scene.get();for(const i of t){const t=new e.BufferGeometry,n=new e.Mesh(t,this.selectionMaterial);s.add(n);const o=new e.BufferAttribute(i.position,3);t.setAttribute("position",o),t.computeBoundingSphere();const{area:r,perimeter:a}=i,l=this.newLabel(t,r);n.add(l.get()),this.selection.push({area:r,perimeter:a,mesh:n,label:l})}}setupEvents(e){const t=this.components.ui.viewerContainer;e?(t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeydown)):(t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeydown))}setVisibility(e){const t=this.components.scene.get();for(const s of this.selection){const i=s.label.get();e?(t.add(s.mesh),s.mesh.add(i)):(s.mesh.removeFromParent(),i.removeFromParent())}}unselect(){this.preview.removeFromParent(),this._currentSelelection=null}updateSelection(e,t,s){this.components.scene.get().add(this.preview);const i=cs.getFace(e,t,s);if(null===i)return;const n=this.regenerateHighlight(e,i.indices,s);let o=0;for(const{distance:e}of i.edges)o+=e;this._currentSelelection={perimeter:o,area:n}}newLabel(e,t){if(!e.boundingSphere)throw new Error("Error computing area geometry");const{center:s}=e.boundingSphere,i=document.createElement("div");i.className=ts;const n=Math.trunc(100*t)/100;i.textContent=n.toString();const o=new De(this.components,i);return o.get().position.copy(s),o}regenerateHighlight(t,s,i){const n=[],o=[];let r=0,a=0;const l=new e.Triangle;for(const e of s){const{p1:s,p2:h,p3:c}=cs.getVerticesAndNormal(t,e,i);n.push(s.x,s.y,s.z),n.push(h.x,h.y,h.z),n.push(c.x,c.y,c.z),l.set(s,h,c),a+=l.getArea(),o.push(r,r+1,r+2),r+=3}const h=new Float32Array(n),c=new e.BufferAttribute(h,3);return this.preview.geometry.setAttribute("position",c),this.preview.geometry.setIndex(o),a}}ds.uuid="30279548-1309-44f6-aa97-ce26eed73522",Z.libraryUUIDs.add(ds.uuid);class us extends j{set enabled(e){if(this._enabled=e,this.components.uiEnabled){this.uiElement.get("main").active=e}this.setupEvents(e),e||this.cancelCreation()}get enabled(){return this._enabled}constructor(t){super(t),this.uiElement=new Q,this.tolerance=.3,this.onBeforeCreate=new W,this.onAfterCreate=new W,this.onBeforeCancel=new W,this.onAfterCancel=new W,this.onBeforeDelete=new W,this.onAfterDelete=new W,this.onDisposed=new W,this._enabled=!1,this._lineMaterial=new e.LineBasicMaterial({color:"#DC2626",linewidth:2,depthTest:!1,transparent:!0}),this.create=async()=>{if(!this.enabled||!this.preview.visible)return;const e=this.components.tools.get(ls),t=this.preview.startPoint.clone(),s=this.preview.endPoint.clone();e.createOnPoints(t,s)},this.onMouseMove=()=>{if(!this.enabled)return void(this.preview.visible=!1);const t=this.components.raycaster.castRay();if(!t||!t.object)return void(this.preview.visible=!1);const{object:s,faceIndex:i,point:n}=t;void 0!==i&&(s instanceof e.Mesh||s instanceof e.InstancedMesh)?this.updateSelection(s,n,i,t.instanceId):this.preview.visible=!1},this.onKeydown=e=>{},this.components.tools.add(us.uuid,this);const s=document.createElement("div");s.className="w-2 h-2 bg-red-600 rounded-full",this.preview=new is(this.components,{start:new e.Vector3,end:new e.Vector3,lineMaterial:this._lineMaterial,endpointElement:s}),this.preview.visible=!1,t.uiEnabled&&this.setUI()}async dispose(){await this.preview.dispose(),this._lineMaterial.dispose(),this.setupEvents(!1),this.onBeforeCreate.reset(),this.onAfterCreate.reset(),this.onBeforeCancel.reset(),this.onAfterCancel.reset(),this.onBeforeDelete.reset(),this.onAfterDelete.reset(),await this.uiElement.dispose(),await this.onDisposed.trigger(),this.onDisposed.reset(),this.components=null}setUI(){const e=new ae(this.components);e.materialIcon="check_box_outline_blank",e.onClick.add((()=>{this.enabled?(this.enabled=!1,e.active=!1):(e.active=!0,this.enabled=!0)})),this.uiElement.set({main:e})}async delete(){if(!this.enabled)return;const e=this.components.tools.get(ls),t=e.enabled;e.enabled=!0,await e.delete(),e.enabled=t}async deleteAll(){const e=this.components.tools.get(ls);await e.deleteAll()}endCreation(){}cancelCreation(){}get(){const e=this.components.tools.get(ls).get(),t=[];for(const s of e){const e=s.startPoint,i=s.endPoint,n=[e.x,e.y,e.z,i.x,i.y,i.z];t.push(n)}return t}set(t){const s=this.components.tools.get(ls);for(const i of t){const[t,n,o,r,a,l]=i,h=new e.Vector3(t,n,o),c=new e.Vector3(r,a,l);s.createOnPoints(h,c)}}setupEvents(e){const t=this.components.ui.viewerContainer;e?(t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeydown)):(t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeydown))}updateSelection(e,t,s,i){if(!e.geometry.index)return;const n=cs.getFace(e,s,i);if(!n)return;const{edges:o}=n;let r=Number.MAX_VALUE,a=[];for(const e of o){const[s,i]=e.points,n=cs.distanceFromPointToLine(t,s,i,!0);n<this.tolerance&&n<r&&(r=n,a=e.points)}if(!a.length)return void(this.preview.visible=!1);const[l,h]=a;this.preview.startPoint=l,this.preview.endPoint=h,this.preview.visible=!0}}us.uuid="e7be5749-89df-4514-8d25-83aa38ce12d8",Z.libraryUUIDs.add(us.uuid);class ps extends j{constructor(e){super(e),this.name="ViewpointsManager",this.uiElement=new Q,this.enabled=!0,this.list=[],this.selectionHighlighter="",this.onViewpointViewed=new W,this.onViewpointAdded=new W,this.components=e}initialize(e){this.selectionHighlighter=e.selectionHighlighter,this._drawManager=e.drawManager,this.components.uiEnabled&&this.setUI()}setUI(){const e=this.components.renderer.get().domElement.parentElement,t=new de(this.components);t.title="Viewpoints",e.append(t.get()),t.visible=!1;const s=new ae(this.components,{materialIconName:"photo_camera"}),i=new ae(this.components,{materialIconName:"add",name:"New viewpoint"}),n=new ae(this.components,{materialIconName:"format_list_bulleted",name:"Viewpoints list"});n.onClick.add((()=>{t.visible=!t.visible})),s.addChild(n,i),this.uiElement.set({main:s,newButton:i,window:t})}get(){throw new Error("Method not implemented.")}add(e){const{title:t,description:s}=e;if(!t)return;const n=d().toLowerCase(),o=[],r=this.components.tools.get(ls).get();for(const e of r)o.push({start:e.startPoint,end:e.endPoint});const a=this.components.tools.get(gt).selection[this.selectionHighlighter],l=this.components.camera,h=l.controls,c=new i,u=new i;h.getTarget(c),h.getPosition(u);const p=l.getProjection(),m=this._drawManager?.saveDrawing(n),E={guid:n,title:t,target:c,position:u,selection:a,description:s,dimensions:o,annotations:m,projection:p},g=new ce(this.components,E.guid);return g.title=t,g.description=s,g.domElement.onclick=()=>this.view(E.guid),this.uiElement.get("window").addChild(g),this.list.push(E),this.onViewpointAdded.trigger(n),E}retrieve(e){return this.list.find((t=>t.guid===e))}async view(e){const t=this.retrieve(e);if(!t)return;this._drawManager&&t.annotations&&(this._drawManager.viewport.clear(),this._drawManager.enabled=!0,this._drawManager.viewport.get().append(t.annotations));const s=this.components.tools.get(ls);t.dimensions.forEach((e=>{const t=new is(this.components,{start:e.start,end:e.end,lineMaterial:s._lineMaterial,endpoint:s._endpointMesh});t.createBoundingBox(),s._dimensions.push(t)}));const i={};for(const e in t.selection)i[e]=t.selection[e];const n=this.components.tools.get(gt);await n.highlightByID(this.selectionHighlighter,i,!0);this.components.camera.controls.setLookAt(t.position.x,t.position.y,t.position.z,t.target.x,t.target.y,t.target.z,!0),await this.onViewpointViewed.trigger(e)}}class ms extends j{get visible(){return this._visible}set visible(e){this._visible=e,this._visible?this._cubeWrapper.classList.remove("hidden"):this._cubeWrapper.classList.add("hidden")}constructor(t){super(t),this.onDisposed=new W,this.enabled=!0,this.onAfterUpdate=new W,this.onBeforeUpdate=new W,this.offset=1,this._cubeFaceClass="flex justify-center font-bold hover:bg-ifcjs-200 hover:text-ifcjs-100 text-white select-none text-xl items-center cursor-pointer text-center text-ifcjs-100 absolute w-[60px] h-[60px] border-solid border-ifcjs-120",this._cyan="bg-[#3CE6FEDD]",this._pink="bg-[#BD4BF3DD]",this._blue="bg-[#201491DD]",this._cube=document.createElement("div"),this._cubeWrapper=document.createElement("div"),this._matrix=new e.Matrix4,this._faceOrientations={front:new e.Vector3(0,0,1),top:new e.Vector3(0,1,0),bottom:new e.Vector3(0,-1,0),right:new e.Vector3(1,0,0),left:new e.Vector3(-1,0,0),back:new e.Vector3(0,0,-1)},this.update=()=>{this._matrix.extractRotation(this._camera.get().matrixWorldInverse),this._cube.style.transform=`translateZ(-300px) ${this.getCameraCSSMatrix(this._matrix)}`},this.components.tools.add(ms.uuid,this),this._cubeWrapper.id="tooeen-cube-map",this._cubeWrapper.className="absolute z-10",this.setPosition("bottom-right"),this._cube.className="w-[60px] h-[60px] relative",this.setSize("400"),this._cube.style.transformStyle="preserve-3d",this._cube.style.transform="translateZ(-300px)",this._cube.style.textTransform="uppercase",this._cubeWrapper.append(this._cube),t.camera.isUpdateable()&&t.camera.onAfterUpdate.add(this.update);const s=document.createElement("div");s.id="cube-map-front",s.className=`${this._cubeFaceClass} ${this._cyan}`,s.style.transform="rotateX(180deg) translateZ(-30px)",s.style.transition="all 0.2s",s.onclick=()=>this.orientToFace("front");const i=document.createElement("div");i.className=`${this._cubeFaceClass} ${this._pink}`,i.style.transform="rotateX(90deg) translateZ(-30px)",i.style.transition="all 0.2s",i.onclick=()=>this.orientToFace("top");const n=document.createElement("div");n.className=`${this._cubeFaceClass} ${this._pink}`,n.style.transform="rotateX(270deg) translateZ(-30px)",n.style.transition="all 0.2s",n.onclick=()=>this.orientToFace("bottom");const o=document.createElement("div");o.className=`${this._cubeFaceClass} ${this._blue}`,o.style.transform="rotateY(-270deg) rotateX(180deg) translateZ(-30px)",o.style.transition="all 0.2s",o.onclick=()=>this.orientToFace("right");const r=document.createElement("div");r.className=`${this._cubeFaceClass} ${this._blue}`,r.style.transform="rotateY(-90deg) rotateX(180deg) translateZ(-30px)",r.style.transition="all 0.2s",r.onclick=()=>this.orientToFace("left");const a=document.createElement("div");a.className=`${this._cubeFaceClass} ${this._cyan}`,a.style.transform="translateZ(-30px) rotateZ(180deg)",a.style.transition="all 0.2s",a.onclick=()=>this.orientToFace("back"),this._cube.append(s,i,n,o,r,a),this._viewerContainer?.append(this._cubeWrapper),this.visible=!0}async dispose(){this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this._cube.remove(),this._cubeWrapper.remove(),this.components=null,await this.onDisposed.trigger(ms.uuid),this.onDisposed.reset()}setSize(e="350"){this._cubeWrapper.style.perspective=`${e}px`}setPosition(e){this._cubeWrapper.classList.remove("top-8","bottom-8","left-8","right-8");this._cubeWrapper.classList.add(...{"top-left":["top-8","left-8"],"top-right":["top-8","right-8"],"bottom-right":["bottom-8","right-8"],"bottom-left":["bottom-8","left-8"]}[e])}orientToFace(t){const s=this._camera.get();if(this._camera instanceof et){const i=this._camera.controls,n=this._camera.getProjection(),o=s.position.clone().add(this._faceOrientations[t].clone().multiplyScalar(-1)),{x:r,y:a,z:l}=s.position;if("Perspective"===n)i.setLookAt(r,a,l,o.x,o.y,o.z,!0);else{const s=new e.Vector3;"top"===t&&s.set(0,200,0),"bottom"===t&&s.set(0,-200,0),"left"===t&&s.set(-200,0,0),"right"===t&&s.set(200,0,0),"front"===t&&s.set(0,0,200),"back"===t&&s.set(0,0,-200),i.setPosition(s.x,s.y,s.z,!0),i.setTarget(0,0,0,!0)}this._camera.fit(void 0,this.offset)}}get _viewerContainer(){return this.components.renderer.get().domElement.parentElement}get _camera(){return this.components.camera}getCameraCSSMatrix(e){const{elements:t}=e,s=e=>Math.abs(e)<1e-10?0:e;return`matrix3d(\n            ${s(t[0])},\n            ${s(-t[1])},\n            ${s(t[2])},\n            ${s(t[3])},\n            ${s(t[4])},\n            ${s(-t[5])},\n            ${s(t[6])},\n            ${s(t[7])},\n            ${s(t[8])},\n            ${s(-t[9])},\n            ${s(t[10])},\n            ${s(t[11])},\n            ${s(t[12])},\n            ${s(-t[13])},\n            ${s(t[14])},\n            ${s(t[15])})\n        `}get(){return this._cubeWrapper}}ms.uuid="53311ea3-323a-476f-ae4a-d681778e8f67",Z.libraryUUIDs.add(ms.uuid);class Es extends j{get lockRotation(){return this._lockRotation}set lockRotation(e){this._lockRotation=e,e&&(this._camera.rotation.z=0)}get zoom(){return this._camera.zoom}set zoom(e){this._camera.zoom=e,this._camera.updateProjectionMatrix()}get enabled(){return this._enabled}set enabled(e){this._enabled=e;this.uiElement.get("canvas").visible=e}constructor(t){super(t),this.onDisposed=new W,this.uiElement=new Q,this.onAfterUpdate=new W,this.onBeforeUpdate=new W,this.onResize=new W,this.frontOffset=0,this.overrideMaterial=new e.MeshDepthMaterial,this.backgroundColor=new e.Color(395274),this._enabled=!0,this._lockRotation=!0,this._size=new e.Vector2(320,160),this._tempVector1=new e.Vector3,this._tempVector2=new e.Vector3,this._tempTarget=new e.Vector3,this.down=new e.Vector3(0,-1,0),this.updatePlanes=()=>{const e=[],t=this._components.renderer.get();for(const s of t.clippingPlanes)e.push(s);e.push(this._plane),this._renderer.clippingPlanes=e},this.components.tools.add(Es.uuid,this);const s=new ae(t),i=new Ie(t);this.uiElement.set({main:s,canvas:i}),s.materialIcon="map",s.onClick.add((()=>{i.visible=!i.visible}));const n=new ge(t);i.addChild(n),this._components=t;const o=i.get();this._renderer=new e.WebGLRenderer({canvas:o}),this._renderer.setSize(this._size.x,this._size.y);const r=this._size.x/this._size.y;this._camera=new e.OrthographicCamera(1*r/-2,1*r/2,.5,-.5),this._components.renderer.onClippingPlanesUpdated.add(this.updatePlanes),this._camera.position.set(0,200,0),this._camera.zoom=.1,this._camera.rotation.x=-Math.PI/2,this._plane=new e.Plane(this.down,200),this.updatePlanes()}async dispose(){this.enabled=!1,this.uiElement.dispose(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.onResize.reset(),this.overrideMaterial.dispose(),this._renderer.dispose(),await this.onDisposed.trigger(Es.uuid),this.onDisposed.reset()}get(){return this._camera}async update(){if(!this.enabled)return;await this.onBeforeUpdate.trigger();const e=this._components.scene.get(),t=this._components.camera.controls;if(t.getPosition(this._tempVector1),this._camera.position.x=this._tempVector1.x,this._camera.position.z=this._tempVector1.z,0!==this.frontOffset&&(t.getTarget(this._tempVector2),this._tempVector2.sub(this._tempVector1),this._tempVector2.normalize().multiplyScalar(this.frontOffset),this._camera.position.x+=this._tempVector2.x,this._camera.position.z+=this._tempVector2.z),!this._lockRotation){t.getTarget(this._tempTarget);const e=Math.atan2(this._tempTarget.x-this._tempVector1.x,this._tempTarget.z-this._tempVector1.z);this._camera.rotation.z=e+Math.PI}this._plane.set(this.down,this._tempVector1.y);const s=e.background;e.background=this.backgroundColor,this._renderer.render(e,this._camera),e.background=s,await this.onAfterUpdate.trigger()}getSize(){return this.uiElement.get("canvas").getSize()}async resize(e){const t=this.uiElement.get("canvas");if(e){this._size.copy(e),t.resize(e),this._renderer.setSize(e.x,e.y);const s=e.x/e.y,i=1;this._camera.left=i*s/-2,this._camera.right=i*s/2,this._camera.top=i/2,this._camera.bottom=-i/2,this._camera.updateProjectionMatrix(),await this.onResize.trigger(e)}}}Es.uuid="39ad6aad-84c8-4adf-a1e0-7f25313a9e7f",Z.libraryUUIDs.add(Es.uuid);class gs extends j{constructor(e,s,i){super(e),this.name="SVGRectangle",this.enabled=!0,this.id=d(),this.onDisposed=new W,this._line=document.createElementNS("http://www.w3.org/2000/svg","line"),this._polygon=document.createElementNS("http://www.w3.org/2000/svg","polygon"),this._marker=document.createElementNS("http://www.w3.org/2000/svg","marker"),this._arrow=document.createElementNS("http://www.w3.org/2000/svg","g"),this._startPoint=new t,this._endPoint=new t,this._marker.setAttribute("id",`${this.id}-arrowhead`),this._marker.setAttribute("markerWidth","5"),this._marker.setAttribute("markerHeight","6"),this._marker.setAttribute("refX","4"),this._marker.setAttribute("refY","3"),this._marker.setAttribute("orient","auto"),this._polygon.setAttribute("points","0 0, 5 3, 0 6"),this._marker.appendChild(this._polygon),this._line.setAttribute("marker-end",`url(#${this.id}-arrowhead)`),this._arrow.append(this._marker,this._line),this.startPoint=s??this.startPoint,this.endPoint=i??this.endPoint,this._arrow.id=this.id,this.setStyle()}async dispose(){this._arrow.remove(),this._marker.remove(),this._polygon.remove(),this._line.remove(),this.components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}setStyle(e){this._line.setAttribute("stroke",e?.strokeColor??"red"),this._line.setAttribute("stroke-width",e?.strokeWidth?.toString()??"4"),this._polygon.setAttribute("fill",e?.strokeColor??"red")}reset(){this.x1=0,this.y1=0,this.x2=0,this.y2=0}clone(){return new gs(this.components,this.startPoint,this.endPoint)}set x1(e){this._startPoint.x=e,this._line.setAttribute("x1",e.toString())}set y1(e){this._startPoint.y=e,this._line.setAttribute("y1",e.toString())}set startPoint(e){this.x1=e.x,this.y1=e.y}get startPoint(){return this._startPoint}set x2(e){this._endPoint.x=e,this._line.setAttribute("x2",e.toString())}set y2(e){this._endPoint.y=e,this._line.setAttribute("y2",e.toString())}set endPoint(e){this.x2=e.x,this.y2=e.y}get endPoint(){return this._endPoint}get(){return this._arrow}}class Is extends j{get isDrawing(){return this._isDrawing}set isDrawing(e){this._isDrawing=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.components.uiEnabled&&(this.uiElement.get("main").active=e,this.uiElement.get("drawingTools").visible=e),this.viewport.enabled=e}constructor(e){super(e),this.name="DrawManager",this.onDisposed=new W,this.uiElement=new Q,this.drawingTools={},this.drawings={},this._enabled=!1,this._isDrawing=!1,e.tools.add(Is.uuid,this),this.viewport=new $e(e),e.uiEnabled&&this.setUI(),this.enabled=!1}async dispose(){this.uiElement.dispose(),await this.viewport.dispose();for(const e in this.drawings)this.drawings[e].remove();this.drawings={},this.components=null,await this.onDisposed.trigger(Is.uuid),this.onDisposed.reset()}saveDrawing(e){const t=this.drawings[e];t?.childNodes.forEach((e=>t.removeChild(e)));const s=this.viewport.getDrawing(),i=t??document.createElementNS("http://www.w3.org/2000/svg","g");return i.id=e,i.append(...s),this.viewport.get().append(i),this.drawings[e]=i,i}addDrawingTool(e,t){if(!this.drawingTools[e]){if(this.components.uiEnabled){const e=t.uiElement.get("main");this.uiElement.get("drawingTools").addChild(e)}t.svgViewport=this.viewport.get(),this.drawingTools[e]=t}}activateTool(e){const t=Object.values(this.drawingTools);if(t.find((t=>t===e))){for(const e of t)e.enabled=!1;e.enabled=!0}else console.warn("DrawManager: Tried to activate a drawing tool that is not registered yet.")}get activeTool(){return Object.values(this.drawingTools).find((e=>!0===e.enabled))}setUI(){const e=this.viewport.uiElement.get("toolbar"),t=new re(this.components,{position:"top"});setTimeout((()=>{t.visible=!1,e.visible=!1}),.001),this.components.ui.addToolbar(t),this.components.ui.addToolbar(e);const s=new ae(this.components);s.materialIcon="gesture",s.onClick.add((()=>this.enabled=!this.enabled)),this.uiElement.set({drawingTools:t,main:s})}get(){return null}}Is.uuid="4ab8b0f4-665d-4ea2-8f6e-66c98ed04392";class Cs extends K{constructor(e){super(e),this.name="ArrowAnnotation",this.canvas=null,this.uiElement=new Q,this.cancel=()=>{this._isDrawing&&(this._isDrawing=!1,this._previewElement.reset(),this._previewElement.get().remove())},this.start=e=>{if(!this.canDraw)return null;const t=this.components.tools.get(Is);if(this._isDrawing){const e=this._previewElement.clone();return e.setStyle(t.viewport.config),this.svgViewport?.append(e.get()),this.cancel(),e}return this._isDrawing=!0,this._previewElement.setStyle(t.viewport.config),this._previewElement.x1=e.clientX,this._previewElement.y1=e.clientY,this._previewElement.x2=e.clientX,this._previewElement.y2=e.clientY,this.svgViewport?.append(this._previewElement.get()),null},this.draw=e=>{this.canDraw&&this._isDrawing&&(this._previewElement.x1=e.clientX,this._previewElement.y1=e.clientY)},this._previewElement=new gs(e);const t=this.components.tools.get(Is);e.uiEnabled&&this.setUI(),t.addDrawingTool(this.name,this)}setUI(){const e=this.components.tools.get(Is),t=new ae(this.components);t.label="Arrow",t.materialIcon="north_east",t.onClick.add((()=>{e.activateTool(this)})),this.uiElement.set({main:t})}async dispose(){await super.dispose(),this._previewElement.dispose()}}class fs extends j{constructor(e,s,i){super(e),this.id=d(),this.name="SVGRectangle",this.enabled=!0,this.onDisposed=new W,this._circle=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._centerPoint=new t,this._radius=20,this.centerPoint=s??this.centerPoint,this.radius=i??this.radius,this._circle.id=this.id,this.setStyle()}async dispose(){this._circle.remove(),this.components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}setStyle(e){this._circle.setAttribute("stroke",e?.strokeColor??"red"),this._circle.setAttribute("stroke-width",e?.strokeWidth?.toString()??"4"),this._circle.setAttribute("fill",e?.fillColor??"transparent")}reset(){this.cx=0,this.cy=0,this.radius=0}clone(){return new fs(this.components,this.centerPoint,this.radius)}set radius(e){this._radius=e,this._circle.setAttribute("r",e.toString())}get radius(){return this._radius}set cx(e){this._centerPoint.x=e,this._circle.setAttribute("cx",e.toString())}set cy(e){this._centerPoint.y=e,this._circle.setAttribute("cy",e.toString())}set centerPoint(e){this.cx=e.x,this.cy=e.y}get centerPoint(){return this._centerPoint}get(){return this._circle}}class ws extends K{constructor(e){super(e),this.name="CircleAnnotation",this.canvas=null,this.uiElement=new Q,this._cursorPosition=new t,this.start=e=>{if(!this.canDraw)return null;const t=this.components.tools.get(Is);if(this._isDrawing){const e=this._previewElement.clone();return e.setStyle(t.viewport.config),this.svgViewport?.append(e.get()),this.cancel(),e}return this._isDrawing=!0,this._previewElement.setStyle(t.viewport.config),this._previewElement.cx=e.clientX,this._previewElement.cy=e.clientY,this.svgViewport?.append(this._previewElement.get()),null},this.cancel=()=>{this._isDrawing&&(this._isDrawing=!1,this._previewElement.reset(),this._previewElement.get().remove())},this.draw=e=>{this.canDraw&&this._isDrawing&&(this._cursorPosition.x=e.clientX,this._cursorPosition.y=e.clientY,this._previewElement.radius=this._cursorPosition.distanceTo(this._previewElement.centerPoint))},this._previewElement=new fs(e);const s=this.components.tools.get(Is);e.uiEnabled&&this.setUI(),s.addDrawingTool("circle_annotation",this)}setUI(){const e=this.components.tools.get(Is),t=new ae(this.components);t.label="Circle",t.materialIcon="radio_button_unchecked",t.onClick.add((()=>{e.activateTool(this)})),this.uiElement.set({main:t})}async dispose(){await super.dispose(),this._previewElement.dispose()}}class Ts extends j{constructor(e,s,i){super(e),this.id=d(),this.name="SVGRectangle",this.enabled=!0,this.onDisposed=new W,this._startPoint=new t,this._text=document.createElementNS("http://www.w3.org/2000/svg","text"),this._text.setAttribute("fill","red"),this._text.classList.add("text-2xl","font-medium"),this.text=s??"",this.startPoint=i??this.startPoint,this._text.id=this.id}async dispose(){this._text.remove(),await this.onDisposed.trigger(),this.onDisposed.reset()}setStyle(e){this._text.setAttribute("fill",e?.strokeColor??"red")}set text(e){this._text.textContent=e}get text(){return this._text.textContent??""}reset(){this.x=0,this.y=0}clone(){return new Ts(this.components,this.text,this.startPoint)}set x(e){this._startPoint.x=e,this._text.setAttribute("x",e.toString())}set y(e){this._startPoint.y=e,this._text.setAttribute("y",e.toString())}set startPoint(e){this.x=e.x,this.y=e.y}get startPoint(){return this._startPoint}get(){return this._text}}class bs extends K{constructor(e){super(e),this.name="TextAnnotation",this.uiElement=new Q,this.canvas=null,this.cancel=()=>{this._isDrawing&&(this._isDrawing=!1,this._previewElement.reset(),this._previewElement.get().remove())},this.start=e=>{if(!this.canDraw)return null;const t=this.components.tools.get(Is);if(this._isDrawing){const e=this._previewElement.clone();return e.setStyle(t.viewport.config),this.svgViewport?.append(e.get()),this.cancel(),e}{this._isDrawing=!0;const s=prompt("Enter your text",this._previewElement.text);if(!s)return this.cancel(),null;this._previewElement.setStyle(t.viewport.config),this._previewElement.text=s,this._previewElement.x=e.clientX,this._previewElement.y=e.clientY,this.svgViewport?.append(this._previewElement.get())}return null},this.draw=e=>{this.canDraw&&this._isDrawing&&(this._previewElement.x=e.clientX,this._previewElement.y=e.clientY)},this._previewElement=new Ts(e);const t=this.components.tools.get(Is);e.uiEnabled&&this.setUI(),t.addDrawingTool(this.name,this)}setUI(){const e=this.components.tools.get(Is),t=new ae(this.components);t.label="Text",t.materialIcon="title",t.onClick.add((()=>{e.activateTool(this)})),this.uiElement.set({main:t})}async dispose(){await super.dispose(),await this._previewElement.dispose()}}class vs extends j{constructor(e,s,i){super(e),this.id=d(),this.name="SVGRectangle",this.enabled=!0,this.onDisposed=new W,this._startPoint=new t,this._endPoint=new t,this._dimensions=new t,this._rect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.startPoint=s??this.startPoint,this.endPoint=i??this.endPoint,this._rect.setAttribute("rx","5"),this._rect.id=this.id,this.setStyle()}async dispose(){this._rect.remove(),this.components=null,await this.onDisposed.trigger(),this.onDisposed.reset()}setStyle(e){this._rect.setAttribute("stroke",e?.strokeColor??"red"),this._rect.setAttribute("stroke-width",e?.strokeWidth?.toString()??"4"),this._rect.setAttribute("fill",e?.fillColor??"transparent")}reset(){this.x1=0,this.y1=0,this.x2=0,this.y2=0}clone(){return new vs(this.components,this.startPoint,this.endPoint)}set x1(e){this._startPoint.x=e,this._rect.setAttribute("x",e.toString())}set y1(e){this._startPoint.y=e,this._rect.setAttribute("y",e.toString())}set startPoint(e){this.x1=e.x,this.y1=e.y}get startPoint(){return this._startPoint}set x2(e){const t=e<this.startPoint.x;this._endPoint.x=t?this.startPoint.x:e,this.x1=t?e:this.startPoint.x,this._dimensions.x=this.endPoint.x-this.startPoint.x,this._rect.setAttribute("width",this._dimensions.x.toString())}set y2(e){const t=e<this.startPoint.y;this._endPoint.y=t?this.startPoint.y:e,this.y1=t?e:this.startPoint.y,this._dimensions.y=this.endPoint.y-this.startPoint.y,this._rect.setAttribute("height",this._dimensions.y.toString())}set endPoint(e){this.x2=e.x,this.y2=e.y}get endPoint(){return this._endPoint}set width(e){this.x2=this.startPoint.x+e}get width(){return this._dimensions.x}set height(e){this.y2=this.startPoint.y+e}get height(){return this._dimensions.y}set dimensions(e){this.width=e.x,this.height=e.y}get dimensions(){return this._dimensions}get(){return this._rect}}class _s extends K{constructor(e){super(e),this.name="RectangleAnnotation",this.canvas=null,this.uiElement=new Q,this._startPoint=new t,this.start=e=>{if(!this.canDraw)return null;const t=this.components.tools.get(Is);if(this._isDrawing){const e=this._previewElement.clone();return e.setStyle(t.viewport.config),this.svgViewport?.append(e.get()),this.cancel(),e}return this._isDrawing=!0,this._previewElement.setStyle(t.viewport.config),this._startPoint.set(e.clientX,e.clientY),this.svgViewport?.append(this._previewElement.get()),null},this.cancel=()=>{this._isDrawing&&(this._isDrawing=!1,this._startPoint.x=0,this._startPoint.y=0,this._previewElement.reset(),this._previewElement.get().remove())},this.draw=e=>{this.canDraw&&this._isDrawing&&(this._previewElement.x1=this._startPoint.x,this._previewElement.y1=this._startPoint.y,this._previewElement.x2=e.clientX,this._previewElement.y2=e.clientY)},this._previewElement=new vs(e);const s=this.components.tools.get(Is);e.uiEnabled&&this.setUI(),s.addDrawingTool(this.name,this)}setUI(){const e=this.components.tools.get(Is),t=new ae(this.components);t.label="Rectangle",t.materialIcon="crop_square",t.onClick.add((()=>{e.activateTool(this)})),this.uiElement.set({main:t})}async dispose(){await super.dispose(),this._previewElement.dispose()}}const ys=new i(0,1,0),As=1e-16,Fs=function(){const e=new i,t=new i,s=new i,n=new o;return function(i,o,l=1){const h=[],c=Math.pow(10,4),d=Math.cos(r.DEG2RAD*l),u=i.getIndex(),p=i.getAttribute("position"),m=u?u.count:p.count,E=[0,0,0],g=["a","b","c"],I=new Array(3),C={};for(let e=0;e<m;e+=3){u?(E[0]=u.getX(e),E[1]=u.getX(e+1),E[2]=u.getX(e+2)):(E[0]=e,E[1]=e+1,E[2]=e+2);const{a:t,b:i,c:r}=n;if(t.fromBufferAttribute(p,E[0]),i.fromBufferAttribute(p,E[1]),r.fromBufferAttribute(p,E[2]),n.getNormal(s),I[0]=`${Math.round(t.x*c)},${Math.round(t.y*c)},${Math.round(t.z*c)}`,I[1]=`${Math.round(i.x*c)},${Math.round(i.y*c)},${Math.round(i.z*c)}`,I[2]=`${Math.round(r.x*c)},${Math.round(r.y*c)},${Math.round(r.z*c)}`,I[0]!==I[1]&&I[1]!==I[2]&&I[2]!==I[0])for(let e=0;e<3;e++){const t=(e+1)%3,i=I[e],r=I[t],l=n[g[e]],c=n[g[t]],u=`${i}_${r}`,p=`${r}_${i}`;if(p in C&&C[p]){const e=C[p].normal,t=s.dot(e)<=d,i=Math.sign(o.dot(s))!==Math.sign(o.dot(e));if(t||i){const e=new a;e.start.copy(l),e.end.copy(c),h.push(e)}C[p]=null}else u in C||(C[u]={index0:E[e],index1:E[t],normal:s.clone()})}}for(const s in C)if(C[s]){const{index0:i,index1:n}=C[s];e.fromBufferAttribute(p,i),t.fromBufferAttribute(p,n);const o=new a;o.start.copy(e),o.end.copy(t),h.push(o)}return h}}(),Rs=function(){const e=new i,t=new i,s=new i,n=new l,o=new a,r=new a,h=new a;return function(i,l,c=new a){if(l.needsUpdate&&l.needsUpdate(),l.getArea()<=As)return null;const{points:d,plane:u}=l;o.copy(i),o.delta(e);if(!(0===u.normal.dot(e)))return null;e.cross(u.normal).normalize(),n.setFromNormalAndCoplanarPoint(e,o.start);let p=0;for(let e=0;e<3;e++){const t=d[e],s=d[(e+1)%3];if(h.start.copy(t),h.end.copy(s),0===n.distanceToPoint(h.end)&&0===n.distanceToPoint(h.start)){r.copy(h),p=2;break}if(n.intersectLine(h,0===p?r.start:r.end)){let e;if(e=0===p?r.start:r.end,0===e.distanceTo(s))continue;if(p++,2===p)break}}if(2===p){if(o.delta(e).normalize(),r.delta(t).normalize(),e.dot(t)<0){const e=r.start;r.start=r.end,r.end=e}const i=o.start.dot(e),n=o.end.dot(e),a=r.start.dot(e),l=r.end.dot(e);return i!==l&&a!==n&&n<a===i<l?null:(s.subVectors(o.start,r.start),s.dot(e)>0?c.start.copy(o.start):c.start.copy(r.start),s.subVectors(o.end,r.end),s.dot(e)<0?c.end.copy(o.end):c.end.copy(r.end),c)}return null}}(),Ss=function(){const e=new a;return function(t,s,i=null){e.start.copy(s),e.end.copy(s),e.start.y+=1e5,e.end.y-=1e5,t.intersectLine(e,i)}}(),Ms=function(){const e=new i,t=new i;return function(s,i){return e.lerpVectors(i.start,i.end,.5),Ss(s,e,t),t.y<e.y}}(),Ps=function(){const e=new i,t=new i(0,1,0);return function(s){return s.delta(e).normalize(),Math.abs(e.dot(t))>=1-As}}();function Ls(e){return e.needsUpdate&&e.update(),Math.abs(e.plane.normal.dot(ys))<=As}function Ns(e,t){const s=e.points;let i=0;for(let e=0;e<3;e++){const{start:n,end:o}=t,r=s[e];n.distanceToSquared(r)<=As&&i++,o.distanceToSquared(r)<=As&&i++}return i>=2}const Os=function(){const e=new a,t=new i,s=new i,n=new i,o=new a,r=new f;return function(i,a,l){if(o.copy(a),r.copy(i),o.start.y=0,o.end.y=0,r.a.y=0,r.b.y=0,r.c.y=0,r.needsUpdate=!0,r.update(),Rs(o,r,e)){o.delta(t),s.subVectors(e.start,o.start),n.subVectors(e.end,o.start);let i=s.length()/t.length(),r=n.length()/t.length();return i=Math.min(Math.max(i,0),1),r=Math.min(Math.max(r,0),1),Math.abs(i-r)<=As||l.push(new Float32Array([i,r])),!0}return!1}}(),xs=function(){const e=new i,t=new i,s=new i,n=new i;return function(i,o,r){i.needsUpdate&&i.update(),r.copy(o);const{plane:a}=i;if(Ls(i))return!1;o.delta(e);if(0===a.normal.dot(e))return!1;if(a.intersectLine(o,t)){const{start:e,end:o}=r;let a,l=!1;return e.distanceTo(t)>o.distanceTo(t)?a=e:(a=o,l=!0),s.lerpVectors(a,t,.5),Ss(i.plane,s,n),n.y<s.y?l?o.copy(t):e.copy(t):l?e.copy(t):o.copy(t),!0}return!1}}(),Ds=function(){const e=new a;return function(t,s,i=[]){Us(s);const n=[[0,1]];for(let e=0,t=s.length;e<t;e++){const t=n[e],i=s[e];t[1]=i[0],n.push(new Float32Array([i[1],1]))}for(let s=0,o=n.length;s<o;s++){const{start:o,end:r}=t;e.start.lerpVectors(o,r,n[s][0]),e.end.lerpVectors(o,r,n[s][1]),i.push(new Float32Array([e.start.x,e.start.y,e.start.z,e.end.x,e.end.y,e.end.z]))}return i}}();function Us(e){e.sort(((e,t)=>e[0]-t[0]));for(let t=1;t<e.length;t++){const s=e[t],i=e[t-1];s[0]<=i[1]&&(i[1]=Math.max(i[1],s[1]),e.splice(t,1),t--)}}class Bs{constructor(){this.params={displayModel:"color",displayEdges:!1,displayProjection:!0,useBVH:!0,sortEdges:!0,amount:50,color:6710886},this._defaultMaterial=new e.LineBasicMaterial({color:this.params.color}),this.projectedEdges=[]}dispose(){this.disposeGeometry(),this._defaultMaterial.dispose()}disposeGeometry(){this.projectedEdges.forEach((e=>{e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach((e=>e.dispose())):e.material.dispose()})),this.projectedEdges=[]}async project(t,s){const i=new e.LineSegments(new e.BufferGeometry,this._defaultMaterial),n=new e.Matrix4,o=new e.Vector3,r=new e.Vector3,a=new e.Vector3,l=[],h=[];let c=0;for(const e of t){e.updateWorldMatrix(!1,!1);const t=e.matrixWorld.clone(),i=e.geometry.attributes.position.array,d=e.geometry.index.array;for(let u=0;u<e.count;u++){const p=new Map;e.getMatrixAt(u,n),n.multiply(t);for(let e=0;e<d.length;e+=3){const t=3*d[e],u=3*d[e+1],m=3*d[e+2];if(o.set(i[t],i[t+1],i[t+2]),r.set(i[u],i[u+1],i[u+2]),a.set(i[m],i[m+1],i[m+2]),o.applyMatrix4(n),r.applyMatrix4(n),a.applyMatrix4(n),o.y>s&&r.y>s&&a.y>s)continue;p.has(t)||(p.set(t,c++),l.push(o.x,o.y,o.z)),p.has(u)||(p.set(u,c++),l.push(r.x,r.y,r.z)),p.has(m)||(p.set(m,c++),l.push(a.x,a.y,a.z));const E=p.get(t),g=p.get(u),I=p.get(m);void 0!==E&&void 0!==g&&void 0!==I&&h.push(E,g,I)}}}const d=new Float32Array(l),u=new e.BufferGeometry;u.setIndex(h);const p=new e.BufferAttribute(d,3);u.setAttribute("position",p);let m=this.updateEdges(this.params,u,i);for(;m;){m.next().done&&(m=null)}return this.projectedEdges.push(i),u.dispose(),i}*updateEdges(t,s,i){yield;const n=new w(s);yield;const o=Fs(s,new e.Vector3(0,1,0),50);t.sortEdges&&o.sort(((e,t)=>Math.min(e.start.y,e.end.y)-Math.min(t.start.y,t.end.y))),yield;const r=[],a=new e.Line3,l=new e.Ray,d=new e.Vector3;for(let e=0,s=o.length;e<s;e++){const s=o[e];if(Ps(s))continue;const i=Math.min(s.start.y,s.end.y),h=[];n.shapecast({intersectsBounds:e=>!t.useBVH||(e.min.y=Math.min(i,e.min.y),l.origin.copy(s.start),s.delta(l.direction).normalize(),!!e.containsPoint(l.origin)||!!l.intersectBox(e,d)&&l.origin.distanceToSquared(d)<s.distanceSq()),intersectsTriangle:e=>{if(Math.max(e.a.y,e.b.y,e.c.y)<i)return!1;if(Ls(e))return!1;if(Ns(e,s))return!1;if(xs(e,s,a),Ms(e.plane,a))return!1;if(a.distance()<1e-10)return!1;if(Os(e,s,h)&&Us(h),0!==h.length){const[e,t]=h[h.length-1];return 0===e&&1===t}return!1}}),Ds(s,h,r)}i.geometry.dispose(),i.geometry=function(e,t=null){const s=new Float32Array(6*e.length);let i=0;for(let n=0,o=e.length;n<o;n++){const o=e[n];s[i++]=o[0],s[i++]=null===t?o[1]:t,s[i++]=o[2],s[i++]=o[3],s[i++]=null===t?o[4]:t,s[i++]=o[5]}const n=new h,o=new c(s,3,!0);return n.setAttribute("position",o),n}(r,0)}}class ks extends j{constructor(e){super(e),this.enabled=!0,this.precission=.001,this._projector=new Bs,this.components.tools.add(ks.uuid,this)}get(){return this._projector}dispose(){this._projector.dispose()}async export(e){const t=new H;t.setUnits("Meters");const s=this.components.tools.get(Ht),i=this.components.tools.get(rt),n=s.get().find((t=>t.name===e));if(!n||!n.plane)throw new Error("Plan doesn't exist!");const o=Object.values(i.list).map((e=>e.mesh));let r=n.point.y;n.offset&&(r+=n.offset),t.addLayer("projection",H.ACI.BLUE,"CONTINUOUS"),t.setActiveLayer("projection");const a=await this._projector.project(o,r);this.drawGeometry(a.geometry,t),a.geometry.dispose(),a.material.dispose();const l=n.plane.edges.get();for(const e in l){const s=l[e].mesh,i=s.material,{r:n,g:o,b:r}=i.color;let a;a=n>o&&n>r?H.ACI.RED:o>n&&o>r?H.ACI.GREEN:r>n&&r>o?H.ACI.BLUE:H.ACI.WHITE,t.addLayer(e,a,"CONTINUOUS"),t.setActiveLayer(e),this.drawGeometry(s.geometry,t)}return t.toDxfString()}drawGeometry(e,t){const s=e.attributes.position.array,i=Math.min(3*e.drawRange.count,s.length);for(let e=0;e<i;e+=6){const i=s[e],n=s[e+2],o=s[e+3],r=s[e+5];Math.abs(o-i)+Math.abs(r-n)>this.precission&&t.drawLine(i,n,o,r)}}}ks.uuid="568f2167-24a3-4519-b552-3b04cc74a6a6",Z.libraryUUIDs.add(ks.uuid);class Vs extends j{constructor(e){super(e),this.enabled=!0,this.onHighlight=new W,this.onMarkerChange=new W,this.onMarkerHidden=new W,this._curveMeshes=[],this._previousAlignment=null,this.scene=new ot(this.components,!1),this.mouseMarkers={select:this.newMouseMarker("#ffffff"),hover:this.newMouseMarker("#575757")},this.setupEvents(),this.adjustRaycasterOnZoom()}initialize(){console.log("View for CivilNavigator: ",this.view)}get(){return null}async draw(t,s){if(!t.civilData)throw new Error("The provided model doesn't have civil data!");const{alignments:i}=t.civilData,n=s||i.values(),o=this.scene.get(),r=new e.Box3;r.makeEmpty(),r.min.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.max.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(const t of n){if(!t)throw new Error("Alignment not found!");for(const s of t[this.view])if(o.add(s.mesh),this._curveMeshes.push(s.mesh),r.isEmpty()){s.mesh.geometry.computeBoundingBox();const t=s.mesh.geometry.boundingBox;t instanceof e.Box3&&r.copy(t).applyMatrix4(s.mesh.matrixWorld)}else r.expandByObject(s.mesh)}const a=new e.Box3,l=new e.Vector3,h=new e.Vector3;r.getCenter(h),r.getSize(l),l.multiplyScalar(1.2),a.setFromCenterAndSize(h,l),await this.scene.controls.fitToBox(a,!1)}setupEvents(){this.scene.uiElement.get("container").domElement.addEventListener("mousemove",(async e=>{const t=this.scene.uiElement.get("container").domElement,s=this.highlighter.castRay(e,this.scene.camera,t,this._curveMeshes);if(s){const{object:e}=s;return this.highlighter.hover(e),void await this.updateMarker(s,"hover")}this.mouseMarkers.hover.visible=!1,this.highlighter.unHover(),await this.onMarkerHidden.trigger({type:"hover"})})),this.scene.uiElement.get("container").domElement.addEventListener("click",(async e=>{const t=this.scene.uiElement.get("container").domElement,s=this.highlighter.castRay(e,this.scene.camera,t,this._curveMeshes);if(s){const e=s,t=e.object;this.highlighter.select(t),await this.updateMarker(e,"select"),await this.onHighlight.trigger({mesh:t,point:e.point}),this._previousAlignment!==t.curve.alignment&&(this.kpManager.clearKPStations(),this.kpManager.showKPStations(t),this._previousAlignment=t.curve.alignment)}}))}async dispose(){this.highlighter.dispose(),this.clear(),this.onHighlight.reset(),await this.scene.dispose(),this._curveMeshes=[]}clear(){this.highlighter.unSelect(),this.highlighter.unHover();for(const e of this._curveMeshes)e.removeFromParent();this._curveMeshes=[]}setMarker(e,t,s){if(!this._curveMeshes.length)return;const i=e.getCurveAt(t,this.view),n=e.getPointAt(t,this.view),{index:o}=i.curve.getSegmentAt(i.percentage);this.setMouseMarker(n,i.curve.mesh,o,s)}setDefSegments(t){const s=[],i=[];for(let e=0;e<t.length;e++){const s=t[e];let r,a,l,h;for(let e=0;e<Object.keys(s).length/3;e++)if(void 0!==s[3*e]&&void 0!==s[3*e+1]){r=s[3*e],a=s[3*e+1];break}for(let e=Object.keys(s).length/3-1;e>=0;e--)if(void 0!==s[3*e]&&void 0!==s[3*e+1]){l=s[3*e],h=s[3*e+1];break}const c=(100*(((o=[l,h])[1]-(n=[r,a])[1])/(o[0]-n[0]))).toFixed(2);i.push({slope:c})}var n,o;for(const i of t)for(let t=0;t<i.length-3;t+=3){const n=i[t],o=i[t+1],r=i[t+2],a=i[t+3],l=i[t+4],h=i[t+5];s.push({start:new e.Vector3(n,o,r),end:new e.Vector3(a,l,h)})}return{defSegments:s,slope:i}}hideMarker(e){this.mouseMarkers[e].visible=!1}adjustRaycasterOnZoom(){this.scene.controls.addEventListener("update",(()=>{const{zoom:e,left:t,right:s,top:i,bottom:n}=this.scene.camera,o=t-s,r=i-n,a=Math.max(o,r)/e,{caster:l}=this.highlighter;l.params.Line.threshold=a/40}))}newMouseMarker(e){const t=this.scene.get(),s=document.createElement("div"),i=document.createElement("div");s.appendChild(i),i.style.backgroundColor=e,i.style.width="3rem",i.style.height="3px";const n=new De(this.components,s,t);return n.visible=!1,n}setMouseMarker(e,t,s,i){if(void 0===s)return;this.mouseMarkers[i].visible=!0;const n=this.mouseMarkers[i].get();n.position.copy(e);const o=t,{startPoint:r,endPoint:a}=o.curve.getSegment(s),l=Math.atan2(a.y-r.y,a.x-r.x),h=n.element.children[0],c=90-l/Math.PI*180;h.style.transform=`rotate(${c}deg)`}async updateMarker(e,t){const{point:s,index:i,object:n}=e,o=n,r=o.curve,a=o.curve.alignment,l=a.getPercentageAt(s,this.view),h=s.clone();this.setMouseMarker(h,o,i,t),null!==l&&await this.onMarkerChange.trigger({alignment:a,percentage:l,type:t,curve:r})}}class Gs{constructor(t,s){this.onSelect=new W,this.caster=new e.Raycaster,this.scene=t,this.type=s,this.hoverCurve=this.newCurve(.003,4473924,!1),this.hoverPoints=this.newPoints(5,4473924),this.selectCurve=this.newCurve(.005,16777215,!0),this.selectPoints=this.newPoints(7,16777215)}dispose(){this.selectCurve&&this.scene.remove(this.selectCurve),this.selectCurve.material.dispose(),this.selectCurve.geometry.dispose(),this.selectCurve=null,this.hoverCurve.material.dispose(),this.hoverCurve.geometry.dispose(),this.hoverCurve=null,this.hoverPoints.material.dispose(),this.hoverPoints.geometry.dispose(),this.selectPoints.material.dispose(),this.selectPoints.geometry.dispose(),this.scene=null}castRay(t,s,i,n){const o=new e.Vector2,r=i.getBoundingClientRect();o.x=(t.clientX-r.left)/r.width*2-1,o.y=-(t.clientY-r.top)/r.height*2+1,this.caster.setFromCamera(o,s);const a=this.caster.intersectObjects(n);return a.length?a[0]:null}select(e){this.highlight(e,this.selectCurve,this.selectPoints,!0),this.onSelect.trigger(e)}unSelect(){this.selectCurve.removeFromParent(),this.selectPoints.removeFromParent()}hover(e){this.highlight(e,this.hoverCurve,this.hoverPoints,!1)}unHover(){this.hoverCurve.removeFromParent(),this.hoverPoints.removeFromParent()}highlight(t,s,i,n){const{alignment:o}=t.curve;this.scene.add(s),this.scene.add(i);const r=[],a=[],l=[];for(const t of o[this.type]){const s=t.mesh.geometry.attributes.position;for(const e of s.array)r.push(e);if(n){let e;if("absolute"===this.type){const{horizontal:s}=t.alignment;e=s[t.index].data.TYPE}else e=t.data.TYPE;const i=Gs.settings.colors[e]||[1,1,1];for(let e=0;e<s.count;e++)a.push(...i)}const[i,o,h]=s.array;l.push(new e.Vector3(i,o,h))}const h=r[r.length-3],c=r[r.length-2],d=r[r.length-1];l.push(new e.Vector3(h,c,d)),r.length/3>s.geometry.attributes.position.count&&(s.geometry.dispose(),s.geometry=new z),s.geometry.setPositions(r),n&&s.geometry.setColors(a),i.geometry.setFromPoints(l)}newCurve(e,t,s){const i=new z,n=new G({color:t,linewidth:e,vertexColors:s,worldUnits:!1,depthTest:!1}),o=new Y(i,n);return this.scene.add(o),o}newPoints(t,s){const i=new e.BufferGeometry,n=new e.BufferAttribute(new Float32Array,3);i.setAttribute("position",n);const o=new e.PointsMaterial({size:t,color:s,sizeAttenuation:!1,depthTest:!1}),r=new e.Points(i,o);return r.frustumCulled=!1,this.scene.add(r),r}}Gs.settings={colors:{LINE:[213/255,0,1],CIRCULARARC:[0,46,1],CLOTHOID:[0,1,0],PARABOLICARC:[0,1,72/255],CONSTANTGRADIENT:[213/255,0,1]}};class zs extends Gs{constructor(t,s){super(t,"horizontal"),this.kpManager=s,this.offset=10,this.markupLines=[],this.markupMaterial=new e.LineBasicMaterial({color:6842472})}showCurveInfo(e){switch(this.disposeMarkups(),this.currentCurveMesh=e,e.curve.data.TYPE){case"LINE":this.showLineInfo(e,this.offset);break;case"CIRCULARARC":this.showCircularArcInfo(e,this.offset);break;case"CLOTHOID":this.showClothoidInfo(e,this.offset);break;default:console.log("Unknown curve type:",e.curve.data.TYPE)}}updateOffset(e,t,s){const i=Math.max(e.height,e.width)/(150*t);i!==this.offset&&(this.offset=i,s&&this.currentCurveMesh&&this.showCurveInfo(this.currentCurveMesh))}dispose(){super.dispose();for(const e of this.markupLines)this.scene.remove(e),e.removeFromParent();this.disposeMarkups(),this.markupMaterial.dispose()}disposeMarkups(){for(const e of this.markupLines)e.geometry.dispose(),this.scene.remove(e);this.markupLines=[]}unSelect(){super.unSelect(),this.disposeMarkups()}calculateTangent(t,s){const i=3*s,n=Math.max(0,i-3),o=Math.min(t.length-3,i+3),r=(new e.Vector3).fromArray(t,n);return(new e.Vector3).fromArray(t,o).clone().sub(r).normalize()}calculateParallelCurve(t,s,i){const n=[];for(let o=0;o<s;o++){const s=this.calculateTangent(t,o).clone().applyAxisAngle(new e.Vector3(0,0,1),Math.PI/2);s.normalize();const r=s.clone().multiplyScalar(i),a=3*o,l=(new e.Vector3).fromArray(t,a).add(r);n.push(l)}return n}calculateDimensionLines(t,s){const i=[],n=t.geometry.attributes.position.array,o=s.geometry.attributes.position.array;if(n.length<6&&o.length<6)throw new Error("Line must have at least two vertices");const r=new e.Vector3(n[0],n[1],n[2]),a=new e.Vector3(o[0],o[1],o[2]),l=[],h=n.length-3,c=new e.Vector3(n[h],n[h+1],n[h+2]),d=o.length-3,u=new e.Vector3(o[d],o[d+1],o[d+2]);return i.push(r,a),l.push(c,u),{startDimensionPoints:i,endDimensionPoints:l}}offsetDimensionLine(t,s){const i=(new e.Vector3).copy(t[t.length-1]).sub(t[0]).normalize().clone().multiplyScalar(s);return t.map((e=>e.clone().add(i)))}showLineInfo(t,s){this.kpManager.clearMarkersByType("Length"),this.kpManager.clearMarkersByType("Radius");const i=t.geometry.attributes.position.array,n=this.calculateParallelCurve(i,i.length/3,s),o=(new e.BufferGeometry).setFromPoints(n),r=new e.Line(o,this.markupMaterial);this.kpManager.showLineLength(r,t.curve.getLength()),this.scene.add(r),this.markupLines.push(r);const{startDimensionPoints:a,endDimensionPoints:l}=this.calculateDimensionLines(t,r),h=this.offsetDimensionLine(a,.1*s),c=this.offsetDimensionLine(l,.1*s),d=(new e.BufferGeometry).setFromPoints(h),u=(new e.BufferGeometry).setFromPoints(c),p=new e.Line(d,this.markupMaterial);this.scene.add(p),this.markupLines.push(p);const m=new e.Line(u,this.markupMaterial);this.scene.add(m),this.markupLines.push(m)}showClothoidInfo(t,s){this.kpManager.clearMarkersByType("Length"),this.kpManager.clearMarkersByType("Radius");const i=t.geometry.attributes.position.array,n=this.calculateParallelCurve(i,i.length/3,s),o=(new e.BufferGeometry).setFromPoints(n);this.kpManager.showCurveLength(n,t.curve.getLength());const r=new e.Line(o,this.markupMaterial);this.scene.add(r),this.markupLines.push(r);const{startDimensionPoints:a,endDimensionPoints:l}=this.calculateDimensionLines(t,r),h=this.offsetDimensionLine(a,.1*s),c=this.offsetDimensionLine(l,.1*s),d=(new e.BufferGeometry).setFromPoints(h),u=(new e.BufferGeometry).setFromPoints(c),p=new e.Line(d,this.markupMaterial);this.scene.add(p),this.markupLines.push(p);const m=new e.Line(u,this.markupMaterial);this.scene.add(m),this.markupLines.push(m)}showCircularArcInfo(t,s){this.kpManager.clearMarkersByType("Length"),this.kpManager.clearMarkersByType("Radius");const i=t.curve.data.RADIUS,n=t.geometry.attributes.position.array,o=t.geometry.attributes.position.count,r=[],a=new e.Vector3(n[0],n[1],n[2]),l=3*(o-1),h=new e.Vector3(n[l],n[l+1],n[l+2]),c=o/2*3,d=new e.Vector3(n[c],n[c+1],n[c+2]),u=h.clone().sub(a).normalize(),p=new e.Vector3(-u.y,u.x,0);p.multiplyScalar(i);const m=d.clone().add(p);r.push(d),r.push(m);const E=(new e.BufferGeometry).setFromPoints(r),g=new e.Line(E,this.markupMaterial);this.kpManager.showCurveRadius(g,Math.abs(i)),this.scene.add(g),this.markupLines.push(g);const I=[];for(let i=0;i<o;i++){const o=this.calculateTangent(n,i),r=t.curve.data.RADIUS,a=new e.Vector3(o.y,-o.x,0);a.normalize(),r<0&&a.negate();const l=a.clone().multiplyScalar(s),h=3*i,c=new e.Vector3(n[h]+l.x,n[h+1]+l.y,n[h+2]+l.z);I.push(c)}const C=(new e.BufferGeometry).setFromPoints(I);this.kpManager.showCurveLength(I,t.curve.getLength());const f=new e.Line(C,this.markupMaterial);this.scene.add(f),this.markupLines.push(f);const{startDimensionPoints:w,endDimensionPoints:T}=this.calculateDimensionLines(t,f),b=this.offsetDimensionLine(w,.1*s),v=this.offsetDimensionLine(T,.1*s),_=(new e.BufferGeometry).setFromPoints(b),y=(new e.BufferGeometry).setFromPoints(v),A=new e.Line(_,this.markupMaterial);this.scene.add(A),this.markupLines.push(A);const F=new e.Line(y,this.markupMaterial);this.scene.add(F),this.markupLines.push(F)}}class Ys{static get(e,t,s){const i=new de(e);i.title=s,e.ui.add(i),i.visible=!1;const n=t.uiElement.get("container");return i.addChild(n),i.onResized.add((()=>t.grid.regenerate())),i.slots.content.domElement.style.padding="0",i.slots.content.domElement.style.overflow="hidden",i.onResized.add((()=>{const{width:e,height:s}=i.containerSize;t.setSize(s,e)})),i.domElement.style.width="20rem",i.domElement.style.height="20rem",i.onVisible.add((()=>{i.visible&&t.grid.regenerate()})),e.renderer.isUpdateable()&&e.renderer.onAfterUpdate.add((async()=>{i.visible&&await t.update()})),i.onResized.trigger(),i}}class Hs{constructor(e,t,s,i){this.components=e,this.renderer=t,this.controls=i,this.markers=new Set,this.clusterLabels=new Set,this.currentKeys=new Set,this._clusterOnZoom=!0,this._color="white",this._markerKey=0,this._clusterKey=0,this._clusterThreeshold=50,this.isNavigating=!1,this.scene=s,this.setupEvents()}set clusterOnZoom(e){this._clusterOnZoom=e}get clusterOnZoom(){return this._clusterOnZoom}set color(e){this._color=e;for(const t of this.markers)t.label.get().element.style.color=e}set clusterThreeshold(e){this._clusterThreeshold=e}get clusterThreeshold(){return this._clusterThreeshold}setupEvents(){this.scene&&(this.controls.addEventListener("sleep",(()=>{this.manageCluster()})),this.controls.addEventListener("rest",(()=>{this.isNavigating&&(this.manageCluster(),this.isNavigating=!1)})))}resetMarkers(){for(const e of this.markers)e.merged=!1;for(const e of this.clusterLabels)this.scene.remove(e.label.get());this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(){for(const e of this.markers)e.merged?this.scene.remove(e.label.get()):this.scene.add(e.label.get());for(const e of this.clusterLabels)if(1===e.markerKeys.length){const t=Array.from(this.markers).find((t=>t.key===e.markerKeys[0]));t&&(this.scene.add(t.label.get()),t.merged=!1),this.scene.remove(e.label.get()),this.clusterLabels.delete(e)}}manageCluster(){this.resetMarkers();for(const e of this.markers)if(!e.merged&&!e.static){this.currentKeys.clear();for(const t of this.markers)if(!t.static&&e.key!==t.key&&!t.merged){this.distance(e.label,t.label)<this._clusterThreeshold&&(this.currentKeys.add(t.key),t.merged=!0)}if(this.currentKeys.size>0){if(!this.scene)return;this.currentKeys.add(e.key),e.merged=!0;const t=Array.from(this.currentKeys),s=this.getAveragePositionFromLabels(t),i=new De(this.components,this.createClusterElement(this._clusterKey.toString()),this.scene);i.get().element.textContent=t.length.toString(),i.get().position.copy(s),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:t,label:i}),this._clusterKey++}}this.removeMergeMarkers()}getAveragePositionFromLabels(t){const s=t.map((t=>{const s=Array.from(this.markers).find((e=>e.key===t));return s?s.label.get().position:new e.Vector3}));return s.reduce(((e,t)=>e.add(t)),new e.Vector3).divideScalar(s.length)}createClusterElement(e){const t=document.createElement("div");return t.textContent=e,t.style.color="#000000",t.style.background="#FFFFFF",t.style.fontSize="1.2rem",t.style.fontWeight="500",t.style.pointerEvents="auto",t.style.borderRadius="50%",t.style.padding="5px 11px",t.style.textAlign="center",t.style.cursor="pointer",t.addEventListener("pointerdown",(()=>{this.navigateToCluster(e)})),t.addEventListener("pointerover",(()=>{t.style.background="#BCF124"})),t.addEventListener("pointerout",(()=>{t.style.background="#FFFFFF"})),t}addMarker(e,t){const s=document.createElement("span");s.innerHTML=e,s.style.color=this._color;const i=this.addMarkerToScene(s);i.get().position.copy(t.position),this.markers.add({label:i,mesh:t,key:this._markerKey.toString(),merged:!1,static:!1}),this._markerKey++}addMarkerAtPoint(t,s,i,n=!1){if(void 0!==i){const o=document.createElement("span");o.innerHTML=t,o.style.color=this._color;const r=new De(this.components,o,this.scene);r.get().position.copy(s),this.markers.add({label:r,mesh:new e.Mesh,key:this._markerKey.toString(),merged:!1,type:i,static:n}),this._markerKey++}}addKPStation(t,s){const i=document.createElement("div"),n=document.createElement("div");i.appendChild(n),n.innerHTML=t,n.style.color=this._color,n.style.borderBottom="1px dotted white",n.style.width="160px",n.style.textAlign="left";const o=new De(this.components,i,this.scene),r=new e.Vector3;r.x=s.geometry.attributes.position.getX(s.geometry.attributes.position.count-1),r.y=s.geometry.attributes.position.getY(s.geometry.attributes.position.count-1),r.z=s.geometry.attributes.position.getZ(s.geometry.attributes.position.count-1);const a=new e.Vector3;a.x=s.geometry.attributes.position.getX(s.geometry.attributes.position.count-2),a.y=s.geometry.attributes.position.getY(s.geometry.attributes.position.count-2),a.z=s.geometry.attributes.position.getZ(s.geometry.attributes.position.count-2);const l=new e.Vector3;l.x=(r.x+a.x)/2,l.y=(r.y+a.y)/2,l.z=(r.z+a.z)/2,o.get().position.copy(l);const h=new e.Vector3;h.subVectors(r,a).normalize();const c=new e.Quaternion;c.setFromUnitVectors(new e.Vector3(0,1,0),h);const d=(new e.Euler).setFromQuaternion(c).z,u=e.MathUtils.radToDeg(d);n.style.transform=`rotate(${-u-90}deg) translate(-35%, -50%)`,this.markers.add({label:o,mesh:s,key:this._markerKey.toString(),merged:!1,static:!1}),this._markerKey++}addCivilVerticalMarker(t,s,i,n){const o=document.createElement("span");o.innerHTML=t,o.style.color=this._color;const r=new De(this.components,o,n);if("Height"===i){const e=document.createElement("span");e.innerHTML=t,e.style.color=this._color;const{position:i}=s.geometry.attributes,n=3*(i.array.length/3-1),o=i.array.slice(n,n+3);r.get().position.set(o[0],o[1]+10,o[2])}else if("InitialKPV"===i){const{position:e}=s.geometry.attributes,t=e.getX(0),i=e.getY(0),n=e.getZ(0);r.get().position.set(t-20,i,n)}else if("FinalKPV"===i){const{position:e}=s.geometry.attributes,t=e.getX(s.geometry.attributes.position.count-1),i=e.getY(s.geometry.attributes.position.count-1),n=e.getZ(s.geometry.attributes.position.count-1);r.get().position.set(t+20,i,n)}else if("Slope"===i){o.style.color="grey";const{position:t}=s.geometry.attributes,i=new e.Vector3;i.x=t.getX(0),i.y=t.getY(0),i.z=t.getZ(0);const n=new e.Vector3;n.x=t.getX(t.count-1),n.y=t.getY(t.count-1),n.z=t.getZ(t.count-1);const a=new e.Vector3;a.addVectors(i,n).multiplyScalar(.5),r.get().position.set(a.x,a.y-10,a.z)}return this.markers.add({label:r,mesh:s,key:this._markerKey.toString(),type:i,merged:!1,static:!1}),this._markerKey++,r}addCivilMarker(t,s,i){const n=document.createElement("span");n.innerHTML=t,n.style.color=this._color;const o=this.addMarkerToScene(n);if("InitialKP"===i){const e=s.geometry.attributes.position.getX(0),t=s.geometry.attributes.position.getY(0),i=s.geometry.attributes.position.getZ(0);o.get().position.set(e+2,t+2,i)}else if("FinalKP"===i){const e=s.geometry.attributes.position.getX(s.geometry.attributes.position.count-1),t=s.geometry.attributes.position.getY(s.geometry.attributes.position.count-1),i=s.geometry.attributes.position.getZ(s.geometry.attributes.position.count-1);o.get().position.set(e+2,t-2,i)}else if("Length"===i){const t=new e.Vector3;t.x=s.geometry.attributes.position.getX(0),t.y=s.geometry.attributes.position.getY(0),t.z=s.geometry.attributes.position.getZ(0);const i=new e.Vector3;i.x=s.geometry.attributes.position.getX(s.geometry.attributes.position.count-1),i.y=s.geometry.attributes.position.getY(s.geometry.attributes.position.count-1),i.z=s.geometry.attributes.position.getZ(s.geometry.attributes.position.count-1);const n=t.distanceTo(i);o.get().element.innerText=n.toFixed(2),o.get().position.copy(i.clone().add(t).divideScalar(2))}return this.markers.add({label:o,mesh:s,key:this._markerKey.toString(),type:i,merged:!1,static:!1}),this._markerKey++,o}addMarkerToScene(e){if(!this.scene)throw new Error("Scene is needed to add markers!");const t=this.scene;return new De(this.components,e,t)}getScreenPosition(t){const s=new e.Vector3;if(this.scene){const e=t.get().position.clone().project(this.controls.camera),i=this.renderer.getSize();s.x=e.x*i.x/2+i.x/2,s.y=-e.y*i.y/2+i.y/2}else{const e=t.get().position.clone().project(this.components.camera.get()),i=this.components.renderer.getSize();s.x=e.x*i.x/2+i.x/2,s.y=-e.y*i.y/2+i.y/2}return s}distance(e,t){const s=this.getScreenPosition(e),i=this.getScreenPosition(t),n=s.x-i.x,o=s.y-i.y,r=.5*Math.sqrt(n*n+o*o);if(0===r){return this._clusterThreeshold+1}return r}navigateToCluster(t){const s=[],i=Array.from(this.clusterLabels).find((e=>e.key===t));if(i){for(const e of i.markerKeys){const t=Array.from(this.markers).find((t=>t.key===e));t&&s.push(t.label.get().position)}this.scene.remove(i?.label.get()),this.clusterLabels.delete(i)}if(this.scene){const t=this.createBox3FromPoints(s),i=new e.Vector3;t.getSize(i);const n=new e.Vector3;t.getCenter(n);const o=new e.BoxGeometry(i.x,i.y,i.z);o.translate(n.x,n.y,n.z);const r=new e.Mesh(o);r.geometry.computeBoundingSphere();const a=r.geometry?.boundingSphere;this.controls&&a&&this.controls.fitToSphere(r,!0),this.isNavigating=!0,o.dispose(),r.clear()}s.length=0}createBox3FromPoints(t){const s=new e.Box3;for(const e of t)s.expandByPoint(e);return s}clearMarkers(){for(const e of this.markers)this.scene.remove(e.label.get());this.markers.clear(),this._markerKey=0}clearMarkersByType(e){for(const t of this.markers)t.type===e&&(this.scene.remove(t.label.get()),this.markers.delete(t))}dispose(){for(const e of this.markers)e.label.dispose();this.markers.clear(),this._markerKey=0;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}}class js extends Hs{constructor(e,t,s,i,n){super(e,t,s,i),this.divisionLength=100,this.view=n}showKPStations(e){if("horizontal"===this.view){const t=this.generateStartAndEndKP(e);for(const[,e]of t)this.addKPStation(e.value,e.normal);const s=this.generateConstantKP(e);for(const[,e]of s)this.addKPStation(e.value,e.normal)}}showCurveLength(e,t){const s=e.length,i=`${t.toFixed(2)} m`,n=e[Math.round(s/2)];this.addMarkerAtPoint(i,n,"Length",!0)}showLineLength(t,s){const i=new e.Vector3;i.x=t.geometry.getAttribute("position").getX(0),i.y=t.geometry.getAttribute("position").getY(0),i.z=t.geometry.getAttribute("position").getZ(0);const n=new e.Vector3;n.x=t.geometry.getAttribute("position").getX(1),n.y=t.geometry.getAttribute("position").getY(1),n.z=t.geometry.getAttribute("position").getZ(1);const o=`${s.toFixed(2)} m`,r=new e.Vector3;r.addVectors(i,n).multiplyScalar(.5),this.addMarkerAtPoint(o,r,"Length",!0)}showCurveRadius(t,s){const i=new e.Vector3;i.x=t.geometry.getAttribute("position").getX(0),i.y=t.geometry.getAttribute("position").getY(0),i.z=t.geometry.getAttribute("position").getZ(0);const n=new e.Vector3;n.x=t.geometry.getAttribute("position").getX(1),n.y=t.geometry.getAttribute("position").getY(1),n.z=t.geometry.getAttribute("position").getZ(1);const o=`R = ${s.toFixed(2)} m`,r=new e.Vector3;r.addVectors(i,n).multiplyScalar(.5),this.addMarkerAtPoint(o,r,"Radius",!0)}generateStartAndEndKP(t){const{alignment:s}=t.curve,i=new Map;for(const t of s.horizontal){const s=t.getLength();if(i.size>0){const n=t.index-1,o=i.get(n).distance+s,r=t.mesh.geometry.getAttribute("position"),a=r.count-1,l=new e.Vector3;l.x=r.getX(a),l.y=r.getY(a),l.z=r.getZ(a);const h=this.createNormalLine(t.mesh);i.set(t.index,{value:this.getShortendKPValue(o),distance:o,point:l,normal:h})}else{const n=t.mesh.geometry.getAttribute("position"),o=n.count-1,r=new e.Vector3;r.x=n.getX(o),r.y=n.getY(o),r.z=n.getZ(o);const a=this.createNormalLine(t.mesh);i.set(t.index,{value:this.getShortendKPValue(s),distance:s,point:r,normal:a})}}return i}createNormalLine(t){const s=t.geometry.attributes.position.count-1,i=s-1,n=new e.Vector3;n.x=t.geometry.attributes.position.getX(s),n.y=t.geometry.attributes.position.getY(s),n.z=t.geometry.attributes.position.getZ(s);const o=new e.Vector3;o.x=t.geometry.attributes.position.getX(i),o.y=t.geometry.attributes.position.getY(i),o.z=t.geometry.attributes.position.getZ(i);const r=(new e.Vector3).subVectors(n,o).clone().applyAxisAngle(new e.Vector3(0,0,1),.5*Math.PI).normalize(),a=(new e.BufferGeometry).setFromPoints([r.clone().setLength(10).add(n),r.clone().setLength(-10).add(n)]);return new e.Line(a)}generateConstantKP(e){const{alignment:t}=e.curve,s=new Map,i=t.getLength("horizontal"),n=Math.floor(i/this.divisionLength);for(let e=0;e<n;e++){const o=e/n,r=t.getPointAt(o,"horizontal"),a=i*o,l=this.getNormal(t,r);s.set(e,{value:this.getShortendKPValue(a),distance:a,point:r,normal:l})}return s}getNormal(t,s){const i=[],n={start:new e.Vector3,end:new e.Vector3};for(let s=0;s<t.horizontal.length;s++){const n=t.horizontal[s].mesh.geometry.attributes.position,o=n.count;for(let t=0;t<o;t++){const s=n.getX(t),o=n.getY(t),r=n.getZ(t);i.push(new e.Vector3(s,o,r))}}for(let e=0;e<i.length-1;e++){const t=i[e],o=i[e+1],r=t.distanceTo(s),a=o.distanceTo(s),l=t.distanceTo(o),h=1e-5;Math.abs(r+a-l)<h&&(n.start=t,n.end=o)}const o=(new e.Vector3).subVectors(n.end,n.start).clone().applyAxisAngle(new e.Vector3(0,0,1),.5*Math.PI).normalize(),r=(new e.BufferGeometry).setFromPoints([o.clone().setLength(10).add(s),o.clone().setLength(-10).add(s)]);return new e.Line(r,new e.LineBasicMaterial({color:16711680}))}getShortendKPValue(e){const t=e.toFixed(2),[s,i]=t.toString().split("."),n=i||"00";if(parseInt(s,10)>1e3&&parseInt(s,10)<1e4){const[e,...t]=s;return`${e}+${t.join("")}.${n}`}if(parseInt(s,10)>1e4){const[e,t,...i]=s;return`${e}${t}+${i.join("")}.${n}`}return`0+${s.padStart(3,"0")}.${n}`}clearKPStations(){this.clearMarkers()}}class Ws extends Vs{constructor(e){super(e),this.view="horizontal",this.uiElement=new Q;const t=this.scene.get();this.kpManager=new js(e,this.scene.renderer,this.scene.get(),this.scene.controls,this.view),this.highlighter=new zs(t,this.kpManager),this.setUI(),this.components.tools.add(Ws.uuid,this),this.onHighlight.add((({mesh:e})=>{this.highlighter.showCurveInfo(e),this.fitCameraToAlignment(e)}))}async fitCameraToAlignment(t){const s=this.components.tools.get(Et),i=t.curve.alignment;for(const e of i.horizontal)s.addMesh(e.mesh);const n=s.get(),o=new e.Vector3,{min:r,max:a}=n,l=new e.Vector3(1.2*(a.x-r.x),1.2*(a.y-r.y),1.2*(a.z-r.z));n.getCenter(o),n.setFromCenterAndSize(o,l),s.reset(),await this.scene.controls.fitToBox(n,!0)}setUI(){const e=Ys.get(this.components,this.scene,"Horizontal alignment");this.uiElement.set({floatingWindow:e}),this.scene.controls.addEventListener("update",(()=>{const t=e.containerSize,{zoom:s}=this.scene.camera;this.highlighter.updateOffset(t,s,!0)})),e.onResized.add((()=>{const t=e.containerSize,{zoom:s}=this.scene.camera;this.highlighter.updateOffset(t,s,!0)}))}}Ws.uuid="3096dea0-5bc2-41c7-abce-9089b6c9431b",Z.libraryUUIDs.add(Ws.uuid);class Xs extends Vs{constructor(e){super(e),this.view="vertical",this.uiElement=new Q,this.setUI();const t=this.scene.get();this.highlighter=new Gs(t,"vertical"),this.kpManager=new js(e,this.scene.renderer,this.scene.get(),this.scene.controls,this.view),this.highlighter.onSelect.add((e=>{this.kpManager.dispose();const{alignment:t}=e.curve,s=[];for(const e of t.vertical){const t=e.mesh.geometry.attributes.position.array;s.push(t)}const{defSegments:i,slope:n}=this.setDefSegments(s),o=this.scene.get();for(let e=0;e<t.vertical.length;e++){const s=t.vertical[e];this.kpManager.addCivilVerticalMarker(`S: ${n[e].slope}%`,s.mesh,"Slope",o),this.kpManager.addCivilVerticalMarker(`H: ${i[e].end.y.toFixed(2)}`,s.mesh,"Height",o)}this.kpManager.addCivilVerticalMarker("KP: 0",t.vertical[0].mesh,"InitialKPV",o),this.kpManager.addCivilVerticalMarker(`KP: ${t.vertical.length}`,t.vertical[t.vertical.length-1].mesh,"FinalKPV",o)}))}get(){return null}showKPStations(e){console.log(e)}clearKPStations(){}setUI(){const e=new ve(this.components);this.components.ui.add(e),e.alignment="top",e.onVisible.add((()=>{this.scene.grid.regenerate()})),e.visible=!1,e.slots.content.domElement.style.padding="0",e.slots.content.domElement.style.overflow="hidden";const{clientWidth:t,clientHeight:s}=e.domElement;this.scene.setSize(s,t);const i=this.scene.uiElement.get("container");e.addChild(i),this.uiElement.set({drawer:e}),e.onResized.add((()=>{const e=window.innerWidth,t=this.scene.size.y;this.scene.setSize(t,e)})),e.onResized.add((()=>{const{width:t,height:s}=e.containerSize;this.scene.setSize(s,t)})),this.components.renderer.isUpdateable()&&this.components.renderer.onAfterUpdate.add((async()=>{e.visible&&await this.scene.update()}))}}Xs.uuid="097eea29-2d5a-431a-a247-204d44670621";class $s extends j{constructor(e){super(e),this.onHighlight=new W,this.enabled=!0,this.onMarkerChange=new W,this.onMarkerHidden=new W,this._curves=[],this.components.tools.add($s.uuid,this);const t=this.components.scene.get();this.highlighter=new Gs(t,"absolute"),this.mouseMarkers={select:this.newMouseMarker("#ffffff"),hover:this.newMouseMarker("#575757")}}get(){return null}draw(e){if(!e.civilData)throw new Error("Model must have civil data!");const t=this.components.scene.get();for(const[s,i]of e.civilData.alignments)for(const{mesh:e}of i.absolute)t.add(e),this._curves.push(e)}setup(){const e=this.components.renderer.get().domElement;e.addEventListener("click",(async t=>{if(!this.enabled)return;const s=this.components.camera.get(),i=this.highlighter.castRay(t,s,e,this._curves);if(i){const e=i.object;this.highlighter.select(e),await this.updateMarker(i,"select");const{point:t,index:s}=i;void 0!==s&&await this.onHighlight.trigger({curve:e,point:t,index:s})}else this.highlighter.unSelect(),this.mouseMarkers.hover.visible=!1,await this.onMarkerHidden.trigger({type:"hover"})})),e.addEventListener("mousemove",(async t=>{if(!this.enabled)return;const s=this.components.camera.get(),i=this.highlighter.castRay(t,s,e,this._curves);if(i)return this.highlighter.hover(i.object),void await this.updateMarker(i,"hover");this.highlighter.unHover()}))}newMouseMarker(e){const t=this.components.scene.get(),s=document.createElement("div");s.style.backgroundColor=e,s.style.width="1rem",s.style.height="1rem",s.style.borderRadius="1rem";const i=new De(this.components,s,t);return i.visible=!1,i}setMarker(e,t,s){const i=e.getPointAt(t,"absolute");this.mouseMarkers[s].visible=!0;this.mouseMarkers[s].get().position.copy(i)}hideMarker(e){this.mouseMarkers[e].get().visible=!1}async updateMarker(e,t){const{point:s,object:i}=e,n=i,o=n.curve,r=n.curve.alignment,a=r.getPercentageAt(s,"absolute");this.mouseMarkers[t].visible=!0;this.mouseMarkers[t].get().position.copy(s),null!==a&&await this.onMarkerChange.trigger({alignment:r,percentage:a,type:t,curve:o})}}$s.uuid="0a59c09e-2b49-474a-9320-99f51f40f182",Z.libraryUUIDs.add($s.uuid);class Ks extends j{constructor(t){super(t),this.uiElement=new Q,this.enabled=!0,this.scene=new ot(t),this.setUI(),this.components.tools.add(Ks.uuid,this);const s=t.tools.get(Yt);this.plane=s.createFromNormalAndCoplanarPoint(new e.Vector3(1,0,0),new e.Vector3),this.plane.visible=!1,this.plane.enabled=!1}get(){return null}async set(t,s){this.plane.enabled=!0;const i=t.curve.getPercentageAt(s);if(null===i)return;const{startPoint:n,endPoint:o}=t.curve.getSegmentAt(i);if(null===t.geometry.index)throw new Error("Geometry must be indexed!");const r=new e.Vector3;r.subVectors(o,n),r.normalize(),await this.plane.setFromNormalAndCoplanarPoint(r,s);const a=this.plane.helper.matrix.clone();a.invert();const l=this.scene.get(),h=this.plane.edges.get();for(const e in h){const{mesh:t}=h[e];t.position.set(0,0,0),t.rotation.set(0,0,0),t.updateMatrix(),t.applyMatrix4(a),t.parent!==l&&l.add(t)}this.plane.enabled=!1}setUI(){const e=Ys.get(this.components,this.scene,"Cross section");this.uiElement.set({floatingWindow:e})}}Ks.uuid="96b2c87e-d90b-4639-8257-8f01136fe324",Z.libraryUUIDs.add(Ks.uuid);export{as as AngleMeasurement,os as AreaMeasurement,Cs as ArrowAnnotation,Ft as AttributeSet,X as BaseRenderer,K as BaseSVGAnnotation,ae as Button,Ie as Canvas,me as CheckboxInput,ws as CircleAnnotation,$s as Civil3DNavigator,Ks as CivilCrossSectionNavigator,Xs as CivilElevationNavigator,Vs as CivilNavigator,Ws as CivilPlanNavigator,Jt as CloudStorage,Ee as ColorInput,be as CommandsMenu,j as Component,ye as Components,ms as CubeMap,ks as DXFExporter,ts as DimensionLabelClassName,ss as DimensionPreviewClassName,q as Disposer,Ce as DragAndDropInput,Is as DrawManager,ve as Drawer,ue as Dropdown,us as EdgeMeasurement,Yt as EdgesClipper,Gt as EdgesPlane,W as Event,ds as FaceMeasurement,de as FloatingWindow,Et as FragmentBoundingBox,xt as FragmentClassifier,jt as FragmentClipStyler,Ut as FragmentExploder,Nt as FragmentHider,gt as FragmentHighlighter,mt as FragmentIfcLoader,Kt as FragmentIfcStreamConverter,rt as FragmentManager,Ht as FragmentPlans,$t as FragmentPropsStreamConverter,qt as FragmentStreamLoader,Dt as FragmentTree,Be as GeometryVerticesMarker,Ct as IfcCategories,ft as IfcCategoryMap,It as IfcElements,pt as IfcJsonExporter,Lt as IfcPropertiesFinder,_t as IfcPropertiesManager,Rt as IfcPropertiesProcessor,wt as IfcPropertiesUtils,Wt as IfcStreamingSettings,ls as LengthMeasurement,xe as LineIntersectionPicker,Ke as MaterialManager,Es as MiniMap,_e as Modal,$ as Mouse,et as OrthoPerspectiveCamera,it as PostproductionRenderer,Xt as PropertiesStreamingSettings,yt as PropertyTag,ge as RangeInput,_s as RectangleAnnotation,Xe as ScreenCuller,es as ShadowDropper,De as Simple2DMarker,ot as Simple2DScene,te as SimpleCamera,Fe as SimpleClipper,is as SimpleDimensionLine,ne as SimpleGrid,Ae as SimplePlane,ie as SimpleRaycaster,ee as SimpleRenderer,$e as SimpleSVGViewport,J as SimpleScene,ce as SimpleUICard,oe as SimpleUIComponent,fe as Spinner,bs as TextAnnotation,Te as TextArea,pe as TextInput,we as ToastNotification,Z as ToolComponent,re as Toolbar,le as TreeView,Q as UIElement,he as UIManager,Ue as VertexPicker,ps as ViewpointsManager,hs as VolumeMeasurement,Le as bufferGeometryToIndexed,Me as generateExpressIDFragmentIDMap,Pe as generateIfcGUID,Ne as isPointInFrontOfPlane,Oe as isTransparent,je as obbFromPoints};export default null;
//# sourceMappingURL=/sm/1cb5adce9a51e9e094a6f295bbd2a9cbd526ec4b1f7eb0985197e786c76610a9.map
